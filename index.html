<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tunes</title>
    <style>
      :root {
        --bg: linear-gradient(to left, #000814 0%, #000814 30%, #000000 50%, #140028 80%, #1a0033 100%);
        --surface: #121212;
        --card: #181818;
        --hover: #282828;
        --text: #fff;
        --text-secondary: #b3b3b3;
        --accent: #fff;
        --border: #000;
        --theme-color: #32CD32;
      }
      * { box-sizing: border-box; }
      body {
        margin:0;
        font-family: 'Circular', 'Helvetica Neue', Arial, sans-serif;
        background:var(--bg);
        color:var(--text);
        display:flex;
        height:100vh;
        overflow:hidden;
        transition: background 0.8s ease;
      }
      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
      }
      .grid-card {
        background: var(--card);
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: background 0.3s ease;
        position: relative;
      }
      .grid-card:hover {
        background: var(--hover);
      }
      .grid-cover {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 8px 24px rgba(0,0,0,.5);
        margin-bottom: 16px;
      }
      .grid-title {
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        line-height: 1.4;
      }
      .grid-artist {
        font-size: 0.875rem;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.4;
      }
      .playlist-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .playlist-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
      }
      .playlist-header .btns {
        display: flex;
        gap: 8px;
      }
      .playlist-header button {
        background: transparent;
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 4px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .playlist-header button:hover {
        background: var(--accent);
        color: #fff;
      }
      header {
        position:fixed;
        top:0; left:0; width:100%;
        height:70px;
        padding:0 24px;
        background:var(--surface);
        display:flex;
        justify-content:space-between;
        align-items:center;
        border-bottom:5px solid var(--border);
        z-index:20;
        border-radius: 15px;
      }
      header h2 {
        margin:0;
        font-size:1.4em;
        font-weight:600;
        background: linear-gradient(90deg, #fff, #ccc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .header-right { display:flex; align-items:center; gap:12px; }
      #premium-btn {
        background: var(--theme-color);
        padding:8px 18px;
        border-radius:12px;
        cursor:pointer;
        font-weight:600;
        font-size:0.9em;
        transition:background 0.3s ease, transform 0.2s;
      }
      #premium-btn:hover { transform:scale(1.03); }
      #profile-btn {
        width:36px; height:36px;
        background:#333;
        border-radius:50%;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        font-weight:bold;
        font-size:1em;
        transition:0.2s;
        overflow:hidden;
      }
      #profile-btn img {
        width:100%; height:100%; object-fit:cover;
      }
      #profile-btn:hover { background:#444; }
      #profile-popup {
        position:fixed; top:80px; right:24px;
        background:var(--card);
        padding:20px;
        border-radius:14px;
        width:300px;
        box-shadow:0 8px 24px rgba(0,0,0,0.4);
        display:none;
        z-index:100;
        border:5px solid var(--border);
      }
      #profile-popup h4 { margin:0 0 8px; font-size:1.1em; }
      #profile-popup p { margin:4px 0; font-size:0.9em; color:#aaa; }
      #profile-avatar {
        width:80px; height:80px; border-radius:50%; margin:0 auto 12px; display:block; object-fit:cover;
      }
      #upload-avatar, #upload-playlist-cover { display:none; }
      .upload-btn {
        background:var(--hover);
        border:none;
        color:var(--text);
        padding:6px 12px;
        border-radius:8px;
        cursor:pointer;
        width:100%;
        margin-top:8px;
        font-size:0.9em;
        text-align:center;
      }
      #bio-input {
        width:100%; height:80px; background:var(--card); border:none; border-radius:8px; color:var(--text); padding:8px; margin-top:8px; resize:none;
      }
      #bio-input:focus { outline:none; box-shadow:0 0 0 2px var(--accent); }
      #sidebar {
        width:340px;
        background:var(--surface);
        padding-top:90px;
        overflow-y:auto;
        border-right:5px solid var(--border);
        display:flex;
        flex-direction:column;
        border-radius: 15px;
      }
      .nav-item {
        display:flex;
        align-items:center;
        padding:14px 16px;
        cursor:pointer;
        gap:14px;
        transition:0.2s;
        border-bottom:0px solid var(--border);
        font-weight:500;
      }
      .nav-item:hover { background:var(--hover); }
      .nav-item.active {
        background:var(--hover);
        border-left:3px solid var(--accent);
        padding-left:13px;
      }
      .nav-item svg { width:20px; height:20px; fill: #aaa; }
      .nav-item.active svg { fill: var(--accent); }
      .playlists-header {
        padding:16px 16px 8px;
        font-size:0.9em;
        color:#aaa;
        text-transform:uppercase;
        letter-spacing:0.5px;
        font-weight:600;
      }
      .playlist-item {
        display:flex;
        align-items:center;
        padding:12px 16px;
        cursor:pointer;
        gap:12px;
        transition:0.2s;
        border-bottom:1px solid var(--border);
        position:relative;
        overflow:hidden;
      }
      .playlist-item:hover { background:var(--hover); }
      .playlist-cover { width:42px; height:42px; object-fit:cover; border-radius:50%; }
      .playlist-actions {
        margin-left:auto;
        display:flex;
        gap:6px;
        opacity:1;
        transition:0.2s;
        position:static;
        background:none;
        padding:0;
        border-radius:8px;
      }
      .playlist-actions button {
        font-size: 0.75rem;
        padding: 4px 8px;
      }
      #content {
        flex:1;
        padding:90px 32px 20px 32px;
        overflow-y:auto;
      }
      .section { margin-bottom:36px; }
      .section h3 { margin:0 0 16px; font-size:1.3em; font-weight:600; color:#eee; }
      .song-card {
        background:transparent;
        padding:16px;
        border-radius:14px;
        display:flex;
        gap:16px;
        align-items:center;
        transition:0.25s;
        cursor:pointer;
        margin-bottom:14px;
        justify-content:space-between;
        box-shadow:0 2px 6px rgba(0,0,0,0.2);
      }
      .song-card:hover {
        background:var(--hover);
        transform:translateY(-2px);
        box-shadow:0 6px 12px rgba(0,0,0,0.3);
      }
      .cover { width:64px; height:64px; object-fit:cover; border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,0.3); }
      #player {
        position:sticky;
        bottom:0;
        background:transparent;
        padding:16px 24px;
        border-top:1px solid var(--border);
        display:none;
        width:100%;
        box-sizing:border-box;
        backdrop-filter: blur(10px);
      }
      #now-playing { margin:0 0 8px; font-weight:500; font-size:0.95em; }
      input, button, textarea { font-family: inherit; }
      input {
        width:100%;
        padding:14px 16px;
        background:var(--card);
        border:none;
        border-radius:12px;
        color:var(--text);
        margin-bottom:20px;
        font-size:1em;
        transition:0.2s;
      }
      input:focus { outline:none; box-shadow:0 0 0 2px var(--accent); }
      button {
        cursor:pointer;
        background:var(--hover);
        color:var(--text);
        border:none;
        padding:8px 16px;
        border-radius:10px;
        margin-left:8px;
        transition:0.2s;
        font-weight:500;
      }
      button:hover { background:#333; }
      .skeleton {
        height:78px;
        background:linear-gradient(90deg,#202020,#2a2a2a,#202020);
        background-size:200% 100%;
        animation:loading 1.4s infinite;
        border-radius:14px;
        margin-bottom:14px;
      }
      @keyframes loading { 0% { background-position:200% 0; } 100% { background-position:-200% 0; } }
      #welcome {
        font-size:1.8em;
        margin-bottom:24px;
        font-weight:600;
        background: linear-gradient(90deg, #fff, #aaa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      #premium-popup {
        position:fixed;
        background:var(--card);
        padding:24px;
        border-radius:16px;
        box-shadow:0 12px 32px rgba(0,0,0,0.5);
        z-index:100;
        border:1px solid var(--border);
        top:50%; left:50%;
        transform:translate(-50%,-50%);
        width:340px;
        text-align:center;
        display:none;
      }
      #search-results-title {
        margin: 20px 0 16px;
        font-size: 1.3em;
        font-weight: 600;
        color: #eee;
        display: none;
      }
      .modal-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal-box {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 12px 32px rgba(0,0,0,0.6);
      }
      .modal-box h3 {
        margin: 0 0 12px;
        font-size: 1.2em;
      }
      .modal-box p {
        margin: 0 0 20px;
        color: #aaa;
      }
      .modal-box input {
        margin-bottom: 16px;
      }
      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .modal-buttons button {
        margin: 0;
        padding: 10px 20px;
      }
      .modal-buttons .primary {
        background: var(--accent);
        color: #fff;
      }
      .modal-buttons .primary:hover {
        background: #6a00d8;
      }
      .playlist-select-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 16px;
      }
      .playlist-select-item {
        background: var(--hover);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: 0.2s;
      }
      .playlist-select-item:hover {
        background: #333;
      }
      #main-wrapper {
        display: flex;
        height: calc(100vh - 10px);
        flex: 1;
        border: 5px solid var(--border);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
      }
      .playlist-view-header {
        text-align: center;
        margin: 0 0 40px;
        padding: 20px 0;
      }
      .playlist-big-cover {
        width: 280px;
        height: 280px;
        object-fit: cover;
        border-radius: 16px;
        box-shadow: 0 16px 48px rgba(0,0,0,0.7);
        margin: 0 auto 24px;
        display: block;
      }
      .playlist-view-title {
        font-size: 2.8rem;
        font-weight: 900;
        margin: 0;
        background: linear-gradient(90deg, #fff, #ccc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .playlist-view-song-count {
        color: #aaa;
        font-size: 1rem;
        margin-top: 8px;
      }
      #right-sidebar {
        width: 340px;
        background: var(--surface);
        padding-top: 90px;
        border-left: 5px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        flex-shrink: 0;
        transition: width 0.4s ease;
      }
      #right-sidebar.hidden {
        width: 0 !important;
        padding: 0;
        overflow: hidden;
      }
      #now-playing-sidebar {
        width: 100%;
        padding: 20px;
        text-align: center;
        display: none;
      }
      #now-playing-cover {
        width: 290px;
        height: 290px;
        object-fit: cover;
        border-radius: 16px;
        margin: 0 auto 24px;
        display: block;
        box-shadow: 0 12px 32px rgba(0,0,0,0.7);
      }
      #now-playing-info {
        margin-top: 12px;
      }
      #now-playing-title {
        font-size: 1.1em;
        font-weight: 700;
        display: block;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #now-playing-artist {
        color: #aaa;
        margin: 0 0 16px;
        font-size: 0.95em;
      }
      #add-current-to-playlist {
        background: var(--hover);
        color: var(--text);
        border: none;
        padding: 10px 20px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        width: 80%;
        transition: 0.2s;
        margin: 0;
      }
      #add-current-to-playlist:hover {
        background: var(--accent);
        color: #000;
      }
      #lyrics-section {
        width: 100%;
        padding: 20px;
        margin-top: 20px;
        display: none;
      }
      #lyrics-section h4 {
        margin: 0 0 12px;
        font-size: 1.1em;
        font-weight: 600;
        text-align: center;
      }
      #lyrics-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
        transition: background 0.8s ease;
      }
      #lyrics-text {
        color: #fff;
        line-height: 1.8;
        font-size: 0.95em;
        white-space: pre-wrap;
        text-align: center;
      }
      #lyrics-text.loading {
        color: #aaa;
        font-style: italic;
      }
      #lyrics-container::-webkit-scrollbar {
        width: 8px;
      }
      #lyrics-container::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }
      #lyrics-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }
      #lyrics-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }

.header-center {
  display: flex;
  gap: 8px;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
}


      .header-center .nav-item {
  padding: 8px 16px;
  border-radius: 20px;
  border-bottom: none;
  font-size: 0.9em;
  background: rgba(255, 255, 255, 0.1);
  transition: background 0.2s ease;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

.header-center .nav-item:hover {
  background: rgba(255, 255, 255, 0.15);
}

.header-center .nav-item.active {
  background: rgba(255, 255, 255, 0.2);
  border-left: none;
  padding-left: 16px;
}

.header-center .nav-item span {
  font-weight: 500;
}

.header-center .nav-item svg {
  width: 16px;
  height: 16px;
}


      .grid-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 32px;
      }
      .grid-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: background 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .grid-card:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .grid-cover {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 8px 24px rgba(0,0,0,.5);
        flex-shrink: 0;
      }
      .grid-title {
        font-weight: 700;
        font-size: 0.9rem;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        line-height: 1.3;
      }
      .grid-artist {
        font-size: 0.8rem;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        line-height: 1.3;
      }
      /* Square playlist cards (for Made for You and Your Playlists) */
.playlist-grid-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}

.playlist-card {
  background: var(--card);
  border-radius: 8px;
  padding: 16px;
  cursor: pointer;
  transition: background 0.3s ease;
  display: flex;
  flex-direction: column;
}

.playlist-card:hover {
  background: var(--hover);
}

.playlist-cover {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  border-radius: 4px;
  box-shadow: 0 8px 24px rgba(0,0,0,.5);
  margin-bottom: 16px;
}

.playlist-title {
  font-weight: 700;
  font-size: 1rem;
  margin-bottom: 8px;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  line-height: 1.4;
}

.playlist-subtitle {
  font-size: 0.875rem;
  color: var(--text-secondary);
}
    </style>
  </head>
  <body>
    <div id="main-wrapper">
<header>
  <h2>Tunes</h2>
  <div class="header-center">
    <div id="home-nav" class="nav-item active">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
    </div>
    <div id="search-nav" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l4.5 4.5a1 1 0 0 1-1.42 1.42l-4.5-4.5v-.79l-.27-.27A6.5 6.5 0 1 1 9.5 3zm0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
      <span>Search</span>
    </div>
  </div>
  <div class="header-right">
    <div id="premium-btn">Premium</div>
    <div id="profile-btn">?</div>
  </div>
</header>

      <div id="profile-popup">
        <img id="profile-avatar" src="https://via.placeholder.com/80" alt="Profile">
        <h4 id="profile-name">User</h4>
        <p>Customize your experience</p>
        <button class="upload-btn" id="change-avatar-btn">Change Avatar</button>
        <input type="file" id="upload-avatar" accept="image/*">
        <textarea id="bio-input" placeholder="Write your bio... (private)"></textarea>
        <button class="upload-btn" id="change-name">Change Name</button>
      </div>

      <div id="sidebar">
        <div class="playlists-header">Your Library</div>
      </div>

      <div id="content">
        <div id="home-page">
          <div id="welcome">Good day, User</div>
          <div class="section">
            <h3>Recently Played</h3>
            <div id="recently-played"></div>
          </div>
          <div class="section">
            <h3>Your Playlists</h3>
            <div id="your-playlists"></div>
          </div>
          <div class="section">
            <h3>DJ Suggestions</h3>
            <input id="recommend-input" placeholder="Have your personal DJ recommend songs based on other songs">
            <div id="ai-recommendations"></div>
          </div>
        </div>
        <div id="search-page" style="display:none;">
          <input id="search" placeholder="Search for songs, artists, albums...">
          <div id="popular-section">
            <h3>Popular Right Now</h3>
            <div id="popular"></div>
          </div>
          <h3 id="search-results-title">Search Results</h3>
          <div id="results"></div>
        </div>
        <div id="player">
          <p id="now-playing">Now playing...</p>
          <audio id="audio" controls=""></audio>
        </div>
        <div id="lyrics-viewer" style="margin-top:24px; padding:16px; background:var(--card); border-radius:12px; display:none;">
          <h4>Lyrics</h4>
          <p id="lyrics-text-old">Loading lyrics...</p>
        </div>
      </div>

      <div id="right-sidebar">
        <div id="now-playing-sidebar">
          <h3>Audio Menu</h3>
          <img id="now-playing-cover" src="https://via.placeholder.com/240" alt="Cover">
          <div id="now-playing-info">
            <strong id="now-playing-title">Nothing playing</strong>
            <p id="now-playing-artist"></p>
            <button id="add-current-to-playlist">Add to Playlist</button>
          </div>
        </div>

        <div id="lyrics-section">
          <h4>Lyrics</h4>
          <div id="lyrics-container">
            <p id="lyrics-text" class="loading">No lyrics available</p>
          </div>
        </div>
      </div>
    </div>

    <div id="premium-popup">
      <h3>Mini Tunes Premium</h3>
      <p>Only <strong>$3/year, $0.25/month</strong>! Get points every clip listened to + an access code to BETA TV!</p>
      <button onclick="closePremium()">Close</button>
    </div>

    <input type="file" id="upload-playlist-cover" accept="image/*" style="display:none;">

    <div id="input-modal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="input-modal-title">Input</h3>
        <p id="input-modal-message"></p>
        <input type="text" id="input-modal-input">
        <div class="modal-buttons">
          <button id="input-modal-cancel">Cancel</button>
          <button id="input-modal-ok" class="primary">OK</button>
        </div>
      </div>
    </div>

    <div id="alert-modal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="alert-modal-title">Notice</h3>
        <p id="alert-modal-message"></p>
        <div class="modal-buttons">
          <button id="alert-modal-ok" class="primary">OK</button>
        </div>
      </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="confirm-modal-title">Confirm</h3>
        <p id="confirm-modal-message"></p>
        <div class="modal-buttons">
          <button id="confirm-modal-cancel">Cancel</button>
          <button id="confirm-modal-ok" class="primary">OK</button>
        </div>
      </div>
    </div>

    <div id="playlist-select-modal" class="modal-overlay">
      <div class="modal-box">
        <h3>Add to Playlist</h3>
        <div class="playlist-select-list" id="playlist-select-list"></div>
        <div class="modal-buttons">
          <button id="playlist-select-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <script src="script.js"></script>
    <script>
     // ====================== COLOR EXTRACTION & GRADIENT ======================
function extractColorsFromImage(imageUrl) {
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      try {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const colors = [];
        
        // Sample pixels from the image
        for (let i = 0; i < imageData.data.length; i += 4 * 10) {
          const r = imageData.data[i];
          const g = imageData.data[i + 1];
          const b = imageData.data[i + 2];
          
          // Skip very dark or very light colors
          const brightness = (r + g + b) / 3;
          if (brightness > 30 && brightness < 220) {
            colors.push({ r, g, b });
          }
        }

        // Find dominant color
        if (colors.length > 0) {
          const avgColor = colors.reduce((acc, c) => ({
            r: acc.r + c.r,
            g: acc.g + c.g,
            b: acc.b + c.b
          }), { r: 0, g: 0, b: 0 });

          avgColor.r = Math.floor(avgColor.r / colors.length);
          avgColor.g = Math.floor(avgColor.g / colors.length);
          avgColor.b = Math.floor(avgColor.b / colors.length);

          resolve(avgColor);
        } else {
          resolve({ r: 0, g: 20, b: 20 }); // Default dark teal
        }
      } catch (e) {
        // CORS error or other issue - use default
        resolve({ r: 0, g: 20, b: 20 });
      }
    };
    img.onerror = () => resolve({ r: 0, g: 20, b: 20 });
    img.src = imageUrl;
  });
}

function applyGradientFromColor(color) {
  const { r, g, b } = color;
  const darkerR = Math.max(0, Math.floor(r * 0.3));
  const darkerG = Math.max(0, Math.floor(g * 0.3));
  const darkerB = Math.max(0, Math.floor(b * 0.3));
  
  const gradient = `linear-gradient(to bottom, rgb(${r}, ${g}, ${b}), rgb(${darkerR}, ${darkerG}, ${darkerB}), #000)`;
  document.body.style.background = gradient;
}

// Modify the playSong function to update gradient and refresh artists
const originalPlaySong = window.playSong;
window.playSong = async function(song, fromPlaylist = false) {
  await originalPlaySong.call(this, song, fromPlaylist);
  
  // Extract color and apply gradient
  if (song?.album?.cover_medium || song?.album?.cover_big) {
    const coverUrl = song.album.cover_big || song.album.cover_medium;
    const color = await extractColorsFromImage(coverUrl);
    applyGradientFromColor(color);
  }
  
  // Refresh top artists sidebar after each song
  renderTopArtistsSidebar();
};

function renderAutoPlaylists() {
  const { auto, recentSongs } = generateAutoPlaylists();
  const homePage = document.getElementById("home-page");
  if (!homePage) return;

  // Remove existing custom sections
  homePage.querySelectorAll('[data-section="made-for-you"], [data-section="recently-played-new"]').forEach(el => el.remove());

  // === Recently Played (horizontal song cards - keeps your existing flex style) ===
  const recentSection = document.createElement('div');
  recentSection.className = 'section';
  recentSection.setAttribute('data-section', 'recently-played-new');

  const recentTitle = document.createElement('h3');
  recentTitle.textContent = 'Recently Played';
  recentSection.appendChild(recentTitle);

  const recentGrid = document.createElement('div');
  recentGrid.style.display = 'grid';
  recentGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
  recentGrid.style.gap = '16px';

  recentSongs.forEach(song => {
    const card = document.createElement('div');
    card.className = 'grid-card'; // Uses the existing horizontal flex style at the bottom of CSS
    card.style.padding = '12px';

    const cover = song.album?.cover_medium || 'https://via.placeholder.com/80';
    card.innerHTML = `
      <img class="grid-cover" src="${cover}" style="width:80px;height:80px;border-radius:8px;flex-shrink:0;">
      <div class="grid-title" style="font-size:1.1rem;margin:0;line-height:1.4;">${song.title}</div>
    `;
    card.onclick = () => window.playSong(song);
    recentGrid.appendChild(card);
  });

  recentSection.appendChild(recentGrid);

  // === Made for You (now proper square cards) ===
  const autoSection = document.createElement('div');
  autoSection.className = 'section';
  autoSection.setAttribute('data-section', 'made-for-you');

  const autoTitle = document.createElement('h3');
  autoTitle.textContent = 'Made for You';
  autoSection.appendChild(autoTitle);

  const autoGrid = document.createElement('div');
  autoGrid.className = 'playlist-grid-container';

  Object.entries(auto).forEach(([name, playlist]) => {
    const card = document.createElement('div');
    card.className = 'playlist-card';

    const cover = playlist.cover || 'https://via.placeholder.com/300?text=♪';
    card.innerHTML = `
      <img class="playlist-cover" src="${cover}" alt="cover">
      <div class="playlist-title">${name}</div>
      <div class="playlist-subtitle">${playlist.songs.length} songs</div>
    `;

    card.onclick = () => loadAutoPlaylist(name, playlist);
    autoGrid.appendChild(card);
  });

  autoSection.appendChild(autoGrid);

  // Insert in correct order
  const yourPlaylistsSection = homePage.querySelectorAll('.section')[1]; // Your Playlists section

  homePage.insertBefore(recentSection, yourPlaylistsSection);
  homePage.insertBefore(autoSection, yourPlaylistsSection);
}
// ====================== TOP ARTISTS SIDEBAR ======================
function renderTopArtistsSidebar() {
  const sidebar = document.getElementById('sidebar');
  const recent = JSON.parse(localStorage.getItem("recentlyPlayed") || "[]");
  
  // Remove existing top artists section
  const existingHeader = Array.from(sidebar.children).find(el => 
    el.className === 'playlists-header' && el.textContent === 'Top Artists'
  );
  if (existingHeader) {
    let next = existingHeader.nextElementSibling;
    while (next && next.className === 'playlist-item' && next.querySelector('small')) {
      const toRemove = next;
      next = next.nextElementSibling;
      toRemove.remove();
    }
    existingHeader.remove();
  }
  
  if (recent.length === 0) return;

  // Calculate artist play counts
  const artistCounts = {};
  const artistData = {};
  
  recent.forEach(song => {
    const artist = song.artist?.name || "Unknown";
    artistCounts[artist] = (artistCounts[artist] || 0) + 1;
    
    if (!artistData[artist]) {
      artistData[artist] = {
        name: artist,
        cover: song.album?.cover_medium || 'https://via.placeholder.com/42',
        songs: []
      };
    }
    artistData[artist].songs.push(song);
  });

  // Get top 5 artists
  const topArtists = Object.entries(artistCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([artist]) => artistData[artist]);

  if (topArtists.length === 0) return;

  // Create header
  const header = document.createElement('div');
  header.className = 'playlists-header';
  header.textContent = 'Top Artists';
  sidebar.appendChild(header);

  // Render artists
  topArtists.forEach(artist => {
    const div = document.createElement('div');
    div.className = 'playlist-item';
    div.innerHTML = `
      <img class="playlist-cover" src="${artist.cover}" alt="artist">
      <strong style="flex:1;">${artist.name}</strong>
      <small style="color:#666;">${artist.songs.length}</small>
    `;
    
    div.onclick = () => loadArtistPlaylist(artist);
    sidebar.appendChild(div);
  });
}

function loadArtistPlaylist(artist) {
  const searchPage = document.getElementById('search-page');
  const homePage = document.getElementById('home-page');
  const searchInput = document.getElementById('search');
  const results = document.getElementById('results');
  const popularSection = document.getElementById('popular-section');
  const searchResultsTitle = document.getElementById('search-results-title');
  
  homePage.style.display = 'none';
  searchPage.style.display = 'block';
  searchInput.style.display = 'none';
  popularSection.style.display = 'none';
  searchResultsTitle.style.display = 'none';

  const cover = artist.cover || 'https://via.placeholder.com/280?text=♪';

  results.innerHTML = `
    <div class="playlist-view-header">
      <img class="playlist-big-cover" src="${cover}" alt="cover">
      <h1 class="playlist-view-title">${artist.name}</h1>
      <p class="playlist-view-song-count">${artist.songs.length} song${artist.songs.length !== 1 ? 's' : ''}</p>
    </div>
  `;

  const container = document.createElement('div');
  artist.songs.forEach((song, i) => {
    const div = document.createElement('div');
    div.className = 'song-card';
    const coverSrc = song.album?.cover_medium || 'https://via.placeholder.com/64';

    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:16px;">
        <img class="cover" src="${coverSrc}" alt="cover">
        <div>
          <strong>${song.title}</strong><br>
          <small style="color:#aaa;">${artist.name}</small>
        </div>
      </div>
    `;
    div.onclick = () => {
      window.currentSong = song;
      window.playSong(song);
    };
    container.appendChild(div);
  });
  results.appendChild(container);
}

// ====================== INITIALIZE ======================
// Override loadHomeContent to include auto playlists
const originalLoadHomeContent = window.loadHomeContent;
window.loadHomeContent = function() {
  originalLoadHomeContent.call(this);
  renderAutoPlaylists();
};

// Initialize on page load
window.addEventListener('load', () => {
  renderTopArtistsSidebar();
  
  // Refresh top artists when returning to home
  const homeNav = document.getElementById('home-nav');
  const originalHomeClick = homeNav.onclick;
  homeNav.onclick = function() {
    originalHomeClick.call(this);
    renderTopArtistsSidebar();
  };
});
    </script>

    <script>
      // ====================== LYRICS FEATURE ======================
let currentGradientColor = { r: 0, g: 20, b: 20 }; // Store current color

// Update the applyGradientFromColor function to store the color
const originalApplyGradient = window.applyGradientFromColor;
window.applyGradientFromColor = function(color) {
  currentGradientColor = color;
  originalApplyGradient(color);
  
  // Update lyrics container background
  const lyricsContainer = document.getElementById('lyrics-container');
  if (lyricsContainer) {
    lyricsContainer.style.background = `rgba(${color.r}, ${color.g}, ${color.b}, 0.2)`;
  }
};

// Fetch lyrics from lyrics.ovh API (free, no key needed)
async function fetchLyrics(artist, title) {
  try {
    const response = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`);
    
    if (!response.ok) {
      throw new Error('Lyrics not found');
    }
    
    const data = await response.json();
    return data.lyrics || null;
  } catch (error) {
    console.log('Lyrics fetch error:', error);
    return null;
  }
}

// Display lyrics
async function displayLyrics(song) {
  const lyricsSection = document.getElementById('lyrics-section');
  const lyricsText = document.getElementById('lyrics-text');
  const lyricsContainer = document.getElementById('lyrics-container');
  
  if (!song || !song.title || !song.artist?.name) {
    lyricsSection.style.display = 'none';
    return;
  }
  
  // Show section and loading state
  lyricsSection.style.display = 'block';
  lyricsText.className = 'loading';
  lyricsText.textContent = 'Loading lyrics...';
  
  // Update container background to match current gradient color
  if (lyricsContainer) {
    lyricsContainer.style.background = `rgba(${currentGradientColor.r}, ${currentGradientColor.g}, ${currentGradientColor.b}, 0.2)`;
  }
  
  // Fetch lyrics
  const lyrics = await fetchLyrics(song.artist.name, song.title);
  
  if (lyrics) {
    lyricsText.className = '';
    lyricsText.textContent = lyrics.trim();
  } else {
    lyricsText.className = 'loading';
    lyricsText.textContent = 'Lyrics not available for this song';
  }
}

// Hook into the playSong function to fetch lyrics
const originalPlaySongWithLyrics = window.playSong;
window.playSong = async function(song, fromPlaylist = false) {
  await originalPlaySongWithLyrics.call(this, song, fromPlaylist);
  
  // Fetch and display lyrics
  displayLyrics(song);
};

// Hide lyrics when player is hidden
const originalHidePlayer = window.hidePlayer;
window.hidePlayer = function() {
  originalHidePlayer.call(this);
  
  const lyricsSection = document.getElementById('lyrics-section');
  if (lyricsSection) {
    lyricsSection.style.display = 'none';
  }
};
    </script>
    
  </body>
</html>
