<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Tunes</title>
<style>
:root {
  --bg: #000;
  --surface: #121212;
  --card: #181818;
  --hover: #252525;
  --text: #fff;
  --text-secondary: #b3b3b3;
  --accent: #1db954;
  --border: #333;
}
* { box-sizing: border-box; margin:0; padding:0; }
body {
  font-family: 'Circular', 'Helvetica Neue', Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  height:100vh;
  overflow:hidden;
}
header {
  position:fixed; top:0; left:0; width:100%; height:70px;
  padding:0 24px; background:var(--surface);
  display:flex; justify-content:space-between; align-items:center;
  border-bottom:1px solid var(--border); z-index:20;
}
header h2 {
  font-size:1.5em; font-weight:700;
  background: linear-gradient(90deg, #fff, #ccc);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
#premium-btn {
  background:#1db954; color:#000; font-weight:700;
  padding:10px 20px; border-radius:30px; cursor:pointer;
}
#profile-btn {
  width:40px; height:40px; border-radius:50%; overflow: hidden;
  background:#333; display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
#profile-btn img { width:100%; height:100%; object-fit:cover; }

#sidebar {
  width:260px; background:var(--surface); padding-top:90px;
  overflow-y:auto; border-right:1px solid var(--border);
}
.nav-item {
  display:flex; align-items:center; gap:16px;
  padding:14px 20px; cursor:pointer; font-weight:500;
  transition:0.2s;
}
.nav-item:hover { background:var(--hover); }
.nav-item.active { background:var(--hover); border-left:4px solid var(--accent); padding-left:16px; }
.nav-item svg { width:24px; height:24px; fill:#aaa; }
.nav-item.active svg { fill:var(--accent); }
.playlists-header { padding:20px 20px 8px; text-transform:uppercase; font-size:0.8em; color:#888; letter-spacing:1px; }

.playlist-item {
  display:flex; align-items:center; gap:12px;
  padding:12px 20px; cursor:pointer; position:relative;
  transition:0.2s;
}
.playlist-item:hover { background:var(--hover); }
.playlist-cover { width:44px; height:44px; border-radius:8px; object-fit:cover; }
.playlist-actions { margin-left:auto; gap:6px; display:none; }
.playlist-item:hover .playlist-actions { display:flex; }
.playlist-actions button { font-size:0.75rem; padding:4px 8px; background:#333; border:none; border-radius:4px; color:#fff; }

#content {
  flex:1; padding:90px 32px 100px; overflow-y:auto;
  background:var(--bg);
}
#welcome { font-size:2.2em; font-weight:800; margin-bottom:30px;
  background: linear-gradient(90deg, #fff, #aaa);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.section h3 { font-size:1.4em; margin:0 0 20px; font-weight:700; }

.grid-container {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
  gap:20px;
  margin-bottom:40px;
}
.grid-card {
  background:var(--card); border-radius:12px; padding:16px;
  cursor:pointer; transition:0.3s; position:relative; overflow:hidden;
}
.grid-card:hover {
  background:var(--hover); transform:translateY(-6px);
  box-shadow:0 12px 30px rgba(0,0,0,0.6);
}
.grid-card:hover .play-overlay { opacity:1; transform:scale(1); }
.grid-cover {
  width:100%; aspect-ratio:1; object-fit:cover;
  border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.6);
}
.play-overlay {
  position:absolute; bottom:70px; right:16px;
  width:50px; height:50px; background:var(--accent); border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  opacity:0; transform:scale(0.8); transition:0.3s;
  box-shadow:0 8px 20px rgba(0,0,0,0.7);
}
.play-overlay svg { width:24px; height:24px; fill:#000; margin-left:2px; }

.grid-title {
  margin-top:16px; font-weight:700; font-size:1.05rem;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}

/* Song Cards */
.song-card {
  background:var(--card); padding:14px; border-radius:12px;
  display:flex; align-items:center; gap:16px;
  cursor:pointer; transition:0.3s; margin-bottom:12px;
  position:relative;
}
.song-card:hover { background:var(--hover); transform:translateY(-2px); }
.song-card.playing {
  background:#1a2a1a;
  border-left:4px solid var(--accent);
}
.song-card.playing::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:4px;
  background:var(--accent); animation:pulse 2s infinite;
}
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }

.cover { width:60px; height:60px; border-radius:8px; object-fit:cover; }
.song-info strong { font-size:1.1em; }
.song-info small { color:var(--text-secondary); }

/* Player */
#player {
  position:fixed; bottom:0; left:0; width:100%;
  background:linear-gradient(transparent, rgba(0,0,0,0.9));
  padding:16px 24px; backdrop-filter:blur(20px);
  border-top:1px solid var(--border); z-index:30;
  display:none;
}
.player-inner {
  display:flex; align-items:center; gap:20px; max-width:1200px; margin:0 auto;
}
.player-cover { width:60px; height:60px; border-radius:8px; object-fit:cover; }
.player-info { flex:1; }
.player-info strong { font-size:1.1em; display:block; }
.progress-container {
  height:4px; background:#333; border-radius:2px; overflow:hidden; flex:2;
}
.progress { height:100%; width:0%; background:var(--accent); transition:width 0.1s; }
#audio { width:100%; margin-top:10px; accent-color:var(--accent); }

/* Modals & Misc */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.8);
  display:none; align-items:center; justify-content:center; z-index:200;
}
.modal-overlay.active { display:flex; }
.modal-box {
  background:var(--card); padding:28px; border-radius:16px;
  width:90%; max-width:420px; border:1px solid var(--border);
}
.skeleton {
  height:80px; background:linear-gradient(90deg,#202020,#2a2a2a,#202020);
  background-size:200%; animation:loading 1.5s infinite; border-radius:12px;
}
@keyframes loading { 0% { background-position:200% 0; } 100% { background-position:-200% 0; } }
</style>
</head>
<body>

<header>
  <h2>Mini Tunes</h2>
  <div style="display:flex; align-items:center; gap:16px;">
    <div id="premium-btn">Premium</div>
    <div id="profile-btn">?</div>
  </div>
</header>

<div id="sidebar">
  <div id="home-nav" class="nav-item active">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" fill="currentColor"/></svg>
    <span>Home</span>
  </div>
  <div id="search-nav" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l4.5 4.5a1 1 0 0 1-1.42 1.42l-4.5-4.5v-.79l-.27-.27A6.5 6.5 0 1 1 9.5 3zm0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z" fill="currentColor"/></svg>
    <span>Search</span>
  </div>
  <div class="playlists-header">Your Playlists</div>
</div>

<div id="content">
  <div id="home-page">
    <div id="welcome">Welcome, User</div>

    <div class="section">
      <h3>Recently Played</h3>
      <div id="recently-played"></div>
    </div>

    <div class="section">
      <h3>AI Recommendations</h3>
      <input id="recommend-input" placeholder="Recommend songs like 'Bohemian Rhapsody'..." />
      <div id="ai-recommendations"></div>
    </div>

    <div class="section">
      <h3>Your Playlists</h3>
      <div id="your-playlists"></div>
    </div>
  </div>

  <div id="search-page" style="display:none;">
    <input id="search" placeholder="Search songs, artists..." style="font-size:1.1em; padding:16px; border-radius:12px; margin-bottom:20px;" />
    <div id="popular-section">
      <h3>Popular Right Now</h3>
      <div id="popular"></div>
    </div>
    <h3 id="search-results-title" style="display:none; margin:20px 0 16px;">Search Results</h3>
    <div id="results"></div>
  </div>
</div>

<div id="player">
  <div class="player-inner">
    <img id="player-cover" class="player-cover" src="https://via.placeholder.com/60" />
    <div class="player-info">
      <strong id="player-title">Not playing</strong>
      <span id="player-artist" style="color:#aaa;"></span>
    </div>
    <div class="progress-container"><div id="progress" class="progress"></div></div>
    <audio id="audio" controls></audio>
  </div>
</div>

<!-- Modals -->
<div id="input-modal" class="modal-overlay"><div class="modal-box">...</div></div>
<div id="alert-modal" class="modal-overlay"><div class="modal-box">...</div></div>
<div id="confirm-modal" class="modal-overlay"><div class="modal-box">...</div></div>
<div id="playlist-select-modal" class="modal-overlay"><div class="modal-box">...</div></div>
<input type="file" id="upload-playlist-cover" accept="image/*" style="display:none;">

<script>
// === STATE & STORAGE ===
let userName = localStorage.getItem("userName") || "User";
let recentlyPlayed = JSON.parse(localStorage.getItem("recentlyPlayed") || "[]");
let playlists = JSON.parse(localStorage.getItem("miniPlaylists") || "{}");
let currentPlaylist = null; // {name, index}
let currentSong = null;

const audio = document.getElementById("audio");
const player = document.getElementById("player");
const playerTitle = document.getElementById("player-title");
const playerArtist = document.getElementById("player-artist");
const playerCover = document.getElementById("player-cover");
const progress = document.getElementById("progress");

// === DEEZER HELPER ===
async function deezerFetch(path) {
  const url = `https://api.deezer.com/${path}&output=jsonp`;
  return new Promise(resolve => {
    const cb = "cb" + Math.random().toString(36).substr(2);
    window[cb] = data => { resolve(data.data || data || []); delete window[cb]; };
    const s = document.createElement("script");
    s.src = url + "&callback=" + cb;
    document.body.appendChild(s);
  });
}

// === PLAY SONG (FIXED) ===
function playSong(song, fromPlaylist = false) {
  currentSong = song;
  audio.src = song.preview;
  audio.load();
  
  playerTitle.textContent = song.title;
  playerArtist.textContent = song.artist?.name || "";
  playerCover.src = song.album?.cover_medium || song.cover_medium || "https://via.placeholder.com/60";
  player.style.display = "block";

  audio.play().catch(e => console.log("Play prevented:", e));

  // Highlight current song
  document.querySelectorAll(".song-card").forEach(c => c.classList.remove("playing"));
  const activeCard = document.querySelector(`[data-song-id="${song.id}"]`);
  if (activeCard) activeCard.classList.add("playing");

  // Recently played
  recentlyPlayed = recentlyPlayed.filter(s => s.id !== song.id);
  recentlyPlayed.push(song);
  localStorage.setItem("recentlyPlayed", JSON.stringify(recentlyPlayed.slice(-12)));

  if (fromPlaylist && currentPlaylist) {
    // queue stays active
  } else {
    currentPlaylist = null;
  }

  if (document.getElementById("home-page").style.display === "block") loadHomeContent();
}

// Queue next
audio.onended = () => {
  if (currentPlaylist) {
    const pl = playlists[currentPlaylist.name];
    const nextIdx = currentPlaylist.index + 1;
    if (nextIdx < pl.songs.length) {
      currentPlaylist.index = nextIdx;
      playSong(pl.songs[nextIdx], true);
    } else {
      currentPlaylist = null;
    }
  }
};

// Progress bar
audio.ontimeupdate = () => {
  if (audio.duration) progress.style.width = (audio.currentTime / audio.duration * 100) + "%";
};

// === RENDER SONGS (with data-id) ===
function renderSong(song, container, clickHandler = null) {
  const div = document.createElement("div");
  div.className = "song-card";
  div.dataset.songId = song.id;
  const cover = song.album?.cover_medium || song.cover_medium || "https://via.placeholder.com/64";
  div.innerHTML = `
    <img class="cover" src="${cover}">
    <div class="song-info">
      <strong>${song.title}</strong>
      <small>${song.artist?.name || "Unknown"}</small>
    </div>
  `;
  div.onclick = (e) => {
    e.stopPropagation();
    if (clickHandler) clickHandler(song);
    else playSong(song);
  };
  container.appendChild(div);
}

// === GRID CARD WITH PLAY OVERLAY ===
function renderGridCard(item, container, onClick) {
  const div = document.createElement("div");
  div.className = "grid-card";
  const cover = item.album?.cover_medium || item.cover || "https://via.placeholder.com/180?text=♪";
  const title = item.title || item.name || "Untitled";
  div.innerHTML = `
    <img class="grid-cover" src="${cover}">
    <div class="play-overlay">
      <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>
    </div>
    <div class="grid-title">${title}</div>
  `;
  div.onclick = () => onClick(item);
  container.appendChild(div);
}

// === HOME CONTENT ===
function loadHomeContent() {
  // Recently Played
  const recentDiv = document.getElementById("recently-played");
  recentDiv.innerHTML = "";
  const recent = recentlyPlayed.slice(-12).reverse();
  if (recent.length) {
    const grid = document.createElement("div"); grid.className = "grid-container";
    recent.forEach(s => renderGridCard(s, grid, () => playSong(s)));
    recentDiv.appendChild(grid);
  } else {
    recentDiv.innerHTML = "<p style='color:#666; font-style:italic;'>No songs played yet.</p>";
  }

  // Playlists
  const plDiv = document.getElementById("your-playlists");
  plDiv.innerHTML = "";
  const names = Object.keys(playlists);
  if (names.length) {
    const grid = document.createElement("div"); grid.className = "grid-container";
    names.forEach(name => {
      const pl = playlists[name];
      const fake = { title: name, cover: pl.cover || "https://via.placeholder.com/180?text=♪" };
      renderGridCard(fake, grid, () => loadPlaylist(name));
    });
    plDiv.appendChild(grid);
  } else {
    plDiv.innerHTML = "<p style='color:#666; font-style:italic;'>Create your first playlist!</p>";
  }
}

// === PLAYLIST VIEW ===
function loadPlaylist(name) {
  showSearch();
  document.getElementById("search").style.display = "none";
  document.getElementById("popular-section").style.display = "none";
  document.getElementById("search-results-title").style.display = "none";

  const results = document.getElementById("results");
  results.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
      <h3 style="font-size:2em;">${name}</h3>
      <div style="display:flex; gap:12px;">
        <button class="btn" onclick="sharePlaylist('${playlists[name].id}')">Share</button>
        <button class="btn" onclick="deletePlaylist('${name}')">Delete</button>
      </div>
    </div>
  `;

  const container = document.createElement("div");
  playlists[name].songs.forEach((song, i) => {
    renderSong(song, container, (s) => {
      currentPlaylist = { name, index: i };
      playSong(s, true);
    });
  });
  results.appendChild(container);
}

// === SEARCH & POPULAR (unchanged logic, just better rendering) ===
document.getElementById("search").addEventListener("input", async function() {
  const q = this.value.trim();
  const results = document.getElementById("results");
  results.innerHTML = "";
  document.getElementById("search-results-title").style.display = q ? "block" : "none";
  document.getElementById("popular-section").style.display = q ? "none" : "block";

  if (!q) return;
  results.innerHTML = "<div class='skeleton'></div>".repeat(5);
  const data = await deezerFetch(`search?q=${encodeURIComponent(q)}`);
  results.innerHTML = "";
  data.forEach(s => renderSong(s, results));
});

// Popular on load
(async () => {
  const popular = document.getElementById("popular");
  popular.innerHTML = "<div class='skeleton'></div>".repeat(6);
  const data = await deezerFetch("chart/0/tracks?limit=20");
  popular.innerHTML = "";
  data.forEach(s => renderSong(s, popular));
})();

// === NAVIGATION ===
document.getElementById("home-nav").onclick = () => {
  document.getElementById("home-page").style.display = "block";
  document.getElementById("search-page").style.display = "none";
  document.getElementById("home-nav").classList.add("active");
  document.getElementById("search-nav").classList.remove("active");
  loadHomeContent();
};
function showSearch() {
  document.getElementById("home-page").style.display = "none";
  document.getElementById("search-page").style.display = "block";
  document.getElementById("search").style.display = "block";
  document.getElementById("home-nav").classList.remove("active");
  document.getElementById("search-nav").classList.add("active");
}
document.getElementById("search-nav").onclick = showSearch;

// === PLAYLISTS SIDEBAR (simplified) ===
function renderSidebarPlaylists() {
  const container = document.getElementById("sidebar");
  const existing = container.querySelectorAll(".playlist-item");
  existing.forEach(el => el.remove());

  // + New
  const newBtn = document.createElement("div");
  newBtn.className = "playlist-item";
  newBtn.innerHTML = `<strong style="color:var(--accent);">+ New Playlist</strong>`;
  newBtn.onclick = async () => {
    const name = prompt("Playlist name:");
    if (name) {
      playlists[name] = { id: Math.random().toString(36).substr(2,9), songs: [], cover: null };
      localStorage.setItem("miniPlaylists", JSON.stringify(playlists));
      renderSidebarPlaylists();
      loadHomeContent();
    }
  };
  container.appendChild(newBtn);

  Object.keys(playlists).forEach(name => {
    const pl = playlists[name];
    const div = document.createElement("div");
    div.className = "playlist-item";
    div.innerHTML = `
      <img class="playlist-cover" src="${pl.cover || 'https://via.placeholder.com/44?text=♪'}">
      <strong style="flex:1;">${name}</strong>
      <div class="playlist-actions">
        <button onclick="event.stopPropagation(); editPlaylist('${name}')">Edit</button>
        <button onclick="event.stopPropagation(); sharePlaylist('${pl.id}')">Share</button>
        <button onclick="event.stopPropagation(); deletePlaylist('${name}')">Del</button>
      </div>
    `;
    div.onclick = () => loadPlaylist(name);
    container.appendChild(div);
  });
}
window.editPlaylist = (n) => { /* implement rename if you want */ };
window.sharePlaylist = (id) => navigator.clipboard.writeText(location.origin+location.pathname+"?playlist="+id).then(()=>alert("Link copied!"));
window.deletePlaylist = (name) => { if(confirm("Delete?")) { delete playlists[name]; localStorage.setItem("miniPlaylists", JSON.stringify(playlists)); renderSidebarPlaylists(); loadHomeContent(); }};

// Init
renderSidebarPlaylists();
loadHomeContent();
document.getElementById("welcome").textContent = `Welcome, ${userName}`;
</script>
</body>
</html>
