<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Tunes</title>
<style>
  :root {
    --bg: #0d0d0d;
    --surface: #111;
    --card: #1a1a1a;
    --hover: #222;
    --text: #fff;
    --accent: #7d00ff;
    --accent2: #0044ff;
    --border: #333;
  }
  * { box-sizing: border-box; }
  body {
    margin:0;
    font-family: 'Segoe UI', Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    display:flex;
    height:100vh;
    overflow:hidden;
  }

  /* ---------- 3×2 GRID CARD (recent & playlists) ---------- */
  .grid-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 24px;
  }
  .grid-card {
    background: var(--card);
    border-radius: 16px;
    overflow: hidden;
    cursor: pointer;
    transition: transform .2s, box-shadow .2s;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,.2);
  }
  .grid-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,.3);
  }
  .grid-cover {
    width: 100%;
    height: 180px;
    object-fit: cover;
  }
  .grid-title {
    margin: 10px 8px 0;
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ---------- PLAYLIST HEADER (Name + Share + Delete) ---------- */
  .playlist-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .playlist-header h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
  }
  .playlist-header .btns {
    display: flex;
    gap: 8px;
  }
  .playlist-header button {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
  }
  .playlist-header button:hover {
    background: var(--accent);
    color: #fff;
  }

  /* Header */
  header {
    position:fixed;
    top:0; left:0; width:100%;
    height:70px;
    padding:0 24px;
    background:var(--surface);
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid var(--border);
    z-index:20;
  }
  header h2 {
    margin:0;
    font-size:1.4em;
    font-weight:600;
    background: linear-gradient(90deg, #fff, #ccc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .header-right { display:flex; align-items:center; gap:12px; }
  #premium-btn {
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    padding:8px 18px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
    font-size:0.9em;
    transition:0.2s;
  }
  #premium-btn:hover { transform:scale(1.03); }
  #profile-btn {
    width:36px; height:36px;
    background:#333;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    font-weight:bold;
    font-size:1em;
    transition:0.2s;
    overflow:hidden;
  }
  #profile-btn img {
    width:100%; height:100%; object-fit:cover;
  }
  #profile-btn:hover { background:#444; }

  /* Profile Popup */
  #profile-popup {
    position:fixed; top:80px; right:24px;
    background:var(--card);
    padding:20px;
    border-radius:14px;
    width:300px;
    box-shadow:0 8px 24px rgba(0,0,0,0.4);
    display:none;
    z-index:100;
    border:1px solid var(--border);
  }
  #profile-popup h4 { margin:0 0 8px; font-size:1.1em; }
  #profile-popup p { margin:4px 0; font-size:0.9em; color:#aaa; }
  #profile-avatar {
    width:80px; height:80px; border-radius:50%; margin:0 auto 12px; display:block; object-fit:cover;
  }
  #upload-avatar, #upload-playlist-cover { display:none; }
  .upload-btn {
    background:var(--hover);
    border:none;
    color:var(--text);
    padding:6px 12px;
    border-radius:8px;
    cursor:pointer;
    width:100%;
    margin-top:8px;
    font-size:0.9em;
    text-align:center;
  }
  #bio-input {
    width:100%; height:80px; background:var(--card); border:none; border-radius:8px; color:var(--text); padding:8px; margin-top:8px; resize:none;
  }
  #bio-input:focus { outline:none; box-shadow:0 0 0 2px var(--accent); }

  /* Sidebar */
  #sidebar {
    width:240px;
    background:var(--surface);
    padding-top:90px;
    overflow-y:auto;
    border-right:1px solid var(--border);
    display:flex;
    flex-direction:column;
  }
  .nav-item {
    display:flex;
    align-items:center;
    padding:14px 16px;
    cursor:pointer;
    gap:14px;
    transition:0.2s;
    border-bottom:1px solid var(--border);
    font-weight:500;
  }
  .nav-item:hover { background:var(--hover); }
  .nav-item.active {
    background:var(--hover);
    border-left:3px solid var(--accent);
    padding-left:13px;
  }
  .nav-item svg { width:20px; height:20px; fill: #aaa; }
  .nav-item.active svg { fill: var(--accent); }

  .playlists-header {
    padding:16px 16px 8px;
    font-size:0.9em;
    color:#aaa;
    text-transform:uppercase;
    letter-spacing:0.5px;
    font-weight:600;
  }
  .playlist-item {
    display:flex;
    align-items:center;
    padding:12px 16px;
    cursor:pointer;
    gap:12px;
    transition:0.2s;
    border-bottom:1px solid var(--border);
    position:relative;
    overflow:hidden;
  }
  .playlist-item:hover { background:var(--hover); }
  .playlist-cover { width:42px; height:42px; object-fit:cover; border-radius:50%; }
  .playlist-actions {
    margin-left:auto;
    display:flex;
    gap:6px;
    opacity:0;
    transition:0.2s;
    position:absolute;
    right:16px;
    background:var(--surface);
    padding:0 4px;
    border-radius:8px;
  }
  .playlist-item:hover .playlist-actions { opacity:1; }

  /* Content */
  #content {
    flex:1;
    padding:90px 32px 20px 32px;
    overflow-y:auto;
  }
  .section { margin-bottom:36px; }
  .section h3 { margin:0 0 16px; font-size:1.3em; font-weight:600; color:#eee; }

  .song-card {
    background:var(--card);
    padding:16px;
    border-radius:14px;
    display:flex;
    gap:16px;
    align-items:center;
    transition:0.25s;
    cursor:pointer;
    margin-bottom:14px;
    justify-content:space-between;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
  }
  .song-card:hover {
    background:var(--hover);
    transform:translateY(-2px);
    box-shadow:0 6px 12px rgba(0,0,0,0.3);
  }
  .cover { width:64px; height:64px; object-fit:cover; border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,0.3); }

  /* Player */
  #player {
    position:sticky;
    bottom:0;
    background:var(--surface);
    padding:16px 24px;
    border-top:1px solid var(--border);
    display:none;
    width:100%;
    box-sizing:border-box;
    backdrop-filter: blur(10px);
  }
  #now-playing { margin:0 0 8px; font-weight:500; font-size:0.95em; }

  /* Inputs */
  input, button, textarea { font-family: inherit; }
  input {
    width:100%;
    padding:14px 16px;
    background:var(--card);
    border:none;
    border-radius:12px;
    color:var(--text);
    margin-bottom:20px;
    font-size:1em;
    transition:0.2s;
  }
  input:focus { outline:none; box-shadow:0 0 0 2px var(--accent); }
  button {
    cursor:pointer;
    background:var(--hover);
    color:var(--text);
    border:none;
    padding:8px 16px;
    border-radius:10px;
    margin-left:8px;
    transition:0.2s;
    font-weight:500;
  }
  button:hover { background:#333; }

  /* Skeleton */
  .skeleton {
    height:78px;
    background:linear-gradient(90deg,#202020,#2a2a2a,#202020);
    background-size:200% 100%;
    animation:loading 1.4s infinite;
    border-radius:14px;
    margin-bottom:14px;
  }
  @keyframes loading { 0% { background-position:200% 0; } 100% { background-position:-200% 0; } }

  /* Welcome */
  #welcome {
    font-size:1.8em;
    margin-bottom:24px;
    font-weight:600;
    background: linear-gradient(90deg, #fff, #aaa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* Premium Popup */
  #premium-popup, #profile-popup {
    position:fixed;
    background:var(--card);
    padding:24px;
    border-radius:16px;
    box-shadow:0 12px 32px rgba(0,0,0,0.5);
    z-index:100;
    border:1px solid var(--border);
  }
  #premium-popup {
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    width:340px;
    text-align:center;
    display:none;
  }

  #search-results-title {
    margin: 20px 0 16px;
    font-size: 1.3em;
    font-weight: 600;
    color: #eee;
    display: none;
  }

  /* Welcome Popup */
#welcome-popup {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
}

#welcome-popup .popup-content {
  background: var(--card);
  padding: 30px 24px;
  border-radius: 20px;
  width: 360px;
  text-align: center;
  position: relative;
  box-shadow: 0 12px 32px rgba(0,0,0,0.5);
}

#welcome-popup .close-btn {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 24px;
  cursor: pointer;
  color: #aaa;
  transition: 0.2s;
}
#welcome-popup .close-btn:hover { color: var(--accent); }

#welcome-popup .star {
  font-size: 50px;
  margin-bottom: 16px;
}

#welcome-popup .popup-text {
  font-size: 0.9rem;
  color: #ccc;
  margin-bottom: 20px;
}

#welcome-popup .agree-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: #eee;
  margin-bottom: 16px;
  cursor: pointer;
}

#welcome-popup #agree-btn {
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  color: #fff;
  padding: 10px 20px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.95rem;
  transition: 0.2s;
}

#welcome-popup #agree-btn:disabled {
  opacity: 0.5;
  cursor: default;
}

#welcome-popup #agree-btn:hover:enabled {
  transform: scale(1.05);
}

</style>
</head>
<body>

  <div id="welcome-popup">
  <div class="popup-content">
    <span class="close-btn">&times;</span>
    <div class="star">⭐</div>
    <p class="popup-text">
      Tunes is an experimental feature. By using Mini Tunes, you agree to follow our TOS.<br>
      Competitors may not copy or redistribute this feature.
    </p>
    <label class="agree-label">
      <input type="checkbox" id="agree-checkbox">
      I agree to the terms
    </label>
    <button id="agree-btn" disabled>I Agree</button>
  </div>
</div>

  
<header>
  <h2>Mini Tunes</h2>
  <div class="header-right">
    <div id="premium-btn">Premium</div>
    <div id="profile-btn">?</div>
  </div>
</header>

<div id="profile-popup">
  <img id="profile-avatar" src="https://via.placeholder.com/80" alt="Profile">
  <h4 id="profile-name">User</h4>
  <p>Customize your experience</p>
  <button class="upload-btn" id="change-avatar-btn">Change Avatar</button>
  <input type="file" id="upload-avatar" accept="image/*">
  <textarea id="bio-input" placeholder="Write your bio... (private)"></textarea>
  <button class="upload-btn" id="change-name">Change Name</button>
</div>

<div id="sidebar">
  <div id="home-nav" class="nav-item active">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
    <span>Home</span>
  </div>
  <div id="search-nav" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l4.5 4.5a1 1 0 0 1-1.42 1.42l-4.5-4.5v-.79l-.27-.27A6.5 6.5 0 1 1 9.5 3zm0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
    <span>Search</span>
  </div>
  <div class="playlists-header">Your Playlists</div>
</div>

<div id="content">
  <div id="home-page">
    <div id="welcome">Welcome, User</div>
    <div class="section">
      <h3>Recently Played</h3>
      <div id="recently-played"></div>
    </div>
    <div class="section">
      <h3>AI Recommendations</h3>
      <input id="recommend-input" placeholder="Recommend songs like 'No Me Diga' from In the Heights..." />
      <div id="ai-recommendations"></div>
    </div>
    <div class="section">
      <h3>Your Playlists</h3>
      <div id="your-playlists"></div>
    </div>
  </div>

  <div id="search-page" style="display:none;">
    <input id="search" placeholder="Search for songs, artists, albums..." />
    <div id="popular-section">
      <h3>Popular Right Now</h3>
      <div id="popular"></div>
    </div>
    <h3 id="search-results-title">Search Results</h3>
    <div id="results"></div>
  </div>

  <div id="player">
    <p id="now-playing">Now playing...</p>
    <audio id="audio" controls></audio>
  </div>

  <div id="lyrics-viewer" style="margin-top:24px; padding:16px; background:var(--card); border-radius:12px; display:none;">
    <h4>Lyrics</h4>
    <p id="lyrics-text">Loading lyrics...</p>
  </div>
</div>

<div id="premium-popup">
  <h3>Mini Tunes Premium</h3>
  <p>Only <strong>$1/month</strong>! Get points every clip listened to!</p>
  <button onclick="closePremium()">Close</button>
</div>

<input type="file" id="upload-playlist-cover" accept="image/*" style="display:none;">

<script>
  // DOM Elements
  const premiumBtn = document.getElementById("premium-btn");
  const premiumPopup = document.getElementById("premium-popup");
  const profileBtn = document.getElementById("profile-btn");
  const profilePopup = document.getElementById("profile-popup");
  const profileName = document.getElementById("profile-name");
  const changeNameBtn = document.getElementById("change-name");
  const profileAvatar = document.getElementById("profile-avatar");
  const changeAvatarBtn = document.getElementById("change-avatar-btn");
  const uploadAvatar = document.getElementById("upload-avatar");
  const bioInput = document.getElementById("bio-input");
  const searchInput = document.getElementById("search");
  const results = document.getElementById("results");
  const audio = document.getElementById("audio");
  const player = document.getElementById("player");
  const nowPlaying = document.getElementById("now-playing");
  const sidebar = document.getElementById("sidebar");
  const lyricsViewer = document.getElementById("lyrics-viewer");
  const lyricsText = document.getElementById("lyrics-text");
  const homePage = document.getElementById("home-page");
  const searchPage = document.getElementById("search-page");
  const homeNav = document.getElementById("home-nav");
  const searchNav = document.getElementById("search-nav");
  const welcome = document.getElementById("welcome");
  const recentlyPlayedDiv = document.getElementById("recently-played");
  const aiRecommendations = document.getElementById("ai-recommendations");
  const recommendInput = document.getElementById("recommend-input");
  const yourPlaylists = document.getElementById("your-playlists");
  const popular = document.getElementById("popular");
  const popularSection = document.getElementById("popular-section");
  const searchResultsTitle = document.getElementById("search-results-title");
  const uploadPlaylistCover = document.getElementById("upload-playlist-cover");

  // State
  let userName = localStorage.getItem("userName") || "User";
  let userAvatar = localStorage.getItem("userAvatar") || "https://via.placeholder.com/80";
  let userBio = localStorage.getItem("userBio") || "";
  let recentlyPlayed = JSON.parse(localStorage.getItem("recentlyPlayed") || "[]");
  let playlists = JSON.parse(localStorage.getItem("miniPlaylists") || "{}");
  let currentPlaylist = null; // { name, index }
  let queueFromPlaylist = false;

  // Generate ID
  function generateId() {
    return Math.random().toString(36).substr(2, 9);
  }

  // Migrate old playlists
  function ensurePlaylistIds() {
    let changed = false;
    for (const name in playlists) {
      if (!playlists[name].id) {
        playlists[name].id = generateId();
        changed = true;
      }
    }
    if (changed) savePlaylists();
  }

  // Update Profile
  function updateUserProfile() {
    userName = localStorage.getItem("userName") || "User";
    userAvatar = localStorage.getItem("userAvatar") || "https://via.placeholder.com/80";
    userBio = localStorage.getItem("userBio") || "";
    welcome.innerText = `Welcome, ${userName}`;
    profileName.innerText = userName;
    profileAvatar.src = userAvatar;
    bioInput.value = userBio;
    if (userAvatar !== "https://via.placeholder.com/80") {
      const img = document.createElement('img');
      img.src = userAvatar;
      profileBtn.innerHTML = '';
      profileBtn.appendChild(img);
    } else {
      profileBtn.innerText = userName.charAt(0).toUpperCase();
    }
  }
  updateUserProfile();

  // Bio save
  bioInput.addEventListener('input', () => {
    localStorage.setItem("userBio", bioInput.value);
  });

  // Avatar upload
  changeAvatarBtn.onclick = () => uploadAvatar.click();
  uploadAvatar.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        localStorage.setItem("userAvatar", ev.target.result);
        updateUserProfile();
      };
      reader.readAsDataURL(file);
    }
  });

  // Change name
  changeNameBtn.onclick = () => {
    const newName = prompt("Enter your name:", userName);
    if (newName && newName.trim()) {
      localStorage.setItem("userName", newName.trim());
      updateUserProfile();
      profilePopup.style.display = "none";
    }
  };

  // Popups
  premiumBtn.onclick = () => premiumPopup.style.display = "block";
  function closePremium() { premiumPopup.style.display = "none"; }
  profileBtn.onclick = () => {
    profilePopup.style.display = profilePopup.style.display === "block" ? "none" : "block";
  };
  document.addEventListener("click", (e) => {
    if (!profileBtn.contains(e.target) && !profilePopup.contains(e.target)) profilePopup.style.display = "none";
    if (!premiumBtn.contains(e.target) && !premiumPopup.contains(e.target)) premiumPopup.style.display = "none";
  });

  // Deezer fetch
  async function deezerFetch(path) {
    const url = `https://api.deezer.com/${path}&output=jsonp`;
    return new Promise((resolve) => {
      const callbackName = "dzcb_" + Math.random().toString(36).substring(2);
      window[callbackName] = function (data) {
        resolve(data.data || data || []);
        delete window[callbackName];
        const script = document.querySelector(`script[src^="${url}"]`);
        if (script) script.remove();
      };
      const script = document.createElement("script");
      script.src = `${url}&callback=${callbackName}`;
      document.body.appendChild(script);
    });
  }

  // Search
  let searchTimeout;
  searchInput.addEventListener("input", async () => {
    clearTimeout(searchTimeout);
    const q = searchInput.value.trim();
    showSearch();
    results.innerHTML = "";
    searchResultsTitle.style.display = 'none';
    if (!q) { popularSection.style.display = 'block'; return; }
    popularSection.style.display = 'none';
    searchResultsTitle.style.display = 'block';
    showSkeletons(results, 5);
    searchTimeout = setTimeout(async () => {
      try {
        const songs = await deezerFetch(`search?q=${encodeURIComponent(q)}`);
        results.innerHTML = "";
        if (songs.length === 0) {
          results.innerHTML = "<p style='color:#aaa; text-align:center; padding:20px;'>No results found.</p>";
        } else {
          renderSongs(songs, results);
        }
      } catch (err) {
        results.innerHTML = "<p style='color:#f66; text-align:center;'>Search failed. Try again.</p>";
      }
    }, 400);
  });

  // Popular
  async function loadPopular() {
    popular.innerHTML = "";
    showSkeletons(popular, 5);
    try {
      const songs = await deezerFetch('chart/0/tracks?limit=20');
      renderSongs(songs, popular);
    } catch (err) {
      popular.innerHTML = "<p style='color:#f66;'>Failed to load popular songs.</p>";
    }
  }

  // AI Recommendations
  let recommendTimeout;
  recommendInput.addEventListener("input", async () => {
    clearTimeout(recommendTimeout);
    const q = recommendInput.value.trim();
    aiRecommendations.innerHTML = "";
    if (!q) return;
    showSkeletons(aiRecommendations, 5);
    recommendTimeout = setTimeout(async () => {
      try {
        const searchResults = await deezerFetch(`search/track?q=${encodeURIComponent(q)}&limit=1`);
        if (!searchResults.length) {
          aiRecommendations.innerHTML = "<p style='color:#aaa;'>No song found.</p>";
          return;
        }
        const song = searchResults[0];
        const recommendations = await deezerFetch(`artist/${song.artist.id}/radio?limit=12`);
        aiRecommendations.innerHTML = `<p style='margin-bottom:12px; color:#aaa;'>Songs like <strong>${song.title}</strong>:</p>`;
        renderSongs(recommendations, aiRecommendations);
      } catch (err) {
        aiRecommendations.innerHTML = "<p style='color:#f66;'>Recommendation failed.</p>";
      }
    }, 500);
  });

  // Render song card (for search, popular, AI)
  function renderSongs(songs, container) {
    songs.forEach(song => {
      const div = document.createElement("div");
      div.className = "song-card";
      const artistName = song.artist ? song.artist.name : (song.name || "Unknown");
      const cover = song.album ? song.album.cover_medium : (song.cover_medium || 'https://via.placeholder.com/64');
      div.innerHTML = `
        <div style='display:flex; align-items:center; gap:16px;'>
          <img class="cover" src="${cover}" alt="Cover" />
          <div>
            <strong>${song.title}</strong><br>
            <small style="color:#aaa;">${artistName}</small>
          </div>
        </div>
        <button>Add</button>
      `;
      div.querySelector('button').onclick = (e) => { e.stopPropagation(); addSongToPlaylist(song); };
      div.onclick = () => playSong(song);
      container.appendChild(div);
    });
  }

  function showSkeletons(container, count) {
    for (let i = 0; i < count; i++) {
      const sk = document.createElement("div");
      sk.className = "skeleton";
      container.appendChild(sk);
    }
  }

  // === GRID CARD RENDERER ===
  function renderGridCard(item, container, clickHandler) {
    const div = document.createElement('div');
    div.className = 'grid-card';
    const cover = item.album?.cover_medium || item.cover_medium || 'https://via.placeholder.com/180?text=♪';
    const title = item.title || item.name || 'Untitled';
    div.innerHTML = `
      <img class="grid-cover" src="${cover}" alt="cover">
      <div class="grid-title">${title}</div>
    `;
    div.onclick = () => clickHandler(item);
    container.appendChild(div);
  }

  // === PLAY SONG + QUEUE ===
  function playSong(song, fromPlaylist = false) {
    audio.src = song.preview;
    nowPlaying.innerText = `Now playing: ${song.title} — ${song.artist?.name || ''}`;
    player.style.display = "block";
    audio.play().catch(() => {});

    // Update recently played (max 6)
    recentlyPlayed = recentlyPlayed.filter(s => s.id !== song.id);
    recentlyPlayed.push(song);
    localStorage.setItem("recentlyPlayed", JSON.stringify(recentlyPlayed.slice(-6)));

    if (homePage.style.display === 'block') loadHomeContent();

    // Queue logic
    if (fromPlaylist && currentPlaylist) {
      queueFromPlaylist = true;
    } else {
      queueFromPlaylist = false;
      currentPlaylist = null;
    }
  }

  function startPlaylistPlayback(plName, startIdx = 0) {
    const pl = playlists[plName];
    if (!pl?.songs?.length) return;
    currentPlaylist = { name: plName, index: startIdx };
    playSong(pl.songs[startIdx], true);
  }

  audio.onended = () => {
    if (queueFromPlaylist && currentPlaylist) {
      const pl = playlists[currentPlaylist.name];
      const nextIdx = currentPlaylist.index + 1;
      if (nextIdx < pl.songs.length) {
        currentPlaylist.index = nextIdx;
        playSong(pl.songs[nextIdx], true);
      } else {
        queueFromPlaylist = false;
        currentPlaylist = null;
      }
    }
  };

  // === PLAYLISTS ===
  function savePlaylists() {
    ensurePlaylistIds();
    localStorage.setItem("miniPlaylists", JSON.stringify(playlists));
  }

  function renderSidebarPlaylists() {
  const playlistItems = sidebar.querySelectorAll('.playlist-item');
  playlistItems.forEach(item => item.remove());

  // + New Playlist
  const newBtn = document.createElement('div');
  newBtn.className='playlist-item';
  newBtn.innerHTML='<strong style="color:var(--accent);">+ New Playlist</strong>';
  newBtn.onclick = () => {
    const name = prompt('Playlist name:');
    if (!name?.trim()) return;
    const id = generateId();
    playlists[name] = { id, songs: [], cover: null };
    savePlaylists();
    renderSidebarPlaylists();
    loadHomeContent();
  };
  sidebar.appendChild(newBtn);

  // Existing Playlists
  for (const name in playlists) {
    const pl = playlists[name];
    const cover = pl.cover || 'https://via.placeholder.com/42x42.png?text=♪';
    const div = document.createElement('div');
    div.className='playlist-item';

    // Always show the action buttons (no hover)
    div.innerHTML = `
      <img class='playlist-cover' src='${cover}'/>
      <strong style="flex:1;">${name}</strong>
      <div class="playlist-actions" style="opacity:1; position:static; background:none; padding:0;">
        <button onclick="editPlaylist('${name}')">Edit</button>
        <button onclick="uploadPlaylistCover('${name}')">Cover</button>
        <button onclick="sharePlaylist('${pl.id}')">Share</button>
        <button onclick="deletePlaylist('${name}')">Delete</button>
      </div>
    `;

    // Click on cover or name → open playlist
    div.onclick = (e) => {
      if (!e.target.closest('.playlist-actions')) loadPlaylist(name);
    };
    sidebar.appendChild(div);
  }
}
  window.editPlaylist = function(name) {
    const newName = prompt('Rename playlist:', name);
    if (newName && newName !== name) {
      playlists[newName] = playlists[name];
      delete playlists[name];
      savePlaylists();
      renderSidebarPlaylists();
      loadHomeContent();
    }
  };

  window.sharePlaylist = function(id) {
    const url = `${location.origin}${location.pathname}?playlist=${id}`;
    navigator.clipboard.writeText(url).then(() => {
      alert(`Link copied!\n${url}\nSend to friends!`);
    }).catch(() => {
      prompt(`Copy this link:`, url);
    });
  };

  window.deletePlaylist = function(name) {
    if (confirm(`Delete "${name}"?`)) {
      delete playlists[name];
      savePlaylists();
      renderSidebarPlaylists();
      loadHomeContent();
    }
  };

  function loadPlaylist(name) {
    showSearch();
    searchInput.style.display = 'none';
    popularSection.style.display = 'none';
    searchResultsTitle.style.display = 'none';

    results.innerHTML = `
      <div class="playlist-header">
        <h3>${name}</h3>
        <div class="btns">
          <button onclick="sharePlaylist('${playlists[name].id}')">Share</button>
          <button onclick="deletePlaylist('${name}')">Delete</button>
        </div>
      </div>
    `;

    const songsContainer = document.createElement('div');
    playlists[name].songs.forEach((song, idx) => {
      const div = document.createElement('div');
      div.className = 'song-card';
      div.innerHTML = `
        <img class='cover' src='${song.album.cover_medium}'>
        <div><strong>${song.title}</strong><br><small style="color:#aaa;">${song.artist.name}</small></div>
      `;
      div.onclick = () => startPlaylistPlayback(name, idx);
      songsContainer.appendChild(div);
    });
    results.appendChild(songsContainer);
  }

  function addSongToPlaylist(song) {
    const names = Object.keys(playlists);
    if (!names.length) return alert('Create a playlist first!');
    const pl = prompt(`Add to playlist:\n${names.join(', ')}`, names[0]);
    if (pl && playlists[pl]) {
      playlists[pl].songs.push(song);
      savePlaylists();
      alert(`Added to ${pl}`);
      loadHomeContent();
    }
  }

  window.uploadPlaylistCover = function(playlistName) {
    uploadPlaylistCover.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        playlists[playlistName].cover = ev.target.result;
        savePlaylists();
        renderSidebarPlaylists();
        loadHomeContent();
      };
      reader.readAsDataURL(file);
    };
    uploadPlaylistCover.click();
  };

  // === HOME CONTENT (3x2 grids) ===
  function loadHomeContent() {
    // Recently Played (6 max)
    recentlyPlayedDiv.innerHTML = '';
    const recent = recentlyPlayed.slice(-6).reverse();
    if (recent.length) {
      const grid = document.createElement('div');
      grid.className = 'grid-container';
      recent.forEach(s => renderGridCard(s, grid, playSong));
      recentlyPlayedDiv.appendChild(grid);
    } else {
      recentlyPlayedDiv.innerHTML = '<p style="color:#666; font-style:italic;">No songs played yet.</p>';
    }

    // Your Playlists
    yourPlaylists.innerHTML = '';
    const plNames = Object.keys(playlists);
    if (plNames.length) {
      const grid = document.createElement('div');
      grid.className = 'grid-container';
      plNames.forEach(name => {
        const pl = playlists[name];
        const fakeSong = { title: name, album: { cover_medium: pl.cover || 'https://via.placeholder.com/180?text=♪' } };
        renderGridCard(fakeSong, grid, () => loadPlaylist(name));
      });
      yourPlaylists.appendChild(grid);
    } else {
      yourPlaylists.innerHTML = '<p style="color:#666; font-style:italic;">No playlists yet. Create one!</p>';
    }
  }

  // Navigation
  function showHome() {
    homePage.style.display = 'block';
    searchPage.style.display = 'none';
    homeNav.classList.add('active');
    searchNav.classList.remove('active');
    lyricsViewer.style.display = 'none';
    loadHomeContent();
  }
  function showSearch() {
    homePage.style.display = 'none';
    searchPage.style.display = 'block';
    homeNav.classList.remove('active');
    searchNav.classList.add('active');
    searchInput.style.display = 'block';
    searchResultsTitle.style.display = 'none';
    results.innerHTML = '';
  }
  homeNav.onclick = showHome;
  searchNav.onclick = showSearch;

  // Init
  ensurePlaylistIds();
  renderSidebarPlaylists();
  showHome();
  loadPopular();

  // URL playlist load
  const params = new URLSearchParams(location.search);
  const plId = params.get("playlist");
  if (plId) {
    setTimeout(() => {
      for (const name in playlists) {
        if (playlists[name].id === plId) {
          loadPlaylist(name);
          break;
        }
      }
    }, 500);
  }

// Show welcome popup only if not agreed before
if (!localStorage.getItem("miniTunesAgreed")) {
  const welcomePopup = document.getElementById("welcome-popup");
  const closeBtn = welcomePopup.querySelector(".close-btn");
  const agreeCheckbox = document.getElementById("agree-checkbox");
  const agreeBtn = document.getElementById("agree-btn");

  welcomePopup.style.display = "flex";

  // Close X just hides it temporarily
  closeBtn.onclick = () => welcomePopup.style.display = "none";

  // Enable/disable agree button based on checkbox
  agreeCheckbox.onchange = () => {
    agreeBtn.disabled = !agreeCheckbox.checked;
  };

  // When agreed
  agreeBtn.onclick = () => {
    if (agreeCheckbox.checked) {
      localStorage.setItem("miniTunesAgreed", "true");
      welcomePopup.style.display = "none";
    }
  };
}

  
</script>
</body>
</html>
