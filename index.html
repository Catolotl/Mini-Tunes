<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mini Tunes AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    /* YOUR STYLES — KEPT 99% SAME */
    :root {
      --bg: #0a0a0a;
      --card: #1a1a1a;
      --accent: #6366f1;
      --accent-hover: #7c3aed;
      --text: #ffffff;
      --text-secondary: #a3a3a3;
      --ai-glow: #10b981;
      --premium-gold: #f59e0b;
      --premium-purple: #8b5cf6;
      --border: #262626;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    /* ... [ALL YOUR ORIGINAL STYLES] ... */
    /* (I'm keeping them — just removed for brevity) */
    /* Paste your full <style> block here */
  </style>
</head>
<body>
  <!-- YOUR FULL HTML (modals, header, sidebar, etc.) -->
  <!-- Paste your entire <body> content here -->

<script>
  // === FULL SONGS VIA INVIDIOUS (YOUTUBE) ===
  const INVIDIOUS = "https://yewtu.be";
  const CORS_PROXY = "https://corsproxy.io/?";

  let currentSongs = [];
  let currentIndex = 0;
  let isPlaying = false;
  let currentPlaylist = null;
  let djMode = false;
  let listenHistory = [];
  let currentEditPlaylist = null;
  let playlists = {};

  const audio = document.getElementById("audio");
  const player = document.getElementById("player");
  const playPauseBtn = document.getElementById("play-pause-btn");
  const progress = document.getElementById("progress");
  const lyricsViewer = document.getElementById("lyrics-viewer");
  const results = document.getElementById("results");
  const searchInput = document.getElementById("search");

  // === PROXY FETCH ===
  async function proxyFetch(url) {
    const res = await fetch(CORS_PROXY + encodeURIComponent(url));
    if (!res.ok) throw new Error("Network error");
    return res.json();
  }

  // === SEARCH SONGS (FULL VIDEOS) ===
  async function performSearch(query) {
    try {
      results.innerHTML = `<div class="spinner"></div>`;
      const data = await proxyFetch(`${INVIDIOUS}/api/v1/search?q=${encodeURIComponent(query + " official audio")}&type=video`);
      
      const songs = data.slice(0, 12).map(item => ({
        id: item.videoId,
        title: item.title,
        artist: { name: item.author },
        thumbnailUrl: item.videoThumbnails?.[0]?.url || "https://via.placeholder.com/56",
        duration: item.lengthSeconds
      }));

      displayResults(songs);
    } catch (error) {
      console.error(error);
      results.innerHTML = "<p style='text-align:center; color:#ef4444;'>Search failed. Try again!</p>";
    }
  }

  // === GET FULL AUDIO URL ===
  async function getAudioStream(videoId) {
    const data = await proxyFetch(`${INVIDIOUS}/api/v1/videos/${videoId}`);
    const audio = data.adaptiveFormats?.find(f => f.type.startsWith("audio/"));
    return audio?.url || null;
  }

  // === DISPLAY RESULTS ===
  function displayResults(songs) {
    results.innerHTML = "";
    if (songs.length === 0) {
      results.innerHTML = "<p style='text-align:center; color:#737373;'>No results found</p>";
      return;
    }
    songs.forEach(song => addSongCard(song, () => playSongList([song], 0), false));
  }

  function addSongCard(song, onclick, showRemove) {
    const div = document.createElement("div");
    div.className = "song-card";
    const songStr = JSON.stringify(song).replace(/"/g, '&quot;');
    div.innerHTML = `
      <img class="song-cover" src="${song.thumbnailUrl}" />
      <div style="flex:1;">
        <div style="font-weight:600;">${song.title}</div>
        <div style="color:#a3a3a3; font-size:13px;">${song.artist.name}</div>
      </div>
      <div class="song-actions">
        ${showRemove ?
          `<button onclick="event.stopPropagation(); removeFromPlaylist(${songStr}, '${currentPlaylist}')"><i class="fas fa-trash"></i></button>` :
          `<button onclick="event.stopPropagation(); addToPlaylist(${songStr})"><i class="fas fa-plus"></i></button>`
        }
      </div>
    `;
    div.onclick = onclick;
    results.appendChild(div);
  }

  // === PLAY SONG ===
  async function playCurrentSong() {
    const song = currentSongs[currentIndex];
    if (!song) return;

    const streamUrl = await getAudioStream(song.id);
    if (!streamUrl) {
      alert("Stream not available. Try another song.");
      return;
    }

    audio.src = streamUrl;
    audio.play().catch(() => alert("Playback failed."));
    isPlaying = true;
    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
    document.getElementById("now-playing-title").textContent = song.title;
    document.getElementById("now-playing-artist").textContent = song.artist.name;
    document.getElementById("now-playing-cover").src = song.thumbnailUrl;
    player.style.display = "flex";

    fetchLyrics(song.artist.name, song.title);
  }

  function playSongList(songs, index) {
    currentSongs = songs;
    currentIndex = index;
    playCurrentSong();
  }

  // === CONTROLS ===
  function togglePlayPause() {
    if (isPlaying) { audio.pause(); } else { audio.play(); }
    isPlaying = !isPlaying;
    playPauseBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
  }

  function nextSong() {
    currentIndex = (currentIndex + 1) % currentSongs.length;
    playCurrentSong();
  }

  function prevSong() {
    currentIndex = currentIndex === 0 ? currentSongs.length - 1 : currentIndex - 1;
    playCurrentSong();
  }

  audio.ontimeupdate = () => {
    if (audio.duration) progress.style.width = (audio.currentTime / audio.duration * 100) + "%";
  };

  audio.onended = () => {
    if (currentSongs.length > 1) nextSong();
  };

  // === LYRICS ===
  async function fetchLyrics(artist, title) {
    lyricsViewer.innerHTML = "Loading lyrics...";
    lyricsViewer.style.display = 'block';
    try {
      const res = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`);
      const data = await res.json();
      lyricsViewer.innerHTML = data.lyrics ? data.lyrics.replace(/\n/g, "<br>") : "No lyrics found.";
    } catch {
      lyricsViewer.innerHTML = "Lyrics unavailable.";
    }
  }

  // === SEARCH INPUT ===
  let searchTimeout;
  searchInput.addEventListener("input", () => {
    clearTimeout(searchTimeout);
    const query = searchInput.value.trim();
    if (!query) {
      results.innerHTML = "<p style='text-align:center; color:#737373; margin-top:80px; font-size:16px;'>Type to search for music...</p>";
      return;
    }
    results.innerHTML = `<div class="spinner"></div>`;
    searchTimeout = setTimeout(() => performSearch(query), 500);
  });

  // === INIT ===
  loadProfile();
  renderPlaylists();
  listenHistory = JSON.parse(localStorage.getItem("miniTunes_history") || "[]");
  results.innerHTML = "<p style='text-align:center; color:#737373; margin-top:100px; font-size:16px;'>Search for music to get started</p>";
</script>
</body>
</html>
