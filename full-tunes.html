<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>INDY Music</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
    --bg: #0a0a0a;
    --panel: #1a1a1a;
    --sidebar-bg: #252525;
    --soft: #2a2a2a;
    --hover: #333333;
    --accent: #ffffff;
    --accent-dim: #eaeaea;
    --text: #ffffff;
    --muted: #b3b3b3;
    --glow: rgba(29, 185, 84, .3);
    --gradient-color: #517c7a;
    --border: rgba(255, 255, 255, .08);
    --profile-accent: #6366f1;
}

*{
    box-sizing:border-box;
    margin:0;
    padding:0;
}

body{
    font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
    background:var(--bg);
    color:var(--text);
    overflow:hidden;
    height:100vh;
}

.app-container{
    display:flex;
    height:100vh;
    gap:12px;
    padding:12px;
}

/* LEFT SIDEBAR */
.left-sidebar{
    width:300px;
    display:flex;
    flex-direction:column;
    gap:12px;
    transition:width .3s;
    border:none;
    position: relative;
}

.left-sidebar.minimized{
    width:80px;
}

/* USER PROFILE HEADER */
.user-profile-header {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(99, 102, 241, 0.05) 100%);
    backdrop-filter: blur(20px);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid rgba(99, 102, 241, 0.2);
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.user-profile-header::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.3s;
}

.user-profile-header:hover::before {
    opacity: 1;
}

.user-profile-header:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
}

.profile-avatar-large {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    background-size: cover;
    background-position: center;
    border: 3px solid rgba(99, 102, 241, 0.3);
    flex-shrink: 0;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.user-profile-header:hover .profile-avatar-large {
    transform: scale(1.08);
    border-color: rgba(99, 102, 241, 0.5);
}

.profile-info-large {
    flex: 1;
    min-width: 0;
}

.profile-name-large {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.profile-status {
    font-size: 13px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10b981;
    box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.profile-badge {
    background: rgba(99, 102, 241, 0.2);
    color: #a5b4fc;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.left-sidebar.minimized .user-profile-header {
    flex-direction: column;
    padding: 16px 12px;
    gap: 8px;
}

.left-sidebar.minimized .profile-info-large,
.left-sidebar.minimized .profile-badge {
    display: none;
}

.left-sidebar.minimized .profile-avatar-large {
    width: 48px;
    height: 48px;
}

.sync-status {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    opacity: 0;
    transition: all 0.3s;
}

.user-profile-header:hover .sync-status {
    opacity: 1;
}

/* ACCOUNT SEARCH POPUP */
.account-search-popup {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(30px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    animation: fadeIn 0.3s ease;
}

.account-search-popup.active {
    display: flex;
}

.search-popup-content {
    background: var(--panel);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 24px;
    padding: 48px 40px;
    max-width: 440px;
    width: 90%;
    text-align: center;
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.8);
    animation: popupSlide 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes popupSlide {
    from {
        transform: scale(0.8) translateY(40px);
        opacity: 0;
    }
    to {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}

.search-star {
    font-size: 80px;
    margin-bottom: 24px;
    display: inline-block;
    animation: thinkingSpin 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
    transform-origin: center;
}

@keyframes thinkingSpin {
    0% { transform: rotate(0deg) scale(1); opacity: 0.6; }
    50% { transform: rotate(180deg) scale(1.3); opacity: 1; }
    100% { transform: rotate(360deg) scale(1); opacity: 0.6; }
}

.search-text {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #ffffff 0%, #c0c0c0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.search-subtext {
    font-size: 15px;
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 8px;
}

.search-dots {
    font-size: 24px;
    color: var(--muted);
    letter-spacing: 4px;
    animation: dotPulse 1.5s ease-in-out infinite;
}

@keyframes dotPulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
}

/* PROFILE CONFIRMATION POPUP */
.profile-confirm-content {
    display: none;
}

.profile-confirm-content.active {
    display: block;
}

.found-profile-avatar {
    width: 96px;
    height: 96px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    background-size: cover;
    background-position: center;
    border: 4px solid rgba(99, 102, 241, 0.4);
    margin: 0 auto 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    color: white;
    box-shadow: 0 12px 40px rgba(99, 102, 241, 0.3);
    animation: avatarPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes avatarPop {
    from {
        transform: scale(0);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.found-profile-name {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.found-profile-question {
    font-size: 18px;
    color: var(--text);
    margin-bottom: 32px;
}

.confirm-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.confirm-btn {
    padding: 14px 32px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.confirm-btn.yes {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
}

.confirm-btn.yes:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
}

.confirm-btn.no {
    background: var(--soft);
    color: var(--text);
}

.confirm-btn.no:hover {
    background: var(--hover);
}

/* SYNC NOTIFICATION */
.sync-notification {
    position: fixed;
    top: 24px;
    right: 24px;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 16px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 3000;
    max-width: 360px;
}

.sync-notification.show {
    transform: translateX(0);
    opacity: 1;
}

.sync-notification-icon {
    font-size: 24px;
}

.sync-notification-content {
    flex: 1;
}

.sync-notification-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
}

.sync-notification-message {
    font-size: 13px;
    color: var(--muted);
}

.sidebar-top{
    background:var(--sidebar-bg);
    border-radius:12px;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:16px;
    border:none;
}

.logo{
    font-size:24px;
    font-weight:900;
    color:var(--text);
    letter-spacing:-1px;
    text-align:left;
}

.nav-buttons{
    display:flex;
    flex-direction:column;
    gap:8px;
}

.nav-btn{
    padding:12px 16px;
    background:transparent;
    border:none;
    color:var(--muted);
    border-radius:8px;
    cursor:pointer;
    transition:all .2s;
    display:flex;
    align-items:center;
    gap:12px;
    font-size:15px;
    font-weight:600;
}

.nav-btn:hover{
    background:var(--hover);
    color:var(--text);
}

.nav-btn.active{
    background:var(--soft);
    color:var(--text);
}

.sidebar-library{
    background:var(--sidebar-bg);
    border-radius:12px;
    padding:20px;
    flex:1;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:12px;
}

.library-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:8px;
}

.library-header h3{
    font-size:14px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:1px;
}

.create-playlist-btn{
    background:var(--accent);
    border:none;
    color:#000;
    width:32px;
    height:32px;
    border-radius:50%;
    font-size:20px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .2s;
}

.create-playlist-btn:hover{
    background:var(--accent-dim);
    transform:scale(1.05);
}

.playlist-item{
    padding:12px;
    background:var(--soft);
    border-radius:8px;
    cursor:pointer;
    transition:all .2s;
    display:flex;
    align-items:center;
    gap:12px;
}

.playlist-item:hover{
    background:var(--hover);
}

.playlist-item.active{
    background:var(--accent);
    color:#000;
}

.playlist-icon{
    font-size:24px;
}

.playlist-info{
    flex:1;
    min-width:0;
}

.playlist-name{
    font-size:14px;
    font-weight:600;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

.playlist-count{
    font-size:12px;
    color:var(--muted);
}

.playlist-item.active .playlist-count{
    color:#000;
    opacity:0.7;
}

/* MAIN CONTENT */
.main-content{
    flex:1;
    background:linear-gradient(180deg, var(--gradient-color) 0%, var(--bg) 20%);
    border-radius:12px;
    overflow-y:auto;
    padding:32px;
    transition:background .8s;
}

.section{
    margin-bottom:40px;
}

.section-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:20px;
}

.section-header h2{
    font-size:24px;
    font-weight:700;
}

.scroll-btns{
    display:flex;
    gap:8px;
}

.scroll-btn{
    width:36px;
    height:36px;
    background:rgba(0,0,0,.5);
    border:none;
    border-radius:50%;
    color:var(--text);
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .2s;
}

.scroll-btn:hover{
    background:rgba(0,0,0,.7);
}

/* Recently Played Grid */
.recent-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
    gap:16px;
}

.song-card{
    background:rgba(0,0,0,.3);
    border-radius:8px;
    padding:16px;
    cursor:pointer;
    transition:all .3s;
    display:flex;
    align-items:center;
    gap:12px;
}

.song-card:hover{
    background:rgba(0,0,0,.5);
    transform:translateY(-2px);
}

.song-card img{
    width:56px;
    height:56px;
    border-radius:6px;
    object-fit:cover;
    flex-shrink:0;
}

.song-info{
    flex:1;
    min-width:0;
}

.song-title{
    font-size:14px;
    font-weight:600;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    margin-bottom:4px;
}

.song-artist{
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

/* Horizontal Scroll Sections */
.scroll-container{
    display:flex;
    gap:16px;
    overflow-x:auto;
    padding-bottom:8px;
    scroll-behavior:smooth;
}

.scroll-container::-webkit-scrollbar{
    height:8px;
}

.scroll-container::-webkit-scrollbar-track{
    background:rgba(255,255,255,.05);
    border-radius:4px;
}

.scroll-container::-webkit-scrollbar-thumb{
    background:rgba(255,255,255,.2);
    border-radius:4px;
}

.album-card{
    min-width:180px;
    background:rgba(0,0,0,.3);
    border-radius:8px;
    padding:16px;
    cursor:pointer;
    transition:all .3s;
}

.album-card:hover{
    background:rgba(0,0,0,.5);
    transform:translateY(-4px);
}

.album-card img{
    width:100%;
    aspect-ratio:1;
    border-radius:6px;
    margin-bottom:12px;
}

.album-title{
    font-size:14px;
    font-weight:600;
    margin-bottom:4px;
    overflow:hidden;
    text-overflow:ellipsis;
    display:-webkit-box;
    -webkit-line-clamp:2;
    line-clamp:2;
    -webkit-box-orient:vertical;
}

.album-artist{
    font-size:12px;
    color:var(--muted);
}

/* RIGHT SIDEBAR */
.right-sidebar{
    width:380px;
    background: #000;
    border-radius:12px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    transition:width .3s;
    position: relative; /* ADD THIS - makes absolute children relative to sidebar */
}

.right-sidebar.minimized{
    width:0;
    padding:0;
    overflow: hidden;
}

.video-container{
    position:relative;
    width:100%;
    aspect-ratio:16/9;
    background:#000;
    flex-shrink: 0; /* Prevent video from shrinking */
}

.video-container iframe{
    width:100%;
    height:100%;
    border:none;
}

.video-container::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
        180deg,
        rgba(0, 0, 0, 0.4) 0%,
        rgba(0, 0, 0, 0.3) 40%,
        rgba(0, 0, 0, 0.5) 100%);
    pointer-events: none;
    z-index: 2;
}

.now-playing-info{
    padding:20px;
    position: absolute;
    top: 55%;  /* Changed from 35% to 55% */
    left: 0;
    right: 0;
    transform: translateY(-20%);  /* Changed from -50% to -20% */
    z-index: 3;
    text-align: center;
}

.np-title{
    font-size:18px;
    font-weight:700;
    margin-bottom:4px;
    text-shadow: 0 4px 16px rgba(0, 0, 0, 0.9), 0 2px 4px rgba(0, 0, 0, 0.8);
}

.np-artist{
    font-size:14px;
    color:var(--muted);
    margin-bottom:16px;
    text-shadow: 0 4px 16px rgba(0, 0, 0, 0.9), 0 2px 4px rgba(0, 0, 0, 0.8);
}

.playback-controls{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:16px;
    padding:16px 0;
    position: absolute;
    bottom: 5%;
    left: 0;
    right: 0;
    background: linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.85) 0%,
        rgba(0, 0, 0, 0.5) 70%,
        transparent 100%
    );
    backdrop-filter: blur(16px);
    z-index: 3;
}

.lyrics-section {
    position: absolute !important;
    top: 65% !important; /* Changed from 55% to 65% */
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    padding: 20px !important;
    overflow-y: auto !important;
    z-index: 3 !important;
    background: linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.95) 0%,
        rgba(0, 0, 0, 0.8) 20%,
        transparent 100%
    ) !important;
    margin-top: 0 !important;
}

.lyrics-section h4{
    font-size:16px;
    font-weight:600;
    margin-bottom:16px;
    color:var(--accent);
    text-shadow: 0 4px 16px rgba(0, 0, 0, 0.9), 0 2px 4px rgba(0, 0, 0, 0.8);
}

.lyrics{
    font-size:14px;
    line-height:1.8;
    color:var(--muted);
    white-space:pre-wrap;
    text-shadow: 0 3px 12px rgba(0, 0, 0, 0.95), 0 2px 4px rgba(0, 0, 0, 0.8);
    color: rgba(255, 255, 255, 0.9);
}

.lyrics.loading{
    text-align:center;
    font-style:italic;
    color: rgba(255, 255, 255, 0.5);
}

/* Search View */
.search-view{
    display:none;
}

.search-view.active{
    display:block;
}

.search-header{
    margin-bottom:32px;
}

.search-input{
    width:100%;
    max-width:600px;
    padding:16px 24px;
    background:rgba(0,0,0,.3);
    border:2px solid rgba(255,255,255,.1);
    border-radius:30px;
    color:var(--text);
    font-size:16px;
    transition:all .2s;
}

.search-input:focus{
    outline:none;
    border-color:var(--accent);
    background:rgba(0,0,0,.5);
}

.search-results{
    display:flex;
    flex-direction:column;
    gap:32px;
}

/* Toast Notification */
.toast{
    position:fixed;
    bottom:24px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.95);
    backdrop-filter:blur(10px);
    color:var(--text);
    padding:16px 24px;
    border-radius:8px;
    display:flex;
    align-items:center;
    gap:12px;
    box-shadow:0 8px 32px rgba(0,0,0,.5);
    opacity:0;
    transition:opacity .3s;
    z-index:1000;
    pointer-events:none;
}

.toast.show{
    opacity:1;
}

.toast img{
    width:48px;
    height:48px;
    border-radius:4px;
}

.toast-info{
    flex:1;
    min-width:0;
}

.toast-title{
    font-size:14px;
    font-weight:600;
    margin-bottom:2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

.toast-subtitle{
    font-size:12px;
    color:var(--muted);
}

/* Modal */
.modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.8);
    backdrop-filter:blur(10px);
    z-index:1000;
    align-items:center;
    justify-content:center;
}

.modal.active{
    display:flex;
}

.modal-content{
    background:var(--panel);
    padding:32px;
    border-radius:16px;
    max-width:400px;
    width:90%;
    border:1px solid var(--border);
}

.modal-content h3{
    margin-bottom:24px;
    font-size:24px;
}

.modal-content input{
    width:100%;
    padding:14px;
    border-radius:8px;
    border:1px solid var(--border);
    background:var(--soft);
    color:var(--text);
    font-size:14px;
    margin-bottom:16px;
}

.modal-content input:focus{
    outline:none;
    border-color:var(--accent);
}

.modal-buttons{
    display:flex;
    gap:12px;
}

.modal-buttons button{
    flex:1;
    padding:14px;
    border:none;
    border-radius:8px;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    transition:all .2s;
}

.modal-buttons .primary{
    background:var(--accent);
    color:#000;
}

.modal-buttons .secondary{
    background:var(--soft);
    color:var(--text);
}

.modal-buttons button:hover{
    transform:scale(1.02);
}

/* Scrollbar */
::-webkit-scrollbar{
    width:10px;
}

::-webkit-scrollbar-track{
    background:rgba(255,255,255,.02);
}

::-webkit-scrollbar-thumb{
    background:rgba(255,255,255,.12);
    border-radius:10px;
}

::-webkit-scrollbar-thumb:hover{
    background:rgba(255,255,255,.2);
}

/* Toggle Buttons */
.toggle-sidebar{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    width:24px;
    height:48px;
    background:var(--sidebar-bg);
    border:none;
    color:var(--muted);
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .2s;
    z-index:10;
}

.toggle-sidebar:hover{
    color:var(--text);
    background:var(--soft);
}

.toggle-left{
    right:-24px;
    border-radius:0 8px 8px 0;
}

.toggle-right{
    left:-24px;
    border-radius:8px 0 0 8px;
}

.minimized .toggle-left{
    right:0;
}

.minimized .toggle-right{
    left:0;
}

/* Album/Playlist View */
.album-view, .playlist-view {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.back-btn {
    background: rgba(0,0,0,.3);
    border: none;
    color: var(--text);
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 24px;
    transition: all .2s;
}

.back-btn:hover {
    background: rgba(0,0,0,.5);
}

.album-header, .playlist-header {
    display: flex;
    gap: 24px;
    margin-bottom: 32px;
    align-items: flex-end;
}

.album-cover {
    width: 200px;
    height: 200px;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,.5);
}

.playlist-icon-large {
    width: 200px;
    height: 200px;
    font-size: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.3);
    border-radius: 8px;
}

.album-info, .playlist-info-large {
    flex: 1;
}

.album-info h1, .playlist-info-large h1 {
    font-size: 48px;
    font-weight: 900;
    margin-bottom: 8px;
}

.album-info p, .playlist-info-large p {
    color: var(--muted);
    font-size: 14px;
    margin-bottom: 16px;
}

.play-all-btn {
    background: var(--accent);
    color: #000;
    border: none;
    padding: 14px 32px;
    border-radius: 30px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all .2s;
}

.play-all-btn:hover {
    background: var(--accent-dim);
    transform: scale(1.05);
}

.album-songs, .playlist-songs {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.album-song-item {
    background: rgba(0,0,0,.3);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 16px;
    cursor: pointer;
    transition: all .2s;
}

.album-song-item:hover {
    background: rgba(0,0,0,.5);
}

.song-number {
    color: var(--muted);
    font-size: 16px;
    font-weight: 600;
    min-width: 24px;
}

.album-song-item img {
    width: 48px;
    height: 48px;
    border-radius: 4px;
}

.left-sidebar.minimized .nav-btn span:first-child {
    font-size: 24px;
}

.left-sidebar.minimized .nav-btn {
    justify-content: center;
    padding: 12px;
}

.left-sidebar.minimized .logo {
    font-size: 20px;
}

.add-to-playlist-btn {
    margin-top: 16px;
    padding: 10px 20px;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 30px;
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.add-to-playlist-btn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    border-color: rgba(255,255,255,0.4);
}

@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap');

body {
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
}

.logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -2px;
}
/* Add this to .main-content */
.main-content {
    flex: 1;
    background: linear-gradient(180deg, var(--gradient-color) 0%, var(--bg) 20%);
    border-radius: 12px;
    overflow-y: auto;
    padding: 32px;
    transition: background .8s;
    /* Add these to prevent overlap */
    margin-left: 12px; /* Match the gap in .app-container */
    position: relative; /* Ensure proper stacking */
}
/* Ensure sidebar z-index doesn't interfere with main content */
.left-sidebar {
    z-index: 2;
    position: relative; /* Added to establish stacking context */
}

/* Make sure app-container spacing works properly */
.app-container {
    display: flex;
    height: 100vh;
    gap: 12px;
    padding: 12px;
    overflow: hidden; /* Prevent horizontal scroll */
}
/* Add this to the end of your CSS */
.right-sidebar > * {
    box-sizing: border-box;
}

/* Ensure the right sidebar content stays within bounds */
.right-sidebar .video-container,
.right-sidebar .now-playing-info,
.right-sidebar .playback-controls,
.right-sidebar .lyrics-section {
    position: relative;
    width: 100%;
}
/* ============================================
   RIGHT SIDEBAR FIX (OVERLAY VERSION)
   ============================================ */

/* Make right sidebar a positioning context */
.right-sidebar {
    position: relative !important;
    display: block !important;
    overflow: hidden !important;
}

/* Video container as background layer */
.video-container {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    height: 50% !important;
    aspect-ratio: unset !important;
    flex-shrink: 0 !important;
    margin-top: 0 !important;
    z-index: 1 !important;
}

.video-container::after {
    content: '' !important;
    position: absolute !important;
    inset: 0 !important;
    background: linear-gradient(
        180deg,
        rgba(0, 0, 0, 0.4) 0%,
        rgba(0, 0, 0, 0.3) 40%,
        rgba(0, 0, 0, 0.5) 100%
    ) !important;
    pointer-events: none !important;
    z-index: 2 !important;
}

.now-playing-info {
    position: absolute !important;
    top: 70% !important; /* Position at 45% from top */
    left: 0 !important;
    right: 0 !important;
    transform: translateY(-20%) !important; /* Changed from -50% to -20% */
    padding: 20px !important;
    z-index: 3 !important;
    text-align: left !important;
    background: transparent !important;
    backdrop-filter: none !important;
}

.np-title, .np-artist {
    text-shadow: 0 4px 16px rgba(0, 0, 0, 0.9), 0 2px 4px rgba(0, 0, 0, 0.8) !important;
}

.lyrics-section {
    position: absolute !important;
    top: 55% !important; /* Changed from 50% to 55% to make room for title/artist */
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    padding: 20px !important;
    overflow-y: auto !important;
    z-index: 3 !important;
    background: linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.95) 0%,
        rgba(0, 0, 0, 0.8) 20%,
        transparent 100%
    ) !important;
    margin-top: 0 !important;
}

.lyrics-section h4, .lyrics {
    text-shadow: 0 4px 16px rgba(0, 0, 0, 0.9), 0 2px 4px rgba(0, 0, 0, 0.8) !important;
}

/* Playback controls - bottom over video */
.playback-controls {
    position: absolute !important;
    bottom: 5% !important;
    left: 0 !important;
    right: 0 !important;
    padding: 16px 0 !important;
    background: linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.85) 0%,
        rgba(0, 0, 0, 0.5) 70%,
        transparent 100%
    ) !important;
    backdrop-filter: blur(16px) !important;
    z-index: 3 !important;
}

/* Control buttons styling */
.control-btn {
    background: rgba(255, 255, 255, 0.2) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.3) !important;
}

.control-btn.play {
    background: rgba(255, 255, 255, 0.95) !important;
    color: #000 !important;
    border: none !important;
}

.control-btn.play:hover {
    background: rgba(255, 255, 255, 1) !important;
    transform: scale(1.05) !important;
}

/* Add to playlist button */
.add-to-playlist-btn {
    margin-top: 16px !important;
    padding: 10px 20px !important;
    background: rgba(255, 255, 255, 0.12) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 30px !important;
    color: var(--text) !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    backdrop-filter: blur(10px) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.add-to-playlist-btn:hover {
    background: rgba(255, 255, 255, 0.25) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
    border-color: rgba(255, 255, 255, 0.4) !important;
}

.add-to-playlist-btn {
    margin-top: 16px !important;
    margin-bottom: 8px !important; /* Add bottom margin */
    padding: 10px 20px !important;
    background: rgba(255, 255, 255, 0.12) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 30px !important;
    color: var(--text) !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    backdrop-filter: blur(10px) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.add-to-playlist-btn:hover {
    background: rgba(255, 255, 255, 0.25) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
    border-color: rgba(255, 255, 255, 0.4) !important;
}

/* Lyrics text styling */
.lyrics {
    font-size: 14px !important;
    line-height: 1.8 !important;
    color: var(--muted) !important;
    white-space: pre-wrap !important;
    text-shadow: 0 3px 12px rgba(0, 0, 0, 0.95), 0 2px 4px rgba(0, 0, 0, 0.8) !important;
    color: rgba(255, 255, 255, 0.9) !important;
}

.lyrics.loading {
    text-align: center !important;
    font-style: italic !important;
    color: rgba(255, 255, 255, 0.5) !important;
}
</style>
</head>
<body>

<div class="app-container">
    <!-- LEFT SIDEBAR -->
    <aside class="left-sidebar" id="leftSidebar">
        <!-- User Profile Header -->
        <div class="user-profile-header" id="userProfileHeader" onclick="linkIndy()">
            <div class="profile-avatar-large" id="profileAvatarLarge">‚ú¶</div>
            <div class="profile-info-large">
                <div class="profile-name-large" id="profileNameLarge">Guest</div>
                <div class="profile-status">
                    <span class="status-dot" id="statusDot" style="background: #ef4444;"></span>
                    <span id="profileStatusText">Not linked</span>
                </div>
            </div>
            <div class="profile-badge" id="profileBadge" style="display: none;">INDY+</div>
            <div class="sync-status" id="syncStatus">üîó</div>
        </div>

        <div class="sidebar-top">
            <div class="nav-buttons">
                <button class="nav-btn active" id="homeBtn" onclick="showHome()">
                    <span>‚åÇ</span> Home
                </button>
                <button class="nav-btn" id="searchBtn" onclick="showSearch()">
                    <span>‚åï</span> Search
                </button>
            </div>
        </div>
        
        <div class="sidebar-library">
            <div class="library-header">
                <h3>Your Library</h3>
                <button class="create-playlist-btn" onclick="openCreateModal()">+</button>
            </div>
            
            <div class="playlist-item" onclick="viewLikedSongs()">
                <span class="playlist-icon">‚ù§Ô∏è</span>
                <div class="playlist-info">
                    <div class="playlist-name">Liked Songs</div>
                    <div class="playlist-count" id="likedCount">0 songs</div>
                </div>
            </div>
            
            <div id="playlistsList"></div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content" id="mainContent">
        <!-- HOME VIEW -->
        <div id="homeView">
            <div class="section">
                <div class="section-header">
                    <h2>Recently Played</h2>
                </div>
                <div class="recent-grid" id="recentGrid"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Recommended Albums</h2>
                </div>
                <div class="scroll-container" id="albumsScroll"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>‚ú¶ Recommended Mixes</h2>
                </div>
                <div class="scroll-container" id="mixesScroll"></div>
            </div>
        </div>

        <!-- SEARCH VIEW -->
        <div class="search-view" id="searchView">
            <div class="search-header">
                <input type="text" class="search-input" id="searchInput" placeholder="Listen to anything!">
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
    </main>

<!-- RIGHT SIDEBAR -->
<aside class="right-sidebar" id="rightSidebar">
    <div class="video-container">
        <iframe id="player" allow="autoplay; encrypted-media"></iframe>
        
        <div class="now-playing-info">
            <div class="np-title" id="npTitle">Start playing a song</div>
            <div class="np-artist" id="npArtist"></div>
            
            <button id="addToPlaylistBtn" class="add-to-playlist-btn" style="display:none;">
                <span style="font-size:18px;">+</span> Add to Playlist
            </button>
        </div>
    </div>
    
    <div class="lyrics-section">
        <h4>Lyrics</h4>
        <div class="lyrics loading" id="lyrics">Play a song to view lyrics...</div>
    </div>
</aside>
</div>

<!-- Account Search Popup -->
<div class="account-search-popup" id="accountSearchPopup">
    <div class="search-popup-content">
        <!-- Searching State -->
        <div id="searchingState">
            <div class="search-star">‚ú¶</div>
            <div class="search-text">Searching for user</div>
            <div class="search-subtext">Looking through the INDY network...</div>
            <div class="search-dots">...</div>
        </div>
        
        <!-- Profile Confirmation State -->
        <div class="profile-confirm-content" id="confirmState">
            <div class="found-profile-avatar" id="foundAvatar">‚ú¶</div>
            <div class="found-profile-name" id="foundName">John Doe</div>
            <div class="found-profile-question">Is this you?</div>
            <div class="confirm-actions">
                <button class="confirm-btn no" onclick="cancelLink()">No</button>
                <button class="confirm-btn yes" onclick="confirmLink()">Yes, that's me!</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <img id="toastImg" src="" alt="">
    <div class="toast-info">
        <div class="toast-title" id="toastTitle"></div>
        <div class="toast-subtitle" id="toastSubtitle">Now Playing</div>
    </div>
</div>

<!-- Sync Notification -->
<div class="sync-notification" id="syncNotification">
    <div class="sync-notification-icon">‚úì</div>
    <div class="sync-notification-content">
        <div class="sync-notification-title" id="syncNotifTitle">Synced!</div>
        <div class="sync-notification-message" id="syncNotifMessage">Your music is up to date</div>
    </div>
</div>

<!-- Create Playlist Modal -->
<div class="modal" id="createModal">
    <div class="modal-content">
        <h3>Create Playlist</h3>
        <input type="text" id="playlistNameInput" placeholder="Playlist name">
        <input type="text" id="playlistEmojiInput" placeholder="Emoji (e.g. üéµ)" maxlength="2">
        <div class="modal-buttons">
            <button class="secondary" onclick="closeCreateModal()">Cancel</button>
            <button class="primary" onclick="createPlaylist()">Create</button>
        </div>
    </div>
</div>

<script>
const API_KEY = "AIzaSyDNd7dwB1rZEpJzpyRrVZQwSKHvnt3Q7vQ";

function getNextKey() {
    return API_KEY;
}

if (!window.YT) {
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const first = document.getElementsByTagName('script')[0];
    first.parentNode.insertBefore(tag, first);
}

window.onYouTubeIframeAPIReady = function() {
    console.log('YouTube IFrame API fully ready');
    window.ytPlayer = new YT.Player('player', {
        events: {
            'onReady': () => console.log('Player ready'),
            'onStateChange': onPlayerStateChange,
            'onError': (e) => console.error('YT Player error:', e.data)
        }
    });
};

// Storage
function save(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
        console.error("Storage error:", e);
    }
}

function load(key, def) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : def;
    } catch (e) {
        return def;
    }
}

const CACHE_TTL = 24 * 60 * 60 * 1000;

function cachedFetch(url, cacheKey, maxAge = CACHE_TTL) {
    const cached = load(cacheKey, null);
    if (cached && Date.now() - cached.timestamp < maxAge) {
        console.log(`Cache hit: ${cacheKey}`);
        return Promise.resolve(cached.data);
    }

    return fetch(url)
        .then(r => {
            if (!r.ok) throw new Error(r.status);
            return r.json();
        })
        .then(data => {
            save(cacheKey, { timestamp: Date.now(), data });
            return data;
        })
        .catch(err => {
            console.warn("Fetch failed, using stale cache if available", err);
            return cached ? cached.data : null;
        });
}

// State
let recent = load("recent", []);
let playlists = load("playlists", {});
let liked = load("liked", []);
let currentPlaylist = null;
let currentSongs = [];
let currentIndex = -1;
let ytPlayer = null;
let searchTimeout = null;
let lastPlayedVideoId = null;
let currentPlayingSong = null;

// Initialize
renderRecent();
renderPlaylists();
renderAlbums();
renderMixes();
updateLikedCount();

let playerReady = false;
let pendingVideo = null;

function initPlayer(videoId) {
    if (!window.YT || !window.YT.Player) {
        console.log('API not ready yet ‚Äî will try again soon');
        pendingVideo = videoId;
        return;
    }

    if (!ytPlayer || !ytPlayer.loadVideoById) {
        console.log('Creating new YT.Player instance');
        ytPlayer = new YT.Player('player', {
            height: '100%',
            width: '100%',
            videoId: videoId,
            playerVars: {
                autoplay: 1,
                enablejsapi: 1,
                rel: 0,
                modestbranding: 1,
                origin: window.location.origin
            },
            events: {
                onReady: (e) => {
                    console.log('Player is ready ‚Äî should start playing');
                    playerReady = true;
                },
                onStateChange: onPlayerStateChange,
                onError: (e) => {
                    console.error('YouTube Player error:', e.data);
                }
            }
        });
    } else {
        console.log('Loading video into existing player');
        ytPlayer.loadVideoById(videoId);
    }
}

function onPlayerStateChange(event) {
    if (event.data === window.YT.PlayerState.ENDED) {
        skipToNext();
    }
}

function showHome() {
    const mainContent = document.getElementById('mainContent');
    const searchView = document.getElementById('searchView');
    const homeBtn = document.getElementById('homeBtn');
    const searchBtn = document.getElementById('searchBtn');
    
    mainContent.innerHTML = `
        <div id="homeView">
            <div class="section">
                <div class="section-header">
                    <h2>Recently Played</h2>
                </div>
                <div class="recent-grid" id="recentGrid"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Recommended Albums</h2>
                </div>
                <div class="scroll-container" id="albumsScroll"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>‚ú¶ Recommended Mixes</h2>
                </div>
                <div class="scroll-container" id="mixesScroll"></div>
            </div>
        </div>
        
        <div class="search-view" id="searchView">
            <div class="search-header">
                <input type="text" class="search-input" id="searchInput" placeholder="What do you want to listen to?">
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
    `;
    
    if (searchView) searchView.classList.remove('active');
    if (homeBtn) homeBtn.classList.add('active');
    if (searchBtn) searchBtn.classList.remove('active');
    
    renderRecent();
    renderAlbums();
    renderMixes();
    
    document.getElementById('searchInput').oninput = async (e) => {
        clearTimeout(searchTimeout);
        const q = e.target.value.trim();
        
        if (!q) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            try {
                const [videos, playlists] = await Promise.all([
                    fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=10&q=${encodeURIComponent(q)}&key=${getNextKey()}`).then(r => r.json()),
                    fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=playlist&maxResults=4&q=${encodeURIComponent(q + ' album')}&key=${getNextKey()}`).then(r => r.json())
                ]);
                
                renderSearchResults(videos, playlists);
            } catch (error) {
                console.error("Search error:", error);
            }
        }, 300);
    };
}

function showSearch() {
    document.getElementById('homeView').style.display = 'none';
    document.getElementById('searchView').classList.add('active');
    document.getElementById('homeBtn').classList.remove('active');
    document.getElementById('searchBtn').classList.add('active');
    
    const searchInput = document.getElementById('searchInput');
    searchInput.focus();
    
    searchInput.oninput = (e) => {
        clearTimeout(searchTimeout);
        const q = e.target.value.trim();

        if (q.length < 3) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            try {
                const [videos, playlists] = await Promise.all([
                    fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=10&q=${encodeURIComponent(q)}&key=${getNextKey()}`).then(r => r.json()),
                    fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=playlist&maxResults=4&q=${encodeURIComponent(q + ' album')}&key=${getNextKey()}`).then(r => r.json())
                ]);
                
                renderSearchResults(videos, playlists);
            } catch (error) {
                console.error("Search error:", error);
            }
        }, 300);
    };
}

function toggleLeftSidebar() {
    document.getElementById('leftSidebar').classList.toggle('minimized');
}

function toggleRightSidebar() {
    document.getElementById('rightSidebar').classList.toggle('minimized');
}

function renderSearchResults(videos, playlists) {
    const container = document.getElementById('searchResults');
    container.innerHTML = '';
    
    if (playlists.items && playlists.items.length > 0) {
        const albumSection = document.createElement('div');
        albumSection.className = 'section';
        albumSection.innerHTML = `
            <div class="section-header"><h2>Albums</h2></div>
            <div class="scroll-container"></div>
        `;
        
        const scrollContainer = albumSection.querySelector('.scroll-container');
        playlists.items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'album-card';
            div.innerHTML = `
                <img src="${item.snippet.thumbnails.medium.url}">
                <div class="album-title">${escapeHtml(item.snippet.title)}</div>
                <div class="album-artist">${escapeHtml(item.snippet.channelTitle)}</div>
            `;
            div.onclick = () => playPlaylist(item.id.playlistId, true);
            scrollContainer.appendChild(div);
        });
        
        container.appendChild(albumSection);
    }
    
    if (videos.items && videos.items.length > 0) {
        const songSection = document.createElement('div');
        songSection.className = 'section';
        songSection.innerHTML = `
            <div class="section-header"><h2>Songs</h2></div>
            <div class="recent-grid"></div>
        `;
        
        const grid = songSection.querySelector('.recent-grid');
        videos.items.forEach(item => {
            const song = {
                id: item.id.videoId,
                title: item.snippet.title,
                artist: item.snippet.channelTitle,
                art: item.snippet.thumbnails.medium.url
            };
            
            const div = document.createElement('div');
            div.className = 'song-card';
            div.innerHTML = `
                <img src="${song.art}">
                <div class="song-info">
                    <div class="song-title">${escapeHtml(song.title)}</div>
                    <div class="song-artist">${escapeHtml(song.artist)}</div>
                </div>
                <button onclick="event.stopPropagation(); showAddToPlaylistMenu(${JSON.stringify(song).replace(/"/g, '&quot;')})" style="background:var(--accent);color:#000;border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;flex-shrink:0;">+</button>
            `;
            div.onclick = () => playSong(song);
            grid.appendChild(div);
        });
        
        container.appendChild(songSection);
    }
}

async function playPlaylist(playlistId, isAlbum = false) {
    try {
        const response = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${getNextKey()}`);
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
            currentSongs = data.items.map(item => ({
                id: item.snippet.resourceId.videoId,
                title: item.snippet.title,
                artist: item.snippet.channelTitle,
                art: item.snippet.thumbnails.medium.url
            })).filter(song => song.id && song.title !== 'Private video' && song.title !== 'Deleted video');
            
            currentIndex = 0;
            currentPlaylist = null;
            
            if (isAlbum) {
                const playlistResponse = await fetch(`https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${playlistId}&key=${getNextKey()}`);
                const playlistData = await playlistResponse.json();
                const albumName = playlistData.items?.[0]?.snippet?.title || data.items[0].snippet.channelTitle;
                
                showAlbumView(currentSongs, albumName);
            } else {
                playSong(currentSongs[0]);
            }
        }
    } catch (error) {
        console.error("Playlist error:", error);
    }
}

function showAlbumView(songs, albumName) {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="album-view">
            <button class="back-btn" onclick="showHome()">‚Üê Back</button>
            <div class="album-header">
                <img src="${songs[0].art}" class="album-cover">
                <div class="album-info">
                    <h1>${escapeHtml(albumName)}</h1>
                    <p>${songs.length} songs</p>
                    <button class="play-all-btn" onclick="playSong(currentSongs[0])">‚ñ∂ Play All</button>
                </div>
            </div>
            <div class="album-songs" id="albumSongsList"></div>
        </div>
    `;
    
    const songsList = document.getElementById('albumSongsList');
    songs.forEach((song, i) => {
        const div = document.createElement('div');
        div.className = 'album-song-item';
        div.innerHTML = `
            <span class="song-number">${i + 1}</span>
            <img src="${song.art}">
            <div class="song-info">
                <div class="song-title">${escapeHtml(song.title)}</div>
                <div class="song-artist">${escapeHtml(song.artist)}</div>
            </div>
        `;
        div.onclick = () => {
            currentIndex = i;
            playSong(song);
        };
        songsList.appendChild(div);
    });
}

function playSong(song, fromPlaylist = null) {
    if (lastPlayedVideoId === song.id) {
        console.log("Already playing this exact video ‚Äî skipping duplicate call");
        return;
    }
    lastPlayedVideoId = song.id;

    if (fromPlaylist) {
        currentPlaylist = fromPlaylist;
        currentSongs = playlists[fromPlaylist].songs;
        currentIndex = currentSongs.findIndex(s => s.id === song.id);
        if (currentIndex === -1) currentIndex = 0;
    } else {
        const idx = currentSongs.findIndex(s => s.id === song.id);
        if (idx !== -1) currentIndex = idx;
    }

    document.getElementById('npTitle').textContent = song.title || "Unknown Title";
    document.getElementById('npArtist').textContent = song.artist || "Unknown Artist";

    addToRecent(song);
    if (song.art) updateGradient(song.art);
    fetchLyrics(song.title, song.artist);
    showToast(song);

    const params = new URLSearchParams({
        autoplay: 1,
        enablejsapi: 1,
        origin: window.location.origin,
        rel: 0,
        modestbranding: 1,
        showinfo: 0,
        iv_load_policy: 3,
        playsinline: 1,
        fs: 1
    });

    const embedUrl = `https://www.youtube.com/embed/${song.id}?${params.toString()}`;

    if (window.ytPlayer && typeof window.ytPlayer.loadVideoById === 'function') {
        try {
            window.ytPlayer.loadVideoById({
                videoId: song.id,
                startSeconds: 0
            });
            console.log(`Playing "${song.title}" via ytPlayer.loadVideoById`);
        } catch (err) {
            console.error("loadVideoById failed:", err);
            document.getElementById('player').src = embedUrl;
            console.log(`Fallback: set iframe src directly`);
        }
    } else {
        document.getElementById('player').src = embedUrl;
        console.log(`Playing "${song.title}" via direct iframe src (API not ready)`);
    }

    const playerEl = document.getElementById('player');
    if (playerEl) playerEl.focus?.();
    
    currentPlayingSong = { ...song };
    const btn = document.getElementById('addToPlaylistBtn');
    if (btn) {
        btn.style.display = 'flex';
    }
    
    const rightSidebar = document.getElementById('rightSidebar');
    if (rightSidebar && rightSidebar.classList.contains('minimized')) {
        rightSidebar.classList.remove('minimized');
    }
}

function skipToNext() {
    if (currentIndex < currentSongs.length - 1) {
        currentIndex++;
        playSong(currentSongs[currentIndex]);
    }
}

function skipToPrevious() {
    if (currentIndex > 0) {
        currentIndex--;
        playSong(currentSongs[currentIndex]);
    }
}

function togglePlay() {
    // Will be implemented with YouTube API
}

function showToast(song) {
    const toast = document.getElementById('toast');
    document.getElementById('toastImg').src = song.art;
    document.getElementById('toastTitle').textContent = song.title;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 5000);
}

function addToRecent(song) {
    recent = recent.filter(s => s.id !== song.id);
    recent.unshift(song);
    recent = recent.slice(0, 8);
    save("recent", recent);
    renderRecent();
}

function renderRecent() {
    const recentDiv = document.getElementById('recentGrid');
    if (!recentDiv) return;

    recentDiv.innerHTML = '';

    if (recent.length === 0) {
        recentDiv.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);grid-column:1/-1">No recent songs yet</div>';
        return;
    }

    recent.forEach(song => {
        const div = document.createElement('div');
        div.className = 'song-card';
        div.innerHTML = `
            <img src="${song.art}">
            <div class="song-info">
                <div class="song-title">${escapeHtml(song.title)}</div>
                <div class="song-artist">${escapeHtml(song.artist)}</div>
            </div>
        `;
        div.onclick = () => playSong(song);
        recentDiv.appendChild(div);
    });
}

async function renderAlbums() {
    const container = document.getElementById('albumsScroll');
    if (!container) return;
    
    container.innerHTML = '<div style="padding:20px;color:var(--muted);">Loading albums...</div>';
    
    const uniqueArtists = [...new Set(recent.map(s => s.artist))].slice(0, 3);
    
    if (uniqueArtists.length === 0) {
        container.innerHTML = '<div style="padding:20px;color:var(--muted);">Play some songs to see album recommendations</div>';
        return;
    }
    
    try {
        const albumPromises = uniqueArtists.map(artist =>
            cachedFetch(
                `https://www.googleapis.com/youtube/v3/search?part=snippet&type=playlist&maxResults=4&q=${encodeURIComponent(artist + ' album')}&key=${getNextKey()}`,
                `album-cache-${artist.replace(/\W/g,'_')}`
            )
        );
        
        const results = await Promise.all(albumPromises);
        const albums = results.flatMap(data => data.items || []).slice(0, 6);
        
        container.innerHTML = '';
        
        if (albums.length === 0) {
            container.innerHTML = '<div style="padding:20px;color:var(--muted);">No albums found</div>';
            return;
        }
        
        albums.forEach(item => {
            const div = document.createElement('div');
            div.className = 'album-card';
            div.innerHTML = `
                <img src="${item.snippet.thumbnails.medium.url}">
                <div class="album-title">${escapeHtml(item.snippet.title)}</div>
                <div class="album-artist">${escapeHtml(item.snippet.channelTitle)}</div>
            `;
            div.onclick = () => playPlaylist(item.id.playlistId, true);
            container.appendChild(div);
        });
    } catch (error) {
        console.error("Album fetch error:", error);
        container.innerHTML = '<div style="padding:20px;color:var(--muted);">Could not load albums</div>';
    }
}

function renderMixes() {
    const container = document.getElementById('mixesScroll');
    if (!container) return;

    container.innerHTML = '';

    const seeds = recent.slice(0, 6);

    if (seeds.length === 0) {
        container.innerHTML = '<div style="padding:20px;color:var(--muted);">Play some music to get mixes</div>';
        return;
    }

    seeds.forEach(song => {
        const div = document.createElement('div');
        div.className = 'album-card';
        div.innerHTML = `
            <img src="${song.art}">
            <div class="album-title">${escapeHtml(song.title)} Mix</div>
            <div class="album-artist">Based on ${escapeHtml(song.artist)}</div>
        `;
        div.onclick = () => openMix(song);
        container.appendChild(div);
    });
}

async function openMix(seedSong) {
    const songs = await generateMix(seedSong);

    if (songs.length === 0) {
        showNotification("Couldn't generate mix");
        return;
    }

    currentSongs = songs;
    currentIndex = 0;
    currentPlaylist = null;

    const mixName = `${seedSong.title} Mix`;

    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="playlist-view">
            <button class="back-btn" onclick="showHome()">‚Üê Back</button>
            <div class="playlist-header">
                <div class="playlist-icon-large">‚ú¶</div>
                <div class="playlist-info-large">
                    <h1>${escapeHtml(mixName)}</h1>
                    <p>${songs.length} songs ¬∑ Recommended</p>
                    <button class="play-all-btn" onclick="playSong(currentSongs[0])">‚ñ∂ Play</button>
                </div>
            </div>
            <div class="playlist-songs" id="mixSongsList"></div>
        </div>
    `;

    const list = document.getElementById('mixSongsList');
    songs.forEach((song, i) => {
        const div = document.createElement('div');
        div.className = 'album-song-item';
        div.innerHTML = `
            <span class="song-number">${i + 1}</span>
            <img src="${song.art}">
            <div class="song-info">
                <div class="song-title">${escapeHtml(song.title)}</div>
                <div class="song-artist">${escapeHtml(song.artist)}</div>
            </div>
        `;
        div.onclick = () => {
            currentIndex = i;
            playSong(song);
        };
        list.appendChild(div);
    });
}

async function generateMix(seedSong) {
    const query = `${seedSong.artist} official audio`;
    
    const res = await fetch(
        `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=15&q=${encodeURIComponent(query)}&key=${getNextKey()}`
    );
    const data = await res.json();

    return (data.items || [])
        .map(item => ({
            id: item.id.videoId,
            title: item.snippet.title,
            artist: item.snippet.channelTitle,
            art: item.snippet.thumbnails.medium.url
        }))
        .filter(song => song.id);
}

function renderPlaylists() {
    const container = document.getElementById('playlistsList');
    container.innerHTML = '';
    
    Object.keys(playlists).forEach(name => {
        const playlist = playlists[name];
        const div = document.createElement('div');
        div.className = 'playlist-item';
        div.innerHTML = `
            <span class="playlist-icon">${playlist.emoji || 'üéµ'}</span>
            <div class="playlist-info">
                <div class="playlist-name">${escapeHtml(name)}</div>
                <div class="playlist-count">${playlist.songs.length} songs</div>
            </div>
        `;
        div.onclick = () => viewPlaylist(name);
        container.appendChild(div);
    });
}

function viewPlaylist(name) {
    currentPlaylist = name;
    currentSongs = playlists[name].songs;
    
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="playlist-view">
            <button class="back-btn" onclick="showHome()">‚Üê Back</button>
            <div class="playlist-header">
                <div class="playlist-icon-large">${playlists[name].emoji || 'üéµ'}</div>
                <div class="playlist-info-large">
                    <h1>${escapeHtml(name)}</h1>
                    <p>${currentSongs.length} songs</p>
                    <div style="display:flex;gap:12px;margin-top:16px;">
                        ${currentSongs.length > 0 ? '<button class="play-all-btn" onclick="currentIndex=0; playSong(currentSongs[0])">‚ñ∂ Play All</button>' : ''}
                        <button onclick="editPlaylist('${escapeHtml(name)}')" style="background:var(--soft);color:var(--text);border:none;padding:14px 24px;border-radius:30px;font-size:14px;font-weight:600;cursor:pointer;">‚úèÔ∏è Edit</button>
                        <button onclick="deletePlaylist('${escapeHtml(name)}')" style="background:rgba(255,0,0,.2);color:var(--text);border:none;padding:14px 24px;border-radius:30px;font-size:14px;font-weight:600;cursor:pointer;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            </div>
            <div class="playlist-songs" id="playlistSongsList"></div>
        </div>
    `;
    
    const songsList = document.getElementById('playlistSongsList');
    if (currentSongs.length === 0) {
        songsList.innerHTML = '<p style="text-align:center; color:var(--muted); padding:40px;">No songs yet. Search and add some!</p>';
    } else {
        currentSongs.forEach((song, i) => {
            const div = document.createElement('div');
            div.className = 'album-song-item';
            div.innerHTML = `
                <span class="song-number">${i + 1}</span>
                <img src="${song.art}">
                <div class="song-info">
                    <div class="song-title">${escapeHtml(song.title)}</div>
                    <div class="song-artist">${escapeHtml(song.artist)}</div>
                </div>
                <button onclick="event.stopPropagation(); removeSongFromPlaylist('${escapeHtml(name)}', '${song.id}')" style="background:rgba(255,0,0,.2);color:var(--text);border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px;margin-left:auto;">√ó</button>
            `;
            div.onclick = () => {
                currentIndex = i;
                playSong(song);
            };
            songsList.appendChild(div);
        });
    }
}

function viewLikedSongs() {
    currentSongs = liked;
    currentIndex = 0;
    currentPlaylist = null;
    
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="playlist-view">
            <button class="back-btn" onclick="showHome()">‚Üê Back</button>
            <div class="playlist-header">
                <div class="playlist-icon-large">‚ù§Ô∏è</div>
                <div class="playlist-info-large">
                    <h1>Liked Songs</h1>
                    <p>${currentSongs.length} songs</p>
                    ${currentSongs.length > 0 ? '<button class="play-all-btn" onclick="currentIndex=0; playSong(currentSongs[0])">‚ñ∂ Play All</button>' : ''}
                </div>
            </div>
            <div class="playlist-songs" id="likedSongsList"></div>
        </div>
    `;
    
    const songsList = document.getElementById('likedSongsList');
    if (currentSongs.length === 0) {
        songsList.innerHTML = '<p style="text-align:center; color:var(--muted); padding:40px;">No liked songs yet</p>';
    } else {
        currentSongs.forEach((song, i) => {
            const div = document.createElement('div');
            div.className = 'album-song-item';
            div.innerHTML = `
                <span class="song-number">${i + 1}</span>
                <img src="${song.art}">
                <div class="song-info">
                    <div class="song-title">${escapeHtml(song.title)}</div>
                    <div class="song-artist">${escapeHtml(song.artist)}</div>
                </div>
            `;
            div.onclick = () => {
                currentIndex = i;
                playSong(song);
            };
            songsList.appendChild(div);
        });
    }
}

function updateLikedCount() {
    document.getElementById('likedCount').textContent = `${liked.length} songs`;
}

function updateGradient(imageUrl) {
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.src = imageUrl;
    
    img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 1;
        canvas.height = 1;
        ctx.drawImage(img, 0, 0, 1, 1);
        const data = ctx.getImageData(0, 0, 1, 1).data;
        const color = `rgb(${data[0]}, ${data[1]}, ${data[2]})`;
        document.documentElement.style.setProperty('--gradient-color', color);
    };
}

async function fetchLyrics(title, artist) {
    const lyricsDiv = document.getElementById('lyrics');
    lyricsDiv.className = 'lyrics loading';
    lyricsDiv.textContent = 'Loading lyrics...';
    
    try {
        const cleanTitle = title.split('(')[0].split('[')[0].split('|')[0].trim();
        const cleanArtist = artist.split('-')[0].split('(')[0].trim();
        
        const response = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(cleanArtist)}/${encodeURIComponent(cleanTitle)}`);
        const data = await response.json();
        
        if (data.lyrics) {
            lyricsDiv.className = 'lyrics';
            lyricsDiv.textContent = data.lyrics;
        } else {
            lyricsDiv.className = 'lyrics loading';
            lyricsDiv.textContent = 'Lyrics not available';
        }
    } catch (error) {
        lyricsDiv.className = 'lyrics loading';
        lyricsDiv.textContent = 'Could not load lyrics';
    }
}

function openCreateModal() {
    document.getElementById('createModal').classList.add('active');
    document.getElementById('playlistNameInput').focus();
}

function closeCreateModal() {
    document.getElementById('createModal').classList.remove('active');
    document.getElementById('playlistNameInput').value = '';
    document.getElementById('playlistEmojiInput').value = '';
}

function createPlaylist() {
    const name = document.getElementById('playlistNameInput').value.trim();
    const emoji = document.getElementById('playlistEmojiInput').value.trim() || 'üéµ';
    
    if (!name) return;
    
    if (playlists[name]) {
        alert('Playlist already exists!');
        return;
    }
    
    playlists[name] = { emoji, songs: [] };
    save('playlists', playlists);
    renderPlaylists();
    closeCreateModal();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function addToPlaylist(song, playlistName) {
    if (!playlists[playlistName]) return;
    
    const exists = playlists[playlistName].songs.some(s => s.id === song.id);
    if (exists) {
        showNotification('Song already in playlist');
        return;
    }
    
    playlists[playlistName].songs.push(song);
    save('playlists', playlists);
    renderPlaylists();
    showNotification(`Added to ${playlistName}`);
}

function showAddToPlaylistMenu(song) {
    const playlistNames = Object.keys(playlists);
    
    if (playlistNames.length === 0) {
        showNotification('Create a playlist first!');
        return;
    }
    
    const menu = document.createElement('div');
    menu.className = 'modal active';
    menu.innerHTML = `
        <div class="modal-content">
            <h3>Add to Playlist</h3>
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;">
                ${playlistNames.map(name => `
                    <div class="playlist-item" onclick="addToPlaylist(${JSON.stringify(song).replace(/"/g, '&quot;')}, '${escapeHtml(name)}'); closeAddMenu()" style="margin-bottom: 8px;">
                        <span class="playlist-icon">${playlists[name].emoji || 'üéµ'}</span>
                        <div class="playlist-info">
                            <div class="playlist-name">${escapeHtml(name)}</div>
                            <div class="playlist-count">${playlists[name].songs.length} songs</div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="modal-buttons">
                <button class="secondary" onclick="closeAddMenu()">Cancel</button>
            </div>
        </div>
    `;
    menu.id = 'addMenu';
    document.body.appendChild(menu);
}

function closeAddMenu() {
    const menu = document.getElementById('addMenu');
    if (menu) menu.remove();
}

function deletePlaylist(name) {
    if (confirm(`Delete playlist "${name}"?`)) {
        delete playlists[name];
        save('playlists', playlists);
        renderPlaylists();
        showHome();
        showNotification('Playlist deleted');
    }
}

function editPlaylist(name) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'editModal';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Edit Playlist</h3>
            <input type="text" id="editPlaylistNameInput" placeholder="Playlist name" value="${escapeHtml(name)}">
            <input type="text" id="editPlaylistEmojiInput" placeholder="Emoji (e.g. üéµ)" maxlength="2" value="${playlists[name].emoji || 'üéµ'}">
            <div class="modal-buttons">
                <button class="secondary" onclick="closeEditModal()">Cancel</button>
                <button class="primary" onclick="savePlaylistEdit('${escapeHtml(name)}')">Save</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeEditModal() {
    const modal = document.getElementById('editModal');
    if (modal) modal.remove();
}

function savePlaylistEdit(oldName) {
    const newName = document.getElementById('editPlaylistNameInput').value.trim();
    const newEmoji = document.getElementById('editPlaylistEmojiInput').value.trim() || 'üéµ';
    
    if (!newName) {
        showNotification('Playlist name cannot be empty');
        return;
    }
    
    if (newName !== oldName && playlists[newName]) {
        showNotification('Playlist name already exists');
        return;
    }
    
    const songs = playlists[oldName].songs;
    delete playlists[oldName];
    playlists[newName] = { emoji: newEmoji, songs: songs };
    
    save('playlists', playlists);
    renderPlaylists();
    closeEditModal();
    showNotification('Playlist updated');
    
    if (currentPlaylist === oldName) {
        viewPlaylist(newName);
    } else {
        showHome();
    }
}

function removeSongFromPlaylist(playlistName, songId) {
    if (!playlists[playlistName]) return;
    
    playlists[playlistName].songs = playlists[playlistName].songs.filter(s => s.id !== songId);
    save('playlists', playlists);
    renderPlaylists();
    viewPlaylist(playlistName);
    showNotification('Song removed');
}

function showNotification(message) {
    const notif = document.createElement('div');
    notif.style.cssText = `
        position: fixed;
        top: 24px;
        right: 24px;
        background: rgba(0,0,0,.95);
        backdrop-filter: blur(10px);
        color: var(--text);
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0,0,0,.5);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    notif.textContent = message;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notif.remove(), 300);
    }, 2000);
}

const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);

function extractYouTubeVideoId(input) {
    if (!input) return null;

    input = input.trim();

    if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;

    const patterns = [
        /(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=))([a-zA-Z0-9_-]{11})/i,
        /youtu\.be\/([a-zA-Z0-9_-]{11})/i,
        /youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/i,
        /(?:v|embed)\/([a-zA-Z0-9_-]{11})/i,
        /[?&]v=([a-zA-Z0-9_-]{11})/i
    ];

    for (const regex of patterns) {
        const match = input.match(regex);
        if (match && match[1]) return match[1];
    }

    return null;
}

async function fetchVideoDetails(videoId, song) {
    if (!videoId) return;

    try {
        const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${getNextKey()}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(res.status);

        const data = await res.json();
        const item = data.items?.[0];

        if (item?.snippet) {
            const realTitle  = item.snippet.title;
            const realArtist = item.snippet.channelTitle;

            if (song) {
                song.title  = realTitle;
                song.artist = realArtist;
            }

            const npTitle  = document.getElementById('npTitle');
            const npArtist = document.getElementById('npArtist');

            if (npTitle)  npTitle.textContent  = realTitle  || "Unknown Title";
            if (npArtist) npArtist.textContent = realArtist || "Unknown Artist";

            const toastTitle = document.getElementById('toastTitle');
            if (toastTitle && toastTitle.textContent.includes("Loading")) {
                toastTitle.textContent = realTitle;
            }

            console.log(`Updated metadata: "${realTitle}" by ${realArtist}`);
        }
    } catch (err) {
        console.warn("Could not fetch video details:", err);
    }
}

function enhanceSearchInput() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput || searchInput.dataset.enhanced) return;

    searchInput.dataset.enhanced = 'true';

    searchInput.oninput = (e) => {
        clearTimeout(searchTimeout);
        const value = e.target.value.trim();

        if (!value) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }

        searchTimeout = setTimeout(async () => {
            const videoId = extractYouTubeVideoId(value);

            if (videoId) {
                e.target.value = '';

                const song = {
                    id: videoId,
                    title: "Loading title...",
                    artist: "YouTube",
                    art: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
                };

                playSong(song);
                showNotification("Playing pasted YouTube video...");
                fetchVideoDetails(videoId, song);

            } else if (value.length >= 3) {
                try {
                    const [videos, playlists] = await Promise.all([
                        fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=10&q=${encodeURIComponent(value)}&key=${getNextKey()}`).then(r => r.json()),
                        fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=playlist&maxResults=4&q=${encodeURIComponent(value + ' album')}&key=${getNextKey()}`).then(r => r.json())
                    ]);

                    renderSearchResults(videos, playlists);
                } catch (error) {
                    console.error("Search error:", error);
                    showNotification("Search failed ‚Äì check console");
                }
            }
        }, 500);
    };

    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            const value = searchInput.value.trim();
            const videoId = extractYouTubeVideoId(value);

            if (videoId) {
                const song = {
                    id: videoId,
                    title: "Loading title...",
                    artist: "YouTube",
                    art: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
                };
                playSong(song);
                searchInput.value = '';
                showNotification("Playing pasted video!");
                fetchVideoDetails(videoId, song);
            }
        }
    });
}

const originalShowSearch = window.showSearch;
window.showSearch = function() {
    originalShowSearch();
    setTimeout(enhanceSearchInput, 150);
};

const originalShowHome = window.showHome;
window.showHome = function() {
    originalShowHome();
    setTimeout(() => {
        if (document.getElementById('searchView')?.classList.contains('active')) {
            enhanceSearchInput();
        }
    }, 150);
};

setTimeout(enhanceSearchInput, 800);

document.addEventListener('click', (e) => {
    if (e.target.id === 'addToPlaylistBtn' || e.target.closest('#addToPlaylistBtn')) {
        if (!currentPlayingSong) {
            showNotification("Nothing playing right now");
            return;
        }
        showAddToPlaylistMenu(currentPlayingSong);
    }
});

(function() {
    const rightSidebar = document.getElementById('rightSidebar');
    if (rightSidebar) {
        rightSidebar.classList.add('minimized');
    }

    const originalPlaySong = window.playSong;
    window.playSong = function(song, fromPlaylist) {
        originalPlaySong.call(this, song, fromPlaylist);
        
        const rightSidebar = document.getElementById('rightSidebar');
        if (rightSidebar && rightSidebar.classList.contains('minimized')) {
            rightSidebar.classList.remove('minimized');
        }
    };
})();

// ============================================
// INDY ACCOUNT INTEGRATION
// ============================================

function linkIndy() {
    const indyProfile = JSON.parse(localStorage.getItem('userProfile')) || { name: '', picture: '' };
    
    if (!indyProfile.name || indyProfile.name.trim() === '') {
        showSyncNotification('‚ö†Ô∏è', 'No INDY Account Found', 'Please set up your profile in INDY Sunrise AI first');
        return;
    }
    
    const popup = document.getElementById('accountSearchPopup');
    const searchingState = document.getElementById('searchingState');
    const confirmState = document.getElementById('confirmState');
    
    searchingState.style.display = 'block';
    confirmState.classList.remove('active');
    
    popup.classList.add('active');
    
    const waitTime = Math.floor(Math.random() * 7000) + 3000;
    
    setTimeout(() => {
        searchingState.style.display = 'none';
        
        const foundAvatar = document.getElementById('foundAvatar');
        const foundName = document.getElementById('foundName');
        
        if (indyProfile.picture && indyProfile.picture.trim()) {
            foundAvatar.style.backgroundImage = `url(${indyProfile.picture})`;
            foundAvatar.textContent = '';
        } else {
            foundAvatar.style.backgroundImage = 'none';
            foundAvatar.textContent = indyProfile.name.charAt(0).toUpperCase();
        }
        
        foundName.textContent = indyProfile.name;
        
        confirmState.classList.add('active');
    }, waitTime);
}

function cancelLink() {
    const popup = document.getElementById('accountSearchPopup');
    popup.classList.remove('active');
    
    setTimeout(() => {
        document.getElementById('searchingState').style.display = 'block';
        document.getElementById('confirmState').classList.remove('active');
    }, 300);
}

function confirmLink() {
    const popup = document.getElementById('accountSearchPopup');
    popup.classList.remove('active');
    const indyProfile = JSON.parse(localStorage.getItem('userProfile')) || { name: '', picture: '' };
    
    // Save link status
    localStorage.setItem('indyMusicLinked', 'true');
    localStorage.setItem('indyMusicLinkTime', Date.now());
    
    // Also save a reference in INDY Sunrise (so it knows Music is linked)
    localStorage.setItem('indyMusicAppConnected', 'true');
    
    // Update profile display
    updateProfileDisplay();
    
    // Show success notification
    showSyncNotification('‚úì', 'Account Linked!', `Welcome back, ${indyProfile.name}`);
    
    setTimeout(() => {
        document.getElementById('searchingState').style.display = 'block';
        document.getElementById('confirmState').classList.remove('active');
    }, 300);
}

function updateProfileDisplay() {
    const indyProfile = JSON.parse(localStorage.getItem('userProfile')) || { name: '', picture: '' };
    const isLinked = localStorage.getItem('indyMusicLinked') === 'true';
    
    const avatar = document.getElementById('profileAvatarLarge');
    const name = document.getElementById('profileNameLarge');
    const status = document.getElementById('profileStatusText');
    const statusDot = document.getElementById('statusDot');
    const badge = document.getElementById('profileBadge');
    
    if (isLinked && indyProfile.name) {
        // Update avatar
        if (indyProfile.picture && indyProfile.picture.trim()) {
            avatar.style.backgroundImage = `url(${indyProfile.picture})`;
            avatar.textContent = '';
        } else {
            avatar.style.backgroundImage = 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)';
            avatar.textContent = indyProfile.name.charAt(0).toUpperCase();
        }
        
        // Update name
        name.textContent = indyProfile.name;
        
        // Update status
        status.textContent = 'Synced';
        statusDot.style.background = '#10b981';
        
        // Show badge
        badge.style.display = 'block';
    } else {
        avatar.style.backgroundImage = 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)';
        avatar.textContent = '‚ú¶';
        name.textContent = 'Guest';
        status.textContent = 'Not linked';
        statusDot.style.background = '#ef4444';
        badge.style.display = 'none';
    }
}

function showSyncNotification(icon, title, message) {
    const notif = document.getElementById('syncNotification');
    document.querySelector('.sync-notification-icon').textContent = icon;
    document.getElementById('syncNotifTitle').textContent = title;
    document.getElementById('syncNotifMessage').textContent = message;
    
    notif.classList.add('show');
    
    setTimeout(() => {
        notif.classList.remove('show');
    }, 4000);
}

// Auto-update profile on page load
document.addEventListener('DOMContentLoaded', () => {
    updateProfileDisplay();
    
    // Check for profile changes every 2 seconds
    setInterval(() => {
        const currentProfile = JSON.parse(localStorage.getItem('userProfile')) || { name: '', picture: '' };
        const lastProfileCheck = localStorage.getItem('lastProfileCheck');
        const currentProfileString = JSON.stringify(currentProfile);
        
        if (lastProfileCheck !== currentProfileString) {
            updateProfileDisplay();
            localStorage.setItem('lastProfileCheck', currentProfileString);
        }
    }, 2000);
});

document.getElementById('accountSearchPopup')?.addEventListener('click', (e) => {
    if (e.target.id === 'accountSearchPopup') {
        cancelLink();
    }
});
// Add double-click to profile to toggle left sidebar
document.getElementById('userProfileHeader').addEventListener('dblclick', function() {
    toggleLeftSidebar();
});

// Add double-click to now playing info to toggle right sidebar
document.getElementById('now-playing-info').addEventListener('dblclick', function() {
    toggleRightSidebar();
});
</script>

</body>
</html>
