<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>INDY Music</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@300;400;500;600&family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0a;--panel:#1a1a1a;--sidebar-bg:#252525;--soft:#2a2a2a;
  --hover:#333;--accent:#ffffff;--accent-dim:#eaeaea;--text:#fff;
  --muted:#b3b3b3;--glow:rgba(29,185,84,.3);--gradient-color:#517c7a;
  --border:rgba(255,255,255,.08);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh;-webkit-font-smoothing:antialiased}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:1000;mix-blend-mode:overlay}

/* NAV */
.sticky-nav{position:sticky;top:0;z-index:900;width:100%;height:60px;background:rgba(10,10,10,.85);backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,.06);box-shadow:0 8px 32px rgba(0,0,0,.2)}
.sticky-nav-inner{display:flex;align-items:center;justify-content:space-between;height:100%;padding:0 24px;gap:20px}
.nav-logo{display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 12px;border-radius:40px;transition:all .3s}
.nav-logo:hover{background:rgba(255,255,255,.05)}
.nav-logo-icon{font-size:24px;background:linear-gradient(135deg,#fff 0%,#b0b0b0 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.nav-logo-text{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;letter-spacing:-.5px;background:linear-gradient(135deg,#fff 0%,#d0d0d0 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.nav-search-wrap{flex:1;max-width:560px;margin:0 20px;display:flex;align-items:center;gap:10px}
.nav-search-box{flex:1;display:flex;align-items:center;background:rgba(20,20,20,.6);border:1px solid rgba(255,255,255,.08);border-radius:40px;padding:2px 2px 2px 16px;transition:all .3s;backdrop-filter:blur(8px)}
.nav-search-box:focus-within{border-color:rgba(255,255,255,.3)}
.nav-search-box input{flex:1;background:transparent;border:none;color:var(--text);font-size:14px;padding:8px 0;outline:none;font-family:'DM Sans',sans-serif}
.nav-search-box input::placeholder{color:rgba(255,255,255,.3);font-size:13px}
.nav-search-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.1);color:var(--text);padding:6px 18px;border-radius:40px;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;white-space:nowrap}
.nav-search-btn:hover{background:rgba(255,255,255,.18)}
.nav-right{flex:0 0 auto;display:flex;align-items:center;gap:8px}
.nav-btn{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);color:var(--text);padding:8px 16px;border-radius:40px;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;white-space:nowrap;font-family:'DM Sans',sans-serif}
.nav-btn:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.15)}

/* APP LAYOUT */
.app{display:flex;height:calc(100vh - 60px);gap:12px;padding:12px}

/* LEFT SIDEBAR */
.left-sidebar{width:280px;display:flex;flex-direction:column;gap:12px;transition:width .3s;position:relative}
.left-sidebar.minimized{width:0;overflow:hidden}
.sidebar-lib{background:var(--sidebar-bg);border-radius:12px;padding:20px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
.lib-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.lib-header h3{font-size:14px;color:#fff;font-weight:700}
.pl-item{padding:12px 14px;background:transparent;border-radius:10px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;margin-bottom:4px}
.pl-item:hover{background:var(--hover)}
.pl-item.active{background:var(--accent);color:#000}
.pl-icon{font-size:24px}
.pl-info{flex:1;min-width:0}
.pl-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pl-count{font-size:12px;color:var(--muted);margin-top:2px}
.pl-item.active .pl-count{color:#000;opacity:.7}
.pl-cover{width:44px;height:44px;border-radius:6px;object-fit:cover;flex-shrink:0}
.toggle-sidebar{position:absolute;top:50%;transform:translateY(-50%);width:24px;height:48px;background:var(--sidebar-bg);border:none;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;z-index:10;border-radius:0 8px 8px 0}
.toggle-left{right:-24px}
.toggle-right{left:-24px;border-radius:8px 0 0 8px}
.toggle-sidebar:hover{color:var(--text);background:var(--soft)}

/* MAIN CONTENT */
.main-content{flex:1;background:linear-gradient(180deg,var(--gradient-color) 0%,var(--bg) 25%);border-radius:12px;overflow-y:auto;padding:0;transition:background .8s}
#homeView,#searchView{padding:28px 32px}
.section{margin-bottom:44px}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.section-header h2{font-size:22px;font-weight:700}

/* Filter chips */
.filter-chips{display:flex;gap:10px;margin-bottom:28px;margin-top:8px;flex-wrap:wrap;align-items:center}
.chip{padding:7px 14px;background:rgba(255,255,255,.08);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12);border-radius:30px;color:var(--text);font-size:13px;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:8px;white-space:nowrap}
.chip:hover{background:rgba(255,255,255,.14)}
.chip.active{background:linear-gradient(135deg,#fff 0%,#e0e0e0 100%);color:#000;border-color:transparent}
.chip .cnt{font-size:11px;opacity:.7}
.filter-chips>button:not(.chip){padding:7px 13px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:30px;color:rgba(255,255,255,.65);font-size:13px;font-weight:500;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .25s;display:flex;align-items:center;gap:6px;white-space:nowrap}
.filter-chips>button:not(.chip):hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.18);color:rgba(255,255,255,.9);transform:translateY(-1px)}

/* Recent grid */
.recent-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.song-card{background:rgba(255,255,255,.048);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.04);border-radius:12px;padding:6px;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:12px;min-height:76px}
.song-card:hover{background:rgba(255,255,255,.1);transform:translateY(-2px)}
.song-card img{width:64px;height:64px;border-radius:8px;object-fit:cover;flex-shrink:0}
.song-info{flex:1;min-width:0;margin-right:8px}
.song-title{font-size:14px;font-weight:600;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.song-artist{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.clickable-artist{cursor:pointer;transition:color .2s}
.clickable-artist:hover{color:var(--accent)!important;text-decoration:underline}

/* Scroll row */
.scroll-row{display:flex;gap:16px;overflow-x:auto;padding-bottom:10px;scroll-behavior:smooth}
.scroll-row::-webkit-scrollbar{height:6px}
.scroll-row::-webkit-scrollbar-track{background:rgba(255,255,255,.02)}
.scroll-row::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18);border-radius:4px}

/* Album card */
.album-card{min-width:160px;max-width:160px;background:rgba(0,0,0,.3);border-radius:12px;padding:14px;cursor:pointer;transition:all .4s}
.album-card:hover{background:rgba(0,0,0,.5);transform:translateY(-6px);box-shadow:0 16px 40px rgba(0,0,0,.5)}
.album-card img{width:100%;aspect-ratio:1;border-radius:8px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,.4);object-fit:cover}
.album-card .ac-title{font-size:13px;font-weight:600;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;line-height:1.4;min-height:38px}
.album-card .ac-artist{font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Stats */
.stats-card{background:rgba(0,0,0,.25);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:28px;margin-bottom:36px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:24px}
.stat-item{text-align:center;padding:14px;border-radius:12px;background:rgba(255,255,255,.02);transition:all .3s}
.stat-item:hover{background:rgba(255,255,255,.05);transform:translateY(-2px)}
.stat-value{font-family:'Syne',sans-serif;font-size:40px;font-weight:800;background:linear-gradient(135deg,#fff 0%,#a0a0a0 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px}

/* Library grid */
.lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px}
.lib-album-card{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.04);border-radius:12px;padding:16px;cursor:pointer;transition:all .4s;position:relative}
.lib-album-card:hover{background:rgba(0,0,0,.5);transform:translateY(-6px);box-shadow:0 16px 48px rgba(0,0,0,.6)}
.lib-album-card img{width:100%;aspect-ratio:1;border-radius:8px;margin-bottom:12px;object-fit:cover}
.remove-album-btn{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.8);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;opacity:0;transition:opacity .2s}
.lib-album-card:hover .remove-album-btn{opacity:1}
.new-badge{position:absolute;top:8px;left:8px;background:var(--accent);color:#000;font-size:10px;font-weight:700;padding:3px 8px;border-radius:10px;letter-spacing:.5px}

/* Genre grid */
.genre-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
.genre-card{border-radius:12px;padding:16px;cursor:pointer;transition:all .3s;text-align:center;min-height:90px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
.genre-card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,.5)}
.genre-emoji{font-size:28px}
.genre-name{font-size:13px;font-weight:700}

/* Search results */
.search-song-card{min-width:180px;max-width:180px;background:rgba(0,0,0,.3);border-radius:12px;padding:14px;cursor:pointer;transition:all .4s;border:1px solid rgba(255,255,255,.04)}
.search-song-card:hover{background:rgba(0,0,0,.5);transform:translateY(-4px);border-color:rgba(255,255,255,.1)}
.search-song-card img{width:100%;aspect-ratio:1;border-radius:8px;margin-bottom:10px;object-fit:cover}
.search-song-title{font-size:13px;font-weight:600;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.search-song-artist{font-size:12px;color:var(--muted);margin-bottom:8px}
.search-song-actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.search-action-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:var(--text);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:14px;transition:all .2s;display:flex;align-items:center;justify-content:center}
.search-action-btn:hover{background:rgba(255,255,255,.22)}
.search-action-btn.liked{color:#ff6b6b}
.search-album-card{min-width:160px;max-width:160px;background:rgba(0,0,0,.3);border-radius:12px;padding:14px;cursor:pointer;transition:all .4s;border:1px solid rgba(255,255,255,.04)}
.search-album-card:hover{background:rgba(0,0,0,.5);transform:translateY(-6px);border-color:rgba(255,255,255,.1)}
.search-album-card img{width:100%;aspect-ratio:1;border-radius:8px;margin-bottom:10px;box-shadow:0 6px 18px rgba(0,0,0,.4);object-fit:cover}
.scard-title{font-size:13px;font-weight:600;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;line-height:1.4;min-height:36px}
.scard-artist{font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:10px}
.scard-play-btn{width:100%;padding:8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);border-radius:20px;color:var(--text);font-size:12px;font-weight:600;cursor:pointer;transition:all .3s}
.scard-play-btn:hover{background:var(--accent);color:#000}
.search-artist-card{min-width:160px;max-width:160px;background:rgba(0,0,0,.3);border-radius:12px;padding:18px;cursor:pointer;transition:all .4s;text-align:center;border:1px solid rgba(255,255,255,.04)}
.search-artist-card:hover{background:rgba(0,0,0,.5);transform:translateY(-6px)}
.artist-img-wrap{position:relative;width:110px;height:110px;margin:0 auto 12px}
.artist-img{width:100%;height:100%;border-radius:50%;object-fit:cover}
.artist-name{font-size:14px;font-weight:600;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.artist-type{font-size:12px;color:var(--muted);margin-bottom:10px}
.artist-follow-btn{width:100%;padding:8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);border-radius:20px;color:var(--text);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.artist-follow-btn:hover{background:rgba(255,255,255,.2)}

/* Album / Playlist view */
.album-view,.playlist-view{padding:32px;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.back-btn{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08);color:var(--text);padding:10px 20px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:600;margin-bottom:24px;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
.back-btn:hover{background:rgba(0,0,0,.4);transform:translateX(-4px)}
.av-header{display:flex;gap:24px;margin-bottom:28px;align-items:flex-end}
.av-cover{width:180px;height:180px;border-radius:8px;box-shadow:0 16px 48px rgba(0,0,0,.6);object-fit:cover}
.av-icon{width:180px;height:180px;font-size:90px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.3);border-radius:8px}
.av-info h1{font-family:'Syne',sans-serif;font-size:40px;font-weight:900;margin-bottom:8px;letter-spacing:-2px;background:linear-gradient(135deg,#fff 0%,#b0b0b0 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.av-info p{color:var(--muted);font-size:14px;margin-bottom:16px}
.av-actions{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}
.play-all-btn{border:none;padding:14px 28px;border-radius:30px;font-size:14px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all .2s;background:var(--accent);color:#000}
.play-all-btn:hover{transform:scale(1.05)}
.save-lib-btn{border:1px solid rgba(255,255,255,.2);padding:14px 24px;border-radius:30px;font-size:14px;font-weight:600;cursor:pointer;background:rgba(255,255,255,.1);color:var(--text);transition:all .2s}
.save-lib-btn:hover{background:rgba(255,255,255,.18)}
.save-lib-btn.saved{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.4)}
.song-list{display:flex;flex-direction:column;gap:8px}
.song-row{background:rgba(0,0,0,.2);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.04);border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:16px;cursor:pointer;transition:all .3s}
.song-row:hover{background:rgba(0,0,0,.4);transform:translateX(8px)}
.song-row img{width:48px;height:48px;border-radius:6px;object-fit:cover}
.song-num{color:var(--muted);font-size:15px;font-weight:600;min-width:26px;text-align:center}
.preview-badge{display:inline-block;background:rgba(255,160,0,.2);border:1px solid rgba(255,160,0,.4);color:#ffcc44;font-size:10px;font-weight:700;padding:2px 7px;border-radius:8px;letter-spacing:.5px;vertical-align:middle;margin-left:6px}

/* RIGHT SIDEBAR */
.right-sidebar{width:360px;background:#000;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;transition:width .3s;position:relative}
.right-sidebar.minimized{width:0;padding:0;overflow:hidden}
.art-container{position:absolute;top:0;left:0;right:0;height:50%;z-index:1}
.art-container::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.4) 0%,rgba(0,0,0,.2) 40%,rgba(0,0,0,.7) 100%);pointer-events:none;z-index:2}
#nowPlayingArt{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1;transition:opacity .5s;opacity:0}
#npArtPlaceholder{position:absolute;inset:0;z-index:1;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);font-size:64px}
.np-info{position:absolute;top:35%;left:0;right:0;transform:translateY(-50%);padding:28px 22px;z-index:3;pointer-events:none}
.np-info>*{pointer-events:auto}
.np-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;letter-spacing:-.5px;text-shadow:0 4px 16px rgba(0,0,0,.9);margin-bottom:6px}
.np-artist{font-size:15px;color:rgba(255,255,255,.8);text-shadow:0 4px 16px rgba(0,0,0,.9)}
.np-add-btn{margin-top:14px;padding:9px 18px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:30px;color:var(--text);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;backdrop-filter:blur(10px);transition:all .3s}
.np-add-btn:hover{background:rgba(255,255,255,.22)}
.np-mode-btns{display:flex;gap:8px;margin-top:12px}
.mode-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:var(--muted);padding:8px 16px;border-radius:20px;font-size:13px;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:6px}
.mode-btn:hover{background:rgba(255,255,255,.15)}
.mode-btn.active{color:#fff;border-color:rgba(255,255,255,.4)}

/* Progress */
.progress-wrap{position:absolute;bottom:110px;left:0;right:0;z-index:3;padding:0 22px}
.progress-bar{width:100%;height:4px;background:rgba(255,255,255,.2);border-radius:2px;cursor:pointer;overflow:hidden}
.progress-fill{height:100%;background:#fff;border-radius:2px;width:0%;transition:width .3s linear}
.audio-time{display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,.5);margin-top:4px}

/* Lyrics */
.lyrics-section{position:absolute;top:50%;bottom:20%;left:0;right:0;padding:22px;overflow-y:auto;z-index:3;pointer-events:none}
.lyrics-section>*{pointer-events:auto}
.lyrics-section h4{color:rgba(255,255,255,.9);text-shadow:0 4px 16px rgba(0,0,0,.9);margin-bottom:16px;font-family:'Syne',sans-serif;font-size:15px}
.lyrics-section::-webkit-scrollbar{width:4px}
.lyrics-section::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:4px}
#lyricsEl{font-size:14px;line-height:1.9;font-weight:300;letter-spacing:.3px;white-space:pre-wrap;color:rgba(255,255,255,.85);text-shadow:0 3px 12px rgba(0,0,0,.95)}
#lyricsEl p{margin:0}
.lyric-line.active{color:#fff;font-weight:600}
.lyrics-loading{color:var(--muted);font-size:14px;font-style:italic}

/* Playback controls */
.pb-controls{position:absolute;bottom:0;left:0;right:0;padding:20px;background:linear-gradient(0deg,rgba(0,0,0,.9) 0%,rgba(0,0,0,.6) 50%,transparent 100%);backdrop-filter:blur(16px);z-index:3;display:flex;align-items:center;justify-content:center;gap:14px}
.ctrl-btn{width:40px;height:40px;background:rgba(255,255,255,.18);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.28);color:var(--text);cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s;font-size:18px}
.ctrl-btn:hover{background:rgba(255,255,255,.3)}
.ctrl-btn.play{background:rgba(255,255,255,.95);border:none;color:#000;width:48px;height:48px;font-size:22px}
.ctrl-btn.play:hover{background:#fff;transform:scale(1.05)}

/* Video error */
.video-error{position:absolute;inset:0;z-index:10;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.85);text-align:center;padding:24px}
.video-error.show{display:flex}
.video-error-icon{font-size:48px;margin-bottom:12px}
.video-error-text{font-size:14px;color:rgba(255,255,255,.7);margin-bottom:16px;line-height:1.5}
.retry-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:var(--text);padding:10px 20px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s}
.retry-btn:hover{background:rgba(255,255,255,.2)}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.95);backdrop-filter:blur(10px);color:var(--text);padding:14px 20px;border-radius:8px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 32px rgba(0,0,0,.5);opacity:0;transition:opacity .3s;z-index:10000;pointer-events:none}
.toast.show{opacity:1}
.toast img{width:44px;height:44px;border-radius:4px;object-fit:cover}
.toast-info{flex:1;min-width:0}
.toast-title{font-size:13px;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.toast-sub{font-size:11px;color:var(--muted)}

/* Modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);z-index:10000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:rgba(20,20,20,.98);padding:32px;border-radius:20px;max-width:440px;width:90%;border:1px solid rgba(255,255,255,.1);box-shadow:0 24px 64px rgba(0,0,0,.8)}
.modal-content h3{margin-bottom:24px;font-size:22px}
.modal-content input{width:100%;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:var(--soft);color:var(--text);font-size:14px;margin-bottom:16px;outline:none;transition:border-color .2s;font-family:'DM Sans',sans-serif}
.modal-content input:focus{border-color:rgba(255,255,255,.4)}
.modal-btns{display:flex;gap:12px}
.modal-btns button{flex:1;padding:14px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.modal-btns .primary{background:var(--accent);color:#000}
.modal-btns .secondary{background:var(--soft);color:var(--text)}
.modal-btns button:hover{transform:scale(1.02)}

/* Queue panel */
.queue-panel{position:fixed;right:-400px;top:12px;bottom:12px;width:360px;background:rgba(20,20,20,.97);backdrop-filter:blur(30px);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:24px;z-index:500;transition:right .4s cubic-bezier(.4,0,.2,1);overflow-y:auto;box-shadow:-8px 0 32px rgba(0,0,0,.6)}
.queue-panel.open{right:376px}
.queue-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,.08)}
.queue-header h3{font-family:'Syne',sans-serif;font-size:20px;font-weight:700}
.close-queue{background:transparent;border:none;color:var(--muted);font-size:22px;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .3s}
.close-queue:hover{background:rgba(255,255,255,.1);color:var(--text)}
.queue-item{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,.05);border-radius:10px;cursor:pointer;transition:all .3s;margin-bottom:8px}
.queue-item:hover{background:rgba(255,255,255,.1)}
.queue-item.playing{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2)}
.queue-item img{width:48px;height:48px;border-radius:6px;object-fit:cover}
.qi-info{flex:1;min-width:0}
.qi-title{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.qi-artist{font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.q-remove{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:4px;opacity:0;transition:all .3s}
.queue-item:hover .q-remove{opacity:1}
.q-remove:hover{color:#f44}

/* Mini player */
.mini-player{position:fixed;bottom:-80px;left:50%;transform:translateX(-50%);background:rgba(18,18,18,.98);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px;z-index:900;box-shadow:0 8px 32px rgba(0,0,0,.7);transition:bottom .4s cubic-bezier(.34,1.56,.64,1);max-width:400px;width:calc(100vw - 48px)}
.mini-player.show{bottom:24px}
.mini-player img{width:44px;height:44px;border-radius:6px;object-fit:cover}
.mp-info{flex:1;min-width:0}
.mp-title{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mp-artist{font-size:11px;color:var(--muted)}
.mp-controls{display:flex;gap:8px}
.mp-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:var(--text);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.mp-btn:hover{background:rgba(255,255,255,.2)}

/* Context menu */
.ctx-menu{position:fixed;background:rgba(18,18,18,.98);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:8px 0;z-index:100000;display:none;min-width:200px;box-shadow:0 16px 48px rgba(0,0,0,.8)}
.ctx-menu.show{display:block}
.ctx-item{padding:11px 16px;cursor:pointer;transition:background .15s;font-size:14px;display:flex;align-items:center;gap:10px}
.ctx-item:hover{background:rgba(255,255,255,.08)}
.ctx-sep{height:1px;background:rgba(255,255,255,.08);margin:4px 0}

/* Link option btn */
.link-opt{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:14px 18px;border-radius:12px;cursor:pointer;text-align:left;transition:all .3s;display:flex;align-items:center;gap:14px;font-size:14px;font-weight:600;width:100%;margin-bottom:10px}
.link-opt:hover{background:rgba(255,255,255,.14);transform:translateY(-2px)}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:rgba(255,255,255,.02)}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}

/* Animations */
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}
.empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
.empty-state-icon{font-size:48px;margin-bottom:12px}

/* Playing indicator */
.playing-indicator{display:inline-flex;align-items:center;gap:3px;margin-left:8px}
.playing-bar{width:3px;background:#fff;border-radius:2px;animation:playBar .8s ease infinite alternate}
.playing-bar:nth-child(2){animation-delay:.2s;height:10px}
.playing-bar:nth-child(3){animation-delay:.4s;height:7px}
@keyframes playBar{from{height:4px}to{height:14px}}

/* Startup banner */
.startup-banner{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:rgba(255,160,0,.12);border:1px solid rgba(255,160,0,.3);backdrop-filter:blur(16px);border-radius:14px;padding:16px 20px;display:flex;align-items:flex-start;gap:14px;z-index:9500;max-width:520px;width:calc(100vw - 32px);box-shadow:0 12px 40px rgba(0,0,0,.6);font-family:'DM Sans',sans-serif;animation:bannerIn .5s cubic-bezier(.34,1.56,.64,1) .5s both}
@keyframes bannerIn{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.banner-close{background:transparent;border:none;color:rgba(255,255,255,.4);font-size:20px;cursor:pointer;transition:color .2s;padding:0}
.banner-close:hover{color:rgba(255,255,255,.8)}

@media(max-width:768px){.app{flex-direction:column;padding:8px}.left-sidebar{width:100%;height:auto;max-height:180px}.right-sidebar{width:100%;height:280px}.main-content{height:calc(100vh - 520px)}.queue-panel.open{right:8px}}
</style>
</head>
<body>

<!-- STARTUP BANNER -->
<div class="startup-banner" id="startupBanner">
  <div style="font-size:28px;flex-shrink:0;margin-top:2px">‚ö†Ô∏è</div>
  <div style="flex:1">
    <div style="font-size:14px;font-weight:700;color:#ffcc44;margin-bottom:4px">30-Second Preview Mode</div>
    <div style="font-size:13px;color:rgba(255,255,255,.75);line-height:1.5">As of this break, our music provider was blocked so we hope you will enjoy the preview experience until we find a new music backend!</div>
  </div>
  <button class="banner-close" onclick="this.closest('.startup-banner').remove()">√ó</button>
</div>

<!-- NAV -->
<div class="sticky-nav">
  <div class="sticky-nav-inner">
    <div class="nav-logo" onclick="showHome()">
      <span class="nav-logo-icon">‚ú¶</span>
      <span class="nav-logo-text">INDY MUSIC</span>
    </div>
    <div class="nav-search-wrap">
      <div class="nav-search-box">
        <span style="color:rgba(255,255,255,.4);font-size:20px;margin-right:8px">‚åï</span>
        <input type="text" id="navSearchInput" placeholder="Search songs, artists, albums‚Ä¶" onkeypress="if(event.key==='Enter')doNavSearch()">
        <button class="nav-search-btn" onclick="doNavSearch()">Search</button>
      </div>
    </div>
    <div class="nav-right">
      <button class="nav-btn" onclick="toggleQueue()">üéµ Queue</button>
      <button class="nav-btn" onclick="linkIndy()">üîó Link</button>
    </div>
  </div>
</div>

<div class="app">
  <!-- LEFT SIDEBAR -->
  <aside class="left-sidebar" id="leftSidebar">
    <div class="sidebar-lib">
      <div class="lib-header">
        <h3>Your Library</h3>
        <button class="nav-search-btn" onclick="openCreateModal()">+ Create</button>
      </div>
      <div class="pl-item" onclick="viewLikedSongs()">
        <span class="pl-icon">‚ô°</span>
        <div class="pl-info">
          <div class="pl-name">Saved Songs</div>
          <div class="pl-count" id="likedCount">0 songs</div>
        </div>
      </div>
      <div id="playlistsList"></div>
    </div>
    <button class="toggle-sidebar toggle-left" onclick="toggleLeft()">‚Ä∫</button>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content" id="mainContent">
    <!-- HOME VIEW -->
    <div id="homeView">
      <div class="filter-chips" id="filterChips">
        <button class="chip active" data-filter="all" onclick="filterContent('all')">All <span class="cnt" id="fcAll"></span></button>
        <button class="chip" data-filter="songs" onclick="filterContent('songs')">Music <span class="cnt" id="fcSongs"></span></button>
        <button class="chip" data-filter="albums" onclick="filterContent('albums')">Albums <span class="cnt" id="fcAlbums"></span></button>
        <button class="chip" data-filter="mixes" onclick="filterContent('mixes')">‚ú¶ Mixes <span class="cnt" id="fcMixes"></span></button>
        <button class="chip" data-filter="library" onclick="filterContent('library')">My Library <span class="cnt" id="fcLib"></span></button>
        <button onclick="openMoodDetector()">üé≠ Mood</button>
        <button onclick="openListeningRecap()">üìä Recap</button>
        <button onclick="openQuickPlaylistBuilder()">‚ú¶ Build Playlist</button>
        <button onclick="openSongInfoCard()">‚ÑπÔ∏è Song Info</button>
        <button onclick="openDailyMix()">üéµ Daily Mix</button>
        <button onclick="openAIDJ()">üéß AI DJ</button>
      </div>

      <div class="stats-card" id="statsCard" style="display:none">
        <div class="stats-grid">
          <div class="stat-item"><div class="stat-value" id="statSongs">0</div><div class="stat-label">Songs Played</div></div>
          <div class="stat-item"><div class="stat-value" id="statAlbums">0</div><div class="stat-label">Albums Saved</div></div>
          <div class="stat-item"><div class="stat-value" id="statPlaylists">0</div><div class="stat-label">Playlists</div></div>
          <div class="stat-item"><div class="stat-value" id="statTime">0h</div><div class="stat-label">Listening Time</div></div>
        </div>
      </div>

      <div class="section" id="recentSection">
        <div class="section-header"><h2>Recently Played</h2></div>
        <div class="recent-grid" id="recentGrid"></div>
      </div>
      <div class="section" id="albumsSection">
        <div class="section-header"><h2>Albums For You</h2></div>
        <div class="scroll-row" id="albumsScroll"></div>
      </div>
      <div class="section" id="mixesSection">
        <div class="section-header"><h2>Your Mixes</h2></div>
        <div class="scroll-row" id="mixesScroll"></div>
      </div>
      <div class="section" id="popularSection">
        <div class="section-header"><h2>Popular Now</h2></div>
        <div class="scroll-row" id="popularScroll"></div>
      </div>
      <div class="section" id="artistsSection">
        <div class="section-header"><h2>üé§ Discover Artists</h2></div>
        <div class="scroll-row" id="artistsScroll"></div>
      </div>
      <div class="section" id="librarySection" style="display:none">
        <div class="section-header"><h2>üìö My Album Library</h2></div>
        <div class="lib-grid" id="libraryGrid"></div>
      </div>
    </div>

    <!-- SEARCH VIEW -->
    <div id="searchView" style="display:none">
      <div style="margin-bottom:20px">
        <div style="font-size:11px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px;font-weight:600">Browse Genres</div>
        <div class="genre-grid" id="genreGrid"></div>
      </div>
      <div id="searchResults"></div>
    </div>
  </main>

  <!-- RIGHT SIDEBAR -->
  <aside class="right-sidebar minimized" id="rightSidebar">
    <div class="art-container" id="artContainer">
      <img id="nowPlayingArt" src="" alt="">
      <div id="npArtPlaceholder">üéµ</div>
      <div style="position:absolute;inset:0;z-index:2;pointer-events:none;background:linear-gradient(180deg,rgba(0,0,0,.4) 0%,rgba(0,0,0,.2) 40%,rgba(0,0,0,.7) 100%)"></div>
      <div class="video-error" id="videoError">
        <div class="video-error-icon">üîá</div>
        <div class="video-error-text">Preview unavailable<br><small style="opacity:.7">No preview for this track</small></div>
        <button class="retry-btn" onclick="skipNext()">Skip to Next ‚Üí</button>
      </div>
    </div>

    <audio id="audioEl" preload="none" style="display:none"></audio>

    <div class="np-info">
      <div class="np-title" id="npTitle">Start playing a song</div>
      <div class="np-artist" id="npArtist"><span class="preview-badge">30s Preview</span></div>
      <button class="np-add-btn" id="addToPlaylistBtn" style="display:none" onclick="showAddToPlaylistMenu(currentPlayingSong)">
        <span style="font-size:16px">+</span> Add to Playlist
      </button>
      <div class="np-mode-btns">
        <button class="mode-btn" id="shuffleBtn" onclick="toggleShuffle()">üîÄ Shuffle</button>
        <button class="mode-btn" id="repeatBtn" onclick="toggleRepeat()">üîÅ Repeat</button>
      </div>
    </div>

    <div class="progress-wrap">
      <div class="progress-bar" id="progressBar" onclick="seekAudio(event)">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="audio-time"><span id="curTime">0:00</span><span id="durTime">0:30</span></div>
    </div>

    <div class="lyrics-section">
      <h4>Lyrics</h4>
      <div id="lyricsEl" class="lyrics-loading">Play a song to view lyrics‚Ä¶</div>
    </div>

    <div class="pb-controls">
      <button class="ctrl-btn" onclick="skipPrev()">‚èÆ</button>
      <button class="ctrl-btn play" id="playPauseBtn" onclick="togglePlay()">‚ñ∂</button>
      <button class="ctrl-btn" onclick="skipNext()">‚è≠</button>
    </div>

    <button class="toggle-sidebar toggle-right" onclick="toggleRight()">‚Äπ</button>
  </aside>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <img id="toastImg" src="" alt="">
  <div class="toast-info">
    <div class="toast-title" id="toastTitle"></div>
    <div class="toast-sub">Now Playing ¬∑ 30s Preview</div>
  </div>
</div>

<!-- Create Playlist Modal -->
<div class="modal" id="createModal">
  <div class="modal-content">
    <h3>Create Playlist</h3>
    <input type="text" id="plNameInput" placeholder="Playlist name">
    <input type="text" id="plEmojiInput" placeholder="Emoji (e.g. üéµ)" maxlength="2">
    <div class="modal-btns">
      <button class="secondary" onclick="closeCreateModal()">Cancel</button>
      <button class="primary" onclick="createPlaylist()">Create</button>
    </div>
  </div>
</div>

<!-- Queue Panel -->
<div class="queue-panel" id="queuePanel">
  <div class="queue-header">
    <h3>Queue</h3>
    <button class="close-queue" onclick="toggleQueue()">√ó</button>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:16px">
    <button onclick="clearQueue()" style="flex:1;background:rgba(255,0,0,.2);border:1px solid rgba(255,0,0,.3);color:var(--text);padding:10px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:600">Clear</button>
    <button onclick="shuffleQueueFn()" style="flex:1;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:600">üîÄ Shuffle</button>
  </div>
  <div id="queueList"></div>
</div>

<!-- Mini Player -->
<div class="mini-player" id="miniPlayer">
  <img id="mpImg" src="" alt="">
  <div class="mp-info">
    <div class="mp-title" id="mpTitle">Song Title</div>
    <div class="mp-artist" id="mpArtist">Artist</div>
  </div>
  <div class="mp-controls">
    <button class="mp-btn" onclick="skipPrev()">‚èÆ</button>
    <button class="mp-btn" onclick="togglePlay()">‚èØ</button>
    <button class="mp-btn" onclick="skipNext()">‚è≠</button>
  </div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctxMenu">
  <div class="ctx-item" onclick="ctxAction('play')">‚ñ∂ Play Now</div>
  <div class="ctx-item" onclick="ctxAction('queue')">+ Add to Queue</div>
  <div class="ctx-item" onclick="ctxAction('playlist')">üìù Add to Playlist</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxAction('like')">‚ù§Ô∏è Like Song</div>
  <div class="ctx-item" onclick="ctxAction('info')">‚ÑπÔ∏è Song Info</div>
  <div class="ctx-item" onclick="ctxAction('share')">üîó Copy Info</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GROQ_API_KEY = "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";
const CORS = 'https://corsproxy.io/?';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let recent = [];
let playlists = {};
let savedAlbums = {};
let savedArtists = {};
let listeningStats = {};
let queue = [];
let queueIndex = 0;
let currentSongs = [];
let currentIndex = -1;
let currentPlayingSong = null;
let currentPlaylist = null;
let shuffleMode = false;
let repeatMode = 'off';
let currentFilter = 'all';
let ctxTarget = null;
let isPlaying = false;
const lyricsCache = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(t) {
  if (!t) return '';
  const d = document.createElement('div'); d.textContent = t; return d.innerHTML;
}
function save(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} }
function load(k, def) { try { const d = localStorage.getItem(k); return d ? JSON.parse(d) : def; } catch(e) { return def; } }
function notify(msg) {
  const n = document.createElement('div');
  n.style.cssText = 'position:fixed;top:24px;right:24px;background:rgba(0,0,0,.95);backdrop-filter:blur(10px);color:#fff;padding:14px 22px;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:99999;font-family:DM Sans,sans-serif;font-size:14px;font-weight:500;animation:slideIn .3s ease;max-width:320px;border:1px solid rgba(255,255,255,.1)';
  n.textContent = msg;
  document.body.appendChild(n);
  setTimeout(() => { n.style.animation = 'slideOut .3s ease'; setTimeout(() => n.remove(), 300); }, 2500);
}
function fmt(s) {
  if (!s || isNaN(s)) return '0:00';
  return `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEEZER API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dUrl(path) { return CORS + encodeURIComponent('https://api.deezer.com' + path); }

async function searchDeezer(q, type='track', limit=10) {
  const path = type === 'album'
    ? `/search/album?q=${encodeURIComponent(q)}&limit=${limit}`
    : `/search?q=${encodeURIComponent(q)}&limit=${limit}`;
  try {
    const r = await fetch(dUrl(path));
    const d = await r.json();
    if (!d.data) return [];
    if (type === 'album') {
      return d.data.map(i => ({ deezerAlbumId: i.id, title: i.title, artist: i.artist?.name || 'Unknown', art: i.cover_medium || i.cover || '', _isAlbum: true }));
    }
    return d.data.map(i => ({
      id: `dz_${i.id}`, deezerTrackId: i.id,
      title: i.title, artist: i.artist?.name || 'Unknown',
      art: i.album?.cover_medium || '', album: i.album?.title || '',
      duration: i.duration, preview: i.preview || null, _isDeezer: true
    }));
  } catch(e) { return []; }
}

async function getDeezerPreview(trackId) {
  try {
    const r = await fetch(dUrl(`/track/${trackId}`));
    const d = await r.json();
    return d.preview || null;
  } catch(e) { return null; }
}

async function getDeezerAlbumTracks(albumId, albumArt) {
  try {
    const r = await fetch(dUrl(`/album/${albumId}/tracks`));
    const d = await r.json();
    if (!d.data) return [];
    return d.data.map(t => ({
      id: `dz_${t.id}`, deezerTrackId: t.id,
      title: t.title, artist: t.artist?.name || 'Unknown',
      art: albumArt, preview: t.preview || null, _isDeezer: true
    }));
  } catch(e) { return []; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO PLAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const audio = document.getElementById('audioEl');

audio.addEventListener('timeupdate', () => {
  const fill = document.getElementById('progressFill');
  const cur = document.getElementById('curTime');
  if (fill && audio.duration) fill.style.width = (audio.currentTime / audio.duration * 100) + '%';
  if (cur) cur.textContent = fmt(audio.currentTime);
});
audio.addEventListener('loadedmetadata', () => {
  const el = document.getElementById('durTime');
  if (el) el.textContent = fmt(audio.duration);
});
audio.addEventListener('play', () => { isPlaying = true; const b = document.getElementById('playPauseBtn'); if(b) b.textContent = '‚è∏'; });
audio.addEventListener('pause', () => { isPlaying = false; const b = document.getElementById('playPauseBtn'); if(b) b.textContent = '‚ñ∂'; });
audio.addEventListener('ended', () => {
  if (repeatMode === 'one' && currentPlayingSong) { audio.currentTime = 0; audio.play(); return; }
  handleNext();
});
audio.addEventListener('error', showVidErr);

function seekAudio(e) {
  const bar = document.getElementById('progressBar');
  if (!bar || !audio.duration) return;
  const rect = bar.getBoundingClientRect();
  audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
}
function togglePlay() {
  if (!currentPlayingSong) return;
  audio.paused ? audio.play().catch(()=>{}) : audio.pause();
}
function showVidErr() { const o = document.getElementById('videoError'); if(o) o.classList.add('show'); }
function hideVidErr() { const o = document.getElementById('videoError'); if(o) o.classList.remove('show'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAY SONG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function playSong(song, fromPlaylist = null) {
  if (!song) return;
  currentPlayingSong = { ...song };
  hideVidErr();
  incrementPlay();

  // Update NP info
  const npT = document.getElementById('npTitle');
  const npA = document.getElementById('npArtist');
  if (npT) npT.textContent = song.title || 'Unknown';
  if (npA) npA.innerHTML = esc(song.artist || 'Unknown') + ' <span class="preview-badge">30s</span>';

  // Update art
  const artImg = document.getElementById('nowPlayingArt');
  const artPh = document.getElementById('npArtPlaceholder');
  if (artImg && song.art) {
    artImg.src = song.art;
    artImg.onload = () => { artImg.style.opacity = '1'; if(artPh) artPh.style.display = 'none'; };
    artImg.onerror = () => { artImg.style.opacity = '0'; if(artPh) artPh.style.display = 'flex'; };
  } else if (artPh) { artPh.style.display = 'flex'; if(artImg) artImg.style.opacity = '0'; }

  // Update playlist context
  if (fromPlaylist && fromPlaylist !== 'queue') {
    currentPlaylist = fromPlaylist;
    currentSongs = playlists[fromPlaylist]?.songs || [];
    currentIndex = currentSongs.findIndex(s => s.id === song.id);
    if (currentIndex === -1) currentIndex = 0;
  } else {
    const idx = currentSongs.findIndex(s => s.id === song.id);
    if (idx !== -1) currentIndex = idx;
  }

  addToRecent(song);
  if (song.art) updateGradient(song.art);
  showToast(song);
  updateMiniPlayer(song);

  const addBtn = document.getElementById('addToPlaylistBtn');
  if (addBtn) addBtn.style.display = 'flex';

  // Open right sidebar
  const rs = document.getElementById('rightSidebar');
  if (rs && rs.classList.contains('minimized')) rs.classList.remove('minimized');

  // Resolve preview URL
  let previewUrl = song.preview || null;
  if (!previewUrl && song.deezerTrackId) {
    previewUrl = await getDeezerPreview(song.deezerTrackId);
    song.preview = previewUrl;
    currentPlayingSong.preview = previewUrl;
  }

  if (previewUrl) {
    audio.src = previewUrl;
    audio.play().catch(() => showVidErr());
  } else {
    showVidErr();
    notify('No preview available for this track');
  }

  renderQueue();
  setTimeout(() => updateLyrics(song), 600);
}

function handleNext() {
  if (shuffleMode && currentSongs.length > 1) {
    let ni; do { ni = Math.floor(Math.random() * currentSongs.length); } while (ni === currentIndex);
    currentIndex = ni; playSong(currentSongs[currentIndex]); return;
  }
  if (currentIndex < currentSongs.length - 1) { currentIndex++; playSong(currentSongs[currentIndex]); }
  else if (repeatMode === 'all' && currentSongs.length > 0) { currentIndex = 0; playSong(currentSongs[0]); }
  else notify('End of queue');
}
function skipNext() { if (repeatMode === 'one' && currentPlayingSong) { audio.currentTime = 0; audio.play(); return; } handleNext(); }
function skipPrev() {
  if (audio.currentTime > 3) { audio.currentTime = 0; return; }
  if (currentIndex > 0) { currentIndex--; playSong(currentSongs[currentIndex]); }
}

function toggleShuffle() {
  shuffleMode = !shuffleMode;
  const b = document.getElementById('shuffleBtn');
  if (b) { b.classList.toggle('active', shuffleMode); }
  notify(shuffleMode ? 'Shuffle ON üîÄ' : 'Shuffle OFF');
}
function toggleRepeat() {
  const modes = ['off','all','one'];
  repeatMode = modes[(modes.indexOf(repeatMode) + 1) % modes.length];
  const b = document.getElementById('repeatBtn');
  if (b) {
    b.classList.toggle('active', repeatMode !== 'off');
    b.textContent = repeatMode === 'one' ? 'üîÇ One' : repeatMode === 'all' ? 'üîÅ All' : 'üîÅ Repeat';
  }
  notify(repeatMode === 'off' ? 'Repeat OFF' : repeatMode === 'all' ? 'Repeat All üîÅ' : 'Repeat One üîÇ');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LYRICS (lrclib.net)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchLyrics(song) {
  if (!song?.title || !song?.artist) return null;
  const key = `${song.id}_${song.title}`;
  if (lyricsCache[key] !== undefined) return lyricsCache[key];
  try {
    const p = new URLSearchParams({ track_name: song.title, artist_name: song.artist });
    let r = await fetch(`https://lrclib.net/api/get?${p}`);
    if (r.ok) { const d = await r.json(); lyricsCache[key] = d; return d; }
    if (r.status === 404) {
      const sr = await fetch(`https://lrclib.net/api/search?${p}`);
      if (sr.ok) {
        const res = await sr.json();
        if (res?.length > 0) {
          const lr = await fetch(`https://lrclib.net/api/get?id=${res[0].id}`);
          if (lr.ok) { const d = await lr.json(); lyricsCache[key] = d; return d; }
        }
      }
    }
  } catch(e) {}
  lyricsCache[key] = null; return null;
}

function formatLyrics(ld) {
  if (!ld) return null;
  if (ld.syncedLyrics) {
    const lines = ld.syncedLyrics.split('\n');
    let html = '<div class="synced-lyrics">';
    lines.forEach(line => {
      const m = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
      if (m) {
        const t = parseInt(m[1]) * 60 + parseInt(m[2]);
        const text = m[4].trim();
        if (text) html += `<p data-time="${t}" class="lyric-line">${esc(text)}</p>`;
      } else if (line.trim()) html += `<p class="lyric-line">${esc(line.trim())}</p>`;
    });
    return html + '</div>';
  }
  if (ld.plainLyrics) return ld.plainLyrics.split('\n').map(l => `<p>${esc(l)||'&nbsp;'}</p>`).join('');
  if (ld.instrumental) return '<p style="text-align:center;font-style:italic">‚ô™ Instrumental ‚ô™</p>';
  return null;
}

async function updateLyrics(song) {
  const el = document.getElementById('lyricsEl');
  if (!el) return;
  el.innerHTML = '<div class="lyrics-loading">Loading lyrics‚Ä¶</div>';
  const ld = await fetchLyrics(song);
  const html = formatLyrics(ld);
  el.innerHTML = html || '<div class="lyrics-loading">No lyrics found</div>';
  setupLyricsSync();
}

function setupLyricsSync() {
  if (window._lyricsInterval) clearInterval(window._lyricsInterval);
  window._lyricsInterval = setInterval(() => {
    if (!audio.paused && document.querySelector('.synced-lyrics')) {
      const ct = audio.currentTime;
      const lines = document.querySelectorAll('.lyric-line[data-time]');
      let active = null;
      lines.forEach(l => { if (parseFloat(l.dataset.time) <= ct) active = l; });
      lines.forEach(l => l.classList.remove('active'));
      if (active) { active.classList.add('active'); active.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }
  }, 500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GRADIENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateGradient(url) {
  if (!url) return;
  const img = new Image(); img.crossOrigin = 'Anonymous'; img.src = url;
  img.onload = () => {
    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
    c.width = 1; c.height = 1; ctx.drawImage(img, 0, 0, 1, 1);
    const d = ctx.getImageData(0, 0, 1, 1).data;
    document.documentElement.style.setProperty('--gradient-color', `rgb(${d[0]},${d[1]},${d[2]})`);
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function incrementPlay() {
  listeningStats.songsPlayed = (listeningStats.songsPlayed || 0) + 1;
  listeningStats.totalMinutes = (listeningStats.totalMinutes || 0) + 0.5;
  save('listening_stats', listeningStats);
}
function updateStats() {
  const set = (id, v) => { const e = document.getElementById(id); if(e) e.textContent = v; };
  set('statSongs', listeningStats.songsPlayed || 0);
  set('statAlbums', Object.keys(savedAlbums).length);
  set('statPlaylists', Object.keys(playlists).filter(n => n !== 'Liked Songs').length);
  set('statTime', Math.floor((listeningStats.totalMinutes || 0) / 60) + 'h');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST & MINI PLAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(song) {
  const t = document.getElementById('toast');
  const img = document.getElementById('toastImg');
  const title = document.getElementById('toastTitle');
  if (!t) return;
  if (img) { img.src = song.art || ''; img.onerror = () => img.style.display = 'none'; }
  if (title) title.textContent = song.title || 'Unknown';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 4000);
}
function updateMiniPlayer(song) {
  const img = document.getElementById('mpImg');
  const title = document.getElementById('mpTitle');
  const artist = document.getElementById('mpArtist');
  if (img) { img.src = song.art || ''; img.onerror = () => img.style.display = 'none'; }
  if (title) title.textContent = song.title || 'Unknown';
  if (artist) artist.textContent = song.artist || '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addToRecent(song) {
  if (!song?.id) return;
  recent = recent.filter(s => s.id !== song.id);
  recent.unshift(song);
  recent = recent.slice(0, 8);
  save('recent', recent);
  renderRecent();
}
function renderRecent() {
  const el = document.getElementById('recentGrid');
  if (!el) return;
  el.innerHTML = '';
  if (!recent.length) {
    el.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);grid-column:1/-1">No recent songs yet ‚Äî search and play something!</div>';
    return;
  }
  recent.forEach(song => {
    const div = document.createElement('div');
    div.className = 'song-card';
    div.innerHTML = `<img src="${esc(song.art||'')}" alt="" onerror="this.style.display='none'"><div class="song-info"><div class="song-title">${esc(song.title)}</div><div class="song-artist clickable-artist" onclick="event.stopPropagation();showArtistMenu('${esc(song.artist)}')">${esc(song.artist)}</div></div>`;
    div.onclick = () => { currentSongs = recent; playSong(song); };
    div.addEventListener('contextmenu', e => { e.preventDefault(); showCtxMenu(e, song); });
    el.appendChild(div);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALBUMS / POPULAR / ARTISTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderAlbums() {
  const el = document.getElementById('albumsScroll');
  if (!el) return;
  el.innerHTML = '<div style="padding:20px;color:var(--muted)">Loading‚Ä¶</div>';
  const artists = [...new Set(recent.map(s => s.artist).filter(Boolean))].slice(0, 3);
  if (!artists.length) { el.innerHTML = '<div style="padding:20px;color:var(--muted)">Play some songs first</div>'; return; }
  try {
    const results = await Promise.all(artists.map(a => searchDeezer(a, 'album', 2)));
    const albums = results.flat().slice(0, 8);
    el.innerHTML = '';
    albums.forEach(album => {
      const div = document.createElement('div');
      div.className = 'album-card';
      div.innerHTML = `<img src="${esc(album.art)}" alt="" onerror="this.style.background='#333'"><div class="ac-title">${esc(album.title)}</div><div class="ac-artist">${esc(album.artist)}</div>`;
      div.onclick = () => openAlbumView(album.deezerAlbumId, album.title, album.art);
      el.appendChild(div);
    });
  } catch(e) { el.innerHTML = '<div style="padding:20px;color:var(--muted)">Could not load</div>'; }
}

function renderMixes() {
  const el = document.getElementById('mixesScroll');
  if (!el) return;
  el.innerHTML = '';
  if (!recent.length) { el.innerHTML = '<div style="padding:20px;color:var(--muted)">Play some music first</div>'; return; }
  recent.slice(0, 6).forEach(song => {
    const div = document.createElement('div');
    div.className = 'album-card';
    div.innerHTML = `<img src="${esc(song.art||'')}" alt="" onerror="this.style.background='#333'"><div class="ac-title">${esc(song.title)} Mix</div><div class="ac-artist">Based on ${esc(song.artist)}</div>`;
    div.onclick = () => openMix(song);
    el.appendChild(div);
  });
}

async function renderPopular() {
  const el = document.getElementById('popularScroll');
  if (!el) return;
  el.innerHTML = '<div style="padding:20px;color:var(--muted)">Loading‚Ä¶</div>';
  const q = ['pop hits','hip hop','indie','r&b','electronic','chill vibes','top songs'][Math.floor(Math.random()*7)];
  try {
    const tracks = await searchDeezer(q, 'track', 10);
    el.innerHTML = '';
    tracks.forEach(song => {
      const div = document.createElement('div');
      div.className = 'album-card';
      div.innerHTML = `<img src="${esc(song.art)}" alt="" onerror="this.style.background='#333'"><div class="ac-title">${esc(song.title)}</div><div class="ac-artist">${esc(song.artist)}</div>`;
      div.onclick = () => { currentSongs = tracks; playSong(song); };
      el.appendChild(div);
    });
  } catch(e) { el.innerHTML = '<div style="padding:20px;color:var(--muted)">Could not load</div>'; }
}

function renderArtists() {
  const el = document.getElementById('artistsScroll');
  if (!el) return;
  const fromRecent = [...new Set(recent.map(s => s.artist).filter(Boolean))].slice(0, 4);
  const popular = ['Drake','Taylor Swift','The Weeknd','Beyonc√©','Post Malone','Billie Eilish'];
  const all = [...fromRecent, ...popular.filter(a => !fromRecent.includes(a))].slice(0, 8);
  const colors = ['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEAA7','#DDA0DD','#FF9F43','#A29BFE'];
  el.innerHTML = '';
  all.forEach((name, i) => {
    const div = document.createElement('div');
    div.className = 'album-card';
    div.innerHTML = `<div style="width:100%;aspect-ratio:1;background:${colors[i%colors.length]};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:44px;margin-bottom:12px">${name[0].toUpperCase()}</div><div class="ac-title" style="text-align:center">${esc(name)}</div><div class="ac-artist" style="text-align:center">Artist</div>`;
    div.onclick = () => searchArtist(name);
    el.appendChild(div);
  });
}

function renderLibrary() {
  const el = document.getElementById('libraryGrid');
  const sec = document.getElementById('librarySection');
  if (!el || !sec) return;
  const albums = Object.values(savedAlbums);
  if (!albums.length) { sec.style.display = 'none'; return; }
  sec.style.display = 'block';
  el.innerHTML = '';
  albums.sort((a,b) => (b.dateAdded||0)-(a.dateAdded||0)).slice(0,8).forEach(album => {
    const div = document.createElement('div');
    div.className = 'lib-album-card';
    const isNew = Date.now() - (album.dateAdded||0) < 7*24*60*60*1000;
    div.innerHTML = `${isNew?'<div class="new-badge">New</div>':''}<img src="${esc(album.cover)}" alt="" onerror="this.style.background='#333'"><div style="font-size:13px;font-weight:600">${esc(album.name)}</div><div style="font-size:12px;color:var(--muted)">${esc(album.artist)}</div><button class="remove-album-btn" onclick="event.stopPropagation();removeAlbum('${esc(album.id)}')">√ó</button>`;
    div.onclick = () => playAlbumFromLib(album);
    el.appendChild(div);
  });
}

function renderPlaylists() {
  const el = document.getElementById('playlistsList');
  if (!el) return;
  el.innerHTML = '';
  Object.keys(playlists).filter(n => n !== 'Liked Songs').forEach(name => {
    const p = playlists[name];
    const div = document.createElement('div');
    div.className = 'pl-item';
    div.innerHTML = `<span class="pl-icon">${esc(p.emoji||'üéµ')}</span><div class="pl-info"><div class="pl-name">${esc(name)}</div><div class="pl-count">${p.songs?.length||0} songs</div></div>`;
    div.onclick = () => viewPlaylist(name);
    el.appendChild(div);
  });
  Object.values(savedAlbums).sort((a,b)=>(b.dateAdded||0)-(a.dateAdded||0)).forEach(album => {
    const div = document.createElement('div');
    div.className = 'pl-item';
    div.innerHTML = `<img src="${esc(album.cover)}" class="pl-cover" alt="" onerror="this.style.display='none'"><div class="pl-info"><div class="pl-name">${esc(album.name)}</div><div class="pl-count">${album.songs?.length||0} songs</div></div>`;
    div.onclick = () => playAlbumFromLib(album);
    el.appendChild(div);
  });
  Object.values(savedArtists||{}).forEach(artist => {
    const div = document.createElement('div');
    div.className = 'pl-item';
    div.innerHTML = `<span class="pl-icon">üé§</span><div class="pl-info"><div class="pl-name">${esc(artist.name)}</div><div class="pl-count">Artist</div></div>`;
    div.onclick = () => showArtistMenu(artist.name);
    el.appendChild(div);
  });
}

function updateLikedCount() {
  const el = document.getElementById('likedCount');
  if (el) el.textContent = `${playlists['Liked Songs']?.songs?.length||0} songs`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALBUM VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openAlbumView(albumId, albumName, albumArt) {
  notify('Loading album‚Ä¶');
  const songs = await getDeezerAlbumTracks(albumId, albumArt);
  if (!songs.length) { notify('No tracks found'); return; }
  showAlbumView(songs, albumName, albumArt);
}

function showAlbumView(songs, albumName, albumArt, playlistId) {
  const mc = document.getElementById('mainContent');
  if (!mc || !songs?.length) return;
  const cover = albumArt || songs[0]?.art || '';
  mc.innerHTML = `<div class="album-view">
    <button class="back-btn" onclick="showHome()">‚Üê Back</button>
    <div class="av-header">
      <img src="${esc(cover)}" class="av-cover" alt="" onerror="this.style.display='none'">
      <div class="av-info">
        <h1>${esc(albumName)}</h1>
        <p>${songs.length} tracks ¬∑ 30s previews</p>
        <div class="av-actions">
          <button class="play-all-btn" id="playAllBtn">‚ñ∂ Play All</button>
          <button class="save-lib-btn" id="saveLibBtn"><span>+</span> Add to Library</button>
        </div>
      </div>
    </div>
    <div class="song-list" id="songListEl"></div>
  </div>`;

  const listEl = document.getElementById('songListEl');
  songs.forEach((song, i) => {
    const div = document.createElement('div');
    div.className = 'song-row';
    div.innerHTML = `<span class="song-num">${i+1}</span><img src="${esc(song.art||'')}" alt="" onerror="this.style.display='none'"><div class="song-info"><div class="song-title">${esc(song.title)}</div><div class="song-artist">${esc(song.artist)}</div></div>`;
    div.onclick = () => { currentSongs = songs; currentIndex = i; playSong(song); };
    listEl.appendChild(div);
  });

  document.getElementById('playAllBtn').onclick = () => { currentSongs = songs; currentIndex = 0; playSong(songs[0]); };

  const saveBtn = document.getElementById('saveLibBtn');
  const albumId = playlistId || albumName.replace(/\W/g,'_');
  if (savedAlbums[albumId]) { saveBtn.classList.add('saved'); saveBtn.innerHTML = '<span>‚úì</span> In Library'; }
  saveBtn.onclick = () => {
    if (savedAlbums[albumId]) { notify('Already in library'); return; }
    savedAlbums[albumId] = { id: albumId, name: albumName, artist: songs[0]?.artist || 'Various', cover, songs, dateAdded: Date.now() };
    save('indy_saved_albums', savedAlbums);
    saveBtn.classList.add('saved'); saveBtn.innerHTML = '<span>‚úì</span> In Library';
    notify(`Added "${albumName}" to library üéµ`);
    renderLibrary(); renderPlaylists(); updateFilterCounts();
  };
}

function removeAlbum(id) {
  if (!savedAlbums[id]) return;
  const name = savedAlbums[id].name;
  if (confirm(`Remove "${name}" from library?`)) {
    delete savedAlbums[id]; save('indy_saved_albums', savedAlbums);
    notify(`Removed "${name}"`); renderLibrary(); renderPlaylists(); updateFilterCounts();
  }
}

function playAlbumFromLib(album) {
  currentSongs = album.songs; currentIndex = 0;
  showAlbumView(album.songs, album.name, album.cover, album.id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYLIST VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function viewPlaylist(name) {
  if (!playlists[name]) return;
  currentPlaylist = name;
  currentSongs = playlists[name].songs || [];
  const isLocked = name === 'Liked Songs' || playlists[name].locked;
  const mc = document.getElementById('mainContent');
  mc.innerHTML = `<div class="playlist-view">
    <button class="back-btn" onclick="showHome()">‚Üê Back</button>
    <div class="av-header">
      <div class="av-icon">${esc(playlists[name].emoji||'üéµ')}</div>
      <div class="av-info">
        <h1>${esc(name)}</h1>
        <p>${currentSongs.length} songs</p>
        <div class="av-actions">
          ${currentSongs.length ? `<button class="play-all-btn" onclick="currentSongs=${JSON.stringify(currentSongs).replace(/"/g,'&quot;')};currentIndex=0;playSong(currentSongs[0])">‚ñ∂ Play All</button>` : ''}
          ${!isLocked ? `<button class="save-lib-btn" onclick="deletePlaylist('${esc(name)}')">üóëÔ∏è Delete</button>` : ''}
          ${!isLocked ? `<button class="save-lib-btn" onclick="editPlaylist('${esc(name)}')">‚úèÔ∏è Edit</button>` : ''}
        </div>
      </div>
    </div>
    <div class="song-list" id="plSongList"></div>
  </div>`;

  const listEl = document.getElementById('plSongList');
  if (!currentSongs.length) {
    listEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${name === 'Liked Songs' ? 'üíî' : 'üéµ'}</div><p>${name === 'Liked Songs' ? 'No liked songs yet' : 'No songs yet ‚Äî search and add some!'}</p></div>`;
  } else {
    currentSongs.forEach((song, i) => {
      const div = document.createElement('div');
      div.className = 'song-row';
      div.innerHTML = `<span class="song-num">${i+1}</span><img src="${esc(song.art||'')}" alt="" onerror="this.style.display='none'"><div class="song-info"><div class="song-title">${esc(song.title)}</div><div class="song-artist">${esc(song.artist)}</div></div>${!isLocked ? `<button onclick="event.stopPropagation();removeSongFromPl('${esc(name)}','${esc(song.id)}')" style="background:rgba(255,0,0,.2);color:#fff;border:none;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px;margin-left:auto">√ó</button>` : ''}`;
      div.onclick = () => { currentIndex = i; playSong(song); };
      listEl.appendChild(div);
    });
  }
}

function viewLikedSongs() { viewPlaylist('Liked Songs'); }

function isLiked(songId) { return !!playlists['Liked Songs']?.songs?.some(s => s.id === songId); }

function toggleLike(song) {
  if (!song?.id) return;
  const liked = isLiked(song.id);
  if (liked) { playlists['Liked Songs'].songs = playlists['Liked Songs'].songs.filter(s => s.id !== song.id); notify('Removed from Saved Songs'); }
  else { playlists['Liked Songs'].songs.push(song); notify('Added to Saved Songs ‚ù§Ô∏è'); }
  save('playlists', playlists); updateLikedCount();
}

function addToPlaylist(song, plName) {
  if (!playlists[plName]) return;
  if (playlists[plName].songs.some(s => s.id === song.id)) { notify('Already in playlist'); return; }
  playlists[plName].songs.push(song);
  save('playlists', playlists); renderPlaylists();
  notify(`Added to ${plName}`); closeAddMenu();
}

function showAddToPlaylistMenu(song) {
  if (!song) return;
  const names = ['Liked Songs', ...Object.keys(playlists).filter(n => n !== 'Liked Songs')];
  const menu = document.createElement('div');
  menu.className = 'modal active'; menu.id = 'addMenu';
  menu.innerHTML = `<div class="modal-content"><h3>Add to Playlist</h3><div style="max-height:280px;overflow-y:auto;margin-bottom:16px">${names.map(n => `<div class="pl-item" onclick="addToPlaylist(${JSON.stringify(song).replace(/"/g,'&quot;')},'${esc(n)}')" style="cursor:pointer"><span class="pl-icon">${esc(playlists[n]?.emoji||'üéµ')}</span><div class="pl-info"><div class="pl-name">${esc(n)}</div><div class="pl-count">${playlists[n]?.songs?.length||0} songs</div></div></div>`).join('')}</div><div class="modal-btns"><button class="secondary" onclick="closeAddMenu()">Cancel</button></div></div>`;
  document.body.appendChild(menu);
}
function closeAddMenu() { const m = document.getElementById('addMenu'); if(m) m.remove(); }

function removeSongFromPl(name, songId) {
  if (!playlists[name]) return;
  playlists[name].songs = playlists[name].songs.filter(s => s.id !== songId);
  save('playlists', playlists); renderPlaylists(); viewPlaylist(name); notify('Song removed');
}

// Modals
function openCreateModal() { document.getElementById('createModal').classList.add('active'); document.getElementById('plNameInput').focus(); }
function closeCreateModal() {
  document.getElementById('createModal').classList.remove('active');
  document.getElementById('plNameInput').value = '';
  document.getElementById('plEmojiInput').value = '';
}
function createPlaylist() {
  const name = document.getElementById('plNameInput').value.trim();
  const emoji = document.getElementById('plEmojiInput').value.trim() || 'üéµ';
  if (!name) return;
  if (playlists[name]) { alert('Playlist already exists!'); return; }
  playlists[name] = { emoji, songs: [] };
  save('playlists', playlists); renderPlaylists(); closeCreateModal(); notify('Playlist created!');
}
function deletePlaylist(name) {
  if (confirm(`Delete "${name}"?`)) { delete playlists[name]; save('playlists', playlists); renderPlaylists(); showHome(); notify('Deleted'); }
}
function editPlaylist(name) {
  const m = document.createElement('div');
  m.className = 'modal active'; m.id = 'editModal';
  m.innerHTML = `<div class="modal-content"><h3>Edit Playlist</h3><input type="text" id="editName" value="${esc(name)}"><input type="text" id="editEmoji" value="${esc(playlists[name]?.emoji||'üéµ')}" maxlength="2"><div class="modal-btns"><button class="secondary" onclick="this.closest('.modal').remove()">Cancel</button><button class="primary" onclick="savePlaylistEdit('${esc(name)}')">Save</button></div></div>`;
  document.body.appendChild(m);
}
function savePlaylistEdit(oldName) {
  const newName = document.getElementById('editName').value.trim();
  const newEmoji = document.getElementById('editEmoji').value.trim() || 'üéµ';
  if (!newName) { notify('Name cannot be empty'); return; }
  if (newName !== oldName && playlists[newName]) { notify('Name already exists'); return; }
  const songs = playlists[oldName].songs;
  delete playlists[oldName];
  playlists[newName] = { emoji: newEmoji, songs };
  save('playlists', playlists); renderPlaylists();
  document.getElementById('editModal')?.remove();
  notify('Playlist updated');
  if (currentPlaylist === oldName) viewPlaylist(newName); else showHome();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUEUE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addToQueue(song) {
  queue.push(song); save('queue', queue); renderQueue(); notify(`Added to queue: ${song.title}`);
}
function removeFromQueue(i) {
  queue.splice(i, 1); save('queue', queue); renderQueue();
}
function clearQueue() {
  if (!queue.length) return;
  if (confirm(`Clear ${queue.length} songs?`)) { queue = []; save('queue', queue); renderQueue(); notify('Queue cleared'); }
}
function shuffleQueueFn() {
  if (queue.length < 2) return;
  for (let i = queue.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [queue[i],queue[j]] = [queue[j],queue[i]]; }
  save('queue', queue); renderQueue(); notify('Queue shuffled üîÄ');
}
function toggleQueue() { document.getElementById('queuePanel')?.classList.toggle('open'); renderQueue(); }
function renderQueue() {
  const el = document.getElementById('queueList');
  if (!el) return;
  if (!queue.length) { el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéµ</div><p>Queue is empty</p></div>'; return; }
  el.innerHTML = '';
  queue.forEach((song, i) => {
    const div = document.createElement('div');
    div.className = 'queue-item' + (currentPlayingSong?.id === song.id ? ' playing' : '');
    div.innerHTML = `<img src="${esc(song.art||'')}" alt="" onerror="this.style.display='none'"><div class="qi-info"><div class="qi-title">${esc(song.title)}</div><div class="qi-artist">${esc(song.artist)}</div></div><button class="q-remove" onclick="event.stopPropagation();removeFromQueue(${i})">√ó</button>`;
    div.onclick = () => { currentSongs = [...queue]; currentIndex = i; playSong(song); };
    el.appendChild(div);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCH & GENRES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showHome() {
  document.getElementById('homeView').style.display = 'block';
  document.getElementById('searchView').style.display = 'none';
  renderRecent(); renderAlbums(); renderMixes(); renderPopular(); renderArtists(); renderLibrary();
  updateFilterCounts(); setupFilterBtns();
}
function showSearch() {
  document.getElementById('homeView').style.display = 'none';
  const sv = document.getElementById('searchView');
  sv.style.display = 'block';
  renderGenres();
}
function doNavSearch() {
  const inp = document.getElementById('navSearchInput');
  const q = inp.value.trim(); inp.value = '';
  if (!q) { showSearch(); return; }
  showSearch();
  notify('Searching‚Ä¶');
  Promise.all([searchDeezer(q, 'track', 10), searchDeezer(q, 'album', 6)])
    .then(([tracks, albums]) => renderSearchResults(tracks, albums))
    .catch(() => notify('Search failed'));
}

function renderSearchResults(tracks, albums) {
  const el = document.getElementById('searchResults');
  if (!el) return;
  el.innerHTML = '';

  // Artists
  const artMap = new Map();
  tracks.forEach(t => { if (t.artist && !artMap.has(t.artist)) artMap.set(t.artist, { name: t.artist, img: t.art }); });
  if (artMap.size) {
    const sec = document.createElement('div');
    sec.className = 'section';
    sec.innerHTML = '<div class="section-header"><h2>Artists</h2></div><div class="scroll-row" id="sArtists"></div>';
    const sc = sec.querySelector('.scroll-row');
    [...artMap.values()].slice(0,6).forEach(a => {
      const div = document.createElement('div');
      div.className = 'search-artist-card';
      div.innerHTML = `<div class="artist-img-wrap"><img src="${esc(a.img)}" class="artist-img" alt="" onerror="this.style.display='none'"></div><div class="artist-name">${esc(a.name)}</div><div class="artist-type">Artist</div><button class="artist-follow-btn" onclick="event.stopPropagation();showArtistMenu('${esc(a.name)}')">+ Follow</button>`;
      div.onclick = () => searchArtist(a.name);
      sc.appendChild(div);
    });
    el.appendChild(sec);
  }

  // Albums
  if (albums.length) {
    const sec = document.createElement('div');
    sec.className = 'section';
    sec.innerHTML = '<div class="section-header"><h2>Albums</h2></div><div class="scroll-row" id="sAlbums"></div>';
    const sc = sec.querySelector('.scroll-row');
    albums.forEach(album => {
      const div = document.createElement('div');
      div.className = 'search-album-card';
      div.innerHTML = `<img src="${esc(album.art)}" alt="" onerror="this.style.background='#333'"><div class="scard-title">${esc(album.title)}</div><div class="scard-artist">${esc(album.artist)}</div><button class="scard-play-btn" onclick="event.stopPropagation();openAlbumView(${album.deezerAlbumId},'${esc(album.title)}','${esc(album.art)}')">‚ñ∂ Play</button>`;
      div.onclick = () => openAlbumView(album.deezerAlbumId, album.title, album.art);
      sc.appendChild(div);
    });
    el.appendChild(sec);
  }

  // Songs
  if (tracks.length) {
    const sec = document.createElement('div');
    sec.className = 'section';
    sec.innerHTML = '<div class="section-header"><h2>Songs</h2></div><div class="scroll-row" id="sSongs"></div>';
    const sc = sec.querySelector('.scroll-row');
    tracks.forEach(song => {
      const sj = JSON.stringify(song).replace(/"/g,'&quot;');
      const div = document.createElement('div');
      div.className = 'search-song-card';
      div.innerHTML = `<img src="${esc(song.art)}" alt="" onerror="this.style.background='#333'"><div class="search-song-title">${esc(song.title)}</div><div class="search-song-artist">${esc(song.artist)}</div><div class="search-song-actions"><button class="search-action-btn" title="Play" onclick="event.stopPropagation()">‚ñ∂</button><button class="search-action-btn" title="Queue" onclick="event.stopPropagation();addToQueue(${sj})">+</button><button class="search-action-btn" title="Playlist" onclick="event.stopPropagation();showAddToPlaylistMenu(${sj})">üìù</button><button class="search-action-btn ${isLiked(song.id)?'liked':''}" title="Like" onclick="event.stopPropagation();toggleLike(${sj})">‚ù§Ô∏è</button></div>`;
      div.onclick = () => { currentSongs = tracks; playSong(song); };
      div.querySelector('[title="Play"]').onclick = e => { e.stopPropagation(); currentSongs = tracks; playSong(song); };
      div.addEventListener('contextmenu', e => { e.preventDefault(); showCtxMenu(e, song); });
      sc.appendChild(div);
    });
    el.appendChild(sec);
  }
}

async function searchArtist(name) {
  showSearch();
  document.getElementById('searchResults').innerHTML = '<div style="padding:20px;color:var(--muted)">Searching‚Ä¶</div>';
  notify(`Searching "${name}"‚Ä¶`);
  const [tracks, albums] = await Promise.all([searchDeezer(name, 'track', 10), searchDeezer(name, 'album', 6)]);
  renderSearchResults(tracks, albums);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GENRE BROWSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const genres = [
  {name:'Pop',emoji:'üé§',g:'linear-gradient(135deg,#FF6B9D,#C44569)'},
  {name:'Hip Hop',emoji:'üéß',g:'linear-gradient(135deg,#8E44AD,#6C5CE7)'},
  {name:'Rock',emoji:'üé∏',g:'linear-gradient(135deg,#E74C3C,#C0392B)'},
  {name:'Jazz',emoji:'üé∑',g:'linear-gradient(135deg,#3498DB,#2980B9)'},
  {name:'Classical',emoji:'üéª',g:'linear-gradient(135deg,#9B59B6,#8E44AD)'},
  {name:'Electronic',emoji:'üéπ',g:'linear-gradient(135deg,#1ABC9C,#16A085)'},
  {name:'R&B',emoji:'üíø',g:'linear-gradient(135deg,#E67E22,#D35400)'},
  {name:'Country',emoji:'ü§†',g:'linear-gradient(135deg,#F39C12,#E67E22)'},
  {name:'Reggae',emoji:'üå¥',g:'linear-gradient(135deg,#27AE60,#229954)'},
  {name:'Blues',emoji:'üé∫',g:'linear-gradient(135deg,#34495E,#2C3E50)'},
  {name:'Metal',emoji:'‚ö°',g:'linear-gradient(135deg,#95A5A6,#7F8C8D)'},
  {name:'Soul',emoji:'‚ú®',g:'linear-gradient(135deg,#D4AF37,#C19A2E)'},
  {name:'Indie',emoji:'üåô',g:'linear-gradient(135deg,#5DADE2,#3498DB)'},
  {name:'Folk',emoji:'üçÇ',g:'linear-gradient(135deg,#A04000,#7D3C00)'},
  {name:'K-Pop',emoji:'üå∏',g:'linear-gradient(135deg,#FF69B4,#FF1493)'},
  {name:'Lo-fi',emoji:'‚òï',g:'linear-gradient(135deg,#A0826D,#8B7355)'},
  {name:'EDM',emoji:'üí•',g:'linear-gradient(135deg,#00D9FF,#0099CC)'},
  {name:'Trap',emoji:'üî•',g:'linear-gradient(135deg,#FF4757,#EE5A6F)'},
  {name:'Acoustic',emoji:'üéº',g:'linear-gradient(135deg,#6C5B7B,#5B4A6B)'},
  {name:'Ambient',emoji:'üåä',g:'linear-gradient(135deg,#4ECDC4,#44A9A0)'},
  {name:'Latin',emoji:'üíÉ',g:'linear-gradient(135deg,#EC7063,#E74C3C)'},
  {name:'Anime',emoji:'üéå',g:'linear-gradient(135deg,#FF6B9D,#FF1493)'},
  {name:'Afrobeat',emoji:'üåç',g:'linear-gradient(135deg,#28B463,#239B56)'},
  {name:'Bollywood',emoji:'üáÆüá≥',g:'linear-gradient(135deg,#FF9933,#FF6600)'}
];
function renderGenres() {
  const el = document.getElementById('genreGrid');
  if (!el || el.children.length > 0) return;
  genres.forEach(g => {
    const div = document.createElement('div');
    div.className = 'genre-card';
    div.style.background = g.g;
    div.innerHTML = `<div class="genre-emoji">${g.emoji}</div><div class="genre-name">${g.name}</div>`;
    div.onclick = () => {
      document.getElementById('searchResults').innerHTML = '<div style="padding:20px;color:var(--muted)">Searching‚Ä¶</div>';
      searchDeezer(g.name + ' music', 'track', 10).then(tracks => {
        searchDeezer(g.name, 'album', 4).then(albums => renderSearchResults(tracks, albums));
      });
    };
    el.appendChild(div);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function filterContent(type) {
  currentFilter = type;
  document.querySelectorAll('.chip').forEach(c => { c.classList.toggle('active', c.dataset.filter === type); });
  const hide = id => { const e = document.getElementById(id); if(e) e.style.display = 'none'; };
  const show = id => { const e = document.getElementById(id); if(e) e.style.display = 'block'; };
  ['recentSection','albumsSection','mixesSection','popularSection','artistsSection','librarySection','statsCard'].forEach(hide);
  switch(type) {
    case 'all': show('recentSection');show('albumsSection');show('mixesSection');show('popularSection');show('artistsSection');if(Object.keys(savedAlbums).length)show('librarySection'); break;
    case 'songs': show('recentSection');show('popularSection'); break;
    case 'albums': show('albumsSection');if(Object.keys(savedAlbums).length)show('librarySection'); break;
    case 'mixes': show('mixesSection'); break;
    case 'library': if(Object.keys(savedAlbums).length)show('librarySection');show('statsCard');updateStats(); break;
  }
}
function setupFilterBtns() { document.querySelectorAll('.chip').forEach(b => { b.onclick = () => filterContent(b.dataset.filter); }); }
function updateFilterCounts() {
  const s = (id,v) => { const e = document.getElementById(id); if(e) e.textContent = `(${v})`; };
  s('fcAll', recent.length + Object.keys(savedAlbums).length);
  s('fcSongs', recent.length);
  s('fcAlbums', Object.keys(savedAlbums).length);
  s('fcMixes', recent.length > 0 ? recent.length : 0);
  s('fcLib', Object.keys(savedAlbums).length);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MIX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openMix(seedSong) {
  notify(`Building ${seedSong.title} Mix‚Ä¶`);
  const tracks = await searchDeezer(seedSong.artist, 'track', 15);
  if (!tracks.length) { notify("Couldn't generate mix"); return; }
  currentSongs = tracks; currentIndex = 0; currentPlaylist = null;
  const mc = document.getElementById('mainContent');
  mc.innerHTML = `<div class="playlist-view"><button class="back-btn" onclick="showHome()">‚Üê Back</button><div class="av-header"><div class="av-icon">‚ú¶</div><div class="av-info"><h1>${esc(seedSong.title)} Mix</h1><p>${tracks.length} songs</p><div class="av-actions"><button class="play-all-btn" onclick="currentSongs=tracks;currentIndex=0;playSong(currentSongs[0])">‚ñ∂ Play</button></div></div></div><div class="song-list" id="mixList"></div></div>`;
  const list = document.getElementById('mixList');
  tracks.forEach((song, i) => {
    const div = document.createElement('div'); div.className = 'song-row';
    div.innerHTML = `<span class="song-num">${i+1}</span><img src="${esc(song.art)}" alt="" onerror="this.style.display='none'"><div class="song-info"><div class="song-title">${esc(song.title)}</div><div class="song-artist">${esc(song.artist)}</div></div>`;
    div.onclick = () => { currentIndex = i; playSong(song); };
    list.appendChild(div);
  });
  document.getElementById('mixList').closest('.playlist-view').querySelector('.play-all-btn').onclick = () => { currentSongs = tracks; currentIndex = 0; playSong(tracks[0]); };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTEXT MENU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showCtxMenu(e, song) {
  e.preventDefault(); e.stopPropagation();
  ctxTarget = song;
  const m = document.getElementById('ctxMenu');
  m.style.left = Math.min(e.clientX, window.innerWidth - 220) + 'px';
  m.style.top = Math.min(e.clientY, window.innerHeight - 200) + 'px';
  m.classList.add('show');
  const close = () => { m.classList.remove('show'); document.removeEventListener('click', close); };
  setTimeout(() => document.addEventListener('click', close), 50);
}
function ctxAction(action) {
  const song = ctxTarget;
  document.getElementById('ctxMenu')?.classList.remove('show');
  if (!song) return;
  switch(action) {
    case 'play': currentSongs = [song]; currentIndex = 0; playSong(song); break;
    case 'queue': addToQueue(song); break;
    case 'playlist': showAddToPlaylistMenu(song); break;
    case 'like': toggleLike(song); break;
    case 'info': openSongInfoCard(song); break;
    case 'share': navigator.clipboard?.writeText(`${song.title} - ${song.artist}`).then(()=>notify('Copied!')); break;
  }
}
document.addEventListener('click', () => document.getElementById('ctxMenu')?.classList.remove('show'));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ARTIST MENU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showArtistMenu(name) {
  const id = name.replace(/\W/g,'_');
  const inLib = savedArtists[id];
  const m = document.createElement('div');
  m.className = 'modal active'; m.id = 'artistMenu';
  m.innerHTML = `<div class="modal-content" style="max-width:340px"><h3>üé§ ${esc(name)}</h3><button class="link-opt" onclick="searchArtist('${esc(name)}');closeArtistMenu()"><span style="font-size:24px">üîç</span><div><div>Search Songs</div><div style="font-size:12px;color:var(--muted)">Find music by this artist</div></div></button>${inLib?`<button class="link-opt" onclick="closeArtistMenu()"><span style="font-size:24px">‚úì</span><div><div>In Library</div></div></button>`:`<button class="link-opt" onclick="addArtistToLib('${esc(name)}');closeArtistMenu()"><span style="font-size:24px">‚ûï</span><div><div>Add to Library</div></div></button>`}<div class="modal-btns" style="margin-top:16px"><button class="secondary" onclick="closeArtistMenu()">Close</button></div></div>`;
  document.body.appendChild(m);
}
function closeArtistMenu() { document.getElementById('artistMenu')?.remove(); }
function addArtistToLib(name) {
  const id = name.replace(/\W/g,'_');
  if (savedArtists[id]) { notify('Already in library'); return; }
  savedArtists[id] = { id, name, dateAdded: Date.now() };
  save('indy_saved_artists', savedArtists);
  notify(`Added ${name} to library üé§`);
  renderPlaylists();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR TOGGLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleLeft() { document.getElementById('leftSidebar').classList.toggle('minimized'); }
function toggleRight() { document.getElementById('rightSidebar').classList.toggle('minimized'); }

// Mini player on scroll
document.getElementById('mainContent')?.addEventListener('scroll', e => {
  const mp = document.getElementById('miniPlayer');
  if (!mp) return;
  if (e.target.scrollTop > 300 && currentPlayingSong) mp.classList.add('show');
  else mp.classList.remove('show');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LINK / EXPORT / IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function linkIndy() {
  const m = document.createElement('div');
  m.className = 'modal active'; m.id = 'linkModal';
  m.innerHTML = `<div class="modal-content" style="max-width:500px"><h3>üîó Share & Connect</h3>
    <button class="link-opt" onclick="shareCurrentSong();closeLinkModal()"><span style="font-size:28px">üéµ</span><div><div>Share Current Song</div><div style="font-size:13px;color:var(--muted)">Copy song info</div></div></button>
    <button class="link-opt" onclick="exportData();closeLinkModal()"><span style="font-size:28px">üíæ</span><div><div>Export All Data</div><div style="font-size:13px;color:var(--muted)">Download as JSON</div></div></button>
    <button class="link-opt" onclick="document.getElementById('importFileInput').click()"><span style="font-size:28px">üì•</span><div><div>Import from File</div><div style="font-size:13px;color:var(--muted)">Restore from backup</div></div></button>
    <button class="link-opt" onclick="shareStats();closeLinkModal()"><span style="font-size:28px">üìä</span><div><div>Share My Stats</div><div style="font-size:13px;color:var(--muted)">Copy stats to clipboard</div></div></button>
    <button class="link-opt" onclick="clearAllData()" style="color:#ff6b6b"><span style="font-size:28px">üóëÔ∏è</span><div><div>Reset Everything</div><div style="font-size:13px;opacity:.7">Clear all data</div></div></button>
    <input type="file" id="importFileInput" accept=".json" style="display:none">
    <div class="modal-btns" style="margin-top:16px"><button class="secondary" onclick="closeLinkModal()">Close</button></div>
  </div>`;
  document.body.appendChild(m);
  document.getElementById('importFileInput').onchange = e => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = ev => { try { importData(JSON.parse(ev.target.result)); } catch(e) { notify('‚ùå Invalid file'); } };
    reader.readAsText(f);
  };
}
function closeLinkModal() { document.getElementById('linkModal')?.remove(); }
function shareCurrentSong() {
  if (!currentPlayingSong) { notify('Nothing playing'); return; }
  navigator.clipboard?.writeText(`${currentPlayingSong.title} - ${currentPlayingSong.artist}`).then(() => notify('Copied to clipboard! üîó'));
}
function exportData() {
  const data = { version: '3.0', exportDate: new Date().toISOString(), playlists, recent, savedAlbums, savedArtists, listeningStats, queue };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `indy-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click(); URL.revokeObjectURL(url);
  notify('üíæ Exported!');
}
function importData(data) {
  if (!data?.version) { notify('‚ùå Invalid backup'); return; }
  if (confirm('This will replace all current data. Continue?')) {
    if (data.playlists) { playlists = data.playlists; save('playlists', playlists); }
    if (data.recent) { recent = data.recent; save('recent', recent); }
    if (data.savedAlbums) { savedAlbums = data.savedAlbums; save('indy_saved_albums', savedAlbums); }
    if (data.savedArtists) { savedArtists = data.savedArtists; save('indy_saved_artists', savedArtists); }
    if (data.listeningStats) { listeningStats = data.listeningStats; save('listening_stats', listeningStats); }
    if (data.queue) { queue = data.queue; save('queue', queue); }
    notify('‚úÖ Imported!'); closeLinkModal();
    setTimeout(() => location.reload(), 1000);
  }
}
function shareStats() {
  const txt = `üéµ My INDY Music Stats\n\nüìä Songs Played: ${listeningStats.songsPlayed||0}\nüíø Albums Saved: ${Object.keys(savedAlbums).length}\nüìù Playlists: ${Object.keys(playlists).filter(n=>n!=='Liked Songs').length}\n‚ù§Ô∏è Liked: ${playlists['Liked Songs']?.songs?.length||0}\n‚è±Ô∏è Time: ${Math.floor((listeningStats.totalMinutes||0)/60)}h\n\nPlayed on INDY Music`;
  navigator.clipboard?.writeText(txt).then(() => notify('üìã Stats copied!'));
}
function clearAllData() {
  const c = prompt('Type "DELETE ALL" to confirm:');
  if (c === 'DELETE ALL') { localStorage.clear(); notify('üóëÔ∏è Cleared'); closeLinkModal(); setTimeout(() => location.reload(), 1000); }
  else if (c !== null) notify('‚ùå Cancelled');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI FEATURES (Groq)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function groqChat(prompt, maxTokens = 300) {
  const r = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` },
    body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: [{ role: 'user', content: prompt }], temperature: 0.8, max_tokens: maxTokens })
  });
  const data = await r.json();
  let text = data.choices?.[0]?.message?.content || '';
  return text.replace(/```json|```/g, '').trim();
}

function buildCtx() {
  return `My recently played: ${recent.slice(0,8).map(s=>`"${s.title}" by ${s.artist}`).join(', ')}. Liked songs count: ${playlists['Liked Songs']?.songs?.length||0}.`;
}

// ‚îÄ‚îÄ MOOD DETECTOR ‚îÄ‚îÄ
function openMoodDetector() {
  if (recent.length === 0) { notify('Play some songs first for mood analysis!'); return; }
  const overlay = makeOverlay('moodOverlay');
  overlay.innerHTML = `<div style="width:100%;max-width:440px;background:rgba(18,18,18,.98);border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.8)">
    <div style="padding:22px 24px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800">üé≠ Mood Detector</div><div style="font-size:12px;color:rgba(255,255,255,.35);margin-top:1px">Analyzing your listening vibe‚Ä¶</div></div>
      <button onclick="document.getElementById('moodOverlay').remove()" ${closeBtn}>√ó</button>
    </div>
    <div id="moodContent" style="padding:28px 24px;text-align:center"><div style="font-size:48px;margin-bottom:12px">üîç</div><div style="color:rgba(255,255,255,.4);font-size:14px">Analyzing your vibe‚Ä¶</div></div>
    <div style="padding:0 24px 22px;display:flex;gap:8px" id="moodActions"></div>
  </div>`;
  document.body.appendChild(overlay);
  showOverlay(overlay);
  analyzeMood();
}

async function analyzeMood() {
  const songs = recent.slice(0,8).map(s=>`"${s.title}" by ${s.artist}`).join(', ');
  try {
    const text = await groqChat(`Analyze the mood of: ${songs}. Reply ONLY as JSON: {"emoji":"one emoji","mood":"2-3 word label","description":"one sentence","color":"css hex color","suggestion":"one short suggestion"}`);
    const mood = JSON.parse(text);
    const c = document.getElementById('moodContent');
    if (!c) return;
    c.innerHTML = `<div style="width:90px;height:90px;border-radius:50%;background:${mood.color}22;border:2px solid ${mood.color}55;display:flex;align-items:center;justify-content:center;font-size:44px;margin:0 auto 20px">${mood.emoji}</div><div style="font-family:'Syne',sans-serif;font-size:26px;font-weight:800;margin-bottom:8px">${mood.mood}</div><div style="font-size:14px;color:rgba(255,255,255,.6);line-height:1.6;margin-bottom:16px">${mood.description}</div><div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px 16px;font-size:13px;color:rgba(255,255,255,.5)">üí° ${mood.suggestion}</div>`;
    const a = document.getElementById('moodActions');
    if (a) { a.style.display = 'flex'; a.innerHTML = `<button onclick="document.getElementById('moodOverlay').remove()" ${actBtn}>Close</button>`; }
  } catch(e) {
    const c = document.getElementById('moodContent');
    if (c) c.innerHTML = `<div style="color:rgba(255,255,255,.4);font-size:14px">Couldn't analyze mood right now.</div>`;
  }
}

// ‚îÄ‚îÄ LISTENING RECAP ‚îÄ‚îÄ
function openListeningRecap() {
  const topArtists = {};
  recent.forEach(s => { if (s.artist) topArtists[s.artist] = (topArtists[s.artist]||0)+1; });
  const sorted = Object.entries(topArtists).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const overlay = makeOverlay('recapOverlay');
  overlay.innerHTML = `<div style="width:100%;max-width:500px;background:rgba(18,18,18,.98);border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.8)">
    <div style="padding:22px 24px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800">üìä Your Listening Recap</div><div style="font-size:12px;color:rgba(255,255,255,.35);margin-top:1px">All time on this device</div></div>
      <button onclick="document.getElementById('recapOverlay').remove()" ${closeBtn}>√ó</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;border-bottom:1px solid rgba(255,255,255,.06)">
      ${[[listeningStats.songsPlayed||0,'Songs'],[Math.floor((listeningStats.totalMinutes||0)/60)+'h','Listened'],[Object.keys(playlists).filter(n=>n!=='Liked Songs').length,'Playlists']].map(([v,l])=>`<div style="padding:22px 16px;text-align:center;border-right:1px solid rgba(255,255,255,.06)"><div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;margin-bottom:4px">${v}</div><div style="font-size:12px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px">${l}</div></div>`).join('')}
    </div>
    <div style="padding:20px 24px">
      <div style="font-size:11px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px;font-weight:600">Top Artists</div>
      ${sorted.length ? sorted.map(([artist,count],i)=>`<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px"><span style="font-size:13px;color:rgba(255,255,255,.3);min-width:18px;text-align:right">${i+1}</span><div style="flex:1;background:rgba(255,255,255,.04);border-radius:6px;height:36px;position:relative;overflow:hidden"><div style="position:absolute;left:0;top:0;bottom:0;width:${Math.round((count/(sorted[0][1]||1))*100)}%;background:rgba(255,255,255,.07);border-radius:6px"></div><span style="position:relative;padding:0 12px;line-height:36px;font-size:14px;font-weight:600">${esc(artist)}</span></div><span style="font-size:12px;color:rgba(255,255,255,.35);min-width:30px;text-align:right">${count}x</span></div>`).join('') : '<div style="color:rgba(255,255,255,.3);font-size:14px">No data yet ‚Äî play some music!</div>'}
    </div>
    <div style="padding:0 24px 22px"><button onclick="document.getElementById('recapOverlay').remove()" ${actBtn} style="width:100%">Close</button></div>
  </div>`;
  document.body.appendChild(overlay);
  showOverlay(overlay);
}

// ‚îÄ‚îÄ QUICK PLAYLIST BUILDER ‚îÄ‚îÄ
function openQuickPlaylistBuilder() {
  const overlay = makeOverlay('qpbOverlay');
  overlay.innerHTML = `<div style="width:100%;max-width:520px;background:rgba(18,18,18,.98);border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.8)">
    <div style="padding:22px 24px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800">‚ú¶ Quick Playlist Builder</div><div style="font-size:12px;color:rgba(255,255,255,.35);margin-top:1px">Describe a vibe, AI does the rest</div></div>
      <button onclick="document.getElementById('qpbOverlay').remove()" ${closeBtn}>√ó</button>
    </div>
    <div style="padding:20px 24px 0">
      <div style="font-size:11px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;font-weight:600">Try one of these</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:18px">${['Late night drive üåô','Gym energy ‚ö°','Rainy afternoon ‚òî','Summer road trip üöó','Focus & study üìö','Feel-good Friday üéâ'].map(v=>`<button onclick="document.getElementById('qpbInput').value='${v}'" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:6px 14px;color:rgba(255,255,255,.7);font-size:13px;cursor:pointer">${v}</button>`).join('')}</div>
      <input id="qpbInput" type="text" placeholder="Or describe your own vibe‚Ä¶" style="width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:13px 16px;color:var(--text);font-size:14px;outline:none;font-family:'DM Sans',sans-serif;margin-bottom:10px" onkeypress="if(event.key==='Enter')buildQPB()">
    </div>
    <div id="qpbResult" style="padding:0 24px;min-height:0"></div>
    <div style="padding:14px 24px 22px;display:flex;gap:8px">
      <button onclick="buildQPB()" id="qpbBtn" ${actBtn} style="flex:1">‚ú¶ Build Playlist</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  showOverlay(overlay);
  setTimeout(() => document.getElementById('qpbInput')?.focus(), 50);
}

async function buildQPB() {
  const input = document.getElementById('qpbInput');
  const vibe = input?.value.trim();
  if (!vibe) { notify('Describe a vibe first!'); return; }
  const btn = document.getElementById('qpbBtn');
  const result = document.getElementById('qpbResult');
  if (btn) btn.textContent = 'Building‚Ä¶';
  if (result) result.innerHTML = `<div style="text-align:center;padding:20px 0;color:rgba(255,255,255,.35);font-size:14px">‚ú¶ Asking AI‚Ä¶</div>`;
  try {
    const text = await groqChat(`Create a playlist for: "${vibe}". Reply ONLY as JSON: {"name":"short name","emoji":"one emoji","songs":[{"title":"...","artist":"..."}]} Include exactly 8 songs. No markdown.`, 400);
    const pl = JSON.parse(text);
    if (result) result.innerHTML = `<div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:16px;margin-bottom:14px"><div style="font-size:22px;margin-bottom:6px">${pl.emoji}</div><div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:12px">${esc(pl.name)}</div><div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow-y:auto">${pl.songs.map((s,i)=>`<div style="display:flex;align-items:center;gap:10px;font-size:13px"><span style="color:rgba(255,255,255,.25);min-width:18px">${i+1}</span><span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(s.title)}</span><span style="color:rgba(255,255,255,.4);white-space:nowrap">${esc(s.artist)}</span></div>`).join('')}</div></div><div style="display:flex;gap:8px;margin-bottom:6px"><button onclick="playQPB(${JSON.stringify(pl).replace(/"/g,'&quot;')})" ${actBtn} style="flex:1">‚ñ∂ Play Now</button><button onclick="saveQPB(${JSON.stringify(pl).replace(/"/g,'&quot;')})" ${secBtn}>+ Save</button></div>`;
    if (btn) btn.textContent = '‚ú¶ Rebuild';
  } catch(e) {
    if (result) result.innerHTML = `<div style="color:rgba(255,255,255,.4);font-size:14px;padding:16px 0">Couldn't build playlist right now.</div>`;
    if (btn) btn.textContent = '‚ú¶ Build Playlist';
  }
}

async function playQPB(pl) {
  document.getElementById('qpbOverlay')?.remove();
  notify(`‚ú¶ Finding songs for "${pl.name}"‚Ä¶`);
  const found = [];
  for (const s of pl.songs.slice(0, 8)) {
    try {
      const tracks = await searchDeezer(`${s.title} ${s.artist}`, 'track', 1);
      if (tracks.length) found.push(tracks[0]);
    } catch(e) {}
  }
  if (found.length) { currentSongs = found; currentIndex = 0; playSong(found[0]); notify(`${pl.emoji} Playing "${pl.name}"`); }
  else notify('Could not find songs');
}

function saveQPB(pl) {
  const name = `${pl.emoji} ${pl.name}`;
  if (playlists[name]) { notify('Already saved!'); return; }
  playlists[name] = { emoji: pl.emoji, songs: [] };
  save('playlists', playlists); renderPlaylists();
  notify(`Saved "${name}"`);
  document.getElementById('qpbOverlay')?.remove();
}

// ‚îÄ‚îÄ SONG INFO CARD ‚îÄ‚îÄ
function openSongInfoCard(song) {
  if (!song) song = currentPlayingSong;
  if (!song) { notify('Nothing playing right now'); return; }
  const overlay = makeOverlay('songInfoOverlay');
  overlay.innerHTML = `<div style="width:100%;max-width:480px;background:rgba(18,18,18,.98);border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.8)">
    <div style="display:flex;align-items:center;gap:16px;padding:22px 24px;border-bottom:1px solid rgba(255,255,255,.06)">
      <img src="${esc(song.art||'')}" style="width:56px;height:56px;border-radius:8px;object-fit:cover;flex-shrink:0;background:rgba(255,255,255,.05)">
      <div style="flex:1;min-width:0"><div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(song.title)}</div><div style="font-size:13px;color:rgba(255,255,255,.4);margin-top:2px">${esc(song.artist)}</div></div>
      <button onclick="document.getElementById('songInfoOverlay').remove()" ${closeBtn}>√ó</button>
    </div>
    <div id="songInfoContent" style="padding:24px;text-align:center"><div style="color:rgba(255,255,255,.3);font-size:14px">Loading info‚Ä¶</div></div>
  </div>`;
  document.body.appendChild(overlay);
  showOverlay(overlay);
  fetchSongInfo(song);
}

async function fetchSongInfo(song) {
  const c = document.getElementById('songInfoContent');
  try {
    const text = await groqChat(`Tell me about "${song.title}" by ${song.artist}. Reply ONLY as JSON: {"year":"year or decade","genre":"main genre","mood":"2-3 word mood","fact":"one interesting fact (1-2 sentences)","similar":["Artist One","Artist Two","Artist Three"]}`, 300);
    const info = JSON.parse(text);
    if (!c) return;
    c.style.textAlign = 'left';
    c.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px">${[info.year,info.genre,info.mood].filter(Boolean).map(tag=>`<span style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:5px 12px;font-size:13px;font-weight:500">${esc(tag)}</span>`).join('')}</div><div style="margin-bottom:20px"><div style="font-size:11px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;font-weight:600">Did you know</div><div style="font-size:14px;color:rgba(255,255,255,.8);line-height:1.7">${esc(info.fact)}</div></div><div><div style="font-size:11px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;font-weight:600">You might also like</div><div style="display:flex;gap:8px;flex-wrap:wrap">${(info.similar||[]).map(a=>`<button onclick="searchArtist('${esc(a)}');document.getElementById('songInfoOverlay')?.remove()" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:7px 14px;color:rgba(255,255,255,.7);font-size:13px;cursor:pointer">${esc(a)}</button>`).join('')}</div></div>`;
  } catch(e) {
    if (c) c.innerHTML = `<div style="color:rgba(255,255,255,.4);font-size:14px">Couldn't load song info right now.</div>`;
  }
}

// ‚îÄ‚îÄ DAILY MIX ‚îÄ‚îÄ
function openDailyMix() {
  const today = new Date().toDateString();
  const cached = load('daily_mix_cache', null);
  const overlay = makeOverlay('dailyMixOverlay');
  overlay.innerHTML = `<div style="width:100%;max-width:500px;background:rgba(18,18,18,.98);border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.8)">
    <div style="padding:22px 24px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800">üéµ Daily Mix</div><div style="font-size:12px;color:rgba(255,255,255,.35);margin-top:1px">Fresh for ${today}</div></div>
      <button onclick="document.getElementById('dailyMixOverlay').remove()" ${closeBtn}>√ó</button>
    </div>
    <div id="dailyMixContent" style="padding:24px"><div style="text-align:center;color:rgba(255,255,255,.3);font-size:14px">Building your mix‚Ä¶</div></div>
    <div style="padding:0 24px 22px;display:flex;gap:8px" id="dailyMixActions"></div>
  </div>`;
  document.body.appendChild(overlay);
  showOverlay(overlay);
  if (cached?.date === today && cached?.songs?.length) renderDailyMixUI(cached.songs, cached.theme, true);
  else generateDailyMix(today);
}

async function generateDailyMix(today) {
  try {
    const ctx = buildCtx();
    const hour = new Date().getHours();
    const timeHint = hour < 12 ? 'morning energizing' : hour < 17 ? 'afternoon focus' : hour < 21 ? 'evening wind-down' : 'late night chill';
    const text = await groqChat(`${ctx}\nCreate a ${timeHint} daily mix. Reply ONLY as JSON: {"theme":"short name","description":"one sentence","songs":[{"title":"...","artist":"..."}]} Include exactly 10 songs. No markdown.`, 500);
    const mix = JSON.parse(text);
    save('daily_mix_cache', { date: today || new Date().toDateString(), songs: mix.songs, theme: mix.theme, description: mix.description });
    renderDailyMixUI(mix.songs, mix.theme, false, mix.description);
  } catch(e) {
    const c = document.getElementById('dailyMixContent');
    if (c) c.innerHTML = `<div style="color:rgba(255,255,255,.4);font-size:14px;text-align:center">Couldn't generate mix right now.</div>`;
  }
}

function renderDailyMixUI(songs, theme, fromCache, description = '') {
  const c = document.getElementById('dailyMixContent');
  const a = document.getElementById('dailyMixActions');
  if (!c) return;
  c.innerHTML = `${description?`<div style="font-size:14px;color:rgba(255,255,255,.5);margin-bottom:18px;line-height:1.5">${esc(description)}</div>`:''}<div style="display:flex;flex-direction:column;gap:7px;max-height:260px;overflow-y:auto">${songs.map((s,i)=>`<div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:8px;font-size:14px"><span style="color:rgba(255,255,255,.25);font-size:12px;min-width:18px">${i+1}</span><div style="flex:1;min-width:0"><div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(s.title)}</div><div style="font-size:12px;color:rgba(255,255,255,.4)">${esc(s.artist)}</div></div></div>`).join('')}</div>`;
  if (a) a.innerHTML = `<button onclick="playDailyMix()" ${actBtn} style="flex:1">‚ñ∂ Play Mix</button><button onclick="save('daily_mix_cache',null);generateDailyMix()" ${secBtn} title="Regenerate">‚Ü∫</button>`;
}

async function playDailyMix() {
  const cached = load('daily_mix_cache', null);
  if (!cached?.songs) return;
  document.getElementById('dailyMixOverlay')?.remove();
  notify('‚ú¶ Loading Daily Mix‚Ä¶');
  const found = [];
  for (const s of cached.songs.slice(0, 10)) {
    try {
      const tracks = await searchDeezer(`${s.title} ${s.artist}`, 'track', 1);
      if (tracks.length) found.push(tracks[0]);
    } catch(e) {}
  }
  if (found.length) { currentSongs = found; currentIndex = 0; playSong(found[0]); notify(`üéµ Daily Mix ‚Äî ${found.length} songs`); }
}

// ‚îÄ‚îÄ AI DJ ‚îÄ‚îÄ
let djHistory = [];

function openAIDJ() {
  const overlay = makeOverlay('djOverlay');
  overlay.innerHTML = `<div style="width:100%;max-width:560px;height:80vh;background:rgba(12,12,12,.99);border:1px solid rgba(255,255,255,.1);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 24px 64px rgba(0,0,0,.9)">
    <div style="padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center;flex-shrink:0">
      <div><div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800">üéß AI DJ</div><div style="font-size:12px;color:rgba(255,255,255,.35);margin-top:1px">Your personal music curator</div></div>
      <button onclick="document.getElementById('djOverlay').remove()" ${closeBtn}>√ó</button>
    </div>
    <div id="djMessages" style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px">
      <div style="background:rgba(255,255,255,.06);border-radius:12px;padding:14px 16px;font-size:14px;line-height:1.6;align-self:flex-start;max-width:85%">Hey! I'm your AI DJ üéµ Tell me what you're feeling ‚Äî I can suggest songs, create a vibe, explain music, or help you discover new artists. What's up?</div>
    </div>
    <div style="padding:16px;border-top:1px solid rgba(255,255,255,.08);flex-shrink:0">
      <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">${['Suggest something','Current mood?','Play something energetic','What artists like mine?'].map(s=>`<button onclick="sendDJ('${s}')" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:5px 12px;color:rgba(255,255,255,.7);font-size:12px;cursor:pointer">${s}</button>`).join('')}</div>
      <div style="display:flex;gap:8px">
        <input id="djInput" type="text" placeholder="Ask me anything about music‚Ä¶" style="flex:1;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:11px 14px;color:var(--text);font-size:14px;outline:none;font-family:'DM Sans',sans-serif" onkeypress="if(event.key==='Enter')sendDJ()">
        <button onclick="sendDJ()" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.15);color:var(--text);padding:11px 18px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer">Send</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  showOverlay(overlay);
  djHistory = [{ role: 'system', content: `You are an expert music DJ and curator. ${buildCtx()} Be concise, enthusiastic, and recommend specific songs/artists when relevant. If suggesting songs to play, mention them clearly.` }];
  setTimeout(() => document.getElementById('djInput')?.focus(), 100);
}

async function sendDJ(preset) {
  const input = document.getElementById('djInput');
  const msg = preset || input?.value.trim();
  if (!msg) return;
  if (input) input.value = '';
  const msgs = document.getElementById('djMessages');
  if (!msgs) return;

  // Add user bubble
  const userBubble = document.createElement('div');
  userBubble.style.cssText = 'background:rgba(255,255,255,.1);border-radius:12px;padding:12px 14px;font-size:14px;line-height:1.6;align-self:flex-end;max-width:85%;text-align:right';
  userBubble.textContent = msg;
  msgs.appendChild(userBubble);
  msgs.scrollTop = msgs.scrollHeight;

  // Loading bubble
  const loadBubble = document.createElement('div');
  loadBubble.style.cssText = 'background:rgba(255,255,255,.06);border-radius:12px;padding:12px 14px;font-size:14px;align-self:flex-start;color:rgba(255,255,255,.4)';
  loadBubble.textContent = '‚Ä¶';
  msgs.appendChild(loadBubble);
  msgs.scrollTop = msgs.scrollHeight;

  djHistory.push({ role: 'user', content: msg });

  try {
    const r = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` },
      body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: djHistory, temperature: 0.8, max_tokens: 400 })
    });
    const data = await r.json();
    const reply = data.choices?.[0]?.message?.content || 'Sorry, I hit a snag!';
    djHistory.push({ role: 'assistant', content: reply });
    loadBubble.style.color = 'rgba(255,255,255,.9)';
    loadBubble.innerHTML = reply.replace(/\n/g, '<br>');
    msgs.scrollTop = msgs.scrollHeight;

    // Auto-search if DJ mentions a song
    const songMatch = reply.match(/"([^"]+)" by ([^.,\n]+)/);
    if (songMatch) {
      setTimeout(async () => {
        const tracks = await searchDeezer(`${songMatch[1]} ${songMatch[2]}`, 'track', 1);
        if (tracks.length) {
          const playBtn = document.createElement('button');
          playBtn.style.cssText = 'background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:var(--text);padding:8px 14px;border-radius:20px;font-size:13px;cursor:pointer;margin-top:8px;display:block';
          playBtn.textContent = `‚ñ∂ Play "${tracks[0].title}"`;
          playBtn.onclick = () => playSong(tracks[0]);
          loadBubble.appendChild(playBtn);
        }
      }, 200);
    }
  } catch(e) {
    loadBubble.textContent = 'Oops, something went wrong. Try again!';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERLAY HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const closeBtn = `style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:var(--text);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center" onmouseover="this.style.background='rgba(255,255,255,.1)'" onmouseout="this.style.background='rgba(255,255,255,.06)'"`;
const actBtn = `style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:10px;color:var(--text);padding:12px;font-size:14px;font-weight:600;cursor:pointer" onmouseover="this.style.background='rgba(255,255,255,.18)'" onmouseout="this.style.background='rgba(255,255,255,.1)'"`;
const secBtn = `style="background:transparent;border:1px solid rgba(255,255,255,.1);border-radius:10px;color:rgba(255,255,255,.5);padding:12px 16px;font-size:13px;cursor:pointer" onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,.5)'"`;

function makeOverlay(id) {
  document.getElementById(id)?.remove();
  const o = document.createElement('div');
  o.id = id;
  o.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.85);backdrop-filter:blur(16px);display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;transition:opacity .3s ease';
  o.addEventListener('click', e => { if (e.target === o) o.remove(); });
  return o;
}
function showOverlay(o) { document.body.appendChild(o); requestAnimationFrame(() => { o.style.opacity = '1'; }); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYBOARD SHORTCUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  switch(e.key) {
    case ' ': e.preventDefault(); togglePlay(); break;
    case 'ArrowRight': e.preventDefault(); skipNext(); break;
    case 'ArrowLeft': e.preventDefault(); skipPrev(); break;
    case 'q': case 'Q': toggleQueue(); break;
    case 's': case 'S': if (!e.ctrlKey && !e.metaKey) toggleShuffle(); break;
    case 'r': case 'R': toggleRepeat(); break;
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init() {
  recent = load('recent', []);
  playlists = load('playlists', {});
  savedAlbums = load('indy_saved_albums', {});
  savedArtists = load('indy_saved_artists', {});
  listeningStats = load('listening_stats', { songsPlayed: 0, totalMinutes: 0 });
  queue = load('queue', []);

  if (!playlists['Liked Songs']) {
    playlists['Liked Songs'] = { emoji: '‚ù§Ô∏è', songs: [], locked: true };
    save('playlists', playlists);
  }

  renderRecent();
  renderPlaylists();
  renderAlbums();
  renderMixes();
  renderPopular();
  renderArtists();
  renderLibrary();
  updateLikedCount();
  updateFilterCounts();
  updateStats();
  setupFilterBtns();

  console.log('üéµ INDY Music (Deezer Edition) initialized!');
}

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();
</script>
</body>
</html>
