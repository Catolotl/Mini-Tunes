<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>INDY Music</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
    --bg: #0a0a0a;
    --panel: #1a1a1a;
    --sidebar-bg: #252525;
    --soft: #2a2a2a;
    --hover: #333333;
    --accent: #ffffff;
    --accent-dim: #eaeaea;
    --text: #ffffff;
    --muted: #b3b3b3;
    --glow: rgba(29, 185, 84, .3);
    --gradient-color: #517c7a;
    --border: rgba(255, 255, 255, .08);
}

*{
    box-sizing:border-box;
    margin:0;
    padding:0;
}

body{
    font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
    background:var(--bg);
    color:var(--text);
    overflow:hidden;
    height:100vh;
}

.app-container{
    display:flex;
    height:100vh;
    gap:12px;
    padding:12px;
}

/* LEFT SIDEBAR */
.left-sidebar{
    width:280px;
    display:flex;
    flex-direction:column;
    gap:12px;
    transition:width .3s;
}

.left-sidebar.minimized{
    width:80px;
}

.sidebar-top{
    background:var(--sidebar-bg);
    border-radius:12px;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:16px;
}

.logo{
    font-size:24px;
    font-weight:900;
    color:var(--text);
    letter-spacing:-1px;
    text-align:left;
}

.nav-buttons{
    display:flex;
    flex-direction:column;
    gap:8px;
}

.nav-btn{
    padding:12px 16px;
    background:transparent;
    border:none;
    color:var(--muted);
    border-radius:8px;
    cursor:pointer;
    transition:all .2s;
    display:flex;
    align-items:center;
    gap:12px;
    font-size:15px;
    font-weight:600;
}

.nav-btn:hover{
    background:var(--hover);
    color:var(--text);
}

.nav-btn.active{
    background:var(--soft);
    color:var(--text);
}

.sidebar-library{
    background:var(--sidebar-bg);
    border-radius:12px;
    padding:20px;
    flex:1;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:12px;
}

.library-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:8px;
}

.library-header h3{
    font-size:14px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:1px;
}

.create-playlist-btn{
    background:var(--accent);
    border:none;
    color:#000;
    width:32px;
    height:32px;
    border-radius:50%;
    font-size:20px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .2s;
}

.create-playlist-btn:hover{
    background:var(--accent-dim);
    transform:scale(1.05);
}

.playlist-item{
    padding:12px;
    background:var(--soft);
    border-radius:8px;
    cursor:pointer;
    transition:all .2s;
    display:flex;
    align-items:center;
    gap:12px;
}

.playlist-item:hover{
    background:var(--hover);
}

.playlist-item.active{
    background:var(--accent);
    color:#000;
}

.playlist-icon{
    font-size:24px;
}

.playlist-info{
    flex:1;
    min-width:0;
}

.playlist-name{
    font-size:14px;
    font-weight:600;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

.playlist-count{
    font-size:12px;
    color:var(--muted);
}

.playlist-item.active .playlist-count{
    color:#000;
    opacity:0.7;
}

/* MAIN CONTENT */
.main-content{
    flex:1;
    background:linear-gradient(180deg, var(--gradient-color) 0%, var(--bg) 20%);
    border-radius:12px;
    overflow-y:auto;
    padding:32px;
    transition:background .8s;
}

.section{
    margin-bottom:40px;
}

.section-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:20px;
}

.section-header h2{
    font-size:24px;
    font-weight:700;
}

.scroll-btns{
    display:flex;
    gap:8px;
}

.scroll-btn{
    width:36px;
    height:36px;
    background:rgba(0,0,0,.5);
    border:none;
    border-radius:50%;
    color:var(--text);
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .2s;
}

.scroll-btn:hover{
    background:rgba(0,0,0,.7);
}

/* Recently Played Grid */
.recent-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
    gap:16px;
}

.song-card{
    background:rgba(0,0,0,.3);
    border-radius:8px;
    padding:16px;
    cursor:pointer;
    transition:all .3s;
    display:flex;
    align-items:center;
    gap:12px;
}

.song-card:hover{
    background:rgba(0,0,0,.5);
    transform:translateY(-2px);
}

.song-card img{
    width:56px;
    height:56px;
    border-radius:6px;
    object-fit:cover;
    flex-shrink:0;
}

.song-info{
    flex:1;
    min-width:0;
}

.song-title{
    font-size:14px;
    font-weight:600;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    margin-bottom:4px;
}

.song-artist{
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

/* Horizontal Scroll Sections */
.scroll-container{
    display:flex;
    gap:16px;
    overflow-x:auto;
    padding-bottom:8px;
    scroll-behavior:smooth;
}

.scroll-container::-webkit-scrollbar{
    height:8px;
}

.scroll-container::-webkit-scrollbar-track{
    background:rgba(255,255,255,.05);
    border-radius:4px;
}

.scroll-container::-webkit-scrollbar-thumb{
    background:rgba(255,255,255,.2);
    border-radius:4px;
}

.album-card{
    min-width:180px;
    background:rgba(0,0,0,.3);
    border-radius:8px;
    padding:16px;
    cursor:pointer;
    transition:all .3s;
}

.album-card:hover{
    background:rgba(0,0,0,.5);
    transform:translateY(-4px);
}

.album-card img{
    width:50%;
    aspect-ratio:1;
    border-radius:6px;
    margin-bottom:12px;
}

.album-title{
    font-size:14px;
    font-weight:600;
    margin-bottom:4px;
    overflow:hidden;
    text-overflow:ellipsis;
    display:-webkit-box;
    -webkit-line-clamp:2;
    line-clamp:2;
    -webkit-box-orient:vertical;
}

.album-artist{
    font-size:12px;
    color:var(--muted);
}

/* RIGHT SIDEBAR */
.right-sidebar{
    width:380px;
    background: #000;
    border-radius:12px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    transition:width .3s;
}

.right-sidebar.minimized{
    width:0;
    padding:0;
}

.video-container{
    position:relative;
    width:100%;
    aspect-ratio:16/9;
    background:#000;
}

.video-container iframe{
    width:100%;
    height:100%;
    border:none;
}

.now-playing-info{
    padding:20px;
}

.np-title{
    font-size:18px;
    font-weight:700;
    margin-bottom:4px;
}

.np-artist{
    font-size:14px;
    color:var(--muted);
    margin-bottom:16px;
}

.playback-controls{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:16px;
    padding:16px 0;
}

.control-btn{
    width:40px;
    height:40px;
    background:transparent;
    border:none;
    color:var(--text);
    cursor:pointer;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .2s;
    font-size:20px;
}

.control-btn:hover{
    background:var(--hover);
}

.control-btn.play{
    background:var(--accent);
    color:#000;
    width:48px;
    height:48px;
    font-size:24px;
}

.control-btn.play:hover{
    background:var(--accent-dim);
    transform:scale(1.05);
}

.lyrics-section{
    flex:1;
    padding:20px;
    overflow-y:auto;
}

.lyrics-section h4{
    font-size:16px;
    font-weight:600;
    margin-bottom:16px;
    color:var(--accent);
}

.lyrics{
    font-size:14px;
    line-height:1.8;
    color:var(--muted);
    white-space:pre-wrap;
}

.lyrics.loading{
    text-align:center;
    font-style:italic;
}

/* Search View */
.search-view{
    display:none;
}

.search-view.active{
    display:block;
}

.search-header{
    margin-bottom:32px;
}

.search-input{
    width:100%;
    max-width:600px;
    padding:16px 24px;
    background:rgba(0,0,0,.3);
    border:2px solid rgba(255,255,255,.1);
    border-radius:30px;
    color:var(--text);
    font-size:16px;
    transition:all .2s;
}

.search-input:focus{
    outline:none;
    border-color:var(--accent);
    background:rgba(0,0,0,.5);
}

.search-results{
    display:flex;
    flex-direction:column;
    gap:32px;
}

/* Toast Notification */
.toast{
    position:fixed;
    bottom:24px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.95);
    backdrop-filter:blur(10px);
    color:var(--text);
    padding:16px 24px;
    border-radius:8px;
    display:flex;
    align-items:center;
    gap:12px;
    box-shadow:0 8px 32px rgba(0,0,0,.5);
    opacity:0;
    transition:opacity .3s;
    z-index:1000;
    pointer-events:none;
}

.toast.show{
    opacity:1;
}

.toast img{
    width:48px;
    height:48px;
    border-radius:4px;
}

.toast-info{
    flex:1;
    min-width:0;
}

.toast-title{
    font-size:14px;
    font-weight:600;
    margin-bottom:2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

.toast-subtitle{
    font-size:12px;
    color:var(--muted);
}

/* Modal */
.modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.8);
    backdrop-filter:blur(10px);
    z-index:1000;
    align-items:center;
    justify-content:center;
}

.modal.active{
    display:flex;
}

.modal-content{
    background:var(--panel);
    padding:32px;
    border-radius:16px;
    max-width:400px;
    width:90%;
    border:1px solid var(--border);
}

.modal-content h3{
    margin-bottom:24px;
    font-size:24px;
}

.modal-content input{
    width:100%;
    padding:14px;
    border-radius:8px;
    border:1px solid var(--border);
    background:var(--soft);
    color:var(--text);
    font-size:14px;
    margin-bottom:16px;
}

.modal-content input:focus{
    outline:none;
    border-color:var(--accent);
}

.modal-buttons{
    display:flex;
    gap:12px;
}

.modal-buttons button{
    flex:1;
    padding:14px;
    border:none;
    border-radius:8px;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    transition:all .2s;
}

.modal-buttons .primary{
    background:var(--accent);
    color:#000;
}

.modal-buttons .secondary{
    background:var(--soft);
    color:var(--text);
}

.modal-buttons button:hover{
    transform:scale(1.02);
}

/* Scrollbar */
::-webkit-scrollbar{
    width:10px;
}

::-webkit-scrollbar-track{
    background:rgba(255,255,255,.02);
}

.scrollbar-thumb{
    background:rgba(255,255,255,.12);
    border-radius:10px;
}

::-webkit-scrollbar-thumb:hover{
    background:rgba(255,255,255,.2);
}

/* Toggle Buttons */
.toggle-sidebar{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    width:24px;
    height:48px;
    background:var(--sidebar-bg);
    border:none;
    color:var(--muted);
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .2s;
    z-index:10;
}

.toggle-sidebar:hover{
    color:var(--text);
    background:var(--soft);
}

.toggle-left{
    right:-24px;
    border-radius:0 8px 8px 0;
}

.toggle-right{
    left:-24px;
    border-radius:8px 0 0 8px;
}

.minimized .toggle-left{
    right:0;
}

.minimized .toggle-right{
    left:0;
}
/* Album/Playlist View */
.album-view, .playlist-view {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.back-btn {
    background: rgba(0,0,0,.3);
    border: none;
    color: var(--text);
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 24px;
    transition: all .2s;
}

.back-btn:hover {
    background: rgba(0,0,0,.5);
}

.album-header, .playlist-header {
    display: flex;
    gap: 24px;
    margin-bottom: 32px;
    align-items: flex-end;
}

.album-cover {
    width: 200px;
    height: 200px;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,.5);
}

.playlist-icon-large {
    width: 200px;
    height: 200px;
    font-size: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.3);
    border-radius: 8px;
}

.album-info, .playlist-info-large {
    flex: 1;
}

.album-info h1, .playlist-info-large h1 {
    font-size: 48px;
    font-weight: 900;
    margin-bottom: 8px;
}

.album-info p, .playlist-info-large p {
    color: var(--muted);
    font-size: 14px;
    margin-bottom: 16px;
}

.play-all-btn {
    background: var(--accent);
    color: #000;
    border: none;
    padding: 14px 32px;
    border-radius: 30px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all .2s;
}

.play-all-btn:hover {
    background: var(--accent-dim);
    transform: scale(1.05);
}

.album-songs, .playlist-songs {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.album-song-item {
    background: rgba(0,0,0,.3);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 16px;
    cursor: pointer;
    transition: all .2s;
}

.album-song-item:hover {
    background: rgba(0,0,0,.5);
}

.song-number {
    color: var(--muted);
    font-size: 16px;
    font-weight: 600;
    min-width: 24px;
}

.album-song-item img {
    width: 48px;
    height: 48px;
    border-radius: 4px;
}

.left-sidebar.minimized .nav-btn span:first-child {
    font-size: 24px;
}

.left-sidebar.minimized .nav-btn {
    justify-content: center;
    padding: 12px;
}

.left-sidebar.minimized .logo {
    font-size: 20px;
}
/* ============================================
   ENHANCED MINIMALIST DESIGN IMPROVEMENTS
   ============================================ */

/* Import beautiful fonts */
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap');

/* Override body font */
body {
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
}

/* Beautiful logo typography */
.logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -2px;
}

/* Glassmorphism for sidebars */
.sidebar-top,
.sidebar-library {
    background: rgba(20, 20, 20, 0.6);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.right-sidebar {
    background: rgba(10, 10, 10, 0.8);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.06);
}

/* Refined navigation buttons */
.nav-btn {
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.nav-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.nav-btn:hover::before {
    opacity: 1;
}

.nav-btn.active {
    background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.06) 100%);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Elevated playlist items */
.playlist-item {
    background: rgba(40, 40, 40, 0.4);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.04);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.playlist-item:hover {
    background: rgba(60, 60, 60, 0.5);
    transform: translateX(4px);
    border-color: rgba(255, 255, 255, 0.08);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.playlist-item.active {
    background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
    box-shadow: 0 8px 24px rgba(255, 255, 255, 0.15);
}

/* Main content with better gradient */
.main-content {
    background: linear-gradient(180deg, var(--gradient-color) 0%, rgba(10, 10, 10, 0.95) 25%, var(--bg) 50%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.04);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
}

/* Section headers with refined typography */
.section-header h2 {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    letter-spacing: -1px;
    background: linear-gradient(135deg, #ffffff 0%, #c0c0c0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Enhanced song cards with hover effects */
.song-card {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.04);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.song-card:hover {
    background: rgba(0, 0, 0, 0.4);
    transform: translateY(-4px) scale(1.02);
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
}

.song-card img {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.song-card:hover img {
    transform: scale(1.05);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
}

/* Refined album cards */
.album-card {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.04);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.album-card:hover {
    background: rgba(0, 0, 0, 0.4);
    transform: translateY(-6px) scale(1.02);
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6);
}

.album-card img {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
}

.album-card:hover img {
    transform: scale(1.08);
}

/* Beautiful search input */
.search-input {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    font-family: 'DM Sans', sans-serif;
    font-weight: 400;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

.search-input:focus {
    background: rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 4px rgba(255, 255, 255, 0.05);
}

.search-input::placeholder {
    color: rgba(255, 255, 255, 0.3);
}

/* Enhanced create playlist button */
.create-playlist-btn {
    background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.create-playlist-btn:hover {
    box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2);
    transform: scale(1.08) rotate(90deg);
}

/* Refined play button */
.control-btn.play,
.play-all-btn {
    background: linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%);
    box-shadow: 0 6px 20px rgba(255, 255, 255, 0.15);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.control-btn.play:hover,
.play-all-btn:hover {
    box-shadow: 0 8px 28px rgba(255, 255, 255, 0.25);
    transform: scale(1.08);
}

/* Enhanced toast notification */
.toast {
    background: rgba(10, 10, 10, 0.95);
    backdrop-filter: blur(30px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.8);
    animation: toastSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes toastSlideIn {
    from {
        transform: translateX(-50%) translateY(100px);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

/* Refined modal */
.modal-content {
    background: rgba(20, 20, 20, 0.95);
    backdrop-filter: blur(30px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 24px 64px rgba(0, 0, 0, 0.8);
    animation: modalZoomIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalZoomIn {
    from {
        transform: scale(0.9);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.modal-content h3 {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    letter-spacing: -1px;
}

.modal-content input {
    background: rgba(40, 40, 40, 0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    transition: all 0.3s ease;
}

.modal-content input:focus {
    background: rgba(50, 50, 50, 0.6);
    border-color: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.05);
}

/* Enhanced buttons */
.modal-buttons .primary {
    background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal-buttons .primary:hover {
    box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2);
}

.modal-buttons .secondary {
    background: rgba(40, 40, 40, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.3s ease;
}

.modal-buttons .secondary:hover {
    background: rgba(60, 60, 60, 0.6);
    border-color: rgba(255, 255, 255, 0.12);
}

/* Album/Playlist view enhancements */
.back-btn {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.back-btn:hover {
    background: rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.12);
    transform: translateX(-4px);
}

.album-cover,
.playlist-icon-large {
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.album-header:hover .album-cover,
.playlist-header:hover .playlist-icon-large {
    transform: scale(1.03);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
}

.album-info h1,
.playlist-info-large h1 {
    font-family: 'Syne', sans-serif;
    letter-spacing: -2px;
    background: linear-gradient(135deg, #ffffff 0%, #b0b0b0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.album-song-item {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.04);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.album-song-item:hover {
    background: rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.08);
    transform: translateX(8px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
}

/* Refined scrollbars */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.02);
}

::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    transition: background 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.25);
}

/* Smooth scroll container */
.scroll-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
}

/* Toggle sidebar buttons */
.toggle-sidebar {
    background: rgba(20, 20, 20, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.toggle-sidebar:hover {
    background: rgba(40, 40, 40, 0.9);
    border-color: rgba(255, 255, 255, 0.12);
}

/* Subtle noise texture overlay */
body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    mix-blend-mode: overlay;
}

/* Staggered fade-in animations for song cards */
.song-card,
.album-card {
    animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) backwards;
}

.song-card:nth-child(1) { animation-delay: 0.05s; }
.song-card:nth-child(2) { animation-delay: 0.1s; }
.song-card:nth-child(3) { animation-delay: 0.15s; }
.song-card:nth-child(4) { animation-delay: 0.2s; }
.song-card:nth-child(5) { animation-delay: 0.25s; }
.song-card:nth-child(6) { animation-delay: 0.3s; }
.song-card:nth-child(7) { animation-delay: 0.35s; }
.song-card:nth-child(8) { animation-delay: 0.4s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Enhanced video container */
.video-container {
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Now playing info refinement */
.np-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    letter-spacing: -0.5px;
}

/* Lyrics section enhancement */
.lyrics-section h4 {
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    letter-spacing: -0.5px;
}

.lyrics {
    font-weight: 300;
    letter-spacing: 0.3px;
}
/* ============================================
   VIDEO OVERLAY DESIGN
   ============================================ */

/* Make right sidebar a single video container */
.right-sidebar {
    position: relative;
    overflow: hidden;
}

/* Video fills entire sidebar */
.video-container {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 50%;
    aspect-ratio: unset;
    border-bottom: none;
    z-index: 1;
}

.video-container::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
        180deg,
        rgba(0, 0, 0, 0.3) 0%,
        rgba(0, 0, 0, 0.5) 50%,
        rgba(0, 0, 0, 0.8) 100%
    );
    pointer-events: none;
    z-index: 2;
}

/* All content overlays the video */
.now-playing-info,
.playback-controls,
.lyrics-section {
    position: relative;
    z-index: 3;
}

/* Now playing info at top with glassmorphism */
.now-playing-info {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 24px;
    background: linear-gradient(
        180deg,
        rgba(0, 0, 0, 0.8) 0%,
        rgba(0, 0, 0, 0.4) 70%,
        transparent 100%
    );
    backdrop-filter: blur(20px);
}

.np-title,
.np-artist {
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
}

/* Playback controls at bottom */
.playback-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 20px;
    background: linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.9) 0%,
        rgba(0, 0, 0, 0.6) 50%,
        transparent 100%
    );
    backdrop-filter: blur(20px);
}

.control-btn {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.25);
}

.control-btn.play {
    background: rgba(255, 255, 255, 0.95);
    border: none;
}

.control-btn.play:hover {
    background: rgba(255, 255, 255, 1);
}

/* Lyrics overlay in center */
.lyrics-section {
    position: absolute;
    top: 120px;
    bottom: 120px;
    left: 0;
    right: 0;
    padding: 24px;
    overflow-y: auto;
    background: linear-gradient(
        180deg,
        transparent 0%,
        rgba(0, 0, 0, 0.3) 20%,
        rgba(0, 0, 0, 0.3) 80%,
        transparent 100%
    );
    backdrop-filter: blur(8px);
}

.lyrics-section h4 {
    color: rgba(255, 255, 255, 0.9);
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
    margin-bottom: 20px;
}

.lyrics {
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
    color: rgba(255, 255, 255, 0.85);
    font-size: 15px;
    line-height: 2;
    text-align: left;
}

.lyrics.loading {
    color: rgba(255, 255, 255, 0.5);
}

/* Enhanced scrollbar for lyrics */
.lyrics-section::-webkit-scrollbar {
    width: 6px;
}

.lyrics-section::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
}

.lyrics-section::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 10px;
}

.lyrics-section::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* Toggle button positioning */
.right-sidebar .toggle-sidebar {
    z-index: 10;
}
/* ============================================
   REPOSITIONED TEXT TO CENTER OF SIDEBAR
   ============================================ */

/* Now playing info repositioned to center-top area */
.now-playing-info {
    position: absolute;
    top: 30%;
    left: 0;
    right: 0;
    transform: translateY(-50%);
    padding: 24px;
    background: linear-gradient(
        180deg,
        rgba(0, 0, 0, 0.7) 0%,
        rgba(0, 0, 0, 0.5) 50%,
        transparent 100%
    );
    backdrop-filter: blur(20px);
}

/* Lyrics repositioned to center area */
.lyrics-section {
    position: absolute;
    top: 45%;
    bottom: 20%;
    left: 0;
    right: 0;
    padding: 24px;
    overflow-y: auto;
    background: linear-gradient(
        180deg,
        transparent 0%,
        rgba(0, 0, 0, 0.4) 20%,
        rgba(0, 0, 0, 0.4) 80%,
        transparent 100%
    );
    backdrop-filter: blur(8px);
}

/* Playback controls stay at bottom */
.playback-controls {
    position: absolute;
    bottom: 5%;
    left: 0;
    right: 0;
    padding: 20px;
    background: linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.9) 0%,
        rgba(0, 0, 0, 0.6) 50%,
        transparent 100%
    );
    backdrop-filter: blur(20px);
}
/* ============================================
   VIDEO AS FULL BACKGROUND WITH CENTERED TEXT
   ============================================ */

/* Video fills entire sidebar as background */
.video-container {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 50%;
    aspect-ratio: unset;
    border-bottom: none;
    z-index: 1;
}

/* Dark overlay on video for readability */
.video-container::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
        180deg,
        rgba(0, 0, 0, 0.4) 0%,
        rgba(0, 0, 0, 0.3) 40%,
        rgba(0, 0, 0, 0.5) 100%
    );
    pointer-events: none;
    z-index: 2;
}

/* Ensure iframe covers the entire container */
.video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Now playing info centered in upper-middle */
.now-playing-info {
    position: absolute;
    top: 35%;
    left: 0;
    right: 0;
    transform: translateY(-50%);
    padding: 32px 24px;
    background: transparent;
    backdrop-filter: none;
    text-align: left;
    z-index: 3;
}

.np-title {
    font-size: 24px;
    text-shadow: 0 4px 16px rgba(0, 0, 0, 0.9), 0 2px 4px rgba(0, 0, 0, 0.8);
    margin-bottom: 8px;
}

.np-artist {
    font-size: 16px;
    text-shadow: 0 4px 16px rgba(0, 0, 0, 0.9), 0 2px 4px rgba(0, 0, 0, 0.8);
}

/* Lyrics centered in middle */
.lyrics-section {
    position: absolute;
    top: 50%;
    bottom: 25%;
    left: 0;
    right: 0;
    padding: 24px;
    overflow-y: auto;
    background: transparent;
    backdrop-filter: none;
    z-index: 3;
}

.lyrics-section h4 {
    color: rgba(255, 255, 255, 0.95);
    text-shadow: 0 4px 16px rgba(0, 0, 0, 0.9), 0 2px 4px rgba(0, 0, 0, 0.8);
    margin-bottom: 20px;
    text-align: left;
}

.lyrics {
    text-shadow: 0 3px 12px rgba(0, 0, 0, 0.95), 0 2px 4px rgba(0, 0, 0, 0.8);
    color: rgba(255, 255, 255, 0.9);
    font-size: 15px;
    line-height: 2;
    text-align: left;
}

/* Playback controls at bottom with dark background */
.playback-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 24px 20px;
    background: linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.85) 0%,
        rgba(0, 0, 0, 0.5) 70%,
        transparent 100%
    );
    backdrop-filter: blur(16px);
    z-index: 3;
}

.control-btn {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.control-btn.play {
    background: rgba(255, 255, 255, 0.95);
    border: none;
}

.control-btn.play:hover {
    background: rgba(255, 255, 255, 1);
}
    .add-to-playlist-btn {
    margin-top: 16px;
    padding: 10px 20px;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 30px;
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.add-to-playlist-btn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    border-color: rgba(255,255,255,0.4);
}
</style>
</head>
<body>

<div class="app-container">
    <!-- LEFT SIDEBAR -->
    <aside class="left-sidebar" id="leftSidebar">
        <div class="sidebar-top">
            <!-- <div class="logo">INDY MUSIC‚ú¶</div> -->
            <div class="nav-buttons">
                <button class="nav-btn active" id="homeBtn" onclick="showHome()">
                    <span>‚åÇ</span> Home
                </button>
                <button class="nav-btn" id="searchBtn" onclick="showSearch()">
                    <span>‚åï</span> Search
                </button>
                <button class="nav-btn" id="searchBtn" onclick="linkIndy()">
                    <span>‚ú¶</span> Link to INDY account
                </button>
            </div>
        </div>
        
        <div class="sidebar-library">
            <div class="library-header">
                <h3>Your Library</h3>
                <button class="create-playlist-btn" onclick="openCreateModal()">+</button>
            </div>
            
            <div class="playlist-item" onclick="viewLikedSongs()">
                <span class="playlist-icon">‚ù§Ô∏è</span>
                <div class="playlist-info">
                    <div class="playlist-name">Liked Songs</div>
                    <div class="playlist-count" id="likedCount">0 songs</div>
                </div>
            </div>
            
            <div id="playlistsList"></div>
        </div>
        
        <button class="toggle-sidebar toggle-left" onclick="toggleLeftSidebar()">‚Ä∫</button>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content" id="mainContent">
        <!-- HOME VIEW -->
        <div id="homeView">
            <div class="section">
                <div class="section-header">
                    <h2>Recently Played</h2>
                </div>
                <div class="recent-grid" id="recentGrid"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Recommended Albums</h2>
                </div>
                <div class="scroll-container" id="albumsScroll"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>‚ú¶Recommended Mixes</h2>
                </div>
                <div class="scroll-container" id="mixesScroll"></div>
            </div>
        </div>

        <!-- SEARCH VIEW -->
        <div class="search-view" id="searchView">
            <div class="search-header">
                <input type="text" class="search-input" id="searchInput" placeholder="Listen to anything!">
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
    </main>

    <!-- RIGHT SIDEBAR -->
    <aside class="right-sidebar" id="rightSidebar">
        <div class="video-container">
            <iframe id="player" allow="autoplay; encrypted-media"></iframe>
        </div>
        
<div class="now-playing-info">
    <div class="np-title" id="npTitle">Start playing a song</div>
    <div class="np-artist" id="npArtist"></div>
    
    <!-- NEW: Add to Playlist button (hidden by default) -->
    <button id="addToPlaylistBtn" class="add-to-playlist-btn" style="display:none;">
        <span style="font-size:18px;">+</span> Add to Playlist
    </button>
</div>
        
        <div class="lyrics-section">
            <h4>Lyrics</h4>
            <div class="lyrics loading" id="lyrics">Play a song to view lyrics...</div>
        </div>
        
        <button class="toggle-sidebar toggle-right" onclick="toggleRightSidebar()">‚Äπ</button>
    </aside>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <img id="toastImg" src="" alt="">
    <div class="toast-info">
        <div class="toast-title" id="toastTitle"></div>
        <div class="toast-subtitle" id="toastSubtitle">Now Playing</div>
    </div>
</div>

<!-- Create Playlist Modal -->
<div class="modal" id="createModal">
    <div class="modal-content">
        <h3>Create Playlist</h3>
        <input type="text" id="playlistNameInput" placeholder="Playlist name">
        <input type="text" id="playlistEmojiInput" placeholder="Emoji (e.g. üéµ)" maxlength="2">
        <div class="modal-buttons">
            <button class="secondary" onclick="closeCreateModal()">Cancel</button>
            <button class="primary" onclick="createPlaylist()">Create</button>
        </div>
    </div>
</div>

<script>
const API_KEY = "AIzaSyDNd7dwB1rZEpJzpyRrVZQwSKHvnt3Q7vQ";

function getNextKey() {
    return API_KEY;
}

// At the very top of <script> (or in a separate early script tag)
if (!window.YT) {
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const first = document.getElementsByTagName('script')[0];
    first.parentNode.insertBefore(tag, first);
}

window.onYouTubeIframeAPIReady = function() {
    console.log('YouTube IFrame API fully ready');
    window.ytPlayer = new YT.Player('player', {
        events: {
            'onReady': () => console.log('Player ready'),
            'onStateChange': onPlayerStateChange,
            'onError': (e) => console.error('YT Player error:', e.data)
        }
    });
};

// Storage
function save(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
        console.error("Storage error:", e);
    }
}

function load(key, def) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : def;
    } catch (e) {
        return def;
    }
}

// Add near the top (after load/save functions)
const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours

function cachedFetch(url, cacheKey, maxAge = CACHE_TTL) {
    const cached = load(cacheKey, null);
    if (cached && Date.now() - cached.timestamp < maxAge) {
        console.log(`Cache hit: ${cacheKey}`);
        return Promise.resolve(cached.data);
    }

    return fetch(url)
        .then(r => {
            if (!r.ok) throw new Error(r.status);
            return r.json();
        })
        .then(data => {
            save(cacheKey, { timestamp: Date.now(), data });
            return data;
        })
        .catch(err => {
            console.warn("Fetch failed, using stale cache if available", err);
            return cached ? cached.data : null;
        });
}

// State
let recent = load("recent", []);
let playlists = load("playlists", {});
let liked = load("liked", []);
let currentPlaylist = null;
let currentSongs = [];
let currentIndex = -1;
let ytPlayer = null;
let searchTimeout = null;  // ‚Üê Add this line

let lastPlayedVideoId = null;

// Initialize
renderRecent();
renderPlaylists();
renderAlbums();
renderMixes();
updateLikedCount();

// Load YouTube API
if (!window.YT) {
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
}

window.onYouTubeIframeAPIReady = function() {
    console.log('YouTube IFrame API is fully loaded');
    playerReady = true;
    
    // If we were waiting for a song ‚Üí start it now
    if (pendingVideo) {
        initPlayer(pendingVideo);
        pendingVideo = null;
    }
};

let playerReady = false;
let pendingVideo = null;

function initPlayer(videoId) {
    if (!window.YT || !window.YT.Player) {
        console.log('API not ready yet ‚Äî will try again soon');
        pendingVideo = videoId;           // remember which video to play
        return;
    }

    if (!ytPlayer || !ytPlayer.loadVideoById) {
        console.log('Creating new YT.Player instance');
        ytPlayer = new YT.Player('player', {
            height: '100%',
            width: '100%',
            videoId: videoId,
            playerVars: {
                autoplay: 1,
                enablejsapi: 1,
                rel: 0,
                modestbranding: 1,
                origin: window.location.origin   // ‚Üê very helpful for local/dev
            },
            events: {
                onReady: (e) => {
                    console.log('Player is ready ‚Äî should start playing');
                    playerReady = true;
                    // Optional: e.target.playVideo();
                },
                onStateChange: onPlayerStateChange,
                onError: (e) => {
                    console.error('YouTube Player error:', e.data);
                }
            }
        });
    } else {
        console.log('Loading video into existing player');
        ytPlayer.loadVideoById(videoId);
    }
}

function onPlayerStateChange(event) {
    if (event.data === window.YT.PlayerState.ENDED) {
        skipToNext();
    }
}

function showHome() {
    const mainContent = document.getElementById('mainContent');
    const searchView = document.getElementById('searchView');
    const homeBtn = document.getElementById('homeBtn');
    const searchBtn = document.getElementById('searchBtn');
    
    mainContent.innerHTML = `
        <div id="homeView">
            <div class="section">
                <div class="section-header">
                    <h2>Recently Played</h2>
                </div>
                <div class="recent-grid" id="recentGrid"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Recommended Albums</h2>
                </div>
                <div class="scroll-container" id="albumsScroll"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>‚ú¶ Recommended Mixes</h2>
                </div>
                <div class="scroll-container" id="mixesScroll"></div>
            </div>
        </div>
        
        <div class="search-view" id="searchView">
            <div class="search-header">
                <input type="text" class="search-input" id="searchInput" placeholder="What do you want to listen to?">
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
    `;
    
    if (searchView) searchView.classList.remove('active');
    if (homeBtn) homeBtn.classList.add('active');
    if (searchBtn) searchBtn.classList.remove('active');
    
    // Re-render content
    renderRecent();
    renderAlbums();
    renderMixes();
    
    // Re-attach search listener
    document.getElementById('searchInput').oninput = async (e) => {
        clearTimeout(searchTimeout);
        const q = e.target.value.trim();
        
        if (!q) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            try {
                const [videos, playlists] = await Promise.all([
                    fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=10&q=${encodeURIComponent(q)}&key=${getNextKey()}`).then(r => r.json()),
                    fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=playlist&maxResults=4&q=${encodeURIComponent(q + ' album')}&key=${getNextKey()}`).then(r => r.json())
                ]);
                
                renderSearchResults(videos, playlists);
            } catch (error) {
                console.error("Search error:", error);
            }
        }, 300);
    };
}
function showSearch() {
    document.getElementById('homeView').style.display = 'none';
    document.getElementById('searchView').classList.add('active');
    document.getElementById('homeBtn').classList.remove('active');
    document.getElementById('searchBtn').classList.add('active');
    
    const searchInput = document.getElementById('searchInput');
    searchInput.focus();
    
    // Re-attach the search event listener
searchInput.oninput = (e) => {
    clearTimeout(searchTimeout);
    const q = e.target.value.trim();

    if (q.length < 3) {                // ‚Üê add this
        document.getElementById('searchResults').innerHTML = '';
        return;
    }
        
        searchTimeout = setTimeout(async () => {
            try {
                const [videos, playlists] = await Promise.all([
                    fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=10&q=${encodeURIComponent(q)}&key=${getNextKey()}`).then(r => r.json()),
                    fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=playlist&maxResults=4&q=${encodeURIComponent(q + ' album')}&key=${getNextKey()}`).then(r => r.json())
                ]);
                
                renderSearchResults(videos, playlists);
            } catch (error) {
                console.error("Search error:", error);
            }
        }, 300);
    };
}

function toggleLeftSidebar() {
    document.getElementById('leftSidebar').classList.toggle('minimized');
}

function toggleRightSidebar() {
    document.getElementById('rightSidebar').classList.toggle('minimized');
}

function renderSearchResults(videos, playlists) {
    const container = document.getElementById('searchResults');
    container.innerHTML = '';
    
    // Albums section
    if (playlists.items && playlists.items.length > 0) {
        const albumSection = document.createElement('div');
        albumSection.className = 'section';
        albumSection.innerHTML = `
            <div class="section-header"><h2>Albums</h2></div>
            <div class="scroll-container"></div>
        `;
        
        const scrollContainer = albumSection.querySelector('.scroll-container');
        playlists.items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'album-card';
            div.innerHTML = `
                <img src="${item.snippet.thumbnails.medium.url}">
                <div class="album-title">${escapeHtml(item.snippet.title)}</div>
                <div class="album-artist">${escapeHtml(item.snippet.channelTitle)}</div>
            `;
            div.onclick = () => playPlaylist(item.id.playlistId, true);
            scrollContainer.appendChild(div);
        });
        
        container.appendChild(albumSection);
    }
    
    // Songs section
    if (videos.items && videos.items.length > 0) {
        const songSection = document.createElement('div');
        songSection.className = 'section';
        songSection.innerHTML = `
            <div class="section-header"><h2>Songs</h2></div>
            <div class="recent-grid"></div>
        `;
        
        const grid = songSection.querySelector('.recent-grid');
        videos.items.forEach(item => {
            const song = {
                id: item.id.videoId,
                title: item.snippet.title,
                artist: item.snippet.channelTitle,
                art: item.snippet.thumbnails.medium.url
            };
            
            const div = document.createElement('div');
            div.className = 'song-card';
            div.innerHTML = `
                <img src="${song.art}">
                <div class="song-info">
                    <div class="song-title">${escapeHtml(song.title)}</div>
                    <div class="song-artist">${escapeHtml(song.artist)}</div>
                </div>
                <button onclick="event.stopPropagation(); showAddToPlaylistMenu(${JSON.stringify(song).replace(/"/g, '&quot;')})" style="background:var(--accent);color:#000;border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;flex-shrink:0;">+</button>
            `;
            div.onclick = () => playSong(song);
            grid.appendChild(div);
        });
        
        container.appendChild(songSection);
    }
}

async function playPlaylist(playlistId, isAlbum = false) {
    try {
        const response = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${getNextKey()}`);
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
            currentSongs = data.items.map(item => ({
                id: item.snippet.resourceId.videoId,
                title: item.snippet.title,
                artist: item.snippet.channelTitle,
                art: item.snippet.thumbnails.medium.url
            })).filter(song => song.id && song.title !== 'Private video' && song.title !== 'Deleted video');
            
            currentIndex = 0;
            currentPlaylist = null;
            
            if (isAlbum) {
                // Fetch playlist details to get the actual album name
                const playlistResponse = await fetch(`https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${playlistId}&key=${getNextKey()}`);
                const playlistData = await playlistResponse.json();
                const albumName = playlistData.items?.[0]?.snippet?.title || data.items[0].snippet.channelTitle;
                
                showAlbumView(currentSongs, albumName);
            } else {
                playSong(currentSongs[0]);
            }
        }
    } catch (error) {
        console.error("Playlist error:", error);
    }
}

function showAlbumView(songs, albumName) {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="album-view">
            <button class="back-btn" onclick="showHome()">‚Üê Back</button>
            <div class="album-header">
                <img src="${songs[0].art}" class="album-cover">
                <div class="album-info">
                    <h1>${escapeHtml(albumName)}</h1>
                    <p>${songs.length} songs</p>
                    <button class="play-all-btn" onclick="playSong(currentSongs[0])">‚ñ∂ Play All</button>
                </div>
            </div>
            <div class="album-songs" id="albumSongsList"></div>
        </div>
    `;
    
    const songsList = document.getElementById('albumSongsList');
    songs.forEach((song, i) => {
        const div = document.createElement('div');
        div.className = 'album-song-item';
        div.innerHTML = `
            <span class="song-number">${i + 1}</span>
            <img src="${song.art}">
            <div class="song-info">
                <div class="song-title">${escapeHtml(song.title)}</div>
                <div class="song-artist">${escapeHtml(song.artist)}</div>
            </div>
        `;
        div.onclick = () => {
            currentIndex = i;
            playSong(song);
        };
        songsList.appendChild(div);
    });
}
function playSong(song, fromPlaylist = null) {
    // Prevent playing the exact same video again immediately
    if (lastPlayedVideoId === song.id) {
        console.log("Already playing this exact video ‚Äî skipping duplicate call");
        return;
    }
    lastPlayedVideoId = song.id;

    // ‚îÄ‚îÄ 1. Update playback context & index ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (fromPlaylist) {
        currentPlaylist = fromPlaylist;
        currentSongs = playlists[fromPlaylist].songs;
        currentIndex = currentSongs.findIndex(s => s.id === song.id);
        if (currentIndex === -1) currentIndex = 0;
    } else {
        const idx = currentSongs.findIndex(s => s.id === song.id);
        if (idx !== -1) currentIndex = idx;
    }

    // ‚îÄ‚îÄ 2. Update UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('npTitle').textContent = song.title || "Unknown Title";
    document.getElementById('npArtist').textContent = song.artist || "Unknown Artist";

    addToRecent(song);
    if (song.art) updateGradient(song.art);
    fetchLyrics(song.title, song.artist);
    showToast(song);

    // ‚îÄ‚îÄ 3. Build clean embed parameters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const params = new URLSearchParams({
        autoplay: 1,
        enablejsapi: 1,
        origin: window.location.origin,           // Critical for postMessage / security
        rel: 0,
        modestbranding: 1,
        showinfo: 0,
        iv_load_policy: 3,
        playsinline: 1,
        fs: 1
    });

    const embedUrl = `https://www.youtube.com/embed/${song.id}?${params.toString()}`;

    // ‚îÄ‚îÄ 4. Try to use the real YouTube Player API first ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (window.ytPlayer && typeof window.ytPlayer.loadVideoById === 'function') {
        try {
            window.ytPlayer.loadVideoById({
                videoId: song.id,
                startSeconds: 0
            });
            console.log(`Playing "${song.title}" via ytPlayer.loadVideoById`);
        } catch (err) {
            console.error("loadVideoById failed:", err);
            // Fallback to src
            document.getElementById('player').src = embedUrl;
            console.log(`Fallback: set iframe src directly`);
        }
    } else {
        // API not ready or not initialized ‚Üí direct src change
        document.getElementById('player').src = embedUrl;
        console.log(`Playing "${song.title}" via direct iframe src (API not ready)`);
    }

    // Optional: give focus to iframe (helps autoplay policies in some browsers)
    const playerEl = document.getElementById('player');
    if (playerEl) playerEl.focus?.();
}

function skipToNext() {
    if (currentIndex < currentSongs.length - 1) {
        currentIndex++;
        playSong(currentSongs[currentIndex]);
    }
}

function skipToPrevious() {
    if (currentIndex > 0) {
        currentIndex--;
        playSong(currentSongs[currentIndex]);
    }
}

function togglePlay() {
    // Will be implemented with YouTube API
}

// Toast notification
function showToast(song) {
    const toast = document.getElementById('toast');
    document.getElementById('toastImg').src = song.art;
    document.getElementById('toastTitle').textContent = song.title;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 5000);
}

// Recent songs
function addToRecent(song) {
    recent = recent.filter(s => s.id !== song.id);
    recent.unshift(song);
    recent = recent.slice(0, 8);
    save("recent", recent);
    renderRecent();
}

function renderRecent() {
    const recentDiv = document.getElementById('recentGrid');  // ‚Üê use correct ID!
    if (!recentDiv) return;

    recentDiv.innerHTML = '';

    if (recent.length === 0) {
        recentDiv.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);grid-column:1/-1">No recent songs yet</div>';
        return;
    }

    recent.forEach(song => {
        const div = document.createElement('div');
        div.className = 'song-card';
        div.innerHTML = `
            <img src="${song.art}">
            <div class="song-info">
                <div class="song-title">${escapeHtml(song.title)}</div>
                <div class="song-artist">${escapeHtml(song.artist)}</div>
            </div>
        `;
        div.onclick = () => playSong(song);
        recentDiv.appendChild(div);   // ‚Üê fixed: recentDiv, not grid
    });
}

// Albums (from recent)
async function renderAlbums() {
    const container = document.getElementById('albumsScroll');
    if (!container) return;
    
    container.innerHTML = '<div style="padding:20px;color:var(--muted);">Loading albums...</div>';
    
    // Get unique artists from recent songs
    const uniqueArtists = [...new Set(recent.map(s => s.artist))].slice(0, 3);
    
    if (uniqueArtists.length === 0) {
        container.innerHTML = '<div style="padding:20px;color:var(--muted);">Play some songs to see album recommendations</div>';
        return;
    }
    
    try {
// In renderAlbums()
const albumPromises = uniqueArtists.map(artist =>
    cachedFetch(
        `https://www.googleapis.com/youtube/v3/search?...q=${encodeURIComponent(artist + ' album')}...`,
        `album-cache-${artist.replace(/\W/g,'_')}`
    )
);
        
        const results = await Promise.all(albumPromises);
        const albums = results.flatMap(data => data.items || []).slice(0, 6);
        
        container.innerHTML = '';
        
        if (albums.length === 0) {
            container.innerHTML = '<div style="padding:20px;color:var(--muted);">No albums found</div>';
            return;
        }
        
        albums.forEach(item => {
            const div = document.createElement('div');
            div.className = 'album-card';
            div.innerHTML = `
                <img src="${item.snippet.thumbnails.medium.url}">
                <div class="album-title">${escapeHtml(item.snippet.title)}</div>
                <div class="album-artist">${escapeHtml(item.snippet.channelTitle)}</div>
            `;
            div.onclick = () => playPlaylist(item.id.playlistId, true);
            container.appendChild(div);
        });
    } catch (error) {
        console.error("Album fetch error:", error);
        container.innerHTML = '<div style="padding:20px;color:var(--muted);">Could not load albums</div>';
    }
}

// Mixes (recommended - using recent songs)
function renderMixes() {
    const container = document.getElementById('mixesScroll');
    if (!container) return;

    container.innerHTML = '';

    const seeds = recent.slice(0, 6);

    if (seeds.length === 0) {
        container.innerHTML = '<div style="padding:20px;color:var(--muted);">Play some music to get mixes</div>';
        return;
    }

    seeds.forEach(song => {
        const div = document.createElement('div');
        div.className = 'album-card';
        div.innerHTML = `
            <img src="${song.art}">
            <div class="album-title">${escapeHtml(song.title)} Mix</div>
            <div class="album-artist">Based on ${escapeHtml(song.artist)}</div>
        `;
        div.onclick = () => openMix(song);
        container.appendChild(div);
    });
}

async function openMix(seedSong) {
    const songs = await generateMix(seedSong);

    if (songs.length === 0) {
        showNotification("Couldn't generate mix");
        return;
    }

    currentSongs = songs;
    currentIndex = 0;
    currentPlaylist = null;

    const mixName = `${seedSong.title} Mix`;

    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="playlist-view">
            <button class="back-btn" onclick="showHome()">‚Üê Back</button>
            <div class="playlist-header">
                <div class="playlist-icon-large">‚ú¶</div>
                <div class="playlist-info-large">
                    <h1>${escapeHtml(mixName)}</h1>
                    <p>${songs.length} songs ¬∑ Recommended</p>
                    <button class="play-all-btn" onclick="playSong(currentSongs[0])">‚ñ∂ Play</button>
                </div>
            </div>
            <div class="playlist-songs" id="mixSongsList"></div>
        </div>
    `;

    const list = document.getElementById('mixSongsList');
    songs.forEach((song, i) => {
        const div = document.createElement('div');
        div.className = 'album-song-item';
        div.innerHTML = `
            <span class="song-number">${i + 1}</span>
            <img src="${song.art}">
            <div class="song-info">
                <div class="song-title">${escapeHtml(song.title)}</div>
                <div class="song-artist">${escapeHtml(song.artist)}</div>
            </div>
        `;
        div.onclick = () => {
            currentIndex = i;
            playSong(song);
        };
        list.appendChild(div);
    });
}

    async function generateMix(seedSong) {
    const query = `${seedSong.artist} official audio`;

    
    const res = await fetch(
        `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=15&q=${encodeURIComponent(query)}&key=${getNextKey()}`
    );
    const data = await res.json();

    return (data.items || [])
        .map(item => ({
            id: item.id.videoId,
            title: item.snippet.title,
            artist: item.snippet.channelTitle,
            art: item.snippet.thumbnails.medium.url
        }))
        .filter(song => song.id);
}


// Playlists
function renderPlaylists() {
    const container = document.getElementById('playlistsList');
    container.innerHTML = '';
    
    Object.keys(playlists).forEach(name => {
        const playlist = playlists[name];
        const div = document.createElement('div');
        div.className = 'playlist-item';
        div.innerHTML = `
            <span class="playlist-icon">${playlist.emoji || 'üéµ'}</span>
            <div class="playlist-info">
                <div class="playlist-name">${escapeHtml(name)}</div>
                <div class="playlist-count">${playlist.songs.length} songs</div>
            </div>
        `;
        div.onclick = () => viewPlaylist(name);
        container.appendChild(div);
    });
}

function viewPlaylist(name) {
    currentPlaylist = name;
    currentSongs = playlists[name].songs;
    
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="playlist-view">
            <button class="back-btn" onclick="showHome()">‚Üê Back</button>
            <div class="playlist-header">
                <div class="playlist-icon-large">${playlists[name].emoji || 'üéµ'}</div>
                <div class="playlist-info-large">
                    <h1>${escapeHtml(name)}</h1>
                    <p>${currentSongs.length} songs</p>
                    <div style="display:flex;gap:12px;margin-top:16px;">
                        ${currentSongs.length > 0 ? '<button class="play-all-btn" onclick="currentIndex=0; playSong(currentSongs[0])">‚ñ∂ Play All</button>' : ''}
                        <button onclick="editPlaylist('${escapeHtml(name)}')" style="background:var(--soft);color:var(--text);border:none;padding:14px 24px;border-radius:30px;font-size:14px;font-weight:600;cursor:pointer;">‚úèÔ∏è Edit</button>
                        <button onclick="deletePlaylist('${escapeHtml(name)}')" style="background:rgba(255,0,0,.2);color:var(--text);border:none;padding:14px 24px;border-radius:30px;font-size:14px;font-weight:600;cursor:pointer;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            </div>
            <div class="playlist-songs" id="playlistSongsList"></div>
        </div>
    `;
    
    const songsList = document.getElementById('playlistSongsList');
    if (currentSongs.length === 0) {
        songsList.innerHTML = '<p style="text-align:center; color:var(--muted); padding:40px;">No songs yet. Search and add some!</p>';
    } else {
        currentSongs.forEach((song, i) => {
            const div = document.createElement('div');
            div.className = 'album-song-item';
            div.innerHTML = `
                <span class="song-number">${i + 1}</span>
                <img src="${song.art}">
                <div class="song-info">
                    <div class="song-title">${escapeHtml(song.title)}</div>
                    <div class="song-artist">${escapeHtml(song.artist)}</div>
                </div>
                <button onclick="event.stopPropagation(); removeSongFromPlaylist('${escapeHtml(name)}', '${song.id}')" style="background:rgba(255,0,0,.2);color:var(--text);border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px;margin-left:auto;">√ó</button>
            `;
            div.onclick = () => {
                currentIndex = i;
                playSong(song);
            };
            songsList.appendChild(div);
        });
    }
}

function viewLikedSongs() {
    currentSongs = liked;
    currentIndex = 0;
    currentPlaylist = null;
    
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="playlist-view">
            <button class="back-btn" onclick="showHome()">‚Üê Back</button>
            <div class="playlist-header">
                <div class="playlist-icon-large">‚ù§Ô∏è</div>
                <div class="playlist-info-large">
                    <h1>Liked Songs</h1>
                    <p>${currentSongs.length} songs</p>
                    ${currentSongs.length > 0 ? '<button class="play-all-btn" onclick="currentIndex=0; playSong(currentSongs[0])">‚ñ∂ Play All</button>' : ''}
                </div>
            </div>
            <div class="playlist-songs" id="likedSongsList"></div>
        </div>
    `;
    
    const songsList = document.getElementById('likedSongsList');
    if (currentSongs.length === 0) {
        songsList.innerHTML = '<p style="text-align:center; color:var(--muted); padding:40px;">No liked songs yet</p>';
    } else {
        currentSongs.forEach((song, i) => {
            const div = document.createElement('div');
            div.className = 'album-song-item';
            div.innerHTML = `
                <span class="song-number">${i + 1}</span>
                <img src="${song.art}">
                <div class="song-info">
                    <div class="song-title">${escapeHtml(song.title)}</div>
                    <div class="song-artist">${escapeHtml(song.artist)}</div>
                </div>
            `;
            div.onclick = () => {
                currentIndex = i;
                playSong(song);
            };
            songsList.appendChild(div);
        });
    }
}

function updateLikedCount() {
    document.getElementById('likedCount').textContent = `${liked.length} songs`;
}

// Gradient color extraction
function updateGradient(imageUrl) {
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.src = imageUrl;
    
    img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 1;
        canvas.height = 1;
        ctx.drawImage(img, 0, 0, 1, 1);
        const data = ctx.getImageData(0, 0, 1, 1).data;
        const color = `rgb(${data[0]}, ${data[1]}, ${data[2]})`;
        document.documentElement.style.setProperty('--gradient-color', color);
    };
}

// Lyrics
async function fetchLyrics(title, artist) {
    const lyricsDiv = document.getElementById('lyrics');
    lyricsDiv.className = 'lyrics loading';
    lyricsDiv.textContent = 'Loading lyrics...';
    
    try {
        const cleanTitle = title.split('(')[0].split('[')[0].split('|')[0].trim();
        const cleanArtist = artist.split('-')[0].split('(')[0].trim();
        
        const response = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(cleanArtist)}/${encodeURIComponent(cleanTitle)}`);
        const data = await response.json();
        
        if (data.lyrics) {
            lyricsDiv.className = 'lyrics';
            lyricsDiv.textContent = data.lyrics;
        } else {
            lyricsDiv.className = 'lyrics loading';
            lyricsDiv.textContent = 'Lyrics not available';
        }
    } catch (error) {
        lyricsDiv.className = 'lyrics loading';
        lyricsDiv.textContent = 'Could not load lyrics';
    }
}

// Modal functions
function openCreateModal() {
    document.getElementById('createModal').classList.add('active');
    document.getElementById('playlistNameInput').focus();
}

function closeCreateModal() {
    document.getElementById('createModal').classList.remove('active');
    document.getElementById('playlistNameInput').value = '';
    document.getElementById('playlistEmojiInput').value = '';
}

function createPlaylist() {
    const name = document.getElementById('playlistNameInput').value.trim();
    const emoji = document.getElementById('playlistEmojiInput').value.trim() || 'üéµ';
    
    if (!name) return;
    
    if (playlists[name]) {
        alert('Playlist already exists!');
        return;
    }
    
    playlists[name] = { emoji, songs: [] };
    save('playlists', playlists);
    renderPlaylists();
    closeCreateModal();
}

// Utilities
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Playlist Management Functions

// Add current song to a playlist
function addToPlaylist(song, playlistName) {
    if (!playlists[playlistName]) return;
    
    // Check if song already exists
    const exists = playlists[playlistName].songs.some(s => s.id === song.id);
    if (exists) {
        showNotification('Song already in playlist');
        return;
    }
    
    playlists[playlistName].songs.push(song);
    save('playlists', playlists);
    renderPlaylists();
    showNotification(`Added to ${playlistName}`);
}

// Show add to playlist menu
function showAddToPlaylistMenu(song) {
    const playlistNames = Object.keys(playlists);
    
    if (playlistNames.length === 0) {
        showNotification('Create a playlist first!');
        return;
    }
    
    const menu = document.createElement('div');
    menu.className = 'modal active';
    menu.innerHTML = `
        <div class="modal-content">
            <h3>Add to Playlist</h3>
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;">
                ${playlistNames.map(name => `
                    <div class="playlist-item" onclick="addToPlaylist(${JSON.stringify(song).replace(/"/g, '&quot;')}, '${escapeHtml(name)}'); closeAddMenu()" style="margin-bottom: 8px;">
                        <span class="playlist-icon">${playlists[name].emoji || 'üéµ'}</span>
                        <div class="playlist-info">
                            <div class="playlist-name">${escapeHtml(name)}</div>
                            <div class="playlist-count">${playlists[name].songs.length} songs</div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="modal-buttons">
                <button class="secondary" onclick="closeAddMenu()">Cancel</button>
            </div>
        </div>
    `;
    menu.id = 'addMenu';
    document.body.appendChild(menu);
}

function closeAddMenu() {
    const menu = document.getElementById('addMenu');
    if (menu) menu.remove();
}

// Delete playlist
function deletePlaylist(name) {
    if (confirm(`Delete playlist "${name}"?`)) {
        delete playlists[name];
        save('playlists', playlists);
        renderPlaylists();
        showHome();
        showNotification('Playlist deleted');
    }
}

// Edit playlist
function editPlaylist(name) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'editModal';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Edit Playlist</h3>
            <input type="text" id="editPlaylistNameInput" placeholder="Playlist name" value="${escapeHtml(name)}">
            <input type="text" id="editPlaylistEmojiInput" placeholder="Emoji (e.g. üéµ)" maxlength="2" value="${playlists[name].emoji || 'üéµ'}">
            <div class="modal-buttons">
                <button class="secondary" onclick="closeEditModal()">Cancel</button>
                <button class="primary" onclick="savePlaylistEdit('${escapeHtml(name)}')">Save</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeEditModal() {
    const modal = document.getElementById('editModal');
    if (modal) modal.remove();
}

function savePlaylistEdit(oldName) {
    const newName = document.getElementById('editPlaylistNameInput').value.trim();
    const newEmoji = document.getElementById('editPlaylistEmojiInput').value.trim() || 'üéµ';
    
    if (!newName) {
        showNotification('Playlist name cannot be empty');
        return;
    }
    
    if (newName !== oldName && playlists[newName]) {
        showNotification('Playlist name already exists');
        return;
    }
    
    const songs = playlists[oldName].songs;
    delete playlists[oldName];
    playlists[newName] = { emoji: newEmoji, songs: songs };
    
    save('playlists', playlists);
    renderPlaylists();
    closeEditModal();
    showNotification('Playlist updated');
    
    // If we're currently viewing this playlist, refresh the view
    if (currentPlaylist === oldName) {
        viewPlaylist(newName);
    } else {
        showHome();
    }
}

// Remove song from playlist
function removeSongFromPlaylist(playlistName, songId) {
    if (!playlists[playlistName]) return;
    
    playlists[playlistName].songs = playlists[playlistName].songs.filter(s => s.id !== songId);
    save('playlists', playlists);
    renderPlaylists();
    viewPlaylist(playlistName);
    showNotification('Song removed');
}

// Simple notification system
function showNotification(message) {
    const notif = document.createElement('div');
    notif.style.cssText = `
        position: fixed;
        top: 24px;
        right: 24px;
        background: rgba(0,0,0,.95);
        backdrop-filter: blur(10px);
        color: var(--text);
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0,0,0,.5);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    notif.textContent = message;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notif.remove(), 300);
    }, 2000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>

<script>
// Auto-minimize right sidebar on page load until a song is played
(function() {
    // Minimize right sidebar on page load
    const rightSidebar = document.getElementById('rightSidebar');
    if (rightSidebar) {
        rightSidebar.classList.add('minimized');
    }

    // Override the playSong function to auto-open sidebar when playing
    const originalPlaySong = window.playSong;
    window.playSong = function(song, fromPlaylist) {
        // Call the original playSong function
        originalPlaySong.call(this, song, fromPlaylist);
        
        // Automatically open the right sidebar when a song starts playing
        const rightSidebar = document.getElementById('rightSidebar');
        if (rightSidebar && rightSidebar.classList.contains('minimized')) {
            rightSidebar.classList.remove('minimized');
        }
    };
})();

// ====================
// IMPROVED: Smart search + direct URL paste + title fetch (1 quota unit)
// Paste at the END of your main <script>
// ====================

// ‚îÄ‚îÄ 1. Extract video ID from almost any YouTube URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function extractYouTubeVideoId(input) {
    if (!input) return null;

    // Clean up input slightly
    input = input.trim();

    // Direct video ID (11 chars alphanumeric/-/_)
    if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;

    // Common URL patterns
    const patterns = [
        /(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=))([a-zA-Z0-9_-]{11})/i,
        /youtu\.be\/([a-zA-Z0-9_-]{11})/i,
        /youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/i,
        /(?:v|embed)\/([a-zA-Z0-9_-]{11})/i,
        /[?&]v=([a-zA-Z0-9_-]{11})/i
    ];

    for (const regex of patterns) {
        const match = input.match(regex);
        if (match && match[1]) return match[1];
    }

    return null;
}

// ‚îÄ‚îÄ 2. Fetch real title + channel (artist) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchVideoDetails(videoId, song) {
    if (!videoId) return;

    try {
        const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${getNextKey()}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(res.status);

        const data = await res.json();
        const item = data.items?.[0];

        if (item?.snippet) {
            const realTitle  = item.snippet.title;
            const realArtist = item.snippet.channelTitle;

            // Update global song reference if possible
            if (song) {
                song.title  = realTitle;
                song.artist = realArtist;
            }

            // Update UI immediately
            const npTitle  = document.getElementById('npTitle');
            const npArtist = document.getElementById('npArtist');

            if (npTitle)  npTitle.textContent  = realTitle  || "Unknown Title";
            if (npArtist) npArtist.textContent = realArtist || "Unknown Artist";

            // Optional: update toast if still visible (a bit hacky but nice)
            const toastTitle = document.getElementById('toastTitle');
            if (toastTitle && toastTitle.textContent.includes("Loading")) {
                toastTitle.textContent = realTitle;
            }

            console.log(`Updated metadata: "${realTitle}" by ${realArtist}`);
        }
    } catch (err) {
        console.warn("Could not fetch video details:", err);
        // Fallback: keep "YouTube" or whatever was set
    }
}

// ‚îÄ‚îÄ 3. Override search input to handle BOTH normal search + pasted URLs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function enhanceSearchInput() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput || searchInput.dataset.enhanced) return;

    // Mark as already enhanced to avoid double-binding
    searchInput.dataset.enhanced = 'true';

    // Replace the oninput handler with our smart version
    searchInput.oninput = (e) => {
        clearTimeout(searchTimeout);
        const value = e.target.value.trim();

        if (!value) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }

        searchTimeout = setTimeout(async () => {
            // Step 1: Check if it's a YouTube URL or direct ID
            const videoId = extractYouTubeVideoId(value);

            if (videoId) {
                // ‚îÄ‚îÄ Direct play mode ‚îÄ‚îÄ
                e.target.value = ''; // clear input after success

                const song = {
                    id: videoId,
                    title: "Loading title...",
                    artist: "YouTube",
                    art: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
                };

                playSong(song);
                showNotification("Playing pasted YouTube video...");

                // Fetch real metadata in background (cheap 1-unit call)
                fetchVideoDetails(videoId, song);

            } else if (value.length >= 3) {
                // ‚îÄ‚îÄ Normal keyword search ‚îÄ‚îÄ
                try {
                    const [videos, playlists] = await Promise.all([
                        fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=10&q=${encodeURIComponent(value)}&key=${getNextKey()}`).then(r => r.json()),
                        fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=playlist&maxResults=4&q=${encodeURIComponent(value + ' album')}&key=${getNextKey()}`).then(r => r.json())
                    ]);

                    renderSearchResults(videos, playlists);
                } catch (error) {
                    console.error("Search error:", error);
                    showNotification("Search failed ‚Äì check console");
                }
            }
        }, 500); // slightly longer debounce for better UX when typing URLs
    };

    // Also support Enter key explicitly (in case browser doesn't trigger oninput)
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            // Trigger the same logic immediately
            const value = searchInput.value.trim();
            const videoId = extractYouTubeVideoId(value);

            if (videoId) {
                const song = {
                    id: videoId,
                    title: "Loading title...",
                    artist: "YouTube",
                    art: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
                };
                playSong(song);
                searchInput.value = '';
                showNotification("Playing pasted video!");
                fetchVideoDetails(videoId, song);
            }
            // Normal search already handled by oninput debounce
        }
    });
}

// ‚îÄ‚îÄ 4. Hook into showSearch() and showHome() to apply enhancement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const originalShowSearch = window.showSearch;
window.showSearch = function() {
    originalShowSearch();
    setTimeout(enhanceSearchInput, 150); // wait for DOM
};

const originalShowHome = window.showHome;
window.showHome = function() {
    originalShowHome();
    setTimeout(() => {
        if (document.getElementById('searchView')?.classList.contains('active')) {
            enhanceSearchInput();
        }
    }, 150);
};

// Optional: If you want to force it on initial load (if search is default view)
setTimeout(enhanceSearchInput, 800);

function linkIndy() {
  alert("Link your tunes account to INDY or INDY+ coming soon!");
}
</script>

<script>
// TUNŒûS Data-Saving Update Popup (brief version)
// Paste before </body>

(function() {
    const UPDATE_KEY = "tunes_datasaving_update_v1";

    if (localStorage.getItem(UPDATE_KEY) === "true") return;

    const modal = document.createElement("div");
    modal.style.cssText = `
        position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px);
        z-index:9999; display:flex; align-items:center; justify-content:center; opacity:0;
        transition:opacity 0.4s ease;
    `;

    const content = document.createElement("div");
    content.style.cssText = `
        background:rgba(30,30,40,0.95); border:1px solid rgba(255,255,255,0.12);
        border-radius:16px; max-width:420px; width:90%; padding:28px 24px; text-align:center;
        box-shadow:0 20px 60px rgba(0,0,0,0.7); transform:scale(0.92);
        transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1);
    `;

    content.innerHTML = `
        <div style="font-size:48px; margin-bottom:12px;">‚ú¶</div>
        <h2 style="font-family:'Syne',sans-serif; font-weight:800; font-size:26px; margin-bottom:16px; letter-spacing:-1px;">
            Data-Saving Update
        </h2>
        <p style="font-size:15px; color:#ddd; line-height:1.6; margin-bottom:20px;">
            INDY MUSIC now lasts way longer each day ‚Äî less quota burn, more music.
        </p>
        <ul style="text-align:left; max-width:360px; margin:0 auto 24px; padding-left:20px; font-size:14px; color:#ccc; line-height:1.7; list-style-type:'‚Üí ';">
            <li>Cached album/mix recommendations (0 quota after first load)</li>
            <li>Smarter search (min 3 chars + longer debounce)</li>
            <li>Paste YouTube URLs ‚Üí instant play (0 quota to start)</li>
            <li>Pasted video metadata fetch = only 1 unit</li>
            <li>Used all of the daily quota? Dont worry, it'll reset in a few hours!</li>
        </ul>
        <button id="acceptUpdateBtn" style="
            background:linear-gradient(135deg,#ffffff,#e0e0e0); color:#000; border:none;
            padding:12px 44px; font-size:16px; font-weight:700; border-radius:50px;
            cursor:pointer; box-shadow:0 6px 20px rgba(255,255,255,0.15);
            transition:all 0.3s ease;
        ">
            Cool!
        </button>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    setTimeout(() => {
        modal.style.opacity = "1";
        content.style.transform = "scale(1)";
    }, 50);

    document.getElementById("acceptUpdateBtn").onclick = () => {
        localStorage.setItem(UPDATE_KEY, "true");
        modal.style.opacity = "0";
        content.style.transform = "scale(0.92)";
        setTimeout(() => modal.remove(), 400);
    };

    modal.onclick = (e) => {
        if (e.target === modal) {
            localStorage.setItem(UPDATE_KEY, "true");
            modal.style.opacity = "0";
            content.style.transform = "scale(0.92)";
            setTimeout(() => modal.remove(), 400);
        }
    };
})();
    // ======================
// ADD TO PLAYLIST FROM RIGHT SIDEBAR üî•
// ======================

let currentPlayingSong = null; // We'll store the currently playing song here

// Override playSong to also save current song + show button
const originalPlaySong = window.playSong;
window.playSong = function(song, fromPlaylist) {
    originalPlaySong.call(this, song, fromPlaylist);
    
    // Save current song so we can add it later
    currentPlayingSong = { ...song }; // copy it
    
    // Show the button
    const btn = document.getElementById('addToPlaylistBtn');
    if (btn) {
        btn.style.display = 'flex';
    }
};

// When song ends or new one starts, we can hide if needed (optional)
function onPlayerStateChange(event) {
    if (event.data === window.YT.PlayerState.ENDED) {
        skipToNext();
        // Optionally hide button if no more songs, but we keep it visible
    }
}

// Click handler for the new button
document.addEventListener('click', (e) => {
    if (e.target.id === 'addToPlaylistBtn' || e.target.closest('#addToPlaylistBtn')) {
        if (!currentPlayingSong) {
            showNotification("Nothing playing right now");
            return;
        }
        showAddToPlaylistMenu(currentPlayingSong);
    }
});
</script>

</body>
</html>
