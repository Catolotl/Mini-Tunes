<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INDY Jam</title>
<link rel="icon" type="image/x-icon" href="favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800;900&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
/* â”€â”€ RESET & VARIABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #080808;
  --panel: #141414;
  --sidebar-bg: #111111;
  --soft: #1e1e1e;
  --hover: #222;
  --accent: #ffffff;
  --accent-dim: #eaeaea;
  --text: #f0f0f0;
  --muted: #888;
  --muted2: #555;
  --teal: #4a8e8b;
  --teal-bright: #6dbfbb;
  --teal-dim: #2d5a58;
  --border: rgba(255,255,255,.07);
  --border-hover: rgba(255,255,255,.14);
  --glow: rgba(74,142,139,.3);
  --radius: 14px;
  --radius-sm: 8px;
  --radius-lg: 20px;
}

html { height: 100%; }

body {
  font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
  height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sticky-nav {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 1000;
  height: 58px;
  background: rgba(8,8,8,.88);
  backdrop-filter: blur(24px) saturate(180%);
  -webkit-backdrop-filter: blur(24px) saturate(180%);
  border-bottom: 1px solid var(--border);
}
.nav-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 100%;
  padding: 0 16px;
}
.nav-logo {
  display: flex; align-items: center; gap: 8px;
  cursor: pointer; padding: 5px 10px;
  border-radius: 40px; text-decoration: none;
  transition: background .2s;
}
.nav-logo:hover { background: rgba(255,255,255,.05); }
.nav-logo-icon {
  font-size: 20px;
  background: linear-gradient(135deg, var(--teal), var(--teal-bright));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1;
}
.nav-logo-text {
  font-family: 'Syne', sans-serif;
  font-size: 18px; font-weight: 800;
  letter-spacing: -0.5px; color: var(--text);
}
.nav-badge {
  background: linear-gradient(135deg, var(--teal), var(--teal-bright));
  color: #000; font-size: 8px; font-weight: 700;
  padding: 2px 6px; border-radius: 10px;
  letter-spacing: 1px; text-transform: uppercase;
}
.nav-center {
  flex: 1; display: flex; align-items: center;
  justify-content: center; padding: 0 20px;
  max-width: 500px; margin: 0 auto;
}
.nav-right { display: flex; align-items: center; gap: 8px; }
.nav-user-chip {
  display: flex; align-items: center; gap: 7px;
  background: rgba(255,255,255,.05);
  border: 1px solid var(--border);
  border-radius: 30px; padding: 5px 12px;
  cursor: pointer; font-size: 13px; font-weight: 500;
  transition: all .2s;
}
.nav-user-chip:hover { background: rgba(255,255,255,.09); border-color: var(--border-hover); }
.nav-btn-ghost {
  background: rgba(255,255,255,.05);
  border: 1px solid var(--border);
  color: var(--text); padding: 7px 14px;
  border-radius: 30px; font-size: 13px; font-weight: 500;
  cursor: pointer; transition: all .2s;
  font-family: 'DM Sans', sans-serif;
}
.nav-btn-ghost:hover { background: rgba(255,255,255,.1); border-color: var(--border-hover); }

/* Network indicator */
.net-indicator {
  width: 8px; height: 8px; border-radius: 50%;
  background: #4caf50; flex-shrink: 0;
  transition: background .3s;
}
.net-indicator.offline { background: #ff5252; animation: pulse 1.2s infinite; }
.net-indicator.reconnecting { background: #ffb300; animation: pulse 0.7s infinite; }

/* â”€â”€ APP CONTAINER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-container { display: flex; height: calc(100vh - 58px); margin-top: 58px; }

/* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen {
  position: fixed; inset: 58px 0 0 0;
  display: flex; align-items: center; justify-content: center;
  padding: 20px; z-index: 500;
  opacity: 0; pointer-events: none;
  transition: opacity .3s ease;
  background: var(--bg); overflow-y: auto;
}
.screen.active { opacity: 1; pointer-events: all; }
#screenAuth { top: 0; }

/* â”€â”€ GLASS CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.glass-card {
  background: rgba(16,16,16,.9);
  backdrop-filter: blur(24px) saturate(150%);
  -webkit-backdrop-filter: blur(24px) saturate(150%);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: var(--radius-lg);
  box-shadow: 0 24px 64px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,.03) inset;
}

/* â”€â”€ AUTH SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screenAuth {
  background: radial-gradient(ellipse at 50% -10%, rgba(74,142,139,.18) 0%, transparent 60%), var(--bg);
}
#screenAuth .glass-card { width: 100%; max-width: 400px; padding: 36px; }
.auth-logo-icon {
  width: 60px; height: 60px; border-radius: 16px;
  background: linear-gradient(135deg, var(--teal), var(--teal-bright));
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; margin: 0 auto 16px;
  box-shadow: 0 8px 32px rgba(74,142,139,.45);
  animation: iconPulse 3s ease-in-out infinite;
}
@keyframes iconPulse {
  0%,100% { box-shadow: 0 8px 32px rgba(74,142,139,.45); }
  50%     { box-shadow: 0 12px 40px rgba(74,142,139,.7); }
}
.auth-title {
  font-family: 'Syne', sans-serif;
  font-size: 24px; font-weight: 800;
  letter-spacing: -0.5px; margin-bottom: 5px; text-align: center;
}
.auth-subtitle { font-size: 13px; color: var(--muted); line-height: 1.6; text-align: center; margin-bottom: 24px; }
.auth-tabs {
  display: flex; background: rgba(255,255,255,.04);
  border-radius: var(--radius-sm); padding: 3px; margin-bottom: 22px; gap: 2px;
}
.auth-tab {
  flex: 1; padding: 8px; background: transparent; border: none;
  border-radius: 6px; color: var(--muted); font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all .2s; font-family: 'DM Sans', sans-serif;
}
.auth-tab.active { background: rgba(255,255,255,.1); color: var(--text); }

/* â”€â”€ INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input {
  width: 100%; padding: 12px 14px;
  background: rgba(255,255,255,.04);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text); font-size: 14px;
  font-family: 'DM Sans', sans-serif;
  outline: none; transition: border-color .2s, box-shadow .2s, background .2s;
}
.input:focus {
  border-color: var(--teal);
  box-shadow: 0 0 0 3px rgba(74,142,139,.2);
  background: rgba(255,255,255,.06);
}
.input::placeholder { color: var(--muted2); }
.input-label {
  font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1.4px;
  color: var(--muted); margin-bottom: 6px; display: block;
}
.input-group { margin-bottom: 16px; }

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; justify-content: center;
  gap: 7px; padding: 11px 22px; border-radius: var(--radius-sm);
  font-size: 14px; font-weight: 600; font-family: 'DM Sans', sans-serif;
  cursor: pointer; border: none;
  transition: all .2s cubic-bezier(.4,0,.2,1);
  white-space: nowrap; position: relative; overflow: hidden;
}
.btn::after { content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0); transition: background .15s; }
.btn:hover::after { background: rgba(255,255,255,.06); }
.btn:active::after { background: rgba(0,0,0,.1); }
.btn-primary {
  background: linear-gradient(135deg, var(--teal), var(--teal-bright));
  color: #000; box-shadow: 0 4px 16px rgba(74,142,139,.4);
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(74,142,139,.55); }
.btn-primary:active { transform: translateY(0); }
.btn-ghost { background: rgba(255,255,255,.05); color: var(--text); border: 1px solid var(--border); }
.btn-ghost:hover { background: rgba(255,255,255,.09); border-color: var(--border-hover); }
.btn-danger { background: rgba(255,80,80,.12); color: #ff6b6b; border: 1px solid rgba(255,80,80,.22); }
.btn-danger:hover { background: rgba(255,80,80,.2); }
.btn-sm { padding: 7px 13px; font-size: 12px; border-radius: 6px; }
.btn-lg { padding: 14px 28px; font-size: 15px; border-radius: var(--radius); }
.btn-block { width: 100%; }
.btn:disabled { opacity: .38; cursor: not-allowed; transform: none !important; pointer-events: none; }

/* â”€â”€ PROFILE SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screenProfile .glass-card { width: 100%; max-width: 440px; padding: 36px; }
.emoji-picker { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
.emoji-opt {
  width: 42px; height: 42px; border-radius: 9px;
  border: 1.5px solid var(--border);
  background: rgba(255,255,255,.03);
  font-size: 20px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .18s;
}
.emoji-opt:hover { border-color: var(--teal); background: rgba(74,142,139,.1); transform: scale(1.08); }
.emoji-opt.selected { border-color: var(--teal); background: rgba(74,142,139,.2); box-shadow: 0 0 0 3px rgba(74,142,139,.15); }
.mood-options { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
.mood-opt {
  padding: 6px 13px; border-radius: 20px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
  color: var(--muted); font-size: 12px; font-weight: 500;
  cursor: pointer; transition: all .18s;
}
.mood-opt:hover { border-color: var(--teal); color: var(--text); }
.mood-opt.selected { border-color: var(--teal); background: rgba(74,142,139,.18); color: var(--text); }

/* â”€â”€ LOBBY SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screenLobby { align-items: flex-start; padding: 0; background: var(--bg); overflow: hidden; }
.lobby-layout { display: flex; width: 100%; height: 100%; overflow: hidden; }
.lobby-sidebar {
  width: 260px; background: var(--sidebar-bg);
  border-right: 1px solid var(--border);
  padding: 24px 16px;
  display: flex; flex-direction: column; gap: 4px;
  overflow-y: auto; flex-shrink: 0;
}
.lobby-sidebar-title {
  font-family: 'Syne', sans-serif;
  font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1.8px;
  color: var(--muted2); margin-bottom: 10px; margin-top: 20px; padding-left: 4px;
}
.lobby-sidebar-title:first-child { margin-top: 0; }
.lobby-main {
  flex: 1; min-width: 0; overflow-y: auto; overflow-x: hidden;
  padding: 40px 40px 80px;
  background: radial-gradient(ellipse 80% 40% at 50% -5%, rgba(74,142,139,.14) 0%, transparent 60%), var(--bg);
}
.lobby-greeting h1 {
  font-family: 'Syne', sans-serif;
  font-size: clamp(24px, 3.5vw, 38px);
  font-weight: 900; letter-spacing: -1.5px; margin-bottom: 6px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.lobby-greeting p { color: var(--muted); font-size: 14px; margin-bottom: 32px; }
.lobby-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 36px; max-width: 700px; }
.action-card {
  background: rgba(0,0,0,.3); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 26px;
  cursor: pointer; transition: all .3s cubic-bezier(.4,0,.2,1);
  position: relative; overflow: hidden;
}
.action-card::before { content: ''; position: absolute; inset: 0; opacity: 0; transition: opacity .3s; pointer-events: none; }
.action-card.host::before { background: linear-gradient(135deg, rgba(74,142,139,.14), rgba(109,191,187,.05)); }
.action-card.join::before { background: linear-gradient(135deg, rgba(255,255,255,.07), rgba(74,142,139,.04)); }
.action-card:hover { border-color: rgba(255,255,255,.14); transform: translateY(-3px); box-shadow: 0 16px 40px rgba(0,0,0,.5); }
.action-card:hover::before { opacity: 1; }
.action-card:active { transform: translateY(0); }
.action-card-icon { font-size: 36px; margin-bottom: 14px; display: block; }
.action-card-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 7px; }
.action-card-desc { font-size: 12px; color: var(--muted); line-height: 1.5; }
.recent-section { margin-top: 32px; max-width: 700px; }
.recent-section h3 {
  font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1.8px;
  color: var(--muted2); margin-bottom: 14px;
}
.recent-room-item {
  display: flex; align-items: center; gap: 12px;
  padding: 11px 14px; background: rgba(0,0,0,.2);
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  cursor: pointer; transition: all .2s; margin-bottom: 6px;
}
.recent-room-item:hover { background: rgba(74,142,139,.08); border-color: rgba(74,142,139,.3); transform: translateX(2px); }
.recent-room-code {
  font-family: 'Syne', sans-serif; font-size: 16px;
  font-weight: 800; letter-spacing: 3px; color: var(--teal); min-width: 78px;
}
.recent-room-info { flex: 1; }
.recent-room-name { font-size: 13px; font-weight: 600; }
.recent-room-time { font-size: 11px; color: var(--muted); margin-top: 2px; }
.profile-card-mini {
  background: rgba(0,0,0,.25); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 14px; margin-bottom: 16px;
}
.profile-card-mini .emoji { font-size: 30px; margin-bottom: 7px; }
.profile-card-mini .name { font-size: 14px; font-weight: 600; }
.profile-card-mini .mood { font-size: 11px; color: var(--muted); margin-top: 2px; }

/* â”€â”€ CREATE/JOIN SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screenCreate .glass-card, #screenJoin .glass-card { width: 100%; max-width: 420px; padding: 36px; }
.error-box {
  background: rgba(255,80,80,.08); border: 1px solid rgba(255,80,80,.2);
  border-radius: var(--radius-sm); padding: 10px 13px;
  font-size: 13px; color: #ff9090; margin-bottom: 14px;
  display: none; line-height: 1.5;
}
.success-box {
  background: rgba(74,142,139,.1); border: 1px solid rgba(74,142,139,.28);
  border-radius: var(--radius-sm); padding: 10px 13px;
  font-size: 13px; color: var(--teal-bright); margin-bottom: 14px; display: none;
}
.setting-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 11px 0; border-bottom: 1px solid rgba(255,255,255,.05);
}
.setting-row:last-child { border-bottom: none; }
.setting-label { font-size: 13px; font-weight: 500; }
.setting-desc { font-size: 11px; color: var(--muted); margin-top: 2px; }
.toggle { position: relative; width: 42px; height: 22px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute; inset: 0;
  background: rgba(255,255,255,.1); border-radius: 11px;
  cursor: pointer; transition: background .2s;
}
.toggle-slider::before {
  content: ''; position: absolute;
  width: 16px; height: 16px; left: 3px; top: 3px;
  background: white; border-radius: 50%;
  transition: transform .2s cubic-bezier(.4,0,.2,1);
  box-shadow: 0 1px 4px rgba(0,0,0,.3);
}
.toggle input:checked + .toggle-slider { background: linear-gradient(135deg, var(--teal), var(--teal-bright)); }
.toggle input:checked + .toggle-slider::before { transform: translateX(20px); }

/* â”€â”€ ROOM SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screenRoom { align-items: flex-start; padding: 0; background: var(--bg); overflow: hidden; }
.room-layout { display: flex; width: 100%; height: 100%; }
.room-left {
  width: 252px; background: var(--sidebar-bg);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;
}
.room-center { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; position: relative; }
.room-center-bg {
  position: absolute; inset: 0;
  background: radial-gradient(ellipse 80% 35% at 50% 0%, rgba(74,142,139,.12) 0%, transparent 55%);
  pointer-events: none; z-index: 0;
}
.room-right { width: 320px; background: #050505; border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; }
.room-header {
  padding: 12px 18px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px; flex-shrink: 0;
  background: rgba(8,8,8,.7); backdrop-filter: blur(12px);
  position: relative; z-index: 1;
}
.room-code-badge {
  background: rgba(74,142,139,.15); border: 1px solid rgba(74,142,139,.3);
  border-radius: 7px; padding: 5px 12px;
  font-family: 'Syne', sans-serif; font-size: 15px;
  font-weight: 800; letter-spacing: 3px; color: var(--teal-bright);
  cursor: pointer; transition: all .2s; white-space: nowrap; flex-shrink: 0;
}
.room-code-badge:hover { background: rgba(74,142,139,.25); border-color: rgba(74,142,139,.5); }
.room-name-disp { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.room-content { flex: 1; overflow-y: auto; padding: 22px; position: relative; z-index: 1; }
.panel-header { padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.panel-title { font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--muted); }
.panel-list { flex: 1; overflow-y: auto; padding: 5px; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; }
.badge-teal { background: rgba(74,142,139,.18); color: var(--teal-bright); border: 1px solid rgba(74,142,139,.3); }
.badge-white { background: rgba(255,255,255,.1); color: #ddd; border: 1px solid rgba(255,255,255,.16); }

/* Queue items */
.queue-item {
  display: flex; align-items: center; gap: 9px; padding: 8px 9px;
  border-radius: var(--radius-sm); cursor: pointer;
  transition: background .15s; position: relative;
}
.queue-item:hover { background: rgba(255,255,255,.04); }
.queue-item.playing { background: rgba(74,142,139,.12); border-left: 2px solid var(--teal); padding-left: 7px; }
.queue-item.dragging { opacity: .5; background: rgba(74,142,139,.08); }
.queue-item[draggable="true"] { cursor: grab; }
.queue-thumb { width: 36px; height: 36px; border-radius: 6px; background: var(--soft); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 15px; overflow: hidden; }
.queue-thumb img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
.queue-item-info { flex: 1; min-width: 0; }
.queue-item-title { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.queue-item-by { font-size: 10px; color: var(--muted); margin-top: 1px; }
.queue-playing-bar { display: flex; align-items: flex-end; gap: 2px; height: 14px; padding-right: 2px; }
.queue-playing-bar span { width: 3px; background: linear-gradient(180deg, var(--teal-bright), var(--teal)); border-radius: 2px; animation: barBounce 1.1s ease-in-out infinite; }
.queue-playing-bar span:nth-child(2) { animation-delay: .18s; }
.queue-playing-bar span:nth-child(3) { animation-delay: .36s; }
@keyframes barBounce { 0%,100% { height: 3px; } 50% { height: 13px; } }

/* Members */
.member-item { display: flex; align-items: center; gap: 9px; padding: 7px 9px; border-radius: var(--radius-sm); transition: background .15s; }
.member-item:hover { background: rgba(255,255,255,.03); }
.member-avatar { width: 32px; height: 32px; border-radius: 7px; background: var(--soft); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; position: relative; }
.member-host-dot { position: absolute; bottom: -2px; right: -2px; width: 11px; height: 11px; border-radius: 50%; background: var(--teal); border: 2px solid var(--sidebar-bg); display: flex; align-items: center; justify-content: center; font-size: 5px; color: #000; font-weight: 700; }
.member-name { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.member-mood { font-size: 10px; color: var(--muted); }
.kick-btn { background: transparent; border: none; color: var(--muted); cursor: pointer; padding: 4px; border-radius: 4px; font-size: 13px; opacity: 0; transition: all .2s; margin-left: auto; flex-shrink: 0; }
.member-item:hover .kick-btn { opacity: 1; }
.kick-btn:hover { color: #ff5f5f; background: rgba(255,80,80,.12) !important; }

/* â”€â”€ PLAYER SIDEBAR (RIGHT) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.player-video { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; flex-shrink: 0; }
.player-video iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: none; }
.player-info { padding: 16px 18px 10px; flex-shrink: 0; border-bottom: 1px solid var(--border); }
.np-song-title { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.np-song-artist { font-size: 12px; color: var(--muted); margin-bottom: 12px; }
.np-controls { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 9px; }
.np-btn { width: 38px; height: 38px; border-radius: 50%; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all .18s; }
.np-btn:hover { background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.22); }
.np-btn-play { width: 44px; height: 44px; background: linear-gradient(135deg, var(--teal), var(--teal-bright)); border: none; color: #000; font-size: 18px; box-shadow: 0 4px 14px rgba(74,142,139,.45); }
.np-btn-play:hover { transform: scale(1.08); box-shadow: 0 6px 20px rgba(74,142,139,.65); }
.np-btn-play.paused { background: linear-gradient(135deg, #555, #777); box-shadow: none; }
.progress-wrap { display: flex; align-items: center; gap: 7px; font-size: 10px; color: var(--muted); padding: 0 0 9px; }
.progress-bar { flex: 1; height: 3px; background: rgba(255,255,255,.1); border-radius: 2px; cursor: pointer; position: relative; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--teal), var(--teal-bright)); border-radius: 2px; width: 0%; transition: width .8s linear; pointer-events: none; }
.volume-wrap { display: flex; align-items: center; gap: 7px; padding: 0 0 2px; }
.volume-icon { font-size: 13px; color: var(--muted); cursor: pointer; }
.volume-slider { -webkit-appearance: none; flex: 1; height: 3px; background: rgba(255,255,255,.1); border-radius: 2px; outline: none; }
.volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 11px; height: 11px; background: #fff; border-radius: 50%; cursor: pointer; transition: transform .1s; }
.volume-slider::-webkit-slider-thumb:hover { transform: scale(1.3); }
.player-lyrics { flex: 1; overflow-y: auto; padding: 12px 18px 18px; }
.player-lyrics h4 { font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.4px; color: var(--teal); margin-bottom: 12px; }
.lyric-line { font-size: 13px; color: rgba(255,255,255,.4); line-height: 2; transition: all .35s ease; cursor: pointer; display: block; }
.lyric-line:hover { color: rgba(255,255,255,.65); }
.lyric-line.active { color: #fff; font-weight: 600; font-size: 14px; }

/* â”€â”€ SEARCH RESULTS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#searchModal {
  position: fixed; inset: 0; z-index: 3000;
  background: rgba(0,0,0,.7); backdrop-filter: blur(10px);
  display: flex; align-items: center; justify-content: center;
  padding: 20px; opacity: 0; visibility: hidden;
  transition: opacity .25s, visibility .25s;
}
#searchModal.open { opacity: 1; visibility: visible; }
.search-modal-card {
  background: #181818; border: 1px solid rgba(255,255,255,.1);
  border-radius: var(--radius-lg); padding: 24px;
  width: 100%; max-width: 520px;
  box-shadow: 0 32px 80px rgba(0,0,0,.8);
  animation: modalIn .25s ease forwards;
}
@keyframes modalIn { from { opacity:0; transform: translateY(16px); } to { opacity:1; transform:none; } }
.search-modal-title { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; margin-bottom: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
.search-result-item {
  display: flex; align-items: center; gap: 11px; padding: 10px 11px;
  border-radius: var(--radius-sm); cursor: pointer; transition: background .15s;
  margin-bottom: 4px; border: 1px solid transparent;
}
.search-result-item:hover { background: rgba(74,142,139,.1); border-color: rgba(74,142,139,.25); }
.search-result-thumb { width: 56px; height: 40px; border-radius: 5px; background: var(--soft); overflow: hidden; flex-shrink: 0; }
.search-result-thumb img { width: 100%; height: 100%; object-fit: cover; }
.search-result-info { flex: 1; min-width: 0; }
.search-result-title { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.search-result-channel { font-size: 11px; color: var(--muted); margin-top: 2px; }
.search-result-duration { font-size: 11px; color: var(--muted2); flex-shrink: 0; }

/* â”€â”€ ROOM MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.upload-panel { background: rgba(0,0,0,.2); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; margin-bottom: 16px; }
.upload-panel h3 { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 7px; }
.settings-panel { background: rgba(0,0,0,.2); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; margin-bottom: 16px; }
.settings-panel h3 { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 7px; }
.playlist-select-item { display: flex; align-items: center; gap: 11px; padding: 9px 11px; border-radius: var(--radius-sm); cursor: pointer; transition: background .15s; border: 1px solid transparent; }
.playlist-select-item:hover { background: rgba(255,255,255,.04); }
.playlist-select-item.selected { background: rgba(74,142,139,.1); border-color: rgba(74,142,139,.25); }

/* Invite link panel */
.invite-panel {
  background: rgba(74,142,139,.06); border: 1px solid rgba(74,142,139,.18);
  border-radius: var(--radius-sm); padding: 14px; margin-bottom: 14px;
}
.invite-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--teal); margin-bottom: 8px; }
.invite-link-row { display: flex; gap: 8px; align-items: center; }
.invite-link-text { flex: 1; background: rgba(0,0,0,.3); border: 1px solid rgba(74,142,139,.2); border-radius: 6px; padding: 8px 11px; font-size: 12px; color: var(--muted); font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
.invite-link-text:hover { color: var(--teal-bright); }

/* â”€â”€ REACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.react-bar {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: rgba(12,12,12,.96); backdrop-filter: blur(20px);
  border: 1px solid var(--border); border-radius: 50px;
  padding: 6px 12px; display: flex; align-items: center; gap: 2px;
  z-index: 50; box-shadow: 0 8px 32px rgba(0,0,0,.6);
}
.react-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; font-size: 20px; cursor: pointer; transition: all .18s; display: flex; align-items: center; justify-content: center; }
.react-btn:hover { background: rgba(255,255,255,.08); transform: scale(1.25); }
.react-btn:active { transform: scale(.9); }
.reaction-float { position: fixed; font-size: 26px; pointer-events: none; z-index: 200; animation: floatUp 2.5s ease-out forwards; }
@keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 50% { opacity: 1; transform: translateY(-80px) scale(1.25); } 100% { opacity: 0; transform: translateY(-180px) scale(.7); } }

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.jam-toast {
  position: fixed; top: 68px; right: 20px;
  background: rgba(18,18,18,.97); border: 1px solid var(--border);
  border-left: 3px solid var(--teal); border-radius: var(--radius-sm);
  padding: 11px 16px; font-size: 13px; font-weight: 500;
  z-index: 9999; box-shadow: 0 8px 24px rgba(0,0,0,.5);
  transform: translateX(130%); transition: transform .3s cubic-bezier(.34,1.4,.64,1);
  max-width: 280px; pointer-events: none;
}
.jam-toast.show { transform: translateX(0); }

/* â”€â”€ SPINNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.1); border-top-color: var(--teal); border-radius: 50%; animation: spin .65s linear infinite; display: inline-block; flex-shrink: 0; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state { text-align: center; padding: 28px 14px; color: var(--muted); }
.empty-state-icon { font-size: 32px; opacity: .35; margin-bottom: 9px; }
.empty-state-text { font-size: 12px; }

/* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(74,142,139,.35); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(74,142,139,.55); }

/* â”€â”€ FADE IN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes fadeInUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeInUp .35s ease forwards; }

/* â”€â”€ CHAT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.chat-messages { flex: 1; overflow-y: auto; padding: 6px; display: flex; flex-direction: column; gap: 2px; }
.chat-msg { display: flex; align-items: flex-start; gap: 7px; padding: 5px 7px; border-radius: 7px; transition: background .12s; animation: msgIn .2s ease forwards; }
@keyframes msgIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }
.chat-msg:hover { background: rgba(255,255,255,.03); }
.chat-msg-emoji { font-size: 14px; flex-shrink: 0; margin-top: 2px; }
.chat-msg-body { flex: 1; min-width: 0; }
.chat-msg-author { font-size: 10px; font-weight: 700; color: var(--teal-bright); margin-bottom: 2px; }
.chat-msg-text { font-size: 12px; color: var(--muted); line-height: 1.45; word-break: break-word; }
.chat-msg-text.is-me { color: var(--text); }
.chat-msg.system .chat-msg-author { color: var(--muted2); }
.chat-msg.system .chat-msg-text { color: var(--muted2); font-style: italic; }
.chat-input-wrap { padding: 8px; border-top: 1px solid var(--border); display: flex; gap: 6px; flex-shrink: 0; }
.chat-input { flex: 1; padding: 7px 11px; background: rgba(255,255,255,.05); border: 1px solid var(--border); border-radius: 18px; color: var(--text); font-size: 12px; font-family: 'DM Sans', sans-serif; outline: none; transition: border-color .2s; }
.chat-input:focus { border-color: var(--teal); }
.chat-send-btn { width: 32px; height: 32px; background: linear-gradient(135deg, var(--teal), var(--teal-bright)); border: none; border-radius: 50%; color: #000; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .18s; flex-shrink: 0; }
.chat-send-btn:hover { transform: scale(1.12); }

/* â”€â”€ VOTE SKIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.vote-panel { background: rgba(74,142,139,.07); border: 1px solid rgba(74,142,139,.2); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 10px; display: none; }
.vote-panel.active { display: block; animation: slideDown .25s ease; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
.vote-label { font-size: 12px; font-weight: 600; margin-bottom: 7px; display: flex; align-items: center; justify-content: space-between; }
.vote-bar { height: 5px; background: rgba(255,255,255,.08); border-radius: 3px; overflow: hidden; margin-bottom: 7px; }
.vote-fill { height: 100%; background: linear-gradient(90deg, var(--teal), var(--teal-bright)); border-radius: 3px; transition: width .4s cubic-bezier(.4,0,.2,1); }
.vote-fill.warning { background: linear-gradient(90deg, #ff8f8f, #ff5f5f); }

/* â”€â”€ ROOM TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.room-tabs { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; background: rgba(8,8,8,.5); }
.room-tab { flex: 1; padding: 11px; background: transparent; border: none; color: var(--muted); font-size: 11px; font-weight: 700; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all .2s; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid transparent; position: relative; }
.room-tab.active { color: var(--text); border-bottom-color: var(--teal); }
.room-tab:hover { color: var(--text); }
.tab-badge { position: absolute; top: 6px; right: 8px; background: var(--teal); color: #000; font-size: 9px; font-weight: 700; padding: 1px 5px; border-radius: 10px; min-width: 16px; text-align: center; }
.tab-pane { display: none; }
.tab-pane.active { display: flex; flex-direction: column; flex: 1; overflow: hidden; }

/* â”€â”€ LIVE ACTIVITY FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.activity-item { display: flex; align-items: center; gap: 7px; padding: 6px 8px; border-radius: 7px; font-size: 11px; color: var(--muted); animation: fadeInUp .3s ease; }
.activity-item .a-icon { font-size: 12px; flex-shrink: 0; }
.activity-item .a-name { color: var(--teal-bright); font-weight: 700; }

/* â”€â”€ MOOD METER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mood-meter-panel { background: rgba(0,0,0,.2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; margin: 8px; flex-shrink: 0; }
.mood-meter-panel h3 { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; margin-bottom: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
.mood-bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 7px; }
.mood-bar-label { font-size: 11px; color: var(--muted); width: 72px; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.mood-bar { flex: 1; height: 5px; background: rgba(255,255,255,.07); border-radius: 3px; overflow: hidden; }
.mood-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--teal), var(--teal-bright)); transition: width .6s cubic-bezier(.4,0,.2,1); }
.mood-count { font-size: 10px; color: var(--muted); width: 18px; text-align: right; }

/* â”€â”€ RADIO MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.radio-on-badge { display: inline-flex; align-items: center; gap: 5px; background: rgba(255,80,80,.12); border: 1px solid rgba(255,80,80,.25); border-radius: 20px; padding: 3px 10px; font-size: 10px; font-weight: 700; color: #ff8080; text-transform: uppercase; letter-spacing: 1px; }
.radio-on-dot { width: 5px; height: 5px; border-radius: 50%; background: #ff5f5f; animation: pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: .6; } }

/* â”€â”€ FULLSCREEN LYRICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#fullLyricsOverlay {
  position: fixed; inset: 0; z-index: 2000;
  background: rgba(0,0,0,.93); backdrop-filter: blur(40px);
  -webkit-backdrop-filter: blur(40px);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 60px; opacity: 0; visibility: hidden;
  transition: opacity .3s ease, visibility .3s ease;
}
#fullLyricsOverlay.open { opacity: 1; visibility: visible; }
#fullLyricsContent { text-align: center; max-width: 700px; }
#fullLyricsContent .lyric-line { font-size: 26px; margin: 8px 0; }
#fullLyricsContent .lyric-line.active { font-size: 36px; text-shadow: 0 0 30px rgba(74,142,139,.8), 0 0 60px rgba(74,142,139,.4); }
#fullLyricsClose { position: fixed; top: 18px; right: 18px; background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.15); border-radius: 50%; width: 40px; height: 40px; color: #fff; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: background .2s; }
#fullLyricsClose:hover { background: rgba(255,255,255,.18); }

/* â”€â”€ ROOM STATS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.room-stats { display: flex; gap: 12px; flex-wrap: wrap; }
.room-stat { background: rgba(0,0,0,.25); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 11px 14px; text-align: center; flex: 1; min-width: 70px; transition: border-color .2s; }
.room-stat:hover { border-color: rgba(74,142,139,.3); }
.room-stat-val { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; background: linear-gradient(135deg, #fff, var(--teal-bright)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.room-stat-label { font-size: 10px; color: var(--muted); margin-top: 2px; text-transform: uppercase; letter-spacing: .8px; }

/* â”€â”€ SEARCH BAR IN NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.room-search-wrap { display: flex; align-items: center; gap: 7px; background: rgba(255,255,255,.05); border: 1px solid var(--border); border-radius: 20px; padding: 6px 13px; flex: 1; max-width: 340px; transition: border-color .2s; }
.room-search-wrap:focus-within { border-color: rgba(74,142,139,.4); }
.room-search-wrap input { flex: 1; background: transparent; border: none; color: var(--text); font-size: 13px; outline: none; font-family: 'DM Sans', sans-serif; }
.room-search-wrap input::placeholder { color: var(--muted2); }
.room-search-icon { color: var(--muted2); font-size: 13px; }
.room-search-spinner { display: none; }
.room-search-spinner.active { display: inline-block; }

/* â”€â”€ QUEUE ADD INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.queue-add-wrap { padding: 8px; border-top: 1px solid var(--border); flex-shrink: 0; }
.queue-add-input { width: 100%; padding: 7px 11px; background: rgba(255,255,255,.04); border: 1px solid var(--border); border-radius: 18px; color: var(--text); font-size: 12px; font-family: 'DM Sans', sans-serif; outline: none; transition: border-color .2s; }
.queue-add-input:focus { border-color: var(--teal); }
.queue-add-input::placeholder { color: var(--muted2); }

/* â”€â”€ FOCUS VISIBLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:focus-visible { outline: 2px solid var(--teal); outline-offset: 2px; }

/* â”€â”€ DRAG OVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.drag-over { background: rgba(74,142,139,.15) !important; border: 1px dashed rgba(74,142,139,.5) !important; }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1000px) { .room-right { display: none; } .room-left { width: 220px; } }
@media (max-width: 720px) { .room-left { display: none; } .lobby-sidebar { display: none; } .lobby-cards { grid-template-columns: 1fr; } .lobby-main { padding: 28px 20px 60px; } }
</style>
</head>
<body>

<!-- â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="sticky-nav" id="jamNav" style="display:none;">
  <div class="nav-inner">
    <a href="full-tunes.html" class="nav-logo">
      <span class="nav-logo-icon">âœ¦</span>
      <span class="nav-logo-text">INDY Jam</span>
      <span class="nav-badge">Beta</span>
    </a>
    <div class="nav-center" id="navCenter"></div>
    <div class="nav-right" id="navRight">
      <div class="net-indicator" id="netIndicator" title="Connected"></div>
    </div>
  </div>
</div>

<!-- â•â• SCREEN: AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screenAuth">
  <div class="glass-card fade-in">
    <div class="auth-logo-icon">âœ¦</div>
    <div class="auth-title">INDY Jam</div>
    <div class="auth-subtitle">Sign in to start or join a real-time jam session with your friends</div>

    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('signin')" id="tabSignIn">Sign In</button>
      <button class="auth-tab" onclick="switchTab('signup')" id="tabSignUp">Sign Up</button>
    </div>

    <div class="error-box" id="authError"></div>
    <div class="success-box" id="authSuccess"></div>

    <div class="input-group">
      <label class="input-label">Email</label>
      <input class="input" id="authEmail" type="email" placeholder="you@example.com"
        onkeypress="if(event.key==='Enter')document.getElementById('authPass').focus()">
    </div>
    <div class="input-group">
      <label class="input-label">Password</label>
      <input class="input" id="authPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
        onkeypress="if(event.key==='Enter')submitAuth()">
    </div>

    <button class="btn btn-primary btn-block btn-lg" id="authBtn" onclick="submitAuth()">Sign In</button>
    <button onclick="forgotPass()" id="forgotBtn"
      style="width:100%;margin-top:10px;background:transparent;border:none;color:var(--muted);font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:color .2s;"
      onmouseover="this.style.color='#fff'" onmouseout="this.style.color='var(--muted)'">
      Forgot password?
    </button>
  </div>
</div>

<!-- â•â• SCREEN: PROFILE SETUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenProfile">
  <div class="glass-card fade-in">
    <div class="auth-title" style="text-align:left;margin-bottom:5px;">Your Jam Profile</div>
    <div class="auth-subtitle" style="text-align:left;margin-bottom:22px;">How you appear in jam sessions</div>
    <div class="input-group">
      <label class="input-label">Display Name</label>
      <input class="input" id="profileName" type="text" placeholder="What should we call you?" maxlength="24">
      <div style="font-size:11px;color:#ff6b6b;margin-top:5px;min-height:16px;" id="profileNameFeedback"></div>
    </div>
    <div class="input-group">
      <label class="input-label">Avatar emoji</label>
      <div class="emoji-picker" id="emojiPicker"></div>
    </div>
    <div class="input-group">
      <label class="input-label">Current Vibe</label>
      <div class="mood-options" id="moodOptions"></div>
    </div>
    <button class="btn btn-primary btn-block btn-lg" onclick="saveProfile()" id="profileBtn">Save &amp; Continue â†’</button>
  </div>
</div>

<!-- â•â• SCREEN: LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenLobby">
  <div class="lobby-layout">
    <div class="lobby-sidebar">
      <div class="lobby-sidebar-title">You</div>
      <div class="profile-card-mini" id="lobbyProfileCard">
        <div class="emoji" id="lbEmoji">ğŸµ</div>
        <div class="name" id="lbName">Loading...</div>
        <div class="mood" id="lbMood"></div>
        <button class="btn btn-ghost btn-sm" onclick="showScreen('screenProfile')" style="margin-top:10px;width:100%;">Edit Profile</button>
      </div>
      <div class="lobby-sidebar-title">Quick Join</div>
      <div style="display:flex;flex-direction:column;gap:6px;" id="recentRoomsSection">
        <div style="font-size:11px;color:var(--muted);padding:4px;">No recent rooms</div>
      </div>
      <div style="margin-top:auto;padding-top:16px;">
        <button class="btn btn-ghost btn-sm btn-block" onclick="signOut()" style="opacity:.5;font-size:12px;">Sign Out</button>
      </div>
    </div>

    <div class="lobby-main">
      <div class="lobby-greeting fade-in">
        <h1 id="lobbyGreeting">Hey there ğŸ‘‹</h1>
        <p>Ready to jam? Create a room or jump into a friend's session.</p>
      </div>
      <div class="lobby-cards fade-in">
        <div class="action-card host" onclick="showScreen('screenCreate')">
          <span class="action-card-icon">ğŸ™ï¸</span>
          <div class="action-card-title">Host a Jam</div>
          <div class="action-card-desc">Create a room, set the vibe, and invite friends with a code</div>
        </div>
        <div class="action-card join" onclick="showScreen('screenJoin')">
          <span class="action-card-icon">ğŸšª</span>
          <div class="action-card-title">Join a Jam</div>
          <div class="action-card-desc">Enter a 6-letter code to join a friend's session</div>
        </div>
      </div>
      <div class="recent-section fade-in">
        <h3>What's new in Jam</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;">
          <div style="background:rgba(0,0,0,.22);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;">
            <div style="font-size:22px;margin-bottom:7px;">ğŸµ</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:3px;">Built-in Player</div>
            <div style="font-size:11px;color:var(--muted);">Songs play right in the sidebar â€” no new tabs</div>
          </div>
          <div style="background:rgba(0,0,0,.22);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;">
            <div style="font-size:22px;margin-bottom:7px;">ğŸ’¬</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:3px;">Live Chat</div>
            <div style="font-size:11px;color:var(--muted);">React and chat with your crew in real-time</div>
          </div>
          <div style="background:rgba(0,0,0,.22);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;">
            <div style="font-size:22px;margin-bottom:7px;">ğŸ“Š</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:3px;">Mood Meter</div>
            <div style="font-size:11px;color:var(--muted);">See the collective vibe of your jam room</div>
          </div>
          <div style="background:rgba(0,0,0,.22);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;">
            <div style="font-size:22px;margin-bottom:7px;">ğŸ”€</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:3px;">Vote to Skip</div>
            <div style="font-size:11px;color:var(--muted);">Democratically skip songs you're not feeling</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• SCREEN: CREATE ROOM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenCreate">
  <div class="glass-card fade-in">
    <button class="btn btn-ghost btn-sm" onclick="showScreen('screenLobby')" style="margin-bottom:18px;">â† Back</button>
    <div class="auth-title" style="text-align:left;margin-bottom:5px;">Host a Jam</div>
    <div class="auth-subtitle" style="text-align:left;margin-bottom:22px;">Set up your room</div>
    <div class="input-group">
      <label class="input-label">Room Name</label>
      <input class="input" id="roomNameInput" type="text" placeholder="Friday Night Vibes" maxlength="32"
        onkeypress="if(event.key==='Enter')createRoom()">
    </div>
    <div style="margin-bottom:18px;">
      <label class="input-label" style="display:block;margin-bottom:10px;">Room Settings</label>
      <div class="setting-row">
        <div><div class="setting-label">Allow reactions</div><div class="setting-desc">Members can react with emojis</div></div>
        <label class="toggle"><input type="checkbox" id="setReactions" checked><span class="toggle-slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-label">Allow song uploads</div><div class="setting-desc">Members can add to the queue</div></div>
        <label class="toggle"><input type="checkbox" id="setUploads" checked><span class="toggle-slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-label">Allow vote-skip</div><div class="setting-desc">Members can vote to skip songs</div></div>
        <label class="toggle"><input type="checkbox" id="setSkips" checked><span class="toggle-slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-label">Enable live chat</div><div class="setting-desc">Members can send messages</div></div>
        <label class="toggle"><input type="checkbox" id="setChat" checked><span class="toggle-slider"></span></label>
      </div>
      <div class="setting-row" style="border-bottom:none;">
        <div><div class="setting-label">Radio mode</div><div class="setting-desc">Auto-play related songs when queue ends</div></div>
        <label class="toggle"><input type="checkbox" id="setRadio"><span class="toggle-slider"></span></label>
      </div>
    </div>
    <button class="btn btn-primary btn-block btn-lg" onclick="createRoom()" id="createBtn">ğŸ™ï¸ Create Room</button>
  </div>
</div>

<!-- â•â• SCREEN: JOIN ROOM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenJoin">
  <div class="glass-card fade-in">
    <button class="btn btn-ghost btn-sm" onclick="showScreen('screenLobby')" style="margin-bottom:18px;">â† Back</button>
    <div class="auth-title" style="text-align:left;margin-bottom:5px;">Join a Jam</div>
    <div class="auth-subtitle" style="text-align:left;margin-bottom:22px;">Enter the 6-letter code from your host</div>
    <div class="input-group">
      <label class="input-label">Room Code</label>
      <input class="input" id="joinCode" type="text" placeholder="ABC123" maxlength="6"
        style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:8px;text-align:center;text-transform:uppercase;"
        oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"
        onkeypress="if(event.key==='Enter')joinRoom()">
    </div>
    <div class="error-box" id="joinError"></div>
    <button class="btn btn-primary btn-block btn-lg" onclick="joinRoom()" id="joinBtn">ğŸšª Join Room</button>
  </div>
</div>

<!-- â•â• SCREEN: ROOM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenRoom" style="overflow:hidden;padding:0;">
  <div class="room-layout">

    <!-- LEFT: Queue + Chat + Members -->
    <div class="room-left">
      <div class="room-tabs">
        <button class="room-tab active" onclick="switchRoomTab('queue',this)">Queue</button>
        <button class="room-tab" onclick="switchRoomTab('chat',this)" id="chatTabBtn">Chat</button>
        <button class="room-tab" onclick="switchRoomTab('members',this)">Members</button>
      </div>

      <!-- QUEUE TAB -->
      <div class="tab-pane active" id="tabQueue">
        <div class="panel-header" style="border-bottom:none;padding-bottom:4px;">
          <div class="panel-title">Up Next</div>
          <span class="badge badge-teal" id="queueCount">0</span>
        </div>
        <div class="vote-panel" id="votePanel">
          <div class="vote-label" id="voteLabel">Vote to skip?</div>
          <div class="vote-bar"><div class="vote-fill" id="voteFill" style="width:0%"></div></div>
          <button class="btn btn-ghost btn-sm" onclick="voteSkip()" id="voteBtn" style="width:100%;font-size:11px;">ğŸ‘ Vote Skip</button>
        </div>
        <div class="panel-list" id="queueList">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¶</div>
            <div class="empty-state-text">Queue is empty</div>
          </div>
        </div>
        <div class="queue-add-wrap" id="queueAddWrap">
          <input class="queue-add-input" id="queueAddInput"
            placeholder="Paste YouTube URL or search..."
            onkeypress="if(event.key==='Enter')quickAddSong()">
        </div>
      </div>

      <!-- CHAT TAB -->
      <div class="tab-pane" id="tabChat">
        <div class="chat-panel">
          <div class="chat-messages" id="chatMessages">
            <div class="empty-state" style="padding:20px;">
              <div class="empty-state-icon">ğŸ’¬</div>
              <div class="empty-state-text">Chat will appear here</div>
            </div>
          </div>
          <div class="chat-input-wrap" id="chatInputWrap">
            <input class="chat-input" id="chatInput" placeholder="Say something..." maxlength="200"
              onkeypress="if(event.key==='Enter')sendChat()">
            <button class="chat-send-btn" onclick="sendChat()">â†‘</button>
          </div>
        </div>
      </div>

      <!-- MEMBERS TAB -->
      <div class="tab-pane" id="tabMembers">
        <div class="panel-header" style="border-bottom:none;padding-bottom:4px;">
          <div class="panel-title">Members</div>
          <span class="badge badge-white" id="memberCount">0</span>
        </div>
        <div class="panel-list" id="membersList"></div>
        <div class="mood-meter-panel">
          <h3>Room Vibe</h3>
          <div id="moodMeterBars"></div>
        </div>
      </div>
    </div>

    <!-- CENTER: Room info + playlists -->
    <div class="room-center">
      <div class="room-center-bg"></div>
      <div class="room-header">
        <div class="room-code-badge" id="roomCodeDisp" onclick="copyCode()" title="Click to copy">------</div>
        <div class="room-name-disp" id="roomNameDisp">Jam Room</div>
        <div id="radioOnBadge" style="display:none;flex-shrink:0;">
          <div class="radio-on-badge"><div class="radio-on-dot"></div> Radio</div>
        </div>
        <div style="display:flex;gap:6px;margin-left:auto;flex-shrink:0;" id="roomHeaderBtns"></div>
      </div>
      <div class="room-content" id="roomContent"></div>
    </div>

    <!-- RIGHT: Player -->
    <div class="room-right">
      <!-- YouTube IFrame API player container -->
      <div class="player-video">
        <div id="ytPlayerContainer"></div>
      </div>

      <div class="player-info">
        <div class="np-song-title" id="npTitle">No song playing</div>
        <div class="np-song-artist" id="npArtist">Add songs to get started</div>

        <div class="progress-wrap">
          <span id="progCurrent">0:00</span>
          <div class="progress-bar" onclick="seekProgress(event)">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <span id="progTotal">~5:00</span>
        </div>

        <div class="np-controls">
          <button class="np-btn" onclick="prevSong()" title="Previous">â®</button>
          <button class="np-btn np-btn-play" onclick="togglePlay()" id="playBtn" title="Play/Pause">â–¶</button>
          <button class="np-btn" onclick="skipSong()" title="Skip">â­</button>
          <button class="np-btn" onclick="toggleMute()" id="muteBtn" title="Mute" style="font-size:11px;">ğŸ”Š</button>
          <button class="np-btn" onclick="toggleFullLyrics()" title="Fullscreen Lyrics" style="font-size:11px;">âœ¦</button>
        </div>

        <div class="volume-wrap">
          <span class="volume-icon" onclick="toggleMute()">ğŸ”Š</span>
          <input class="volume-slider" type="range" min="0" max="100" value="80"
            oninput="setVolume(this.value)" id="volSlider">
          <span style="font-size:10px;color:var(--muted);min-width:26px;text-align:right;" id="volLabel">80%</span>
        </div>
      </div>

      <div class="player-lyrics" id="playerLyrics">
        <h4>â™ª Lyrics</h4>
        <div id="lyricsContent" style="color:var(--muted);font-size:13px;font-style:italic;">Play a song to see lyrics</div>
      </div>
    </div>
  </div>

  <!-- Reaction bar -->
  <div class="react-bar" id="reactBar" style="display:none;">
    <button class="react-btn" onclick="sendReaction('ğŸ”¥')">ğŸ”¥</button>
    <button class="react-btn" onclick="sendReaction('â¤ï¸')">â¤ï¸</button>
    <button class="react-btn" onclick="sendReaction('ğŸ‰')">ğŸ‰</button>
    <button class="react-btn" onclick="sendReaction('ğŸ˜®')">ğŸ˜®</button>
    <button class="react-btn" onclick="sendReaction('ğŸ‘')">ğŸ‘</button>
    <button class="react-btn" onclick="sendReaction('ğŸ’€')">ğŸ’€</button>
    <button class="react-btn" onclick="sendReaction('ğŸ¸')">ğŸ¸</button>
    <button class="react-btn" onclick="sendReaction('ğŸµ')">ğŸµ</button>
  </div>
</div>

<!-- â”€â”€ SEARCH RESULTS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="searchModal">
  <div class="search-modal-card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
      <div class="search-modal-title" id="searchModalTitle">Search Results</div>
      <button onclick="closeSearchModal()" style="background:rgba(255,255,255,.07);border:1px solid var(--border);border-radius:50%;width:28px;height:28px;color:var(--text);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;">âœ•</button>
    </div>
    <div id="searchResultsList"></div>
  </div>
</div>

<!-- Fullscreen Lyrics Overlay -->
<div id="fullLyricsOverlay">
  <div id="fullLyricsSong" style="font-family:'Syne',sans-serif;font-size:12px;color:var(--teal-bright);letter-spacing:2px;text-transform:uppercase;margin-bottom:28px;"></div>
  <div id="fullLyricsContent"></div>
  <button id="fullLyricsClose" onclick="toggleFullLyrics()">âœ•</button>
</div>

<!-- Toast -->
<div class="jam-toast" id="jamToast"></div>

<!-- â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ FIREBASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FB_CONFIG = {
  apiKey: "AIzaSyC50_wBK3TfERX1gm35puugCD324SxHJR8",
  authDomain: "tunesandindy.firebaseapp.com",
  projectId: "tunesandindy",
  storageBucket: "tunesandindy.firebasestorage.app",
  messagingSenderId: "335192973371",
  appId: "1:335192973371:web:ce69d4b67c765d6aaf7c1e"
};

// â”€â”€ YOUTUBE API KEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Replace with your actual YouTube Data API v3 key
const YT_KEY = 'AIzaSyB9U8rjG9bfvXk4Jvl3p8sGsNfL6p8wMCA';

// â”€â”€ PROFANITY FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BAD_WORDS = ['nigger','nigga','faggot','chink','spic','kike','cunt','retard','tranny'];
function hasProfanity(text) {
  const t = text.toLowerCase().replace(/[^a-z0-9]/g,'');
  return BAD_WORDS.some(w => t.includes(w.replace(/[^a-z]/g,'')));
}
function sanitize(s) { return s.trim().replace(/[<>]/g,'').slice(0,32); }

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fbAuth, fbDb;
let jamUser = null, jamProfile = null;
let currentRoom = null, currentRoomId = null, isHost = false;
let roomListeners = [];
let authTabMode = 'signin';
let playStartTime = null;
let progressTimer = null;
let lyricsTimer = null;
let isPlaying = false;
let isMuted = false;
let currentVol = 80;
let ytPlayer = null;       // YouTube IFrame API player instance
let ytReady = false;       // YouTube API loaded
let unreadChatCount = 0;
let chatTabActive = false;
let dragSrcIndex = null;

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EMOJIS = ['ğŸµ','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ¥','ğŸ¤','ğŸ§','ğŸ¦','ğŸ¯','ğŸ¦Š','ğŸº','ğŸ»','ğŸ¼','ğŸ¦„','ğŸŒŸ','âš¡','ğŸ”¥','ğŸ’','ğŸ‘‘','ğŸŒˆ','ğŸš€','ğŸ®','ğŸ†','ğŸ’œ','ğŸŒ™','â˜€ï¸','ğŸƒ','ğŸ„','ğŸ­'];
const MOODS  = ['ğŸ‰ Hyped','ğŸ˜Œ Chill','ğŸ¤˜ Pumped','ğŸ˜´ Sleepy','ğŸ’ƒ Dancey','ğŸ¶ Vibing','ğŸ¤¯ Mind blown','ğŸ˜‚ Silly','ğŸ”¥ On fire','ğŸ’­ Thoughtful'];

// â”€â”€ YOUTUBE IFRAME API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Global callback required by the IFrame API
window.onYouTubeIframeAPIReady = function() {
  ytReady = true;
  // If a song was queued before the API loaded, play it now
  if (pendingVideoId) {
    loadYTVideo(pendingVideoId);
    pendingVideoId = null;
  }
};
let pendingVideoId = null;

function initYTPlayer() {
  if (!ytReady) return;
  ytPlayer = new YT.Player('ytPlayerContainer', {
    height: '100%',
    width: '100%',
    videoId: '',
    playerVars: {
      autoplay: 1,
      controls: 1,
      rel: 0,
      modestbranding: 1,
      iv_load_policy: 3,
    },
    events: {
      onReady: (e) => {
        e.target.setVolume(currentVol);
        isPlaying = false;
      },
      onStateChange: (e) => {
        // YT.PlayerState: -1=unstarted, 0=ended, 1=playing, 2=paused, 3=buffering, 5=cued
        if (e.data === YT.PlayerState.PLAYING) {
          isPlaying = true;
          updatePlayBtn();
          startProgress();
        } else if (e.data === YT.PlayerState.PAUSED) {
          isPlaying = false;
          updatePlayBtn();
          stopProgress();
        } else if (e.data === YT.PlayerState.ENDED) {
          isPlaying = false;
          updatePlayBtn();
          stopProgress();
          // Only host auto-advances to prevent race conditions
          if (isHost) skipSong();
        }
      },
      onError: (e) => {
        console.warn('YT player error:', e.data);
        toast('âš ï¸ Video unavailable â€” skipping...');
        if (isHost) setTimeout(skipSong, 1500);
      }
    }
  });
}

function loadYTVideo(videoId) {
  if (!videoId) {
    if (ytPlayer?.stopVideo) ytPlayer.stopVideo();
    return;
  }
  if (!ytReady) { pendingVideoId = videoId; return; }
  if (!ytPlayer) { initYTPlayer(); pendingVideoId = videoId; return; }
  ytPlayer.loadVideoById(videoId);
}

function updatePlayBtn() {
  const btn = document.getElementById('playBtn');
  if (!btn) return;
  btn.textContent = isPlaying ? 'â¸' : 'â–¶';
  btn.classList.toggle('paused', !isPlaying);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadScript(src) {
  return new Promise((res, rej) => {
    if (document.querySelector(`script[src="${src}"]`)) { res(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = res; s.onerror = rej;
    document.head.appendChild(s);
  });
}

async function init() {
  // Load YouTube IFrame API
  loadScript('https://www.youtube.com/iframe_api').catch(() => {
    console.warn('YouTube IFrame API failed to load');
  });

  // Load Firebase
  try {
    await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js');
    await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js');
    await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js');
  } catch(e) {
    toast('âš ï¸ Failed to load Firebase. Check your connection.');
    return;
  }

  if (!firebase.apps.length) firebase.initializeApp(FB_CONFIG);
  fbAuth = firebase.auth();
  fbDb   = firebase.firestore();

  buildEmojiPicker();
  buildMoodPicker();
  setupNetworkMonitor();

  // Check for invite link in URL
  const urlParams = new URLSearchParams(window.location.search);
  const inviteCode = urlParams.get('join');

  fbAuth.onAuthStateChanged(async user => {
    jamUser = user;
    if (user) {
      jamProfile = await loadProfile(user.uid);
      if (!jamProfile?.name) {
        showScreen('screenProfile');
      } else if (inviteCode) {
        showLobby();
        // Auto-fill and join from invite link
        document.getElementById('joinCode').value = inviteCode.toUpperCase();
        await quickJoin(inviteCode.toUpperCase());
      } else {
        showLobby();
      }
    } else {
      if (inviteCode) {
        // Store code for after login
        sessionStorage.setItem('pendingJoinCode', inviteCode);
      }
      showScreen('screenAuth');
    }
  });
}

// â”€â”€ NETWORK MONITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupNetworkMonitor() {
  const ind = document.getElementById('netIndicator');
  if (!ind) return;
  const update = () => {
    if (navigator.onLine) {
      ind.className = 'net-indicator';
      ind.title = 'Connected';
    } else {
      ind.className = 'net-indicator offline';
      ind.title = 'Offline';
      toast('âš ï¸ You are offline');
    }
  };
  window.addEventListener('online',  update);
  window.addEventListener('offline', update);
  update();
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(mode) {
  authTabMode = mode;
  const isUp = mode === 'signup';
  document.getElementById('tabSignIn').classList.toggle('active', !isUp);
  document.getElementById('tabSignUp').classList.toggle('active', isUp);
  document.getElementById('authBtn').textContent = isUp ? 'Create Account' : 'Sign In';
  document.getElementById('forgotBtn').style.display = isUp ? 'none' : 'block';
  clearAuthMsg();
}
function clearAuthMsg() {
  ['authError','authSuccess'].forEach(id => {
    const el = document.getElementById(id);
    el.style.display = 'none'; el.textContent = '';
  });
}
function showAuthErr(m) { const el = document.getElementById('authError'); el.textContent = m; el.style.display = 'block'; }
function showAuthOk(m)  { const el = document.getElementById('authSuccess'); el.textContent = m; el.style.display = 'block'; }

async function submitAuth() {
  const email = document.getElementById('authEmail').value.trim();
  const pass  = document.getElementById('authPass').value;
  const btn   = document.getElementById('authBtn');
  if (!email || !pass) { showAuthErr('Fill in both fields.'); return; }
  if (pass.length < 6) { showAuthErr('Password must be 6+ characters.'); return; }
  clearAuthMsg();
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Please wait...';
  try {
    if (authTabMode === 'signup') {
      await fbAuth.createUserWithEmailAndPassword(email, pass);
    } else {
      await fbAuth.signInWithEmailAndPassword(email, pass);
    }
    // Check for pending invite code
    const pending = sessionStorage.getItem('pendingJoinCode');
    if (pending) {
      sessionStorage.removeItem('pendingJoinCode');
      document.getElementById('joinCode').value = pending;
    }
  } catch(err) {
    const msgs = {
      'auth/user-not-found':'No account found.',
      'auth/wrong-password':'Incorrect password.',
      'auth/email-already-in-use':'Email already in use.',
      'auth/invalid-email':'Invalid email address.',
      'auth/weak-password':'Password too weak.',
      'auth/too-many-requests':'Too many attempts. Try later.',
      'auth/invalid-credential':'Invalid email or password.',
    };
    showAuthErr(msgs[err.code] || err.message);
    btn.disabled = false;
    btn.textContent = authTabMode === 'signup' ? 'Create Account' : 'Sign In';
  }
}

async function forgotPass() {
  const email = document.getElementById('authEmail').value.trim();
  if (!email) { showAuthErr('Enter your email first.'); return; }
  try {
    await fbAuth.sendPasswordResetEmail(email);
    showAuthOk('Reset email sent! Check your inbox.');
  } catch(e) { showAuthErr(e.message); }
}

async function signOut() {
  await leaveRoom();
  await fbAuth.signOut();
  document.getElementById('jamNav').style.display = 'none';
  showScreen('screenAuth');
}

// â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProfile(uid) {
  try {
    const d = await fbDb.collection('jam_profiles').doc(uid).get();
    return d.exists ? d.data() : null;
  } catch(e) { return null; }
}

function buildEmojiPicker() {
  const c = document.getElementById('emojiPicker');
  EMOJIS.forEach((e, i) => {
    const b = document.createElement('button');
    b.className = 'emoji-opt'; b.dataset.e = e;
    b.textContent = e; b.type = 'button';
    b.onclick = () => {
      document.querySelectorAll('.emoji-opt').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected');
    };
    if (i === 0) b.classList.add('selected');
    c.appendChild(b);
  });
}

function buildMoodPicker() {
  const c = document.getElementById('moodOptions');
  MOODS.forEach((m, i) => {
    const b = document.createElement('button');
    b.className = 'mood-opt'; b.dataset.m = m;
    b.textContent = m; b.type = 'button';
    b.onclick = () => {
      document.querySelectorAll('.mood-opt').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected');
    };
    if (i === 0) b.classList.add('selected');
    c.appendChild(b);
  });
}

function prefillProfile() {
  if (!jamProfile) return;
  document.getElementById('profileName').value = jamProfile.name || '';
  document.getElementById('profileNameFeedback').textContent = '';
  document.querySelectorAll('.emoji-opt').forEach(b =>
    b.classList.toggle('selected', b.dataset.e === jamProfile.emoji));
  document.querySelectorAll('.mood-opt').forEach(b =>
    b.classList.toggle('selected', b.dataset.m === jamProfile.mood));
}

async function saveProfile() {
  const name  = sanitize(document.getElementById('profileName').value);
  const emoji = document.querySelector('.emoji-opt.selected')?.dataset.e || 'ğŸµ';
  const mood  = document.querySelector('.mood-opt.selected')?.dataset.m  || 'ğŸ¶ Vibing';
  const feedbackEl = document.getElementById('profileNameFeedback');

  feedbackEl.textContent = '';
  if (name.length < 2) { feedbackEl.textContent = 'âš ï¸ Name must be at least 2 characters'; return; }
  if (hasProfanity(name)) { feedbackEl.textContent = 'âš ï¸ Please choose an appropriate name'; return; }

  const btn = document.getElementById('profileBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';

  jamProfile = { name, emoji, mood, uid: jamUser.uid, email: jamUser.email };
  await fbDb.collection('jam_profiles').doc(jamUser.uid).set(jamProfile);

  // Update profile in current room if we're in one
  if (currentRoomId) {
    try {
      await fbDb.collection('jam_rooms').doc(currentRoomId)
        .collection('members').doc(jamUser.uid)
        .update({ name, emoji, mood });
    } catch(e) {}
  }

  btn.disabled = false;
  btn.textContent = 'Save & Continue â†’';
  showLobby();
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'screenProfile') prefillProfile();
}

function showLobby() {
  buildNav();
  updateLobbyUI();
  showScreen('screenLobby');
  document.getElementById('jamNav').style.display = '';
  loadRecentRooms();
}

function buildNav() {
  const nr = document.getElementById('navRight');
  const nc = document.getElementById('navCenter');
  nc.innerHTML = '';
  // Keep net indicator
  const ni = document.getElementById('netIndicator');
  nr.innerHTML = '';
  if (ni) nr.appendChild(ni);

  if (jamProfile) {
    const chip = document.createElement('div');
    chip.className = 'nav-user-chip';
    chip.innerHTML = `<span>${jamProfile.emoji}</span><span>${escHtml(jamProfile.name)}</span>`;
    chip.onclick = () => showScreen('screenProfile');
    nr.appendChild(chip);

    const so = document.createElement('button');
    so.className = 'nav-btn-ghost';
    so.textContent = 'Sign Out';
    so.onclick = signOut;
    nr.appendChild(so);
  }
}

function updateLobbyUI() {
  if (!jamProfile) return;
  document.getElementById('lobbyGreeting').textContent = `Hey ${jamProfile.name} ğŸ‘‹`;
  document.getElementById('lbEmoji').textContent = jamProfile.emoji;
  document.getElementById('lbName').textContent = jamProfile.name;
  document.getElementById('lbMood').textContent = jamProfile.mood || '';
}

function loadRecentRooms() {
  const recent = safeGetRecents();
  updateRecentRoomsUI(recent);
}

function safeGetRecents() {
  try { return JSON.parse(localStorage.getItem('jam_recent') || '[]'); }
  catch(e) { return []; }
}

function saveRecentRoom(code, name) {
  const recent = safeGetRecents().filter(r => r.code !== code);
  recent.unshift({ code, name, time: new Date().toLocaleDateString() });
  localStorage.setItem('jam_recent', JSON.stringify(recent.slice(0,5)));
}

function removeFromRecentRooms(roomCode) {
  if (!roomCode) return;
  try {
    const recent = safeGetRecents().filter(r => r.code !== roomCode);
    localStorage.setItem('jam_recent', JSON.stringify(recent));
    updateRecentRoomsUI(recent);
  } catch(e) {}
}

function updateRecentRoomsUI(recent) {
  const sec = document.getElementById('recentRoomsSection');
  if (!sec) return;
  if (!recent?.length) {
    sec.innerHTML = '<div style="font-size:11px;color:var(--muted);padding:4px;">No recent rooms</div>';
    return;
  }
  sec.innerHTML = '';
  recent.slice(0,3).forEach(r => {
    const div = document.createElement('div');
    div.className = 'recent-room-item';
    div.innerHTML = `
      <div class="recent-room-code">${escHtml(r.code)}</div>
      <div class="recent-room-info">
        <div class="recent-room-name">${escHtml(r.name)}</div>
        <div class="recent-room-time">${escHtml(r.time || '')}</div>
      </div>
    `;
    div.onclick = () => quickJoin(r.code);
    sec.appendChild(div);
  });
}

async function quickJoin(code) {
  document.getElementById('joinCode').value = code;
  showScreen('screenJoin');
  await joinRoom();
}

// â”€â”€ ROOM CODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:6}, () => chars[Math.floor(Math.random()*chars.length)]).join('');
}

// â”€â”€ CREATE ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createRoom() {
  const name = sanitize(document.getElementById('roomNameInput').value);
  if (!name) { toast('âš ï¸ Enter a room name'); return; }
  if (hasProfanity(name)) { toast('âš ï¸ Choose an appropriate name'); return; }

  const btn = document.getElementById('createBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Creating...';

  const code = genCode();
  const settings = {
    reactions: document.getElementById('setReactions').checked,
    uploads:   document.getElementById('setUploads').checked,
    skips:     document.getElementById('setSkips').checked,
    chat:      document.getElementById('setChat').checked,
    radio:     document.getElementById('setRadio').checked,
  };

  try {
    const ref = await fbDb.collection('jam_rooms').add({
      code, name,
      hostUid: jamUser.uid,
      hostName: jamProfile.name,
      settings,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      active: true,
      queue: [],
      currentSong: null,
      currentIndex: -1,
      playing: false,
      startedAt: null,
      songsPlayed: 0,
      votes: {},
      memberCount: 1,
    });
    currentRoomId = ref.id;
    isHost = true;
    await fbDb.collection('jam_rooms').doc(ref.id).collection('members').doc(jamUser.uid).set({
      uid: jamUser.uid, name: jamProfile.name, emoji: jamProfile.emoji,
      mood: jamProfile.mood, joinedAt: firebase.firestore.FieldValue.serverTimestamp(), isHost: true,
    });
    await enterRoom(ref.id);
    btn.disabled = false;
    btn.textContent = 'ğŸ™ï¸ Create Room';
  } catch(err) {
    console.error(err);
    toast('âŒ Failed to create room. Try again.');
    btn.disabled = false;
    btn.textContent = 'ğŸ™ï¸ Create Room';
  }
}

// â”€â”€ JOIN ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function joinRoom() {
  const code = document.getElementById('joinCode').value.trim().toUpperCase();
  const errEl = document.getElementById('joinError');
  errEl.style.display = 'none';

  if (code.length !== 6) {
    errEl.textContent = 'Code must be exactly 6 characters.';
    errEl.style.display = 'block';
    return;
  }

  const btn = document.getElementById('joinBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Joining...';

  try {
    const snap = await fbDb.collection('jam_rooms')
      .where('code','==',code).where('active','==',true).limit(1).get();

    if (snap.empty) {
      errEl.textContent = 'Room not found or no longer active.';
      errEl.style.display = 'block';
      btn.disabled = false;
      btn.textContent = 'ğŸšª Join Room';
      return;
    }

    const doc = snap.docs[0];
    currentRoomId = doc.id;
    isHost = doc.data().hostUid === jamUser.uid;

    await fbDb.collection('jam_rooms').doc(doc.id).collection('members').doc(jamUser.uid).set({
      uid: jamUser.uid, name: jamProfile.name, emoji: jamProfile.emoji,
      mood: jamProfile.mood, joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
      isHost: isHost,
    });
    await enterRoom(doc.id);
    btn.disabled = false;
    btn.textContent = 'ğŸšª Join Room';
  } catch(err) {
    console.error(err);
    errEl.textContent = 'Something went wrong. Try again.';
    errEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'ğŸšª Join Room';
  }
}

// â”€â”€ ENTER ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function enterRoom(roomId) {
  currentRoomId = roomId;
  const snap = await fbDb.collection('jam_rooms').doc(roomId).get();
  currentRoom = { id: roomId, ...snap.data() };

  showScreen('screenRoom');
  unreadChatCount = 0;
  chatTabActive = false;

  document.getElementById('roomCodeDisp').textContent = currentRoom.code;
  document.getElementById('roomNameDisp').textContent = currentRoom.name;
  document.getElementById('radioOnBadge').style.display = currentRoom.settings?.radio ? '' : 'none';

  buildRoomNav();
  buildRoomContent();
  setupRoomListeners(roomId);
  renderNowPlaying(currentRoom.currentSong);
  renderQueue(currentRoom.queue || [], currentRoom.currentIndex);

  document.getElementById('reactBar').style.display =
    currentRoom.settings?.reactions ? 'flex' : 'none';
  document.getElementById('chatInputWrap').style.display =
    (currentRoom.settings?.chat || isHost) ? 'flex' : 'none';
  document.getElementById('queueAddWrap').style.display =
    (isHost || currentRoom.settings?.uploads) ? '' : 'none';

  saveRecentRoom(currentRoom.code, currentRoom.name);
  toast(`ğŸ¸ Joined "${currentRoom.name}"!`);
  await logActivity('ğŸ‘‹', 'joined the jam');

  // Update URL with invite code (without full reload)
  const url = new URL(window.location.href);
  url.searchParams.set('join', currentRoom.code);
  window.history.replaceState({}, '', url.toString());
}

// â”€â”€ ROOM NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildRoomNav() {
  const nc = document.getElementById('navCenter');
  const nr = document.getElementById('navRight');

  nc.innerHTML = `
    <div class="room-search-wrap">
      <span class="room-search-icon">âŒ•</span>
      <input id="navSearchInput" placeholder="Search YouTube to add..." 
        onkeypress="if(event.key==='Enter' && this.value.trim()){performNavSearch(this.value.trim());this.value='';}">
      <span class="spinner room-search-spinner" id="navSearchSpinner"></span>
    </div>
  `;

  // Keep net indicator
  const ni = document.getElementById('netIndicator');
  nr.innerHTML = '';
  if (ni) nr.appendChild(ni);

  if (jamProfile) {
    const chip = document.createElement('div');
    chip.className = 'nav-user-chip';
    chip.innerHTML = `<span>${jamProfile.emoji}</span><span>${escHtml(jamProfile.name)}</span>`;
    chip.onclick = () => showScreen('screenProfile');
    nr.appendChild(chip);
  }

  // Invite button
  const invBtn = document.createElement('button');
  invBtn.className = 'nav-btn-ghost';
  invBtn.textContent = 'ğŸ”— Invite';
  invBtn.onclick = shareInviteLink;
  nr.appendChild(invBtn);

  const backBtn = document.createElement('button');
  backBtn.className = 'nav-btn-ghost';
  backBtn.textContent = isHost ? 'ğŸ”’ Close Room' : 'ğŸšª Leave';
  backBtn.onclick = isHost ? closeRoom : () => leaveRoom();
  nr.appendChild(backBtn);
}

// â”€â”€ SHARE / INVITE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shareInviteLink() {
  if (!currentRoom) return;
  const url = new URL(window.location.href);
  url.searchParams.set('join', currentRoom.code);
  const inviteUrl = url.toString();

  if (navigator.share) {
    navigator.share({
      title: `Join "${currentRoom.name}" on INDY Jam`,
      text: `Use code ${currentRoom.code} to join my jam session!`,
      url: inviteUrl,
    }).catch(() => copyToClipboard(inviteUrl));
  } else {
    copyToClipboard(inviteUrl);
    toast('ğŸ”— Invite link copied!');
  }
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  });
}

// â”€â”€ ROOM CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildRoomContent() {
  const c = document.getElementById('roomContent');
  c.innerHTML = '';

  // Stats
  const statsDiv = document.createElement('div');
  statsDiv.className = 'room-stats';
  statsDiv.style.marginBottom = '18px';
  statsDiv.innerHTML = `
    <div class="room-stat">
      <div class="room-stat-val" id="statSongs">0</div>
      <div class="room-stat-label">Songs Played</div>
    </div>
    <div class="room-stat">
      <div class="room-stat-val" id="statMembers">0</div>
      <div class="room-stat-label">Members</div>
    </div>
    <div class="room-stat">
      <div class="room-stat-val" id="statQueue">0</div>
      <div class="room-stat-label">In Queue</div>
    </div>
  `;
  c.appendChild(statsDiv);

  // Invite panel (for host)
  if (isHost) {
    const invDiv = document.createElement('div');
    invDiv.className = 'invite-panel';
    const inviteUrl = buildInviteUrl();
    invDiv.innerHTML = `
      <div class="invite-label">ğŸ”— Invite Friends</div>
      <div class="invite-link-row">
        <div class="invite-link-text" onclick="shareInviteLink()" title="Click to copy/share">${escHtml(inviteUrl)}</div>
        <button class="btn btn-ghost btn-sm" onclick="shareInviteLink()">Share</button>
      </div>
    `;
    c.appendChild(invDiv);
  }

  // Host settings
  if (isHost) {
    const settDiv = document.createElement('div');
    settDiv.className = 'settings-panel';
    settDiv.innerHTML = `<h3>âš™ï¸ Room Settings</h3>${buildSettingsHTML()}`;
    c.appendChild(settDiv);
  }

  // Playlists / add songs
  if (isHost || currentRoom.settings?.uploads) {
    const upDiv = document.createElement('div');
    upDiv.className = 'upload-panel';
    upDiv.innerHTML = `<h3>ğŸµ Add to Queue</h3><div id="playlistList"><div style="font-size:12px;color:var(--muted);padding:6px 0;">Loading playlists...</div></div>`;
    c.appendChild(upDiv);
    loadPlaylists();
  }

  // Activity feed
  const actDiv = document.createElement('div');
  actDiv.className = 'upload-panel';
  actDiv.innerHTML = `<h3>ğŸ“¡ Live Activity</h3><div id="activityFeed" style="max-height:160px;overflow-y:auto;"></div>`;
  c.appendChild(actDiv);

  setupActivityListener(currentRoomId);
}

function buildInviteUrl() {
  if (!currentRoom) return '';
  const url = new URL(window.location.href);
  url.searchParams.set('join', currentRoom.code);
  return url.toString();
}

function buildSettingsHTML() {
  const s = currentRoom.settings || {};
  const rows = [
    ['reactions','Allow reactions','Emoji reactions from members'],
    ['uploads','Allow song uploads','Members can add to queue'],
    ['skips','Allow vote-skip','Members can vote to skip'],
    ['chat','Enable chat','Members can send messages'],
    ['radio','Radio mode','Auto-play related songs when queue ends'],
  ];
  return rows.map(([k,l,d]) => `
    <div class="setting-row">
      <div>
        <div class="setting-label">${l}</div>
        <div class="setting-desc">${d}</div>
      </div>
      <label class="toggle">
        <input type="checkbox" ${s[k]?'checked':''} onchange="updateSetting('${k}',this.checked)">
        <span class="toggle-slider"></span>
      </label>
    </div>
  `).join('');
}

// â”€â”€ ROOM LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupRoomListeners(roomId) {
  roomListeners.forEach(u => u());
  roomListeners = [];

  // Room doc
  const roomUnsub = fbDb.collection('jam_rooms').doc(roomId).onSnapshot(snap => {
    if (!snap.exists || !snap.data().active) { handleRoomClosed(); return; }
    currentRoom = { id: roomId, ...snap.data() };

    renderNowPlaying(currentRoom.currentSong);
    renderQueue(currentRoom.queue || [], currentRoom.currentIndex);

    const rb = document.getElementById('reactBar');
    if (rb) rb.style.display = currentRoom.settings?.reactions ? 'flex' : 'none';

    const qa = document.getElementById('queueAddWrap');
    if (qa && !isHost) qa.style.display = currentRoom.settings?.uploads ? '' : 'none';

    const rd = document.getElementById('radioOnBadge');
    if (rd) rd.style.display = currentRoom.settings?.radio ? '' : 'none';

    const ciw = document.getElementById('chatInputWrap');
    if (ciw && !isHost) ciw.style.display = currentRoom.settings?.chat ? 'flex' : 'none';

    if (document.getElementById('statSongs'))
      document.getElementById('statSongs').textContent = currentRoom.songsPlayed || 0;
    if (document.getElementById('statQueue'))
      document.getElementById('statQueue').textContent = (currentRoom.queue || []).length;

    renderVotePanel(currentRoom.votes || {});
  });

  // Members
  const membersUnsub = fbDb.collection('jam_rooms').doc(roomId)
    .collection('members').onSnapshot(snap => {
      const members = snap.docs.map(d => d.data());
      if (currentRoom) currentRoom.memberCount = members.length;
      renderMembers(members);
      renderMoodMeter(members);
      if (document.getElementById('statMembers'))
        document.getElementById('statMembers').textContent = members.length;
      renderVotePanel(currentRoom?.votes || {});
    });

  // Reactions
  const reactUnsub = fbDb.collection('jam_rooms').doc(roomId)
    .collection('reactions').orderBy('at','desc').limit(1)
    .onSnapshot(snap => {
      snap.docChanges().forEach(c => {
        if (c.type === 'added' && c.doc.data().uid !== jamUser.uid) {
          spawnReaction(c.doc.data().emoji, c.doc.data().x || 50);
        }
      });
    });

  // Kick listener
  const kickUnsub = fbDb.collection('jam_rooms').doc(roomId)
    .collection('kicked').doc(jamUser.uid)
    .onSnapshot(snap => { if (snap.exists) handleKicked(); });

  // Chat
  const chatUnsub = fbDb.collection('jam_rooms').doc(roomId)
    .collection('chat').orderBy('at').limitToLast(80)
    .onSnapshot(snap => {
      snap.docChanges().forEach(c => {
        if (c.type === 'added') {
          appendChatMsg(c.doc.data());
          // Unread badge if chat tab not active
          if (!chatTabActive && c.doc.data().uid !== jamUser?.uid) {
            unreadChatCount++;
            updateChatTabBadge();
          }
        }
      });
    });

  roomListeners = [roomUnsub, membersUnsub, reactUnsub, kickUnsub, chatUnsub];
}

// â”€â”€ UNREAD CHAT BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateChatTabBadge() {
  const btn = document.getElementById('chatTabBtn');
  if (!btn) return;
  let badge = btn.querySelector('.tab-badge');
  if (unreadChatCount > 0) {
    if (!badge) { badge = document.createElement('span'); badge.className = 'tab-badge'; btn.appendChild(badge); }
    badge.textContent = unreadChatCount > 9 ? '9+' : unreadChatCount;
  } else {
    badge?.remove();
  }
}

// â”€â”€ ACTIVITY FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupActivityListener(roomId) {
  const unsub = fbDb.collection('jam_rooms').doc(roomId)
    .collection('activity').orderBy('at','desc').limit(10)
    .onSnapshot(snap => {
      snap.docChanges().forEach(c => {
        if (c.type === 'added') appendActivity(c.doc.data());
      });
    });
  roomListeners.push(unsub);
}

function appendActivity(data) {
  const feed = document.getElementById('activityFeed');
  if (!feed) return;
  const div = document.createElement('div');
  div.className = 'activity-item';
  div.innerHTML = `
    <span class="a-icon">${data.icon||'ğŸ“¢'}</span>
    <span class="a-name">${escHtml(data.name)}</span>
    <span>${escHtml(data.msg)}</span>
  `;
  feed.insertBefore(div, feed.firstChild);
  while (feed.children.length > 10) feed.lastChild.remove();
}

async function logActivity(icon, msg) {
  if (!currentRoomId) return;
  try {
    await fbDb.collection('jam_rooms').doc(currentRoomId).collection('activity').add({
      name: jamProfile.name, icon, msg,
      at: firebase.firestore.FieldValue.serverTimestamp(),
    });
  } catch(e) {}
}

// â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendChatMsg(data) {
  const c = document.getElementById('chatMessages');
  if (!c) return;
  const empty = c.querySelector('.empty-state');
  if (empty) empty.remove();

  const div = document.createElement('div');
  div.className = 'chat-msg' + (data.system ? ' system' : '');
  const isMe = data.uid === jamUser?.uid;
  div.innerHTML = `
    <div class="chat-msg-emoji">${escHtml(data.emoji || 'ğŸµ')}</div>
    <div class="chat-msg-body">
      <div class="chat-msg-author">${escHtml(data.name)}</div>
      <div class="chat-msg-text ${isMe?'is-me':''}">${escHtml(data.text)}</div>
    </div>
  `;
  c.appendChild(div);
  // Auto-scroll if near bottom
  const atBottom = c.scrollHeight - c.scrollTop - c.clientHeight < 80;
  if (atBottom) c.scrollTop = c.scrollHeight;
}

async function sendChat() {
  if (!currentRoom?.settings?.chat && !isHost) return;
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || text.length > 200) return;
  if (hasProfanity(text)) { toast('âš ï¸ Keep it clean!'); return; }
  input.value = '';
  try {
    await fbDb.collection('jam_rooms').doc(currentRoomId).collection('chat').add({
      uid: jamUser.uid, name: jamProfile.name, emoji: jamProfile.emoji, text,
      at: firebase.firestore.FieldValue.serverTimestamp(),
    });
  } catch(e) { input.value = text; toast('âŒ Failed to send'); }
}

// â”€â”€ KICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleKicked() {
  roomListeners.forEach(u => u()); roomListeners = [];
  const roomCode = currentRoom?.code;
  currentRoom = null; currentRoomId = null; isHost = false;
  stopProgress();
  stopLyricsSync();
  if (ytPlayer?.stopVideo) ytPlayer.stopVideo();
  document.getElementById('reactBar').style.display = 'none';
  if (roomCode) removeFromRecentRooms(roomCode);
  // Clear URL params
  window.history.replaceState({}, '', window.location.pathname);
  showLobby();
  toast('ğŸ‘¢ You were removed from the room');
}

// â”€â”€ PLAYLISTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadPlaylists() {
  const el = document.getElementById('playlistList');
  if (!el) return;

  let playlists = {}, recent = [];
  try { playlists = JSON.parse(localStorage.getItem('playlists') || '{}'); } catch(e) {}
  try { recent   = JSON.parse(localStorage.getItem('recent')    || '[]'); } catch(e) {}

  const keys = Object.keys(playlists);
  if (!keys.length && !recent.length) {
    el.innerHTML = `<div style="font-size:12px;color:var(--muted);">No playlists found. <a href="full-tunes.html" style="color:var(--teal-bright);">Go to INDY Music â†’</a></div>`;
    return;
  }

  el.innerHTML = '';
  keys.forEach(name => {
    const p = playlists[name];
    const songs = p.songs || [];
    if (!songs.length) return;
    const item = document.createElement('div');
    item.className = 'playlist-select-item';
    item.innerHTML = `
      <span style="font-size:20px;">${escHtml(p.emoji||'ğŸµ')}</span>
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:600;">${escHtml(name)}</div>
        <div style="font-size:11px;color:var(--muted);">${songs.length} songs</div>
      </div>
      <button class="btn btn-ghost btn-sm" style="flex-shrink:0;">Add All</button>
    `;
    const addBtn = item.querySelector('button');
    addBtn.onclick = (e) => { e.stopPropagation(); addPlaylist(name); };
    item.onclick = () => addPlaylist(name);
    el.appendChild(item);
  });

  if (recent.length) {
    const item = document.createElement('div');
    item.className = 'playlist-select-item';
    item.innerHTML = `
      <span style="font-size:20px;">â±ï¸</span>
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:600;">Recently Played</div>
        <div style="font-size:11px;color:var(--muted);">${recent.length} songs</div>
      </div>
      <button class="btn btn-ghost btn-sm" style="flex-shrink:0;">Add All</button>
    `;
    const addBtn = item.querySelector('button');
    addBtn.onclick = (e) => { e.stopPropagation(); addSongs(recent); };
    item.onclick = () => addSongs(recent);
    el.appendChild(item);
  }
}

async function addPlaylist(name) {
  let playlists = {};
  try { playlists = JSON.parse(localStorage.getItem('playlists')||'{}'); } catch(e) {}
  const songs = playlists[name]?.songs || [];
  if (!songs.length) { toast('âš ï¸ Playlist is empty'); return; }
  await addSongs(songs.slice(0,20));
}

async function addSongs(songs) {
  if (!songs?.length) return;
  const roomRef = fbDb.collection('jam_rooms').doc(currentRoomId);
  const snap    = await roomRef.get();
  const existing = snap.data()?.queue || [];
  const newSongs = songs.map(s => ({
    id: s.id, title: s.title || 'Unknown', artist: s.artist || '',
    art: s.art || '', addedBy: jamProfile.name, addedByEmoji: jamProfile.emoji,
  }));
  const merged = [...existing, ...newSongs].slice(0, 100);
  await roomRef.update({ queue: merged });
  if ((snap.data()?.currentIndex ?? -1) === -1 && merged.length > 0) {
    await playSongAt(0, merged);
  }
  toast(`âœ… Added ${newSongs.length} song${newSongs.length !== 1 ? 's' : ''}`);
  await logActivity('ğŸµ', `added ${newSongs.length} song${newSongs.length !== 1 ? 's' : ''} to the queue`);
}

// â”€â”€ NAV SEARCH (shows results picker) â”€â”€â”€â”€â”€â”€â”€â”€
async function performNavSearch(query) {
  if (!query || query.length < 2) return;
  const sp = document.getElementById('navSearchSpinner');
  if (sp) sp.classList.add('active');
  const results = await searchYouTube(query);
  if (sp) sp.classList.remove('active');
  if (results && results.length) {
    showSearchModal(query, results);
  } else {
    toast('No results found');
  }
}

// â”€â”€ QUICK ADD (from queue input) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function quickAddSong() {
  const inp = document.getElementById('queueAddInput');
  const val = inp.value.trim();
  if (!val) return;
  inp.value = '';

  const ytMatch = val.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  if (ytMatch) {
    const id = ytMatch[1];
    const song = {
      id, title: 'Loading...', artist: 'YouTube',
      art: `https://img.youtube.com/vi/${id}/mqdefault.jpg`,
      addedBy: jamProfile.name, addedByEmoji: jamProfile.emoji,
    };
    await addSongs([song]);
    fetchYTTitle(id).then(info => {
      if (info) updateQueueSongInfo(id, info.title, info.artist);
    });
    return;
  }

  // Show results picker for text search
  const results = await searchYouTube(val);
  if (results?.length) showSearchModal(val, results);
  else toast('âš ï¸ No results. Try pasting a YouTube URL.');
}

// â”€â”€ YOUTUBE SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function searchYouTube(query) {
  try {
    const res = await fetch(
      `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=5&q=${encodeURIComponent(query)}&key=${YT_KEY}`
    );
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (data.error) {
      console.warn('YT Search API error:', data.error.message);
      return null;
    }
    return (data.items || []).filter(i => i.id?.videoId).map(i => ({
      id: i.id.videoId,
      title: i.snippet.title,
      artist: i.snippet.channelTitle,
      art: i.snippet.thumbnails?.medium?.url || `https://img.youtube.com/vi/${i.id.videoId}/mqdefault.jpg`,
    }));
  } catch(e) {
    console.error('YouTube search error:', e);
    return null;
  }
}

// â”€â”€ SEARCH RESULTS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSearchModal(query, results) {
  const modal = document.getElementById('searchModal');
  const list  = document.getElementById('searchResultsList');
  const title = document.getElementById('searchModalTitle');

  title.textContent = `Results for "${query.slice(0,40)}"`;
  list.innerHTML = '';

  if (!results?.length) {
    list.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:10px;">No results found.</div>';
  } else {
    results.forEach(item => {
      const div = document.createElement('div');
      div.className = 'search-result-item';
      div.innerHTML = `
        <div class="search-result-thumb">
          <img src="${escHtml(item.art)}" alt="" onerror="this.style.display='none'">
        </div>
        <div class="search-result-info">
          <div class="search-result-title">${escHtml(item.title)}</div>
          <div class="search-result-channel">${escHtml(item.artist)}</div>
        </div>
        <span style="font-size:18px;color:var(--muted2);">+</span>
      `;
      div.onclick = async () => {
        closeSearchModal();
        await addSongs([{ ...item, addedBy: jamProfile.name, addedByEmoji: jamProfile.emoji }]);
      };
      list.appendChild(div);
    });
  }

  modal.classList.add('open');
}

function closeSearchModal() {
  document.getElementById('searchModal').classList.remove('open');
}

// Close modal on outside click
document.getElementById('searchModal').addEventListener('click', function(e) {
  if (e.target === this) closeSearchModal();
});

async function fetchYTTitle(id) {
  try {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${id}&key=${YT_KEY}`);
    if (!res.ok) return null;
    const data = await res.json();
    const s = data.items?.[0]?.snippet;
    if (s) return { title: s.title, artist: s.channelTitle };
  } catch(e) {}
  return null;
}

async function updateQueueSongInfo(id, title, artist) {
  if (!currentRoomId) return;
  try {
    const snap = await fbDb.collection('jam_rooms').doc(currentRoomId).get();
    let queue = snap.data()?.queue || [];
    queue = queue.map(s => s.id === id && s.title === 'Loading...' ? {...s, title, artist} : s);
    await fbDb.collection('jam_rooms').doc(currentRoomId).update({ queue });
  } catch(e) {}
}

// â”€â”€ QUEUE MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function playSongAt(index, queueArr) {
  const song = queueArr[index];
  if (!song) return;
  await fbDb.collection('jam_rooms').doc(currentRoomId).update({
    currentSong: song, currentIndex: index, playing: true,
    startedAt: firebase.firestore.FieldValue.serverTimestamp(),
    songsPlayed: firebase.firestore.FieldValue.increment(1),
    votes: {},
  });
  await logActivity('â–¶ï¸', `playing "${song.title}"`);
}

async function skipSong() {
  if (!currentRoomId) return;
  const snap = await fbDb.collection('jam_rooms').doc(currentRoomId).get();
  const d = snap.data();
  const q = d.queue || [];
  const next = (d.currentIndex ?? -1) + 1;
  if (next >= q.length) {
    if (d.settings?.radio) {
      toast('ğŸ“» Radio mode: finding related songs...');
      await autoRadio(d.currentSong, q);
    } else {
      await fbDb.collection('jam_rooms').doc(currentRoomId).update({
        currentSong: null, currentIndex: -1, playing: false, votes: {}
      });
      toast('â­ï¸ Queue finished!');
    }
  } else {
    await playSongAt(next, q);
  }
}

async function prevSong() {
  if (!currentRoomId) return;
  const snap = await fbDb.collection('jam_rooms').doc(currentRoomId).get();
  const d = snap.data();
  const prev = (d.currentIndex ?? 0) - 1;
  if (prev < 0) { toast('â® Already at the start'); return; }
  await playSongAt(prev, d.queue || []);
}

async function removeFromQueue(i) {
  if (!isHost) return;
  const snap = await fbDb.collection('jam_rooms').doc(currentRoomId).get();
  let q = [...(snap.data()?.queue || [])];
  q.splice(i, 1);
  let update = { queue: q };
  const ci = snap.data()?.currentIndex ?? 0;
  if (i === ci) {
    if (!q.length) update = {...update, currentSong: null, currentIndex: -1, playing: false};
    else { const ni = Math.min(i, q.length-1); update = {...update, currentSong: q[ni], currentIndex: ni}; }
  } else if (i < ci) {
    update.currentIndex = ci - 1;
  }
  await fbDb.collection('jam_rooms').doc(currentRoomId).update(update);
}

// â”€â”€ DRAG-TO-REORDER QUEUE (host only) â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeDraggable(el, index) {
  el.draggable = true;
  el.dataset.idx = index;

  el.addEventListener('dragstart', e => {
    dragSrcIndex = index;
    e.dataTransfer.effectAllowed = 'move';
    el.classList.add('dragging');
  });
  el.addEventListener('dragend', () => {
    el.classList.remove('dragging');
    document.querySelectorAll('.queue-item').forEach(i => i.classList.remove('drag-over'));
  });
  el.addEventListener('dragover', e => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    document.querySelectorAll('.queue-item').forEach(i => i.classList.remove('drag-over'));
    el.classList.add('drag-over');
  });
  el.addEventListener('drop', e => {
    e.preventDefault();
    el.classList.remove('drag-over');
    const destIndex = parseInt(el.dataset.idx);
    if (dragSrcIndex === null || dragSrcIndex === destIndex) return;
    reorderQueue(dragSrcIndex, destIndex);
    dragSrcIndex = null;
  });
}

async function reorderQueue(fromIdx, toIdx) {
  if (!isHost) return;
  try {
    const snap = await fbDb.collection('jam_rooms').doc(currentRoomId).get();
    let q = [...(snap.data()?.queue || [])];
    let ci = snap.data()?.currentIndex ?? -1;

    // Move element
    const [moved] = q.splice(fromIdx, 1);
    q.splice(toIdx, 0, moved);

    // Adjust current index
    if (ci === fromIdx) {
      ci = toIdx;
    } else if (fromIdx < ci && toIdx >= ci) {
      ci--;
    } else if (fromIdx > ci && toIdx <= ci) {
      ci++;
    }

    await fbDb.collection('jam_rooms').doc(currentRoomId).update({
      queue: q,
      currentIndex: ci,
      currentSong: ci >= 0 ? q[ci] : null,
    });
  } catch(e) { toast('âŒ Reorder failed'); }
}

// â”€â”€ RADIO MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function autoRadio(lastSong, currentQueue) {
  if (!lastSong?.id) return;
  const results = await searchYouTube(`${lastSong.artist} ${lastSong.title} mix`);
  if (!results?.length) { toast('ğŸ“» No related songs found'); return; }
  try {
    const snap = await fbDb.collection('jam_rooms').doc(currentRoomId).get();
    const existing = snap.data()?.queue || [];
    const newSongs = results.map(i => ({ ...i, addedBy: 'ğŸ“» Radio', addedByEmoji: 'ğŸ“»' }));
    const merged = [...existing, ...newSongs].slice(0,100);
    const next = (snap.data()?.currentIndex ?? -1) + 1;
    await fbDb.collection('jam_rooms').doc(currentRoomId).update({ queue: merged });
    await playSongAt(next, merged);
    toast('ğŸ“» Radio: added related songs!');
  } catch(e) { console.error(e); }
}

// â”€â”€ VOTE SKIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function voteSkip() {
  if (!currentRoom?.settings?.skips) return;
  if (currentRoom.votes?.[jamUser.uid]) {
    toast('âš ï¸ You already voted to skip this song');
    return;
  }
  const votes = { ...(currentRoom.votes || {}), [jamUser.uid]: true };
  await fbDb.collection('jam_rooms').doc(currentRoomId).update({ votes });

  const memberCount = currentRoom.memberCount || 1;
  const needed = calcVotesNeeded(memberCount);
  const count = Object.keys(votes).length;
  const remaining = needed - count;
  if (remaining > 0) {
    toast(`ğŸ‘ Vote counted! ${remaining} more vote${remaining !== 1 ? 's' : ''} needed`);
  }
}

function calcVotesNeeded(memberCount) {
  if (memberCount <= 2) return memberCount;
  if (memberCount <= 4) return Math.ceil(memberCount * 0.75);
  return Math.ceil(memberCount * 0.6);
}

function renderVotePanel(votesMap) {
  const panel = document.getElementById('votePanel');
  if (!panel) return;

  if (!currentRoom?.settings?.skips || !currentRoom?.currentSong) {
    panel.classList.remove('active');
    return;
  }

  panel.classList.add('active');

  const memberCount = currentRoom.memberCount || 1;
  const needed = calcVotesNeeded(memberCount);
  const count = Object.keys(votesMap || {}).length;
  const hasVoted = votesMap?.[jamUser?.uid];
  const pct = Math.min(100, (count / needed) * 100);

  const label = document.getElementById('voteLabel');
  if (label) {
    label.innerHTML = `<span>${count}/${needed} votes to skip</span>${hasVoted ? '<span style="font-size:10px;opacity:.6;">(voted)</span>' : ''}`;
  }

  const fill = document.getElementById('voteFill');
  if (fill) { fill.style.width = pct + '%'; fill.className = 'vote-fill' + (pct >= 80 ? ' warning' : ''); }

  const voteBtn = document.getElementById('voteBtn');
  if (voteBtn) { voteBtn.disabled = !!hasVoted; voteBtn.style.opacity = hasVoted ? '0.45' : '1'; }

  // Only host triggers skip to avoid race condition
  if (count >= needed && isHost) skipSong();
}

// â”€â”€ RENDER FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastRenderedSongId = null;

function renderNowPlaying(song) {
  const titleEl  = document.getElementById('npTitle');
  const artistEl = document.getElementById('npArtist');

  if (!song) {
    if (titleEl)  titleEl.textContent  = 'No song playing';
    if (artistEl) artistEl.textContent = 'Add songs to get started';
    if (lastRenderedSongId !== null) {
      loadYTVideo(null);
      stopProgress();
      stopLyricsSync();
      lastRenderedSongId = null;
    }
    return;
  }

  if (titleEl)  titleEl.textContent  = song.title  || 'Unknown';
  if (artistEl) artistEl.textContent = song.artist || '';

  const fullSong = document.getElementById('fullLyricsSong');
  if (fullSong) fullSong.textContent = `${song.title || ''}  â€”  ${song.artist || ''}`;

  // Only load new video if song changed (avoid resetting on every snapshot)
  if (song.id !== lastRenderedSongId) {
    lastRenderedSongId = song.id;
    loadYTVideo(song.id);
    startProgress();
    fetchLyrics(song.title, song.artist);
  }
}

function renderQueue(queue, currentIndex) {
  const el  = document.getElementById('queueList');
  const cnt = document.getElementById('queueCount');
  if (cnt) cnt.textContent = queue.length;
  if (!el) return;

  if (!queue.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¶</div><div class="empty-state-text">Queue is empty</div></div>';
    return;
  }

  el.innerHTML = '';
  queue.forEach((song, i) => {
    const div = document.createElement('div');
    div.className = 'queue-item' + (i === currentIndex ? ' playing' : '');

    const thumbDiv = document.createElement('div');
    thumbDiv.className = 'queue-thumb';
    if (song.art) {
      const img = document.createElement('img');
      img.src = song.art; img.alt = '';
      img.onerror = () => { thumbDiv.innerHTML = ''; thumbDiv.textContent = 'ğŸµ'; };
      thumbDiv.appendChild(img);
    } else {
      thumbDiv.textContent = 'ğŸµ';
    }

    const info = document.createElement('div');
    info.className = 'queue-item-info';
    info.innerHTML = `
      <div class="queue-item-title">${escHtml(song.title)}</div>
      <div class="queue-item-by">${escHtml(song.addedBy || '')} ${escHtml(song.addedByEmoji || '')}</div>
    `;

    div.appendChild(thumbDiv);
    div.appendChild(info);

    if (i === currentIndex) {
      const bars = document.createElement('div');
      bars.className = 'queue-playing-bar';
      bars.innerHTML = '<span></span><span></span><span></span>';
      div.appendChild(bars);
    } else if (isHost) {
      const removeBtn = document.createElement('button');
      removeBtn.style.cssText = 'background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:2px;line-height:1;flex-shrink:0;';
      removeBtn.textContent = 'Ã—'; removeBtn.title = 'Remove';
      removeBtn.onmouseenter = () => removeBtn.style.color = '#ff5f5f';
      removeBtn.onmouseleave = () => removeBtn.style.color = 'var(--muted)';
      removeBtn.onclick = (e) => { e.stopPropagation(); removeFromQueue(i); };
      div.appendChild(removeBtn);
      // Enable drag-to-reorder for non-playing items
      makeDraggable(div, i);
    }

    if (isHost && i !== currentIndex) {
      div.onclick = (e) => {
        if (e.target.tagName === 'BUTTON') return;
        playSongAt(i, queue);
      };
    }

    el.appendChild(div);
  });

  el.querySelector('.playing')?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderMembers(members) {
  const el  = document.getElementById('membersList');
  const cnt = document.getElementById('memberCount');
  if (cnt) cnt.textContent = members.length;
  if (!el) return;

  const sorted = [...members].sort((a,b) => (b.isHost?1:0)-(a.isHost?1:0));
  el.innerHTML = '';
  sorted.forEach(m => {
    const div = document.createElement('div');
    div.className = 'member-item';
    div.innerHTML = `
      <div class="member-avatar">
        ${escHtml(m.emoji||'ğŸµ')}
        ${m.isHost ? '<div class="member-host-dot">â˜…</div>' : ''}
      </div>
      <div style="flex:1;min-width:0;">
        <div class="member-name">${escHtml(m.name)}</div>
        <div class="member-mood">${escHtml(m.mood||'')}</div>
      </div>
      ${isHost && m.uid !== jamUser.uid
        ? `<button class="kick-btn" title="Kick ${escHtml(m.name)}">âœ•</button>`
        : ''}
    `;
    if (isHost && m.uid !== jamUser.uid) {
      const kBtn = div.querySelector('.kick-btn');
      kBtn.onclick = () => kickMember(m.uid, m.name);
    }
    el.appendChild(div);
  });
}

function renderMoodMeter(members) {
  const el = document.getElementById('moodMeterBars');
  if (!el) return;
  const counts = {};
  members.forEach(m => { if (m.mood) counts[m.mood] = (counts[m.mood]||0)+1; });
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,5);
  const total = members.length || 1;

  if (!sorted.length) {
    el.innerHTML = '<div style="font-size:11px;color:var(--muted);">No vibes yet</div>';
    return;
  }

  el.innerHTML = sorted.map(([mood, count]) => `
    <div class="mood-bar-row">
      <div class="mood-bar-label">${escHtml(mood)}</div>
      <div class="mood-bar"><div class="mood-bar-fill" style="width:${(count/total*100).toFixed(0)}%"></div></div>
      <div class="mood-count">${count}</div>
    </div>
  `).join('');
}

// â”€â”€ ROOM ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateSetting(key, val) {
  if (!isHost) return;
  await fbDb.collection('jam_rooms').doc(currentRoomId).update({ [`settings.${key}`]: val });
  if (key === 'radio') {
    document.getElementById('radioOnBadge').style.display = val ? '' : 'none';
    if (val) toast('ğŸ“» Radio mode on');
  }
}

async function kickMember(uid, name) {
  if (!isHost) return;
  if (!confirm(`Kick ${name} from the room?`)) return;
  await fbDb.collection('jam_rooms').doc(currentRoomId).collection('members').doc(uid).delete();
  await fbDb.collection('jam_rooms').doc(currentRoomId).collection('kicked').doc(uid).set({
    at: firebase.firestore.FieldValue.serverTimestamp()
  });
  await logActivity('ğŸ‘¢', `kicked ${name}`);
  toast(`ğŸ‘¢ Kicked ${name}`);
}

async function closeRoom() {
  if (!isHost) return;
  if (!confirm('Close this room? Everyone will be disconnected.')) return;
  const roomCode = currentRoom?.code;
  const roomName = currentRoom?.name;
  await fbDb.collection('jam_rooms').doc(currentRoomId).update({ active: false });
  if (roomCode) removeFromRecentRooms(roomCode);
  await leaveRoom(true);
  window.history.replaceState({}, '', window.location.pathname);
  toast(`ğŸ”’ Room "${roomName}" closed`);
}

async function leaveRoom(silent = false) {
  roomListeners.forEach(u => u()); roomListeners = [];
  stopProgress();
  stopLyricsSync();

  if (currentRoomId && jamUser) {
    try {
      await fbDb.collection('jam_rooms').doc(currentRoomId)
        .collection('members').doc(jamUser.uid).delete();
      if (!silent && currentRoomId) {
        await logActivity('ğŸ‘‹', 'left the jam');
      }
    } catch(e) {}
  }

  if (ytPlayer?.stopVideo) ytPlayer.stopVideo();
  currentRoom = null; currentRoomId = null; isHost = false;
  lastRenderedSongId = null;
  document.getElementById('reactBar').style.display = 'none';

  window.history.replaceState({}, '', window.location.pathname);
  showLobby();
  if (!silent) toast('ğŸ‘‹ Left the room');
}

function handleRoomClosed() {
  roomListeners.forEach(u => u()); roomListeners = [];
  const code = currentRoom?.code, name = currentRoom?.name;
  currentRoom = null; currentRoomId = null; isHost = false;
  lastRenderedSongId = null;
  stopProgress();
  stopLyricsSync();
  if (ytPlayer?.stopVideo) ytPlayer.stopVideo();
  document.getElementById('reactBar').style.display = 'none';
  if (code) removeFromRecentRooms(code);
  window.history.replaceState({}, '', window.location.pathname);
  showLobby();
  toast(`ğŸ”’ Room "${name || code || ''}" was closed by the host`);
}

// â”€â”€ REACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendReaction(emoji) {
  if (!currentRoomId || !currentRoom?.settings?.reactions) return;
  const x = 20 + Math.random() * 60;
  spawnReaction(emoji, x);
  try {
    await fbDb.collection('jam_rooms').doc(currentRoomId).collection('reactions').add({
      emoji, uid: jamUser.uid, name: jamProfile.name, x,
      at: firebase.firestore.FieldValue.serverTimestamp(),
    });
  } catch(e) {}
}

function spawnReaction(emoji, x) {
  const el = document.createElement('div');
  el.className = 'reaction-float';
  el.textContent = emoji;
  el.style.left = x + '%';
  el.style.bottom = '80px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2600);
}

// â”€â”€ PLAYER CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePlay() {
  if (!ytPlayer) return;
  const state = ytPlayer.getPlayerState?.();
  if (state === YT.PlayerState.PLAYING) {
    ytPlayer.pauseVideo();
  } else {
    ytPlayer.playVideo();
  }
}

function toggleMute() {
  if (!ytPlayer) return;
  isMuted = !isMuted;
  if (isMuted) {
    ytPlayer.mute();
  } else {
    ytPlayer.unMute();
    ytPlayer.setVolume(currentVol);
  }
  const muteBtn = document.getElementById('muteBtn');
  if (muteBtn) muteBtn.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
  const volIcon = document.querySelector('.volume-icon');
  if (volIcon) volIcon.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
}

function setVolume(val) {
  currentVol = parseInt(val);
  document.getElementById('volLabel').textContent = val + '%';
  if (ytPlayer?.setVolume) {
    ytPlayer.setVolume(currentVol);
    if (isMuted && currentVol > 0) { isMuted = false; ytPlayer.unMute(); }
  }
}

function startProgress() {
  stopProgress();
  playStartTime = Date.now();
  progressTimer = setInterval(updateProgress, 1000);
  updateProgress();
}

function stopProgress() {
  if (progressTimer) { clearInterval(progressTimer); progressTimer = null; }
  playStartTime = null;
  const pf = document.getElementById('progressFill');
  if (pf) pf.style.width = '0%';
  const pc = document.getElementById('progCurrent');
  if (pc) pc.textContent = '0:00';
}

function updateProgress() {
  if (!playStartTime) return;

  // Prefer real player time if available
  let elapsed;
  if (ytPlayer?.getCurrentTime) {
    try { elapsed = Math.floor(ytPlayer.getCurrentTime()); }
    catch(e) { elapsed = Math.floor((Date.now() - playStartTime) / 1000); }
  } else {
    elapsed = Math.floor((Date.now() - playStartTime) / 1000);
  }

  const mins = Math.floor(elapsed / 60);
  const secs = elapsed % 60;
  const pc = document.getElementById('progCurrent');
  if (pc) pc.textContent = `${mins}:${String(secs).padStart(2,'0')}`;

  // Get real duration if available
  let duration = 300; // fallback 5 min
  if (ytPlayer?.getDuration) {
    try { const d = ytPlayer.getDuration(); if (d > 0) duration = d; } catch(e) {}
  }

  const durMins = Math.floor(duration / 60);
  const durSecs = Math.floor(duration % 60);
  const pt = document.getElementById('progTotal');
  if (pt) pt.textContent = `${durMins}:${String(durSecs).padStart(2,'0')}`;

  const pf = document.getElementById('progressFill');
  if (pf) pf.style.width = Math.min(100, (elapsed / duration) * 100) + '%';
}

function seekProgress(e) {
  const bar = e.currentTarget;
  const pct = Math.max(0, Math.min(1, e.offsetX / bar.offsetWidth));
  if (ytPlayer?.seekTo) {
    try {
      const duration = ytPlayer.getDuration() || 300;
      ytPlayer.seekTo(pct * duration, true);
      playStartTime = Date.now() - (pct * (ytPlayer.getDuration() || 300) * 1000);
    } catch(e2) {
      playStartTime = Date.now() - (pct * 300 * 1000);
    }
  } else {
    playStartTime = Date.now() - (pct * 300 * 1000);
  }
  const pf = document.getElementById('progressFill');
  if (pf) pf.style.width = (pct * 100) + '%';
}

// â”€â”€ LYRICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchLyrics(title, artist) {
  const el   = document.getElementById('lyricsContent');
  const full = document.getElementById('fullLyricsContent');
  if (!el) return;
  el.innerHTML = '<div style="color:var(--muted);font-style:italic;font-size:12px;">Loading lyrics...</div>';
  stopLyricsSync();

  if (!title || !artist) {
    el.innerHTML = '<div style="color:var(--muted);font-style:italic;font-size:12px;">No lyrics available</div>';
    return;
  }

  // Clean title: remove (Official Video), [Lyrics], etc.
  const cleanTitle  = title.replace(/\(.*?\)|\[.*?\]/g,'').trim();
  const cleanArtist = artist.split('-')[0].trim().split('VEVO')[0].trim();

  try {
    const res = await fetch(
      `https://api.lyrics.ovh/v1/${encodeURIComponent(cleanArtist)}/${encodeURIComponent(cleanTitle)}`
    );
    if (res.ok) {
      const data = await res.json();
      if (data.lyrics) {
        const lines = data.lyrics.trim().split('\n').filter(l => l.trim());
        const makeHTML = () => lines.map((l,i) =>
          `<div class="lyric-line" data-i="${i}">${escHtml(l)}</div>`
        ).join('');
        el.innerHTML = makeHTML();
        if (full) full.innerHTML = makeHTML();
        startLyricsSync(lines.length);
        return;
      }
    }
  } catch(e) {}

  const noLyrics = '<div style="color:var(--muted);font-style:italic;font-size:12px;">No lyrics found for this song.</div>';
  el.innerHTML = noLyrics;
  if (full) full.innerHTML = '<div style="color:var(--muted);font-style:italic;font-size:24px;text-align:center;">No lyrics available</div>';
}

function startLyricsSync(lineCount) {
  stopLyricsSync();
  if (!lineCount) return;
  let currentLine = 0;
  // Use real video duration for better sync if available
  let duration = 300;
  if (ytPlayer?.getDuration) {
    try { const d = ytPlayer.getDuration(); if (d > 0) duration = d; } catch(e) {}
  }
  const interval = Math.max(2000, (duration / lineCount) * 1000);

  lyricsTimer = setInterval(() => {
    if (!document.getElementById('lyricsContent')) { stopLyricsSync(); return; }
    document.querySelectorAll('#lyricsContent .lyric-line, #fullLyricsContent .lyric-line').forEach((l, i) => {
      l.classList.toggle('active', i === currentLine);
    });
    const active = document.querySelector('#lyricsContent .lyric-line.active');
    active?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const fullActive = document.querySelector('#fullLyricsContent .lyric-line.active');
    fullActive?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    currentLine = (currentLine + 1) % lineCount;
  }, interval);
}

function stopLyricsSync() {
  if (lyricsTimer) { clearInterval(lyricsTimer); lyricsTimer = null; }
}

// â”€â”€ FULLSCREEN LYRICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFullLyrics() {
  document.getElementById('fullLyricsOverlay').classList.toggle('open');
}

// â”€â”€ ROOM TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchRoomTab(tab, btn) {
  document.querySelectorAll('.room-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const tabId = 'tab' + tab.charAt(0).toUpperCase() + tab.slice(1);
  document.getElementById(tabId)?.classList.add('active');

  if (tab === 'chat') {
    chatTabActive = true;
    unreadChatCount = 0;
    updateChatTabBadge();
    // Scroll to bottom
    setTimeout(() => {
      const c = document.getElementById('chatMessages');
      if (c) c.scrollTop = c.scrollHeight;
    }, 50);
  } else {
    chatTabActive = false;
  }
}

// â”€â”€ COPY CODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyCode() {
  if (!currentRoom) return;
  copyToClipboard(currentRoom.code);
  toast('ğŸ“‹ Room code copied!');
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(t) {
  if (t == null) return '';
  const d = document.createElement('div');
  d.textContent = String(t);
  return d.innerHTML;
}

let toastTimer;
function toast(msg) {
  const el = document.getElementById('jamToast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3400);
}

// Prevent leaving room on accidental back button / tab close
window.addEventListener('beforeunload', (e) => {
  if (currentRoomId) {
    e.preventDefault();
    e.returnValue = 'Leave the jam session?';
    return e.returnValue;
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Only in room, not while typing
  if (!currentRoomId) return;
  const tag = document.activeElement?.tagName?.toLowerCase();
  if (tag === 'input' || tag === 'textarea') return;

  if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
  if (e.code === 'ArrowRight' && e.altKey) { e.preventDefault(); skipSong(); }
  if (e.code === 'ArrowLeft' && e.altKey) { e.preventDefault(); prevSong(); }
  if (e.code === 'KeyM') { toggleMute(); }
  if (e.code === 'KeyL') { toggleFullLyrics(); }
});

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
